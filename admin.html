<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FPS GFX Tool - Admin Dashboard</title>
  <style>
    /* Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* Body with Myanmar Map and Waves */
    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background: linear-gradient(180deg, #1a1a1a, #2a2a2a);
      position: relative;
      overflow-x: hidden;
    }

    body.dashboard-active {
      background: url('https://upload.wikimedia.org/wikipedia/commons/4/48/Myanmar_map.png') no-repeat center center / cover;
      animation: mapZoom 20s ease-in-out infinite;
      position: relative;
    }

    body.dashboard-active::before {
      content: '';
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 200px;
      background: url('https://i.imgur.com/4Dwaves.png') repeat-x bottom;
      background-size: 2000px 200px;
      animation: waveAnimation 10s linear infinite;
      z-index: -1;
      filter: drop-shadow(0 0 20px rgba(0, 191, 255, 0.5));
    }

    @keyframes mapZoom {
      0% { background-size: 100%; }
      50% { background-size: 110%; }
      100% { background-size: 100%; }
    }

    @keyframes waveAnimation {
      0% { background-position-x: 0; }
      100% { background-position-x: 2000px; }
    }

    /* Container */
    .container {
      background: rgba(34, 34, 34, 0.9);
      padding: 24px;
      border-radius: 16px;
      width: 100%;
      max-width: 800px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.8s ease-out;
      backdrop-filter: blur(10px);
      z-index: 1;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Typography */
    h1, h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 24px;
      text-align: center;
      color: #ffd700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    h3 {
      font-size: 18px;
      color: #ffd700;
      margin-bottom: 16px;
    }

    /* Form Elements */
    input, select, button, textarea {
      width: 100%;
      padding: 12px;
      margin: 12px 0;
      border: none;
      border-radius: 8px;
      background: rgba(51, 51, 51, 0.8);
      color: #fff;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      background: rgba(68, 68, 68, 0.9);
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.5);
      transform: scale(1.02);
    }

    /* Button Styles with Myanmar Flag Animation */
    button {
      position: relative;
      background: linear-gradient(45deg, #ffd700, #ff8c00);
      font-weight: 600;
      cursor: pointer;
      overflow: hidden;
      z-index: 1;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: url('https://upload.wikimedia.org/wikipedia/commons/8/8c/Flag_of_Myanmar.svg') center / contain no-repeat;
      opacity: 0;
      transform: translate(-50%, -50%);
      transition: all 0.5s ease;
      z-index: -1;
    }

    button:hover::before {
      width: 200px;
      height: 200px;
      opacity: 0.3;
    }

    button:active::before {
      width: 300px;
      height: 300px;
      opacity: 0.5;
      animation: flagBurst 0.5s ease-out;
    }

    @keyframes flagBurst {
      0% { width: 0; height: 0; opacity: 0; }
      50% { width: 400px; height: 400px; opacity: 0.7; }
      100% { width: 300px; height: 300px; opacity: 0.5; }
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(255, 215, 0, 0.6);
    }

    /* Admin Badge */
    .admin-badge {
      position: fixed;
      top: 16px;
      right: 16px;
      background: linear-gradient(45deg, #ff4444, #ff8c00);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      animation: glow 1.5s ease-in-out infinite alternate;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
    }

    @keyframes glow {
      from { box-shadow: 0 0 8px rgba(255, 215, 0, 0.6); }
      to { box-shadow: 0 0 16px rgba(255, 215, 0, 0.9); }
    }

    /* Messages */
    .message {
      padding: 12px;
      margin: 12px 0;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
      animation: slideIn 0.5s ease-out;
    }

    .error { background: #ff4444; }
    .success { background: #44ff44; }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-16px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
      background: rgba(51, 51, 51, 0.8);
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    th {
      background: rgba(68, 68, 68, 0.9);
      font-weight: 600;
    }

    tr:hover {
      background: rgba(68, 68, 68, 0.9);
    }

    /* Responsive Design */
    @media (max-width: 480px) {
      .container {
        padding: 16px;
      }
      h1, h2 {
        font-size: 20px;
      }
      input, select, button, textarea {
        font-size: 14px;
      }
      table {
        font-size: 12px;
      }
      body.dashboard-active::before {
        height: 150px;
        background-size: 1500px 150px;
      }
    }
  </style>
</head>
<body>
  <div class="admin-badge">Admin</div>
  <div class="container" id="main-container">
    <h1>FPS GFX Tool - Admin Dashboard</h1>
    <div id="status"></div>
    <input type="text" id="admin-key" placeholder="Enter Admin Key" required>
    <button onclick="adminLogin()">Login</button>
    <div id="admin-content" style="display: none;">
      <h2>Admin Panel</h2>
      <div id="manage-about" style="display: none;">
        <h3>Manage About</h3>
        <input type="text" id="about-telegram" placeholder="Telegram Link">
        <input type="text" id="about-viber" placeholder="Viber Link">
        <input type="text" id="about-phone" placeholder="Phone Number">
        <button onclick="updateAbout()">Update About</button>
      </div>
      <div id="manage-keys" style="display: none;">
        <h3>Manage Keys</h3>
        <input type="text" id="key-text" placeholder="Key Text">
        <select id="key-duration-type">
          <option value="days">Days</option>
          <option value="weeks">Weeks</option>
          <option value="months">Months</option>
        </select>
        <input type="number" id="key-duration-value" placeholder="Duration Value">
        <input type="number" id="key-max-devices" placeholder="Max Devices">
        <button onclick="createKey()">Create Key</button>
        <table id="keys-table">
          <thead>
            <tr>
              <th>Key</th>
              <th>Expires At</th>
              <th>Max Devices</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="manage-users" style="display: none;">
        <h3>Manage Users</h3>
        <table id="users-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Name</th>
              <th>Banned</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="manage-news" style="display: none;">
        <h3>Manage News</h3>
        <input type="text" id="admin-news-title" placeholder="Title">
        <textarea id="admin-news-content" placeholder="Content"></textarea>
        <input type="text" id="admin-news-youtube" placeholder="YouTube Link">
        <input type="file" id="admin-news-image" accept="image/*">
        <button onclick="postAdminNews()">Post News</button>
        <table id="news-table">
          <thead>
            <tr>
              <th>Title</th>
              <th>Content</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="manage-support" style="display: none;">
        <h3>Manage Support</h3>
        <div id="support-messages"></div>
        <textarea id="admin-support-input" placeholder="Reply to user"></textarea>
        <button onclick="sendAdminSupportMessage()">Send Reply</button>
      </div>
      <div class="menu">
        <button onclick="showAdminSection('manage-about')">About</button>
        <button onclick="showAdminSection('manage-keys')">Keys</button>
        <button onclick="showAdminSection('manage-users')">Users</button>
        <button onclick="showAdminSection('manage-news')">News</button>
        <button onclick="showAdminSection('manage-support')">Support</button>
      </div>
    </div>
  </div>

  <script>
    // Constants
    const SUPABASE_URL = 'https://rliwdosxsbauwxkayjoa.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsaXdkb3N4c2JhdXd4a2F5am9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxMDA2NjIsImV4cCI6MjA2OTY3NjY2Mn0.uDvU9eX3Cy--D9l6daGaO2QMpn1YnxMJYVlbaeIgHu4';
    const TELEGRAM_BOT_TOKEN = '8493584268:AAEpDAPbwRDJYBf9VjlxSiELc4bTrrn_7xw';
    const TELEGRAM_GROUP_ID = '-1002863080440';
    const ADMIN_KEY = 'admin123'; // Replace with your actual admin key

    let supabase = null;

    // Load Supabase script with fallback
    async function loadSupabaseScript() {
      const cdnUrls = [
        'https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js',
        'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js'
      ];

      for (const url of cdnUrls) {
        try {
          return await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = url;
            script.timeout = 10000; // 10 seconds timeout
            script.onload = () => {
              console.log(`Supabase script loaded successfully from ${url}`);
              resolve();
            };
            script.onerror = () => {
              console.error(`Failed to load Supabase script from ${url}`);
              reject(new Error(`Failed to load Supabase script from ${url}`));
            };
            document.head.appendChild(script);
          });
        } catch (error) {
          console.error(error.message);
          continue;
        }
      }
      throw new Error('All Supabase CDN sources failed to load');
    }

    // Check Internet Connectivity
    async function checkInternet() {
      if (!navigator.onLine) {
        console.error('No internet connection detected');
        showMessage('No internet connection! Please check your network and try again.', 'error');
        return false;
      }
      try {
        const response = await fetch(SUPABASE_URL + '/rest/v1/', {
          method: 'HEAD',
          cache: 'no-store',
          timeout: 5000
        });
        if (!response.ok) {
          throw new Error('Supabase server unreachable');
        }
        console.log('Internet connectivity verified');
        return true;
      } catch (error) {
        console.error('Internet check failed:', error);
        showMessage(`Failed to connect to server: ${error.message}. Please check your network or use a VPN.`, 'error');
        return false;
      }
    }

    // Initialize Supabase with Retry Logic
    async function initializeSupabase(attempt = 1, maxAttempts = 3) {
      if (!(await checkInternet())) {
        if (attempt < maxAttempts) {
          console.log(`Retrying Supabase initialization (Attempt ${attempt + 1}/${maxAttempts})...`);
          await new Promise(resolve => setTimeout(resolve, 2000));
          return initializeSupabase(attempt + 1, maxAttempts);
        }
        showMessage('Unable to connect to database after multiple attempts. Please try again later.', 'error');
        return;
      }

      try {
        await loadSupabaseScript();
        if (typeof Supabase === 'undefined') {
          throw new Error('Supabase library not loaded');
        }
        supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          fetch: (url, options) => fetch(url, { ...options, cache: 'no-store' })
        });
        const { data, error } = await supabase.from('about').select('id').limit(1);
        if (error) {
          throw new Error(`Connection test failed: ${error.message}`);
        }
        console.log('Supabase client initialized successfully');
        showMessage('Database connected successfully!', 'success');
        setupRealtimeSubscriptions();
      } catch (error) {
        console.error('Failed to initialize Supabase client:', error);
        if (attempt < maxAttempts) {
          console.log(`Retrying Supabase initialization (Attempt ${attempt + 1}/${maxAttempts})...`);
          await new Promise(resolve => setTimeout(resolve, 2000));
          return initializeSupabase(attempt + 1, maxAttempts);
        }
        showMessage(`Error initializing database: ${error.message}. Please check your network or refresh the page.`, 'error');
      }
    }

    function showMessage(message, type) {
      const status = document.getElementById('status');
      status.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => status.innerHTML = '', 7000);
      console.log(`Message displayed: ${message} (${type})`);
    }

    async function adminLogin() {
      if (!(await checkInternet())) return;
      if (!supabase) {
        console.error('Supabase client not initialized');
        showMessage('Database not connected.', 'error');
        return;
      }
      try {
        const key = document.getElementById('admin-key').value.trim();
        if (key !== ADMIN_KEY) {
          throw new Error('Invalid admin key');
        }
        document.getElementById('admin-key').style.display = 'none';
        document.querySelector('button[onclick="adminLogin()"]').style.display = 'none';
        document.getElementById('admin-content').style.display = 'block';
        document.body.classList.add('dashboard-active');
        showMessage('Admin login successful!', 'success');
        loadAbout();
        loadKeys();
        loadUsers();
        loadNews();
        loadSupportMessages();
        console.log('Admin login successful');
      } catch (error) {
        console.error('Admin login error:', error);
        showMessage(`Admin login failed: ${error.message}`, 'error');
      }
    }

    function showAdminSection(section) {
      try {
        document.getElementById('manage-about').style.display = section === 'manage-about' ? 'block' : 'none';
        document.getElementById('manage-keys').style.display = section === 'manage-keys' ? 'block' : 'none';
        document.getElementById('manage-users').style.display = section === 'manage-users' ? 'block' : 'none';
        document.getElementById('manage-news').style.display = section === 'manage-news' ? 'block' : 'none';
        document.getElementById('manage-support').style.display = section === 'manage-support' ? 'block' : 'none';
        console.log(`Switched to ${section} section`);
      } catch (error) {
        console.error('Show admin section error:', error);
        showMessage(`Section switch failed: ${error.message}`, 'error');
      }
    }

    async function loadAbout() {
      if (!(await checkInternet())) return;
      if (!supabase) {
        console.error('Supabase client not initialized');
        showMessage('Database not connected.', 'error');
        return;
      }
      try {
        const { data, error } = await supabase.from('about').select('*').single();
        if (error) throw new Error(`About fetch error: ${error.message}`);
        if (data) {
          document.getElementById('about-telegram').value = data.telegram || '';
          document.getElementById('about-viber').value = data.viber || '';
          document.getElementById('about-phone').value = data.phone || '';
        }
        console.log('About data loaded');
      } catch (error) {
        console.error('Load about error:', error);
        showMessage(`Failed to load about data: ${error.message}`, 'error');
      }
    }

    async function updateAbout() {
      if (!(await checkInternet())) return;
      if (!supabase) {
        console.error('Supabase client not initialized');
        showMessage('Database not connected.', 'error');
        return;
      }
      try {
        const telegram = document.getElementById('about-telegram').value.trim();
        const viber = document.getElementById('about-viber').value.trim();
        const phone = document.getElementById('about-phone').value.trim();
        const { error } = await supabase.from('about').upsert({
          id: 'main',
          telegram: telegram || null,
          viber: viber || null,
          phone: phone || null,
        });
        if (error) throw new Error(`About update error: ${error.message}`);
        showMessage('About updated successfully!', 'success');
        console.log('About updated');
      } catch (error) {
        console.error('Update about error:', error);
        showMessage(`About update failed: ${error.message}`, 'error');
      }
    }

    async function createKey() {
      if (!(await checkInternet())) return;
      if (!supabase) {
        console.error('Supabase client not initialized');
        showMessage('Database not connected.', 'error');
        return;
      }
      try {
        const keyText = document.getElementById('key-text').value.trim();
        const durationType = document.getElementById('key-duration-type').value;
        const durationValue = parseInt(document.getElementById('key-duration-value').value);
        const maxDevices = parseInt(document.getElementById('key-max-devices').value);

        if (!keyText || !durationValue || !maxDevices) {
          throw new Error('All fields are required');
        }

        let expiresAt;
        const now = new Date();
        if (durationType === 'days') {
          expiresAt = new Date(now.setDate(now.getDate() + durationValue));
        } else if (durationType === 'weeks') {
          expiresAt = new Date(now.setDate(now.getDate() + durationValue * 7));
        } else if (durationType === 'months') {
          expiresAt = new Date(now.setMonth(now.getMonth() + durationValue));
        }

        const { error } = await supabase.from('keys').insert({
          key_text: keyText,
          expires_at: expiresAt.toISOString(),
          duration_type: durationType,
          duration_value: durationValue,
          max_devices: maxDevices,
          is_active: true,
        });
        if (error) throw new Error(`Key insert error: ${error.message}`);

        showMessage('Key created successfully!', 'success');
        document.getElementById('key-text').value = '';
        document.getElementById('key-duration-value').value = '';
        document.getElementById('key-max-devices').value = '';
        loadKeys();
        console.log('Key created:', keyText);
      } catch (error) {
        console.error('Create key error:', error);
        showMessage(`Key creation failed: ${error.message}`, 'error');
      }
    }

    async function loadKeys() {
      if (!(await checkInternet())) return;
      if (!supabase) {
        console.error('Supabase client not initialized');
        showMessage('Database not connected.', 'error');
        return;
      }
      try {
        const { data, error } = await supabase.from('keys').select('*').order('created_at', { ascending: false });
        if (error) throw new Error(`Keys fetch error: ${error.message}`);

        const tableBody = document.querySelector('#keys-table tbody');
        tableBody.innerHTML = '';
        data.forEach(key => {
          tableBody.innerHTML += `
            <tr>
              <td>${key.key_text}</td>
              <td>${new Date(key.expires_at).toLocaleString()}</td>
              <td>${key.max_devices}</td>
              <td>${key.is_active ? 'Active' : 'Inactive'}</td>
              <td><button onclick="toggleKeyStatus('${key.id}', ${key.is_active})">${key.is_active ? 'Deactivate' : 'Activate'}</button></td>
            </tr>
          `;
        });
        console.log('Keys loaded:', data.length);
      } catch (error) {
        console.error('Load keys error:', error);
        showMessage(`Failed to load keys: ${error.message}`, 'error');
      }
    }

    async function toggleKeyStatus(keyId, isActive) {
      if (!(await checkInternet())) return;
      if (!supabase) {
        console.error('Supabase client not initialized');
        showMessage('Database not connected.', 'error');
        return;
      }
      try {
        const { error } = await supabase.from('keys').update({ is_active: !isActive }).eq('id', keyId);
        if (error) throw new Error(`Key status update error: ${error.message}`);
        showMessage(`Key ${isActive ? 'deactivated' : 'activated'} successfully!`, 'success');
        loadKeys();
        console.log(`Key ${keyId} status toggled to ${!isActive}`);
      } catch (error) {
        console.error('Toggle key status error:', error);
        showMessage(`Key status update failed: ${error.message}`, 'error');
      }
    }

    async function loadUsers() {
      if (!(await checkInternet())) return;
      if (!supabase) {
        console.error('Supabase client not initialized');
        showMessage('Database not connected.', 'error');
        return;
      }
      try {
        const { data, error } = await supabase.from('profiles').select('*').order('created_at', { ascending: false });
        if (error) throw new Error(`Users fetch error: ${error.message}`);

        const tableBody = document.querySelector('#users-table tbody');
        tableBody.innerHTML = '';
        data.forEach(user => {
          tableBody.innerHTML += `
            <tr>
              <td>${user.username}</td>
              <td>${user.name}</td>
              <td>${user.is_banned ? 'Banned' : 'Active'}</td>
              <td><button onclick="toggleUserBan('${user.id}', ${user.is_banned})">${user.is_banned ? 'Unban' : 'Ban'}</button></td>
            </tr>
          `;
        });
        console.log('Users loaded:', data.length);
      } catch (error) {
        console.error('Load users error:', error);
        showMessage(`Failed to load users: ${error.message}`, 'error');
      }
    }

    async function toggleUserBan(userId, isBanned) {
      if (!(await checkInternet())) return;
      if (!supabase) {
        console.error('Supabase client not initialized');
        showMessage('Database not connected.', 'error');
        return;
      }
      try {
        const { error } = await supabase.from('profiles').update({ is_banned: !isBanned }).eq('id', userId);
        if (error) throw new Error(`User ban update error: ${error.message}`);
        showMessage(`User ${isBanned ? 'unbanned' : 'banned'} successfully!`, 'success');
        loadUsers();
        console.log(`User ${userId} ban status toggled to ${!isBanned}`);
      } catch (error) {
        console.error('Toggle user ban error:', error);
        showMessage(`User ban update failed: ${error.message}`, 'error');
      }
    }

    async function postAdminNews() {
      if (!(await checkInternet())) return;
      if (!supabase) {
        console.error('Supabase client not initialized');
        showMessage('Database not connected.', 'error');
        return;
      }
      try {
        const title = document.getElementById('admin-news-title').value.trim();
        const content = document.getElementById('admin-news-content').value.trim();
        const youtubeLink = document.getElementById('admin-news-youtube').value.trim();
        const file = document.getElementById('admin-news-image').files[0];

        if (!title || !content) throw new Error('Title and content are required');

        let imageUrl = null;
        if (file) {
          const { data, error } = await supabase.storage
            .from('news')
            .upload(`public/admin/${Date.now()}_${file.name}`, file);
          if (error) throw new Error(`Image upload error: ${error.message}`);
          imageUrl = `${SUPABASE_URL}/storage/v1/object/public/news/${data.path}`;
        }

        const { error } = await supabase.from('news').insert({
          title,
          content,
          youtube_link: youtubeLink || null,
          image_url: imageUrl,
          is_admin: true,
        });
        if (error) throw new Error(`News insert error: ${error.message}`);

        showMessage('News posted successfully!', 'success');
        document.getElementById('admin-news-title').value = '';
        document.getElementById('admin-news-content').value = '';
        document.getElementById('admin-news-youtube').value = '';
        document.getElementById('admin-news-image').value = '';
        loadNews();
        console.log('Admin news posted:', title);
      } catch (error) {
        console.error('Post admin news error:', error);
        showMessage(`News posting failed: ${error.message}`, 'error');
      }
    }

    async function loadNews() {
      if (!(await checkInternet())) return;
      if (!supabase) {
        console.error('Supabase client not initialized');
        showMessage('Database not connected.', 'error');
        return;
      }
      try {
        const { data, error } = await supabase.from('news').select('*').order('created_at', { ascending: false });
        if (error) throw new Error(`News fetch error: ${error.message}`);

        const tableBody = document.querySelector('#news-table tbody');
        tableBody.innerHTML = '';
        data.forEach(news => {
          tableBody.innerHTML += `
            <tr>
              <td>${news.title}</td>
              <td>${news.content.substring(0, 50)}...</td>
              <td><button onclick="deleteNews('${news.id}')">Delete</button></td>
            </tr>
          `;
        });
        console.log('News loaded:', data.length);
      } catch (error) {
        console.error('Load news error:', error);
        showMessage(`Failed to load news: ${error.message}`, 'error');
      }
    }

    async function deleteNews(newsId) {
      if (!(await checkInternet())) return;
      if (!supabase) {
        console.error('Supabase client not initialized');
        showMessage('Database not connected.', 'error');
        return;
      }
      try {
        const { error } = await supabase.from('news').delete().eq('id', newsId);
        if (error) throw new Error(`News delete error: ${error.message}`);
        showMessage('News deleted successfully!', 'success');
        loadNews();
        console.log('News deleted:', newsId);
      } catch (error) {
        console.error('Delete news error:', error);
        showMessage(`News deletion failed: ${error.message}`, 'error');
      }
    }

    async function loadSupportMessages() {
      if (!(await checkInternet())) return;
      if (!supabase) {
        console.error('Supabase client not initialized');
        showMessage('Database not connected.', 'error');
        return;
      }
      try {
        const { data, error } = await supabase
          .from('support_messages')
          .select('*, profiles(username, name)')
          .order('created_at', { ascending: true });
        if (error) throw new Error(`Support messages fetch error: ${error.message}`);

        const messagesDiv = document.getElementById('support-messages');
        messagesDiv.innerHTML = '';
        if (data.length === 0) {
          messagesDiv.innerHTML = '<p>No support messages found.</p>';
          return;
        }
        data.forEach(msg => {
          messagesDiv.innerHTML += `
            <div class="message ${msg.is_from_user ? 'user' : 'admin'}">
              <p>${msg.profiles?.username || 'Admin'} (${msg.profiles?.name || 'Admin'}): ${msg.content}</p>
              <p>${new Date(msg.created_at).toLocaleString()}</p>
            </div>
          `;
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        console.log('Support messages loaded:', data.length);
      } catch (error) {
        console.error('Load support messages error:', error);
        showMessage(`Failed to load support messages: ${error.message}`, 'error');
      }
    }

    async function sendAdminSupportMessage() {
      if (!(await checkInternet())) return;
      if (!supabase) {
        console.error('Supabase client not initialized');
        showMessage('Database not connected.', 'error');
        return;
      }
      try {
        const content = document.getElementById('admin-support-input').value.trim();
        if (!content) throw new Error('Support message is empty');

        const { error } = await supabase.from('support_messages').insert({
          content,
          is_from_user: false,
        });
        if (error) throw new Error(`Support message insert error: ${error.message}`);

        const telegramResponse = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: TELEGRAM_GROUP_ID,
            text: `Admin Support Reply: ${content}`,
          }),
        });
        if (!telegramResponse.ok) {
          throw new Error(`Telegram API request failed: ${telegramResponse.statusText}`);
        }

        showMessage('Support reply sent!', 'success');
        document.getElementById('admin-support-input').value = '';
        loadSupportMessages();
        console.log('Admin support message sent:', content);
      } catch (error) {
        console.error('Send admin support message error:', error);
        showMessage(`Support reply failed: ${error.message}`, 'error');
      }
    }

    function setupRealtimeSubscriptions() {
      if (!supabase || typeof supabase.channel !== 'function') {
        console.error('Cannot setup subscriptions: Supabase client or channel method not available');
        showMessage('Realtime subscriptions failed: Database not properly initialized.', 'error');
        return;
      }

      supabase
        .channel('about')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'about' }, loadAbout)
        .subscribe((status, err) => {
          if (status === 'SUBSCRIBED') {
            console.log('Subscribed to about channel');
          } else if (err) {
            console.error('About subscription error:', err);
            showMessage(`About subscription failed: ${err.message}`, 'error');
          }
        });

      supabase
        .channel('keys')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'keys' }, loadKeys)
        .subscribe((status, err) => {
          if (status === 'SUBSCRIBED') {
            console.log('Subscribed to keys channel');
          } else if (err) {
            console.error('Keys subscription error:', err);
            showMessage(`Keys subscription failed: ${err.message}`, 'error');
          }
        });

      supabase
        .channel('profiles')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, loadUsers)
        .subscribe((status, err) => {
          if (status === 'SUBSCRIBED') {
            console.log('Subscribed to profiles channel');
          } else if (err) {
            console.error('Profiles subscription error:', err);
            showMessage(`Profiles subscription failed: ${err.message}`, 'error');
          }
        });

      supabase
        .channel('news')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'news' }, loadNews)
        .subscribe((status, err) => {
          if (status === 'SUBSCRIBED') {
            console.log('Subscribed to news channel');
          } else if (err) {
            console.error('News subscription error:', err);
            showMessage(`News subscription failed: ${err.message}`, 'error');
          }
        });

      supabase
        .channel('support_messages')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'support_messages' }, loadSupportMessages)
        .subscribe((status, err) => {
          if (status === 'SUBSCRIBED') {
            console.log('Subscribed to support messages channel');
          } else if (err) {
            console.error('Support messages subscription error:', err);
            showMessage(`Support messages subscription failed: ${err.message}`, 'error');
          }
        });
    }

    // Initialize Supabase client on page load
    window.addEventListener('load', () => initializeSupabase());
  </script>
</body>
</html>
