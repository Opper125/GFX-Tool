<!DOCTYPE html>
<html lang="my">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>FPS GFX Tool - မြန်မာ အက်ဒမင် ဒက်ရှ်ဘုတ်</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+Myanmar:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      font-family: 'Noto Sans Myanmar', 'Inter', sans-serif;
      box-sizing: border-box;
    }

    :root {
      --myanmar-yellow: #FECB00;
      --myanmar-green: #34B233;
      --myanmar-red: #EA2839;
      --myanmar-white: #FFFFFF;
      --myanmar-blue: #0F4C75;
      --dark-bg: #0F1419;
      --darker-bg: #1A1F2E;
      --card-bg: rgba(0, 0, 0, 0.85);
      --border-color: rgba(254, 203, 0, 0.3);
      --gold-color-start: #FFD700; /* Gold */
      --gold-color-end: #DAA520; /* Goldenrod */
    }

    body {
      background: linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 50%, var(--dark-bg) 100%);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      color: var(--myanmar-white);
    }

    .myanmar-pattern {
      background-image: 
        radial-gradient(circle at 25% 25%, rgba(254, 203, 0, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(52, 178, 51, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(234, 40, 57, 0.1) 0%, transparent 50%);
      animation: patternMove 25s ease-in-out infinite;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -2;
    }

    @keyframes patternMove {
      0%, 100% { background-position: 0% 0%, 100% 100%, 50% 50%; }
      33% { background-position: 100% 100%, 0% 0%, 75% 25%; }
      66% { background-position: 50% 50%, 75% 25%, 25% 75%; }
    }

    .myanmar-waves {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 80px;
      background: linear-gradient(45deg, 
        rgba(254, 203, 0, 0.2), 
        rgba(52, 178, 51, 0.2), 
        rgba(234, 40, 57, 0.2));
      clip-path: polygon(0 100%, 0 60%, 25% 40%, 50% 60%, 75% 30%, 100% 50%, 100% 100%);
      animation: waveFloat 12s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes waveFloat {
      0%, 100% { transform: translateY(0px) scaleY(1); }
      50% { transform: translateY(-10px) scaleY(1.1); }
    }

    .admin-card {
      backdrop-filter: blur(20px);
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      box-shadow: 
        0 20px 40px -12px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(254, 203, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 16px;
    }

    .admin-card:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 25px 50px -12px rgba(254, 203, 0, 0.25),
        0 0 0 1px rgba(254, 203, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
      border-color: rgba(254, 203, 0, 0.5);
    }

    .myanmar-btn {
      background: linear-gradient(135deg, var(--myanmar-yellow), var(--myanmar-green));
      color: #000;
      font-weight: 700;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      cursor: pointer;
    }

    .myanmar-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      transition: left 0.6s ease;
    }

    .myanmar-btn:hover::before {
      left: 100%;
    }

    .myanmar-btn:hover {
      background: linear-gradient(135deg, var(--myanmar-green), var(--myanmar-yellow));
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(254, 203, 0, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--myanmar-red), #FF6B6B);
      color: white;
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #FF6B6B, var(--myanmar-red));
      box-shadow: 0 10px 25px rgba(234, 40, 57, 0.4);
    }

    .connection-status {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 1000;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      backdrop-filter: blur(10px);
      animation: statusPulse 2s infinite;
    }

    .status-online {
      background: linear-gradient(135deg, var(--myanmar-green), #4ADE80);
      color: white;
      box-shadow: 0 0 20px rgba(52, 178, 51, 0.5);
    }

    .status-offline {
      background: linear-gradient(135deg, var(--myanmar-red), #EF4444);
      color: white;
      animation: statusShake 0.5s ease-in-out;
    }

    .status-connecting {
      background: linear-gradient(135deg, var(--myanmar-yellow), #FCD34D);
      color: #000;
      animation: statusSpin 1s linear infinite;
    }

    @keyframes statusPulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }

    @keyframes statusShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-3px); }
      75% { transform: translateX(3px); }
    }

    @keyframes statusSpin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .stats-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border-radius: 12px;
    }

    .stats-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--myanmar-yellow), var(--myanmar-green), var(--myanmar-red));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .stats-card:hover::before {
      opacity: 1;
    }

    .stats-card:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 15px 35px rgba(254, 203, 0, 0.2);
      border-color: rgba(254, 203, 0, 0.3);
    }

    .admin-input {
      background: rgba(255, 255, 255, 0.08);
      border: 2px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      color: white;
      transition: all 0.3s ease;
      border-radius: 12px;
      padding: 12px 16px;
    }

    .admin-input:focus {
      border-color: var(--myanmar-yellow);
      background: rgba(255, 255, 255, 0.12);
      outline: none;
      box-shadow: 0 0 25px rgba(254, 203, 0, 0.3);
    }

    .admin-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .admin-table {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      overflow: hidden;
    }

    .admin-table th {
      background: rgba(254, 203, 0, 0.15);
      color: var(--myanmar-yellow);
      font-weight: 700;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.5px;
      padding: 12px 8px;
    }

    .admin-table td {
      padding: 12px 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .admin-table tr:hover {
      background: rgba(254, 203, 0, 0.08);
    }

    .loading-spinner {
      border: 3px solid rgba(254, 203, 0, 0.3);
      border-top: 3px solid var(--myanmar-yellow);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .notification {
      position: fixed;
      top: 70px;
      right: 15px;
      left: 15px;
      max-width: 400px;
      margin: 0 auto;
      padding: 12px 16px;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      z-index: 1001;
      animation: slideInRight 0.4s ease-out;
      backdrop-filter: blur(15px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .admin-nav-item {
      transition: all 0.3s ease;
      position: relative;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.05);
      color: #9ca3af;
    }

    .admin-nav-item.active {
      background: var(--myanmar-yellow) !important;
      color: #000 !important;
      box-shadow: 0 5px 15px rgba(254, 203, 0, 0.4);
    }

    .admin-nav-item:not(.active):hover {
      background: rgba(254, 203, 0, 0.1);
      color: var(--myanmar-yellow);
    }

    .fade-in {
      animation: fadeInUp 0.6s ease-out forwards;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .status-active { color: var(--myanmar-green); }
    .status-inactive { color: var(--myanmar-red); }
    .status-banned { color: var(--myanmar-red); }

    .news-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      transition: all 0.3s ease;
      margin-bottom: 16px;
    }

    .news-card:hover {
      border-color: rgba(254, 203, 0, 0.3);
      transform: translateY(-2px);
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    .modal-content {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      backdrop-filter: blur(20px);
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .container { padding: 8px; }
      .admin-card { padding: 16px; margin: 8px; }
      .connection-status { top: 10px; right: 10px; font-size: 9px; padding: 6px 12px; }
      .notification { top: 50px; right: 10px; left: 10px; max-width: none; }
      .stats-card { margin-bottom: 12px; }
      .myanmar-btn { padding: 10px 16px; font-size: 14px; }
      .admin-table { font-size: 12px; }
      .admin-table th, .admin-table td { padding: 8px 4px; }
      h1 { font-size: 20px; }
      h2 { font-size: 18px; }
      h3 { font-size: 16px; }
      .admin-nav-item { padding: 6px 10px; font-size: 12px; margin: 2px; }
      .modal-content { padding: 16px; max-width: 95vw; }
    }

    @media (max-width: 480px) {
      .myanmar-pattern { opacity: 0.7; }
      .myanmar-waves { height: 60px; }
      .admin-card { padding: 12px; margin: 4px; }
      .grid { gap: 8px; }
      .stats-card { padding: 12px; }
      .admin-table th, .admin-table td { padding: 6px 2px; font-size: 11px; }
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
    ::-webkit-scrollbar-thumb { background: var(--myanmar-yellow); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--myanmar-green); }

    /* Loading overlay */
    .loading-overlay {
      backdrop-filter: blur(8px);
      background: rgba(0,0,0,0.7);
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 8px;
    }

    .table-actions {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .hidden { display: none !important; }

    /* Admin Profile Stamp Design */
    .admin-stamp {
      position: relative;
      display: inline-block;
      padding: 10px 20px;
      border-radius: 15px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #000;
      background: linear-gradient(135deg, var(--gold-color-start), var(--gold-color-end));
      box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4), inset 0 0 15px rgba(255, 215, 0, 0.3);
      overflow: hidden;
      animation: stampGlow 3s infinite alternate;
    }

    .admin-stamp::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: repeating-linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.1),
        rgba(255, 255, 255, 0.1) 10px,
        transparent 10px,
        transparent 20px
      );
      transform: rotate(45deg);
      animation: stripeMove 10s linear infinite;
      mix-blend-mode: overlay;
      opacity: 0.6;
    }

    @keyframes stampGlow {
      from { box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4), inset 0 0 15px rgba(255, 215, 0, 0.3); }
      to { box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6), inset 0 0 20px rgba(255, 215, 0, 0.5); }
    }

    @keyframes stripeMove {
      0% { background-position: 0 0; }
      100% { background-position: 100% 100%; }
    }
  </style>
</head>
<body class="text-white">
  <div class="myanmar-pattern"></div>
  <div class="myanmar-waves"></div>

  <!-- Connection Status -->
  <div id="status-indicator" class="connection-status status-connecting">
    <i class="fas fa-wifi"></i> ချိတ်ဆက်နေသည်...
  </div>

  <!-- Notification Container -->
  <div id="notification-container"></div>

  <!-- Admin Login Section -->
  <div id="admin-login-section" class="myanmar-container max-w-sm mx-auto mt-20 p-6">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-yellow-400 mb-2">
        <i class="fas fa-user-shield mr-2"></i>
        Admin Panel
      </h1>
      <p class="text-gray-300 text-sm">စီမံခန့်ခွဲသူ ဝင်ရောက်ရန်</p>
    </div>

    <div class="mb-4">
      <input 
        type="password" 
        id="admin-key-input" 
        placeholder="Admin Key ထည့်ပါ..." 
        class="myanmar-input w-full"
        required
      >
    </div>

    <button onclick="adminLogin()" id="admin-login-btn" class="myanmar-btn w-full">
      <i class="fas fa-sign-in-alt mr-2"></i>
      <span id="admin-login-text">ဝင်ရောက်ရန်</span>
    </button>
  </div>

  <!-- Admin Main Content -->
  <div id="admin-main-content" class="hidden min-h-screen pb-20">
    <div class="myanmar-container mx-auto max-w-4xl mt-4 p-4">
      <div class="text-center mb-6 fade-in">
        <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold mb-2 text-yellow-400">
          <i class="fas fa-shield-alt mr-2"></i>
          FPS GFX Tool
        </h1>
        <h2 class="text-lg md:text-xl lg:text-2xl font-semibold text-green-400 mb-2">
          မြန်မာ အက်ဒမင် ဒက်ရှ်ဘုတ်
        </h2>
        <div class="admin-stamp">
          <i class="fas fa-crown mr-1"></i> Administrator Panel
        </div>
      </div>

      <!-- Admin Navigation -->
      <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-6">
        <button onclick="showAdminSection('keys')" class="admin-nav-item active" id="admin-nav-keys">
          <i class="fas fa-key mr-2"></i>Keys
        </button>
        <button onclick="showAdminSection('users')" class="admin-nav-item" id="admin-nav-users">
          <i class="fas fa-users mr-2"></i>Users
        </button>
        <button onclick="showAdminSection('news')" class="admin-nav-item" id="admin-nav-news">
          <i class="fas fa-newspaper mr-2"></i>News
        </button>
        <button onclick="showAdminSection('support')" class="admin-nav-item" id="admin-nav-support">
          <i class="fas fa-headset mr-2"></i>Support
        </button>
        <button onclick="adminLogout()" class="admin-nav-item">
          <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </button>
      </div>

      <!-- Keys Section -->
      <div id="admin-keys-section" class="admin-section">
        <h2 class="text-xl font-semibold text-yellow-400 mb-4">
          <i class="fas fa-key mr-2"></i>Key Management
        </h2>

        <div class="myanmar-container p-4 mb-6">
          <h3 class="text-lg font-medium text-yellow-400 mb-3">Key အသစ် ဖန်တီးရန်</h3>
          <div class="space-y-3">
            <input type="text" id="new-key-text" placeholder="Key Text" class="myanmar-input w-full">
            <select id="new-key-duration-type" class="myanmar-input w-full">
              <option value="days">ရက်</option>
              <option value="weeks">ပတ်</option>
              <option value="months">လ</option>
            </select>
            <input type="number" id="new-key-duration-value" placeholder="Duration Value (e.g., 30)" class="myanmar-input w-full">
            <input type="number" id="new-key-max-devices" placeholder="Max Devices (e.g., 1)" class="myanmar-input w-full">
            <button onclick="createKey()" class="myanmar-btn w-full">
              <i class="fas fa-plus-circle mr-2"></i>Key ဖန်တီးရန်
            </button>
          </div>
        </div>

        <div class="myanmar-container p-4 mb-6">
          <h3 class="text-lg font-medium text-yellow-400 mb-3">Key သက်တမ်း တိုးမြှင့်ရန်</h3>
          <div class="space-y-3">
            <input type="text" id="extend-key-text" placeholder="Key Text" class="myanmar-input w-full">
            <input type="number" id="extend-key-days" placeholder="တိုးမြှင့်မည့် ရက် (e.g., 30)" class="myanmar-input w-full">
            <textarea id="extend-key-reason" placeholder="Reason (optional)" rows="2" class="myanmar-input w-full"></textarea>
            <button onclick="extendKey()" class="myanmar-btn w-full">
              <i class="fas fa-calendar-plus mr-2"></i>သက်တမ်း တိုးမြှင့်ရန်
            </button>
          </div>
        </div>

        <div class="myanmar-container p-4">
          <h3 class="text-lg font-medium text-yellow-400 mb-3">လက်ရှိ Keys များ</h3>
          <div id="keys-list" class="overflow-x-auto">
            <div class="loading-spinner mb-4"></div>
            <p class="text-center text-gray-400">Keys များ ရယူနေသည်...</p>
          </div>
        </div>
      </div>

      <!-- Users Section -->
      <div id="admin-users-section" class="admin-section hidden">
        <h2 class="text-xl font-semibold text-yellow-400 mb-4">
          <i class="fas fa-users mr-2"></i>User Management
        </h2>
        <div class="myanmar-container p-4">
          <h3 class="text-lg font-medium text-yellow-400 mb-3">အသုံးပြုသူများ</h3>
          <div id="users-list" class="overflow-x-auto">
            <div class="loading-spinner mb-4"></div>
            <p class="text-center text-gray-400">အသုံးပြုသူများ ရယူနေသည်...</p>
          </div>
        </div>
      </div>

      <!-- News Section (Admin Post) -->
      <div id="admin-news-section" class="admin-section hidden">
        <h2 class="text-xl font-semibold text-yellow-400 mb-4">
          <i class="fas fa-newspaper mr-2"></i>News Management
        </h2>
        <div class="myanmar-container p-4 mb-6">
          <h3 class="text-lg font-medium text-yellow-400 mb-3">သတင်း တင်ရန် (Admin)</h3>
          <div class="space-y-3">
            <input type="text" id="admin-news-title" placeholder="သတင်း ခေါင်းစဥ်" class="myanmar-input w-full">
            <textarea id="admin-news-content" placeholder="သတင်း အကြောင်းအရာ" rows="3" class="myanmar-input w-full"></textarea>
            <input type="text" id="admin-news-youtube" placeholder="YouTube လင့် (မလိုအပ်)" class="myanmar-input w-full">
            <input type="file" id="admin-news-image" accept="image/*,video/*" class="myanmar-input w-full">
            <button onclick="postAdminNews()" class="myanmar-btn w-full">
              <i class="fas fa-paper-plane mr-2"></i>
              သတင်း တင်ရန်
            </button>
          </div>
        </div>
        <div class="myanmar-container p-4">
          <h3 class="text-lg font-medium text-yellow-400 mb-3">တင်ပြီးသော သတင်းများ</h3>
          <div id="admin-news-list" class="space-y-4">
            <div class="loading-spinner mb-4"></div>
            <p class="text-center text-gray-400">သတင်းများ ရယူနေသည်...</p>
          </div>
        </div>
      </div>

      <!-- Support Section -->
      <div id="admin-support-section" class="admin-section hidden">
        <h2 class="text-xl font-semibold text-yellow-400 mb-4">
          <i class="fas fa-headset mr-2"></i>Support Messages
        </h2>
        <div class="myanmar-container p-4">
          <h3 class="text-lg font-medium text-yellow-400 mb-3">အသုံးပြုသူများ၏ မက်ဆေ့ချ်များ</h3>
          <div id="admin-support-list" class="space-y-4">
            <div class="loading-spinner mb-4"></div>
            <p class="text-center text-gray-400">မက်ဆေ့ချ်များ ရယူနေသည်...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script>
    // Configuration - ဒီနေရာမှာ သင့် Supabase credentials တွေကို ထည့်ပါ
    const CONFIG = {
      SUPABASE_URL: 'https://rliwdosxsbauwxkayjoa.supabase.co', // သင့် URL ကို ထည့်ပါ
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsaXdkb3N4c2JhdXd4a2F5am9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxMDA2NjIsImV4cCI6MjA2OTY3NjY2Mn0.uDvU9eX3Cy--D9l6daGaO2QMpn1YnxMJYVlbaeIgHu4', // သင့် Key ကို ထည့်ပါ
      ADMIN_KEY: 'Opper_FPS', // Admin Key ကို ဒီမှာ ထည့်ပါ
      MAX_RETRY_ATTEMPTS: 3,
      RETRY_DELAY: 2000,
      CONNECTION_TIMEOUT: 10000
    };

    // Global State
    let state = {
      supabase: null,
      isAdminLoggedIn: false,
      currentAdminSection: 'keys',
      adminNewsChannel: null,
      adminSupportChannel: null,
      adminUsersChannel: null,
      adminKeysChannel: null
    };

    // Utility Functions (re-used from index.html or simplified)
    const utils = {
      sanitizeInput(input) {
        if (typeof input !== 'string') return '';
        return input.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                   .replace(/[<>]/g, '')
                   .trim();
      },
      formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('my-MM', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      },
      formatTimeRemaining(expirationDate) {
        const now = new Date();
        const timeLeft = new Date(expirationDate) - now;
        
        if (timeLeft <= 0) return 'သက်တမ်း ကုန်ဆုံးပြီ';
        
        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        
        return `${days} ရက် ${hours} နာရီ ${minutes} မိနစ်`;
      }
    };

    // UI Management
    const ui = {
      updateStatus(status, message) {
        const indicator = document.getElementById('status-indicator');
        indicator.className = `status-indicator status-${status}`;
        const icons = {
          connected: 'fas fa-check-circle',
          connecting: 'fas fa-circle-notch fa-spin',
          error: 'fas fa-exclamation-triangle'
        };
        const messages = {
          connected: 'ချိတ်ဆက်ပြီး',
          connecting: 'ချိတ်ဆက်နေသည်...',
          error: 'ချိတ်ဆက်မှု အမှား'
        };
        indicator.innerHTML = `<i class="${icons[status]}"></i> ${message || messages[status]}`;
      },
      showNotification(message, type = 'info', duration = 5000) {
        const container = document.getElementById('notifications-container');
        const notification = document.createElement('div');
        
        const bgColors = {
          success: 'bg-green-600',
          error: 'bg-red-600',
          info: 'bg-blue-600',
          warning: 'bg-yellow-600'
        };
        
        const icons = {
          success: 'fa-check-circle',
          error: 'fa-exclamation-triangle',
          info: 'fa-info-circle',
          warning: 'fa-exclamation-circle'
        };
        
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <i class="fas ${icons[type]} mr-2"></i>
              <span>${message}</span>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 hover:text-gray-200">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
        
        container.appendChild(notification);
        
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, duration);
      },
      showLoading(element, show = true) {
        if (show) {
          element.innerHTML = `
            <div class="loading-spinner mb-4"></div>
            <p class="text-center text-gray-400">Loading...</p>
          `;
        }
      },
      updateAdminNavigationActive(section) {
        document.querySelectorAll('.admin-nav-item').forEach(nav => {
          nav.classList.remove('active');
        });
        const activeNav = document.getElementById(`admin-nav-${section}`);
        if (activeNav) {
          activeNav.classList.add('active');
        }
      }
    };

    // Database Connection Management
    const database = {
      async initialize() {
        ui.updateStatus('connecting', 'စတင်နေသည်...');
        try {
          if (!CONFIG.SUPABASE_URL || CONFIG.SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE') {
            throw new Error('ကျေးဇူးပြု၍ CONFIG အပိုင်းတွင် သင့် Supabase URL ကို ချိန်ညှိပါ');
          }
          if (!CONFIG.SUPABASE_ANON_KEY || CONFIG.SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
            throw new Error('ကျေးဇူးပြု၍ CONFIG အပိုင်းတွင် သင့် Supabase Anon Key ကို ချိန်ညှိပါ');
          }

          state.supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
            auth: { persistSession: false },
            realtime: { params: { eventsPerSecond: 10 } }
          });

          const { data, error } = await state.supabase.from('about').select('id').limit(1);
          if (error && error.code !== 'PGRST116') {
            throw new Error(`Database connection failed: ${error.message}`);
          }

          ui.updateStatus('connected', 'ချိတ်ဆက်ပြီး');
          ui.showNotification('Database သို့ အောင်မြင်စွာ ချိတ်ဆက်ပြီး! အက်ဒမင် ဝင်ရောက်ရန် အသင့်ဖြစ်ပါတယ်။', 'success');
          
          // Check if admin is already logged in (e.g., from session storage)
          if (sessionStorage.getItem('admin_logged_in') === 'true') {
            state.isAdminLoggedIn = true;
            document.getElementById('admin-login-section').classList.add('hidden');
            document.getElementById('admin-main-content').classList.remove('hidden');
            showAdminSection(state.currentAdminSection); // Load default section
            realtime.subscribeToAdminChannels();
          }
        } catch (error) {
          console.error('Database initialization error:', error);
          ui.updateStatus('error', 'ချိတ်ဆက်မှု အမှား');
          ui.showNotification(`Connection failed: ${error.message}`, 'error');
          if (state.reconnectAttempts < CONFIG.MAX_RETRY_ATTEMPTS) {
            state.reconnectAttempts++;
            setTimeout(() => {
              console.log(`Retrying connection (${state.reconnectAttempts}/${CONFIG.MAX_RETRY_ATTEMPTS})...`);
              this.initialize();
            }, CONFIG.RETRY_DELAY);
          }
        }
      }
    };

    // Admin Authentication
    async function adminLogin() {
      const adminKeyInput = document.getElementById('admin-key-input');
      const adminLoginBtn = document.getElementById('admin-login-btn');
      const adminLoginText = document.getElementById('admin-login-text');
      
      const enteredKey = utils.sanitizeInput(adminKeyInput.value);

      if (enteredKey === CONFIG.ADMIN_KEY) {
        state.isAdminLoggedIn = true;
        sessionStorage.setItem('admin_logged_in', 'true');
        document.getElementById('admin-login-section').classList.add('hidden');
        document.getElementById('admin-main-content').classList.remove('hidden');
        ui.showNotification('Admin ဝင်ရောက်မှု အောင်မြင်ပါသည်!', 'success');
        showAdminSection('keys'); // Default to keys section after login
        realtime.subscribeToAdminChannels();
      } else {
        ui.showNotification('Admin Key မမှန်ကန်ပါ', 'error');
      }
      adminKeyInput.value = '';
    }

    function adminLogout() {
      if (confirm('Admin Panel မှ ထွက်ရန် သေချာပါသလား?')) {
        state.isAdminLoggedIn = false;
        sessionStorage.removeItem('admin_logged_in');
        document.getElementById('admin-main-content').classList.add('hidden');
        document.getElementById('admin-login-section').classList.remove('hidden');
        ui.showNotification('Admin Panel မှ ထွက်ပြီးပါပြီ', 'info');
        realtime.unsubscribeFromAdminChannels();
      }
    }

    // Admin Section Management
    function showAdminSection(section) {
      document.querySelectorAll('.admin-section').forEach(el => {
        el.classList.add('hidden');
      });
      document.getElementById(`admin-${section}-section`).classList.remove('hidden');
      ui.updateAdminNavigationActive(section);
      state.currentAdminSection = section;

      // Load data for the selected section
      switch (section) {
        case 'keys':
          loadKeys();
          break;
        case 'users':
          loadUsers();
          break;
        case 'news':
          loadAdminNews();
          break;
        case 'support':
          loadAdminSupportMessages();
          break;
      }
    }

    // Key Management
    async function createKey() {
      const keyText = utils.sanitizeInput(document.getElementById('new-key-text').value);
      const durationType = document.getElementById('new-key-duration-type').value;
      const durationValue = parseInt(document.getElementById('new-key-duration-value').value);
      const maxDevices = parseInt(document.getElementById('new-key-max-devices').value);

      if (!keyText || !durationType || isNaN(durationValue) || isNaN(maxDevices)) {
        ui.showNotification('ကျေးဇူးပြု၍ အချက်အလက် အားလုံး ဖြည့်ပါ', 'error');
        return;
      }

      try {
        ui.showNotification('Key ဖန်တီးနေသည်...', 'info');
        const expiresAt = new Date();
        if (durationType === 'days') expiresAt.setDate(expiresAt.getDate() + durationValue);
        else if (durationType === 'weeks') expiresAt.setDate(expiresAt.getDate() + (durationValue * 7));
        else if (durationType === 'months') expiresAt.setMonth(expiresAt.getMonth() + durationValue);

        const { data, error } = await state.supabase
          .from('keys')
          .insert({
            key_text: keyText,
            expires_at: expiresAt.toISOString(),
            duration_type: durationType,
            duration_value: durationValue,
            max_devices: maxDevices,
            is_active: true,
            created_by_admin: true
          })
          .select()
          .single();

        if (error) {
          if (error.code === '23505') { // Unique violation
            throw new Error('ဤ Key Text ရှိနေပြီးပါပြီ');
          }
          throw error;
        }

        ui.showNotification('Key အောင်မြင်စွာ ဖန်တီးပြီးပါပြီ!', 'success');
        document.getElementById('new-key-text').value = '';
        document.getElementById('new-key-duration-value').value = '';
        document.getElementById('new-key-max-devices').value = '';
        loadKeys(); // Reload keys list
      } catch (error) {
        console.error('Error creating key:', error);
        ui.showNotification(`Key ဖန်တီးရာတွင် အမှားဖြစ်ပေါ်ခဲ့သည်: ${error.message}`, 'error');
      }
    }

    async function extendKey() {
      const keyText = utils.sanitizeInput(document.getElementById('extend-key-text').value);
      const extendDays = parseInt(document.getElementById('extend-key-days').value);
      const reason = utils.sanitizeInput(document.getElementById('extend-key-reason').value);

      if (!keyText || isNaN(extendDays) || extendDays <= 0) {
        ui.showNotification('ကျေးဇူးပြု၍ Key Text နှင့် တိုးမြှင့်မည့် ရက်ကို မှန်ကန်စွာ ဖြည့်ပါ', 'error');
        return;
      }

      try {
        ui.showNotification('Key သက်တမ်း တိုးမြှင့်နေသည်...', 'info');
        const { data, error } = await state.supabase.rpc('extend_key_expiration', {
          input_key_text: keyText,
          extend_days: extendDays,
          admin_reason: reason || null
        });

        if (error) throw error;
        if (!data.success) throw new Error(data.message);

        ui.showNotification(`Key သက်တမ်း အောင်မြင်စွာ တိုးမြှင့်ပြီးပါပြီ! New Expiry: ${utils.formatDate(data.new_expiry)}`, 'success');
        document.getElementById('extend-key-text').value = '';
        document.getElementById('extend-key-days').value = '';
        document.getElementById('extend-key-reason').value = '';
        loadKeys(); // Reload keys list
      } catch (error) {
        console.error('Error extending key:', error);
        ui.showNotification(`Key သက်တမ်း တိုးမြှင့်ရာတွင် အမှားဖြစ်ပေါ်ခဲ့သည်: ${error.message}`, 'error');
      }
    }

    async function loadKeys() {
      const keysList = document.getElementById('keys-list');
      ui.showLoading(keysList);
      try {
        const { data: keys, error } = await state.supabase
          .from('keys')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (!keys || keys.length === 0) {
          keysList.innerHTML = '<p class="text-center text-gray-400">Keys များ မရှိသေးပါ</p>';
          return;
        }

        keysList.innerHTML = `
          <table class="min-w-full bg-black bg-opacity-30 rounded-lg overflow-hidden text-sm">
            <thead>
              <tr class="bg-gray-700 text-yellow-400">
                <th class="py-2 px-4 text-left">Key Text</th>
                <th class="py-2 px-4 text-left">သက်တမ်းကုန်ဆုံးရက်</th>
                <th class="py-2 px-4 text-left">Max Devices</th>
                <th class="py-2 px-4 text-left">Active</th>
                <th class="py-2 px-4 text-left">ကျန်ရှိချိန်</th>
              </tr>
            </thead>
            <tbody>
              ${keys.map(key => `
                <tr class="border-b border-gray-600 last:border-b-0">
                  <td class="py-2 px-4">${key.key_text}</td>
                  <td class="py-2 px-4">${utils.formatDate(key.expires_at)}</td>
                  <td class="py-2 px-4">${key.max_devices}</td>
                  <td class="py-2 px-4">
                    <span class="${key.is_active ? 'text-green-400' : 'text-red-400'}">
                      ${key.is_active ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>'}
                    </span>
                  </td>
                  <td class="py-2 px-4">${utils.formatTimeRemaining(key.expires_at)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        console.error('Error loading keys:', error);
        keysList.innerHTML = `<p class="text-center text-red-400">Keys များ ရယူ၍ မရပါ: ${error.message}</p>`;
      }
    }

    // User Management
    async function loadUsers() {
      const usersList = document.getElementById('users-list');
      ui.showLoading(usersList);
      try {
        const { data: profiles, error } = await state.supabase
          .from('profiles')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (!profiles || profiles.length === 0) {
          usersList.innerHTML = '<p class="text-center text-gray-400">အသုံးပြုသူများ မရှိသေးပါ</p>';
          return;
        }

        usersList.innerHTML = `
          <table class="min-w-full bg-black bg-opacity-30 rounded-lg overflow-hidden text-sm">
            <thead>
              <tr class="bg-gray-700 text-yellow-400">
                <th class="py-2 px-4 text-left">Profile</th>
                <th class="py-2 px-4 text-left">Username</th>
                <th class="py-2 px-4 text-left">Name</th>
                <th class="py-2 px-4 text-left">Banned</th>
                <th class="py-2 px-4 text-left">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${profiles.map(profile => `
                <tr class="border-b border-gray-600 last:border-b-0">
                  <td class="py-2 px-4">
                    ${profile.profile_picture ? 
                      `<img src="${profile.profile_picture}" class="w-8 h-8 rounded-full inline-block mr-2">` :
                      `<div class="w-8 h-8 rounded-full bg-yellow-400 flex items-center justify-center text-black font-bold text-xs inline-block mr-2">${profile.name.charAt(0)}</div>`
                    }
                  </td>
                  <td class="py-2 px-4">${profile.username}</td>
                  <td class="py-2 px-4">${profile.name}</td>
                  <td class="py-2 px-4">
                    <span class="${profile.is_banned ? 'text-red-400' : 'text-green-400'}">
                      ${profile.is_banned ? '<i class="fas fa-ban"></i>' : '<i class="fas fa-check-circle"></i>'}
                    </span>
                  </td>
                  <td class="py-2 px-4">
                    <button onclick="toggleUserBan('${profile.id}', ${!profile.is_banned})" 
                            class="myanmar-btn px-3 py-1 text-xs ${profile.is_banned ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}">
                      ${profile.is_banned ? 'Unban' : 'Ban'}
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        console.error('Error loading users:', error);
        usersList.innerHTML = `<p class="text-center text-red-400">အသုံးပြုသူများ ရယူ၍ မရပါ: ${error.message}</p>`;
      }
    }

    async function toggleUserBan(profileId, banStatus) {
      const reason = banStatus ? prompt('Ban Reason (optional):') : null;
      try {
        ui.showNotification(banStatus ? 'အသုံးပြုသူကို Ban နေသည်...' : 'အသုံးပြုသူကို Unban နေသည်...', 'info');
        const { data, error } = await state.supabase.rpc('toggle_user_ban', {
          profile_id_param: profileId,
          ban_status: banStatus,
          ban_reason_param: reason
        });

        if (error) throw error;
        if (!data.success) throw new Error(data.message);

        ui.showNotification(data.message, 'success');
        loadUsers(); // Reload users list
      } catch (error) {
        console.error('Error toggling user ban:', error);
        ui.showNotification(`အသုံးပြုသူကို Ban/Unban လုပ်ရာတွင် အမှားဖြစ်ပေါ်ခဲ့သည်: ${error.message}`, 'error');
      }
    }

    // News Management (Admin)
    async function postAdminNews() {
      const title = utils.sanitizeInput(document.getElementById('admin-news-title').value);
      const content = utils.sanitizeInput(document.getElementById('admin-news-content').value);
      const youtubeLink = utils.sanitizeInput(document.getElementById('admin-news-youtube').value);
      const imageFile = document.getElementById('admin-news-image').files[0];
      
      if (!title || !content) {
        ui.showNotification('ကျေးဇူးပြု၍ ခေါင်းစဉ် နှင့် အကြောင်းအရာ ကို ရိုက်ထည့်ပါ', 'error');
        return;
      }
      
      try {
        ui.showNotification('သတင်း တင်နေသည်...', 'info');
        
        let mediaUrl = null;
        let videoUrl = null;
        
        if (imageFile) {
          const fileExt = imageFile.name.split('.').pop();
          const fileName = `admin_news_${Date.now()}.${fileExt}`;
          
          const { data: uploadData, error: uploadError } = await state.supabase.storage
            .from('news')
            .upload(fileName, imageFile);
            
          if (uploadError) throw uploadError;
          
          const { data: urlData } = state.supabase.storage
            .from('news')
            .getPublicUrl(fileName);
            
          if (imageFile.type.startsWith('video/')) {
            videoUrl = urlData.publicUrl;
          } else {
            mediaUrl = urlData.publicUrl;
          }
        }
        
        // Post news as admin
        const { data: news, error } = await state.supabase
          .from('news')
          .insert({
            title: title,
            content: content,
            youtube_link: youtubeLink || null,
            video_url: videoUrl,
            image_url: mediaUrl,
            profile_id: null, // Admin posts don't need a profile_id
            is_admin: true,
            admin_posted: true
          })
          .select()
          .single();
          
        if (error) throw error;
        
        // Clear form
        document.getElementById('admin-news-title').value = '';
        document.getElementById('admin-news-content').value = '';
        document.getElementById('admin-news-youtube').value = '';
        document.getElementById('admin-news-image').value = '';
        
        ui.showNotification('သတင်း ကို အောင်မြင်စွာ တင်ပြီးပါပြီ!', 'success');
        
        loadAdminNews(); // Reload news list
        
      } catch (error) {
        console.error('Admin news posting error:', error);
        ui.showNotification('သတင်း တင်ရာတွင် အမှားဖြစ်ပေါ်ခဲ့သည်', 'error');
      }
    }

    async function loadAdminNews() {
      const newsList = document.getElementById('admin-news-list');
      ui.showLoading(newsList);
      try {
        const { data: news, error } = await state.supabase
          .from('news')
          .select(`
            *,
            profiles(username, name, profile_picture)
          `)
          .order('created_at', { ascending: false })
          .limit(20);
        
        if (error) throw error;
        
        if (!news || news.length === 0) {
          newsList.innerHTML = '<p class="text-center text-gray-400">သတင်းများ မရှိသေးပါ</p>';
          return;
        }
        
        newsList.innerHTML = news.map(item => `
          <div class="news-card p-4 mb-4">
            <div class="flex items-center space-x-3 mb-3">
              ${item.profiles?.profile_picture ? 
                `<img src="${item.profiles.profile_picture}" class="profile-avatar">` :
                `<div class="profile-avatar bg-yellow-400 flex items-center justify-center text-black font-bold">${item.profiles?.name?.charAt(0) || 'A'}</div>`
              }
              <div>
                <h4 class="text-yellow-400 font-medium">${item.profiles?.name || 'Admin'}</h4>
                <p class="text-gray-400 text-xs">@${item.profiles?.username || 'admin'}</p>
              </div>
              ${item.is_admin ? '<span class="bg-red-500 text-white px-2 py-1 rounded text-xs">Admin</span>' : ''}
            </div>
            
            <h3 class="text-lg font-semibold text-white mb-2">${item.title}</h3>
            <p class="text-gray-300 mb-3">${item.content.substring(0, 150)}${item.content.length > 150 ? '...' : ''}</p>
            
            ${item.image_url ? `<img src="${item.image_url}" class="w-full rounded-lg mb-3" alt="News image">` : ''}
            
            ${item.video_url ? `
              <div class="video-container mb-3">
                <video controls playsinline webkit-playsinline class="w-full rounded-lg">
                  <source src="${item.video_url}" type="video/mp4">
                </video>
              </div>
            ` : ''}
            
            ${item.youtube_link ? `
              <div class="mb-3">
                <a href="${item.youtube_link}" target="_blank" class="myanmar-btn inline-flex items-center">
                  <i class="fab fa-youtube mr-2"></i>
                  YouTube မှာ ကြည့်ရန်
                </a>
              </div>
            ` : ''}
            
            <div class="flex items-center justify-between text-sm text-gray-400">
              <div class="flex items-center space-x-4">
                <span class="flex items-center space-x-1">
                  <i class="fas fa-heart"></i>
                  <span>${item.likes || 0}</span>
                </span>
                <span class="flex items-center space-x-1">
                  <i class="fas fa-eye"></i>
                  <span>${item.views || 0}</span>
                </span>
              </div>
              <span>${utils.formatDate(item.created_at)}</span>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading admin news:', error);
        newsList.innerHTML = `<p class="text-center text-red-400">သတင်းများ ရယူ၍ မရပါ: ${error.message}</p>`;
      }
    }

    // Support Management (Admin)
    async function loadAdminSupportMessages() {
      const messagesContainer = document.getElementById('admin-support-list');
      ui.showLoading(messagesContainer);
      try {
        const { data: messages, error } = await state.supabase
          .from('support_messages')
          .select(`
            *,
            profiles(username, name)
          `)
          .order('created_at', { ascending: true })
          .limit(50);
        
        if (error) throw error;
        
        if (!messages || messages.length === 0) {
          messagesContainer.innerHTML = `
            <div class="text-center text-gray-400">
              <i class="fas fa-headset text-2xl mb-2"></i>
              <p>အကူအညီ မက်ဆေ့ချ်များ မရှိသေးပါ</p>
            </div>
          `;
          return;
        }
        
        messagesContainer.innerHTML = messages.map(message => `
          <div class="chat-message ${message.is_from_user ? 'received' : 'sent'}">
            <div class="flex items-center space-x-2 mb-1">
              ${message.is_from_user ? 
                `<i class="fas fa-user-circle text-yellow-400"></i> <span class="text-xs font-medium">${message.profiles?.name || 'User'} (@${message.profiles?.username || 'N/A'})</span>` :
                '<i class="fas fa-headset text-green-400"></i> <span class="text-xs font-medium">Admin</span>'
              }
            </div>
            <p class="mb-1">${message.content}</p>
            <p class="text-xs opacity-70">${utils.formatDate(message.created_at)}</p>
            ${!message.is_from_user ? '' : `
              <div class="mt-2">
                <textarea id="reply-input-${message.id}" placeholder="Admin Reply..." rows="1" class="myanmar-input w-full resize-none"></textarea>
                <button onclick="sendAdminReply('${message.id}')" class="myanmar-btn px-3 py-1 text-xs mt-1">
                  <i class="fas fa-reply mr-1"></i> Reply
                </button>
              </div>
            `}
          </div>
        `).join('');
        
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      } catch (error) {
        console.error('Error loading admin support messages:', error);
        messagesContainer.innerHTML = `<p class="text-center text-red-400">မက်ဆေ့ချ်များ ရယူ၍ မရပါ: ${error.message}</p>`;
      }
    }

    async function sendAdminReply(replyToMessageId) {
      const input = document.getElementById(`reply-input-${replyToMessageId}`);
      const message = utils.sanitizeInput(input.value);
      
      if (!message.trim()) {
        ui.showNotification('ကျေးဇူးပြု၍ မက်ဆေ့ချ် ရေးပါ', 'error');
        return;
      }
      
      try {
        // Get the original message to find the profile_id
        const { data: originalMessage, error: originalError } = await state.supabase
          .from('support_messages')
          .select('profile_id, session_id')
          .eq('id', replyToMessageId)
          .single();

        if (originalError || !originalMessage) throw new Error('Original message not found.');

        const { error } = await state.supabase
          .from('support_messages')
          .insert({
            profile_id: originalMessage.profile_id,
            session_id: originalMessage.session_id,
            content: message,
            is_from_user: false, // This is an admin reply
            reply_to: replyToMessageId,
            admin_reply: true
          });
          
        if (error) throw error;
        
        input.value = '';
        ui.showNotification('Admin Reply ပို့ပြီးပါပြီ', 'success');
        loadAdminSupportMessages(); // Reload messages
      } catch (error) {
        console.error('Error sending admin reply:', error);
        ui.showNotification('Admin Reply ပို့ရာတွင် အမှားဖြစ်ပေါ်ခဲ့သည်', 'error');
      }
    }

    // Realtime Management for Admin Panel
    const realtime = {
      subscribeToAdminChannels() {
        if (!state.supabase || !state.isAdminLoggedIn) return;

        // Keys Channel
        if (!state.adminKeysChannel) {
          state.adminKeysChannel = state.supabase.channel('admin_keys_changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'keys' }, payload => {
              console.log('Admin Keys change received!', payload);
              if (state.currentAdminSection === 'keys') {
                loadKeys();
              }
            })
            .subscribe();
        }

        // Users Channel
        if (!state.adminUsersChannel) {
          state.adminUsersChannel = state.supabase.channel('admin_profiles_changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, payload => {
              console.log('Admin Profiles change received!', payload);
              if (state.currentAdminSection === 'users') {
                loadUsers();
              }
            })
            .subscribe();
        }

        // News Channel
        if (!state.adminNewsChannel) {
          state.adminNewsChannel = state.supabase.channel('admin_news_changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'news' }, payload => {
              console.log('Admin News change received!', payload);
              if (state.currentAdminSection === 'news') {
                loadAdminNews();
              }
            })
            .subscribe();
        }

        // Support Messages Channel
        if (!state.adminSupportChannel) {
          state.adminSupportChannel = state.supabase.channel('admin_support_messages_changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'support_messages' }, payload => {
              console.log('Admin Support message change received!', payload);
              if (state.currentAdminSection === 'support') {
                loadAdminSupportMessages();
              }
            })
            .subscribe();
        }
      },

      unsubscribeFromAdminChannels() {
        if (state.supabase) {
          if (state.adminKeysChannel) {
            state.supabase.removeChannel(state.adminKeysChannel);
            state.adminKeysChannel = null;
          }
          if (state.adminUsersChannel) {
            state.supabase.removeChannel(state.adminUsersChannel);
            state.adminUsersChannel = null;
          }
          if (state.adminNewsChannel) {
            state.supabase.removeChannel(state.adminNewsChannel);
            state.adminNewsChannel = null;
          }
          if (state.adminSupportChannel) {
            state.supabase.removeChannel(state.adminSupportChannel);
            state.adminSupportChannel = null;
          }
        }
      }
    };

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      database.initialize();
    });

    // Global functions for HTML onclick events
    window.adminLogin = adminLogin;
    window.adminLogout = adminLogout;
    window.showAdminSection = showAdminSection;
    window.createKey = createKey;
    window.extendKey = extendKey;
    window.toggleUserBan = toggleUserBan;
    window.postAdminNews = postAdminNews;
    window.sendAdminReply = sendAdminReply;
  </script>
</body>
</html>
