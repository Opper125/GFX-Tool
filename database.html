<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPS GFX Tool - Complete Database SQL Setup</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Myanmar:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-dark.min.css">
    <style>
        * {
            font-family: 'Noto Sans Myanmar', 'Inter', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
        }
        
        .sql-container {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(254, 203, 0, 0.2);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        }
        
        .copy-btn {
            background: linear-gradient(45deg, #FECB00, #34B233);
            color: #000;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(254, 203, 0, 0.4);
        }
        
        .sql-code {
            background: #1e293b;
            color: #e2e8f0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            border-radius: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .keyword { color: #60a5fa; }
        .string { color: #34d399; }
        .comment { color: #9ca3af; }
        .function { color: #fbbf24; }
        
        @media (max-width: 768px) {
            .sql-code {
                font-size: 12px;
            }
        }

        @media print {
            body {
                background: white !important;
                color: black !important;
            }
            .sql-container {
                background: white !important;
                border: 1px solid #ccc !important;
                box-shadow: none !important;
            }
            .sql-code {
                background: #f8f9fa !important;
                color: black !important;
                border: 1px solid #dee2e6 !important;
            }
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold mb-4 text-yellow-400">
                <i class="fas fa-database mr-3"></i>
                FPS GFX Tool Database
            </h1>
            <p class="text-xl text-gray-300 mb-6">Complete SQL Script for Supabase Integration</p>
            <div class="flex flex-wrap justify-center gap-4">
                <button onclick="copyAllSQL()" class="copy-btn px-6 py-3 rounded-lg font-bold transition-all">
                    <i class="fas fa-copy mr-2"></i>
                    Copy Complete SQL
                </button>
                <button onclick="downloadSQL()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-bold transition-all">
                    <i class="fas fa-download mr-2"></i>
                    Download SQL File
                </button>
            </div>
        </div>

        <!-- Instructions -->
        <div class="sql-container rounded-2xl p-6 mb-8">
            <h2 class="text-2xl font-bold text-yellow-400 mb-4">
                <i class="fas fa-info-circle mr-2"></i>
                Setup Instructions (·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äï·ÄØ·Ä∂)
            </h2>
            <div class="bg-gray-800 rounded-lg p-4 mb-4">
                <h3 class="text-lg font-semibold text-green-400 mb-3">
                    <i class="fas fa-list-ol mr-2"></i>
                    Step by Step Guide:
                </h3>
                <ol class="text-gray-300 space-y-2 list-decimal list-inside">
                    <li>Create a new Supabase project at <span class="text-blue-400">supabase.com</span></li>
                    <li>Go to SQL Editor in your Supabase dashboard</li>
                    <li>Copy the complete SQL script below</li>
                    <li>Paste and run the SQL script in Supabase</li>
                    <li>Update the CONFIG section in both index.html and admin.html with your:
                        <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                            <li>SUPABASE_URL (Your project URL)</li>
                            <li>SUPABASE_ANON_KEY (Your anon/public key)</li>
                        </ul>
                    </li>
                    <li>Deploy both HTML files to Netlify or any hosting service</li>
                    <li>Your FPS GFX Tool is ready to use!</li>
                </ol>
            </div>
            
            <div class="bg-yellow-900 bg-opacity-50 border border-yellow-600 rounded-lg p-4">
                <h4 class="font-bold text-yellow-400 mb-2">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Important Notes:
                </h4>
                <ul class="text-yellow-200 space-y-1 list-disc list-inside">
                    <li>This SQL creates all necessary tables, policies, and functions</li>
                    <li>Includes complete Row Level Security (RLS) setup</li>
                    <li>Realtime features are enabled for all tables</li>
                    <li>Storage buckets for profile pictures and news images</li>
                    <li>Fixed device-based session management</li>
                    <li>Persistent login support</li>
                    <li>Admin news management with delete functionality</li>
                </ul>
            </div>
        </div>

        <!-- SQL Script -->
        <div class="sql-container rounded-2xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-yellow-400">
                    <i class="fas fa-code mr-2"></i>
                    Complete SQL Script
                </h2>
                <button onclick="copyAllSQL()" class="copy-btn px-4 py-2 rounded-lg font-bold text-sm">
                    <i class="fas fa-copy mr-1"></i>
                    Copy
                </button>
            </div>
            
            <div class="sql-code p-6" id="sql-content">
                <pre><code>-- ================================
-- FPS GFX TOOL DATABASE SETUP - COMPLETE VERSION
-- ·Ä°·Äï·Äº·Ää·Ä∑·Ä∫·Ä°·Äù Myanmar Gaming Tool ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ Database Setup
-- Fixed: Session management, Device tracking, Persistent login
-- ================================

-- Enable necessary extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp" WITH SCHEMA extensions;

-- ================================
-- 1. ABOUT TABLE (·ÄÜ·ÄÄ·Ä∫·Äû·ÄΩ·Äö·Ä∫·Äõ·Äî·Ä∫ ·Ä°·ÄÅ·Äª·ÄÄ·Ä∫·Ä°·Äú·ÄÄ·Ä∫·Äô·Äª·Ä¨·Ä∏)
-- ================================
CREATE TABLE IF NOT EXISTS about (
    id TEXT PRIMARY KEY DEFAULT 'main',
    telegram TEXT,
    viber TEXT,
    phone TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Insert default about data
INSERT INTO about (id, telegram, viber, phone) 
VALUES ('main', 'https://t.me/fpsgfxtool', 'viber://chat?number=+959123456789', '+959123456789')
ON CONFLICT (id) DO UPDATE SET
    telegram = EXCLUDED.telegram,
    viber = EXCLUDED.viber,
    phone = EXCLUDED.phone,
    updated_at = NOW();

-- ================================
-- 2. DEVICES TABLE (·ÄÄ·Ä≠·Äõ·Ä≠·Äö·Ä¨·Äô·Äª·Ä¨·Ä∏)
-- ================================
CREATE TABLE IF NOT EXISTS devices (
    id TEXT PRIMARY KEY,
    user_agent TEXT NOT NULL,
    architecture TEXT,
    android_version TEXT,
    model TEXT,
    ip_address TEXT,
    browser_info TEXT,
    first_seen TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_seen TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ================================
-- 3. KEYS TABLE (Access Keys ·Äô·Äª·Ä¨·Ä∏)
-- ================================
CREATE TABLE IF NOT EXISTS keys (
    id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
    key_text TEXT UNIQUE NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    duration_type TEXT NOT NULL CHECK (duration_type IN ('days', 'weeks', 'months')),
    duration_value INTEGER NOT NULL,
    max_devices INTEGER NOT NULL DEFAULT 1,
    is_active BOOLEAN DEFAULT TRUE,
    created_by_admin BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Insert sample keys
INSERT INTO keys (key_text, expires_at, duration_type, duration_value, max_devices, is_active)
VALUES 
    ('Opper_FPS', NOW() + INTERVAL '365 days', 'days', 365, 100, TRUE),
    ('DEMO123', NOW() + INTERVAL '30 days', 'days', 30, 2, TRUE),
    ('TRIAL456', NOW() + INTERVAL '7 days', 'days', 7, 1, TRUE),
    ('VIP2024', NOW() + INTERVAL '90 days', 'days', 90, 5, TRUE)
ON CONFLICT (key_text) DO UPDATE SET
    expires_at = EXCLUDED.expires_at,
    max_devices = EXCLUDED.max_devices,
    updated_at = NOW();

-- ================================
-- 4. SESSIONS TABLE (Session ·Äô·Äª·Ä¨·Ä∏)
-- ================================
CREATE TABLE IF NOT EXISTS sessions (
    id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
    key_id UUID NOT NULL REFERENCES keys(id) ON DELETE CASCADE,
    device_id TEXT NOT NULL REFERENCES devices(id) ON DELETE CASCADE,
    is_active BOOLEAN DEFAULT TRUE,
    last_activity TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    login_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    logout_time TIMESTAMP WITH TIME ZONE,
    session_data JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(key_id, device_id)
);

-- ================================
-- 5. PROFILES TABLE (·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äû·Ä∞·Äô·Äª·Ä¨·Ä∏·Åè Profile ·Äô·Äª·Ä¨·Ä∏)
-- ================================
CREATE TABLE IF NOT EXISTS profiles (
    id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
    key_id UUID NOT NULL REFERENCES keys(id) ON DELETE CASCADE,
    session_id UUID REFERENCES sessions(id) ON DELETE SET NULL,
    username TEXT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    profile_picture TEXT,
    bio TEXT,
    is_banned BOOLEAN DEFAULT FALSE,
    is_verified BOOLEAN DEFAULT FALSE,
    ban_reason TEXT,
    banned_at TIMESTAMP WITH TIME ZONE,
    last_active TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ================================
-- 6. GENERATED FILES TABLE (·Äñ·Äî·Ä∫·Äê·ÄÆ·Ä∏·Äë·Ä¨·Ä∏·Äû·Ä±·Ä¨ Files ·Äô·Äª·Ä¨·Ä∏)
-- ================================
CREATE TABLE IF NOT EXISTS generated_files (
    id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
    session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    profile_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    game_version TEXT NOT NULL,
    fps INTEGER NOT NULL,
    bit_type TEXT NOT NULL,
    ipad_view BOOLEAN DEFAULT FALSE,
    dpi INTEGER,
    resolution TEXT,
    file_path TEXT NOT NULL,
    file_size BIGINT DEFAULT 0,
    download_count INTEGER DEFAULT 0,
    is_public BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ================================
-- 7. NEWS TABLE (·Äû·Äê·ÄÑ·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏)
-- ================================
CREATE TABLE IF NOT EXISTS news (
    id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    youtube_link TEXT,
    video_url TEXT,
    image_url TEXT,
    profile_id UUID REFERENCES profiles(id) ON DELETE SET NULL,
    is_admin BOOLEAN DEFAULT FALSE,
    admin_posted BOOLEAN DEFAULT FALSE,
    views INTEGER DEFAULT 0,
    likes INTEGER DEFAULT 0,
    comments_count INTEGER DEFAULT 0,
    is_featured BOOLEAN DEFAULT FALSE,
    is_published BOOLEAN DEFAULT TRUE,
    published_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ================================
-- 8. COMMENTS TABLE (·Äô·Äæ·Äê·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫·Äô·Äª·Ä¨·Ä∏)
-- ================================
CREATE TABLE IF NOT EXISTS comments (
    id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
    news_id UUID NOT NULL REFERENCES news(id) ON DELETE CASCADE,
    profile_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    parent_id UUID REFERENCES comments(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    likes INTEGER DEFAULT 0,
    is_edited BOOLEAN DEFAULT FALSE,
    edited_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    CONSTRAINT content_not_empty CHECK (LENGTH(TRIM(content)) > 0)
);

-- ================================
-- 9. LIKES TABLE (Like ·Äô·Äª·Ä¨·Ä∏)
-- ================================
CREATE TABLE IF NOT EXISTS likes (
    id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
    profile_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    news_id UUID REFERENCES news(id) ON DELETE CASCADE,
    comment_id UUID REFERENCES comments(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(profile_id, news_id),
    UNIQUE(profile_id, comment_id),
    CHECK ((news_id IS NOT NULL AND comment_id IS NULL) OR (news_id IS NULL AND comment_id IS NOT NULL))
);

-- ================================
-- 10. CHAT CONVERSATIONS TABLE (·ÄÖ·ÄÄ·Ä¨·Ä∏·Äï·Äº·Ä±·Ä¨·ÄÅ·Äî·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏)
-- ================================
CREATE TABLE IF NOT EXISTS chat_conversations (
    id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
    participant1_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    participant2_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    last_message_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(participant1_id, participant2_id),
    CHECK (participant1_id != participant2_id)
);

-- ================================
-- 11. CHAT MESSAGES TABLE (·ÄÖ·ÄÄ·Ä¨·Ä∏·Äï·Äº·Ä±·Ä¨·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏)
-- ================================
CREATE TABLE IF NOT EXISTS chat_messages (
    id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
    conversation_id UUID NOT NULL REFERENCES chat_conversations(id) ON DELETE CASCADE,
    sender_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    is_read BOOLEAN DEFAULT FALSE,
    message_type TEXT DEFAULT 'text' CHECK (message_type IN ('text', 'image', 'file', 'video')),
    file_url TEXT,
    file_name TEXT,
    file_size BIGINT,
    read_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    CONSTRAINT content_not_empty CHECK (LENGTH(TRIM(content)) > 0)
);

-- ================================
-- 12. SUPPORT MESSAGES TABLE (·Ä°·ÄÄ·Ä∞·Ä°·Ää·ÄÆ·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÅ·Ä∂·Äô·Äæ·ÄØ·Äô·Äª·Ä¨·Ä∏)
-- ================================
CREATE TABLE IF NOT EXISTS support_messages (
    id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
    profile_id UUID REFERENCES profiles(id) ON DELETE SET NULL,
    session_id UUID REFERENCES sessions(id) ON DELETE SET NULL,
    content TEXT NOT NULL,
    is_from_user BOOLEAN DEFAULT TRUE,
    is_read BOOLEAN DEFAULT FALSE,
    priority TEXT DEFAULT 'normal' CHECK (priority IN ('low', 'normal', 'high', 'urgent')),
    status TEXT DEFAULT 'open' CHECK (status IN ('open', 'in_progress', 'resolved', 'closed')),
    reply_to UUID REFERENCES support_messages(id) ON DELETE SET NULL,
    admin_reply BOOLEAN DEFAULT FALSE,
    read_at TIMESTAMP WITH TIME ZONE,
    resolved_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    CONSTRAINT content_not_empty CHECK (LENGTH(TRIM(content)) > 0)
);

-- ================================
-- 13. USER ACTIVITIES TABLE (·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äû·Ä∞ ·Äú·Äæ·ÄØ·Äï·Ä∫·Äõ·Äæ·Ä¨·Ä∏·Äô·Äæ·ÄØ·Äô·Äª·Ä¨·Ä∏)
-- ================================
CREATE TABLE IF NOT EXISTS user_activities (
    id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
    profile_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    session_id UUID REFERENCES sessions(id) ON DELETE CASCADE,
    activity_type TEXT NOT NULL,
    activity_data JSONB,
    ip_address TEXT,
    user_agent TEXT,
    device_info JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ================================
-- 14. KEY EXTENSIONS TABLE (Key ·Äû·ÄÄ·Ä∫·Äê·Äô·Ä∫·Ä∏ ·Äê·Ä≠·ÄØ·Ä∏·Äô·Äº·Äæ·ÄÑ·Ä∑·Ä∫·Äô·Äæ·ÄØ·Äô·Äª·Ä¨·Ä∏)
-- ================================
CREATE TABLE IF NOT EXISTS key_extensions (
    id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
    key_id UUID NOT NULL REFERENCES keys(id) ON DELETE CASCADE,
    previous_expiry TIMESTAMP WITH TIME ZONE NOT NULL,
    new_expiry TIMESTAMP WITH TIME ZONE NOT NULL,
    extended_by_admin BOOLEAN DEFAULT TRUE,
    extension_reason TEXT,
    admin_notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ================================
-- TRIGGERS FOR UPDATED_AT
-- ================================

-- Function to update updated_at column
CREATE OR REPLACE FUNCTION public.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;

$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Apply triggers to tables with updated_at
CREATE TRIGGER update_about_updated_at 
BEFORE UPDATE ON about 
FOR EACH ROW 
EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_devices_updated_at 
BEFORE UPDATE ON devices 
FOR EACH ROW 
EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_keys_updated_at 
BEFORE UPDATE ON keys 
FOR EACH ROW 
EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_sessions_updated_at 
BEFORE UPDATE ON sessions 
FOR EACH ROW 
EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_profiles_updated_at 
BEFORE UPDATE ON profiles 
FOR EACH ROW 
EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_news_updated_at 
BEFORE UPDATE ON news 
FOR EACH ROW 
EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_comments_updated_at 
BEFORE UPDATE ON comments 
FOR EACH ROW 
EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_chat_messages_updated_at 
BEFORE UPDATE ON chat_messages 
FOR EACH ROW 
EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_support_messages_updated_at 
BEFORE UPDATE ON support_messages 
FOR EACH ROW 
EXECUTE FUNCTION public.update_updated_at_column();

-- ================================
-- AUTOMATIC TRIGGERS
-- ================================

-- Update comments count when comment is added/deleted
CREATE OR REPLACE FUNCTION public.update_news_comments_count()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        UPDATE news SET comments_count = comments_count + 1 WHERE id = NEW.news_id;
        RETURN NEW;
    ELSIF TG_OP = 'DELETE' THEN
        UPDATE news SET comments_count = GREATEST(comments_count - 1, 0) WHERE id = OLD.news_id;
        RETURN OLD;
    END IF;
    RETURN NULL;
END;

$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER update_news_comments_count_trigger
AFTER INSERT OR DELETE ON comments
FOR EACH ROW
EXECUTE FUNCTION public.update_news_comments_count();

-- Update last activity for profiles
CREATE OR REPLACE FUNCTION public.update_profile_last_activity()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE profiles SET last_active = NOW() WHERE id = NEW.profile_id;
    RETURN NEW;
END;

$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER update_profile_activity_trigger
AFTER INSERT ON user_activities
FOR EACH ROW
EXECUTE FUNCTION public.update_profile_last_activity();

-- ================================
-- ROW LEVEL SECURITY (RLS) - ·Ä°·Äï·Äº·Ää·Ä∑·Ä∫·Ä°·Äù Security Setup
-- ================================

-- Enable RLS on all tables
ALTER TABLE about ENABLE ROW LEVEL SECURITY;
ALTER TABLE devices ENABLE ROW LEVEL SECURITY;
ALTER TABLE keys ENABLE ROW LEVEL SECURITY;
ALTER TABLE sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE generated_files ENABLE ROW LEVEL SECURITY;
ALTER TABLE news ENABLE ROW LEVEL SECURITY;
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;
ALTER TABLE likes ENABLE ROW LEVEL SECURITY;
ALTER TABLE chat_conversations ENABLE ROW LEVEL SECURITY;
ALTER TABLE chat_messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE support_messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_activities ENABLE ROW LEVEL SECURITY;
ALTER TABLE key_extensions ENABLE ROW LEVEL SECURITY;

-- ABOUT table policies - allow all operations
DROP POLICY IF EXISTS "Allow all access to about" ON about;
CREATE POLICY "Allow all access to about" ON about FOR ALL USING (true);

-- DEVICES table policies
DROP POLICY IF EXISTS "Allow all access to devices" ON devices;
CREATE POLICY "Allow all access to devices" ON devices FOR ALL USING (true);

-- KEYS table policies
DROP POLICY IF EXISTS "Allow all access to keys" ON keys;
CREATE POLICY "Allow all access to keys" ON keys FOR ALL USING (true);

-- SESSIONS table policies
DROP POLICY IF EXISTS "Allow all access to sessions" ON sessions;
CREATE POLICY "Allow all access to sessions" ON sessions FOR ALL USING (true);

-- PROFILES table policies
DROP POLICY IF EXISTS "Allow all access to profiles" ON profiles;
CREATE POLICY "Allow all access to profiles" ON profiles FOR ALL USING (true);

-- GENERATED_FILES table policies
DROP POLICY IF EXISTS "Allow all access to generated_files" ON generated_files;
CREATE POLICY "Allow all access to generated_files" ON generated_files FOR ALL USING (true);

-- NEWS table policies
DROP POLICY IF EXISTS "Allow all access to news" ON news;
CREATE POLICY "Allow all access to news" ON news FOR ALL USING (true);

-- COMMENTS table policies
DROP POLICY IF EXISTS "Allow all access to comments" ON comments;
CREATE POLICY "Allow all access to comments" ON comments FOR ALL USING (true);

-- LIKES table policies
DROP POLICY IF EXISTS "Allow all access to likes" ON likes;
CREATE POLICY "Allow all access to likes" ON likes FOR ALL USING (true);

-- CHAT_CONVERSATIONS table policies
DROP POLICY IF EXISTS "Allow all access to chat_conversations" ON chat_conversations;
CREATE POLICY "Allow all access to chat_conversations" ON chat_conversations FOR ALL USING (true);

-- CHAT_MESSAGES table policies
DROP POLICY IF EXISTS "Allow all access to chat_messages" ON chat_messages;
CREATE POLICY "Allow all access to chat_messages" ON chat_messages FOR ALL USING (true);

-- SUPPORT_MESSAGES table policies
DROP POLICY IF EXISTS "Allow all access to support_messages" ON support_messages;
CREATE POLICY "Allow all access to support_messages" ON support_messages FOR ALL USING (true);

-- USER_ACTIVITIES table policies
DROP POLICY IF EXISTS "Allow all access to user_activities" ON user_activities;
CREATE POLICY "Allow all access to user_activities" ON user_activities FOR ALL USING (true);

-- KEY_EXTENSIONS table policies
DROP POLICY IF EXISTS "Allow all access to key_extensions" ON key_extensions;
CREATE POLICY "Allow all access to key_extensions" ON key_extensions FOR ALL USING (true);

-- ================================
-- STORAGE BUCKETS - File Storage ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫
-- ================================

-- Create storage buckets
INSERT INTO storage.buckets (id, name, public) 
VALUES 
    ('profiles', 'profiles', true),
    ('news', 'news', true),
    ('chat-files', 'chat-files', true),
    ('generated-files', 'generated-files', true),
    ('support-files', 'support-files', true)
ON CONFLICT (id) DO UPDATE SET
    public = EXCLUDED.public;

-- Storage policies for all buckets - Allow all operations
CREATE POLICY "Allow all operations on profiles bucket" 
ON storage.objects FOR ALL 
USING (bucket_id = 'profiles');

CREATE POLICY "Allow all operations on news bucket" 
ON storage.objects FOR ALL 
USING (bucket_id = 'news');

CREATE POLICY "Allow all operations on chat-files bucket" 
ON storage.objects FOR ALL 
USING (bucket_id = 'chat-files');

CREATE POLICY "Allow all operations on generated-files bucket" 
ON storage.objects FOR ALL 
USING (bucket_id = 'generated-files');

CREATE POLICY "Allow all operations on support-files bucket" 
ON storage.objects FOR ALL 
USING (bucket_id = 'support-files');

-- ================================
-- INDEXES FOR PERFORMANCE - ·Äô·Äº·Äî·Ä∫·ÄÜ·Äî·Ä∫·Äô·Äæ·ÄØ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫
-- ================================

-- Keys table indexes
CREATE INDEX IF NOT EXISTS idx_keys_active ON keys(is_active);
CREATE INDEX IF NOT EXISTS idx_keys_expires ON keys(expires_at);
CREATE INDEX IF NOT EXISTS idx_keys_text ON keys(key_text);

-- Sessions table indexes
CREATE INDEX IF NOT EXISTS idx_sessions_active ON sessions(is_active);
CREATE INDEX IF NOT EXISTS idx_sessions_device ON sessions(device_id);
CREATE INDEX IF NOT EXISTS idx_sessions_key ON sessions(key_id);
CREATE INDEX IF NOT EXISTS idx_sessions_activity ON sessions(last_activity);

-- Devices table indexes
CREATE INDEX IF NOT EXISTS idx_devices_active ON devices(is_active);
CREATE INDEX IF NOT EXISTS idx_devices_last_seen ON devices(last_seen);

-- Profiles table indexes
CREATE INDEX IF NOT EXISTS idx_profiles_username ON profiles(username);
CREATE INDEX IF NOT EXISTS idx_profiles_banned ON profiles(is_banned);
CREATE INDEX IF NOT EXISTS idx_profiles_key ON profiles(key_id);
CREATE INDEX IF NOT EXISTS idx_profiles_session ON profiles(session_id);
CREATE INDEX IF NOT EXISTS idx_profiles_active ON profiles(last_active);

-- News table indexes
CREATE INDEX IF NOT EXISTS idx_news_created ON news(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_news_published ON news(published_at DESC);
CREATE INDEX IF NOT EXISTS idx_news_profile ON news(profile_id);
CREATE INDEX IF NOT EXISTS idx_news_featured ON news(is_featured);
CREATE INDEX IF NOT EXISTS idx_news_admin ON news(is_admin);
CREATE INDEX IF NOT EXISTS idx_news_views ON news(views DESC);

-- Comments table indexes
CREATE INDEX IF NOT EXISTS idx_comments_news ON comments(news_id);
CREATE INDEX IF NOT EXISTS idx_comments_parent ON comments(parent_id);
CREATE INDEX IF NOT EXISTS idx_comments_profile ON comments(profile_id);
CREATE INDEX IF NOT EXISTS idx_comments_created ON comments(created_at);

-- Likes table indexes
CREATE INDEX IF NOT EXISTS idx_likes_profile ON likes(profile_id);
CREATE INDEX IF NOT EXISTS idx_likes_news ON likes(news_id);
CREATE INDEX IF NOT EXISTS idx_likes_comment ON likes(comment_id);

-- Chat related indexes
CREATE INDEX IF NOT EXISTS idx_chat_conversations_participants ON chat_conversations(participant1_id, participant2_id);
CREATE INDEX IF NOT EXISTS idx_chat_conversations_message_time ON chat_conversations(last_message_at DESC);
CREATE INDEX IF NOT EXISTS idx_chat_messages_conversation ON chat_messages(conversation_id);
CREATE INDEX IF NOT EXISTS idx_chat_messages_sender ON chat_messages(sender_id);
CREATE INDEX IF NOT EXISTS idx_chat_messages_created ON chat_messages(created_at);

-- Support table indexes
CREATE INDEX IF NOT EXISTS idx_support_created ON support_messages(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_support_status ON support_messages(status);
CREATE INDEX IF NOT EXISTS idx_support_profile ON support_messages(profile_id);
CREATE INDEX IF NOT EXISTS idx_support_session ON support_messages(session_id);

-- Activity table indexes
CREATE INDEX IF NOT EXISTS idx_user_activities_profile ON user_activities(profile_id);
CREATE INDEX IF NOT EXISTS idx_user_activities_session ON user_activities(session_id);
CREATE INDEX IF NOT EXISTS idx_user_activities_type ON user_activities(activity_type);
CREATE INDEX IF NOT EXISTS idx_user_activities_created ON user_activities(created_at);

-- Generated files indexes
CREATE INDEX IF NOT EXISTS idx_generated_files_session ON generated_files(session_id);
CREATE INDEX IF NOT EXISTS idx_generated_files_profile ON generated_files(profile_id);
CREATE INDEX IF NOT EXISTS idx_generated_files_created ON generated_files(created_at);

-- Key extensions indexes
CREATE INDEX IF NOT EXISTS idx_key_extensions_key ON key_extensions(key_id);
CREATE INDEX IF NOT EXISTS idx_key_extensions_created ON key_extensions(created_at);

-- ================================
-- UTILITY FUNCTIONS - ·Ä°·Äë·Ä±·Ä¨·ÄÄ·Ä∫·Ä°·ÄÄ·Ä∞·Äï·Äº·ÄØ Functions ·Äô·Äª·Ä¨·Ä∏
-- ================================

-- Function to check key validity and get details
CREATE OR REPLACE FUNCTION public.validate_key(input_key_text TEXT)
RETURNS TABLE(
    is_valid BOOLEAN,
    key_id UUID,
    expires_at TIMESTAMP WITH TIME ZONE,
    max_devices INTEGER,
    current_devices INTEGER
) AS $$
DECLARE
    key_record RECORD;
    device_count INTEGER;
BEGIN
    -- Get key details
    SELECT k.id, k.expires_at, k.max_devices, k.is_active
    INTO key_record
    FROM keys k
    WHERE k.key_text = input_key_text;
    
    IF NOT FOUND THEN
        RETURN QUERY SELECT false, NULL::UUID, NULL::TIMESTAMP WITH TIME ZONE, 0, 0;
        RETURN;
    END IF;
    
    -- Check if key is active and not expired
    IF NOT key_record.is_active OR key_record.expires_at <= NOW() THEN
        RETURN QUERY SELECT false, key_record.id, key_record.expires_at, key_record.max_devices, 0;
        RETURN;
    END IF;
    
    -- Count active devices for this key
    SELECT COUNT(*)::INTEGER INTO device_count
    FROM sessions s
    WHERE s.key_id = key_record.id 
    AND s.is_active = true;
    
    RETURN QUERY SELECT 
        true,
        key_record.id,
        key_record.expires_at,
        key_record.max_devices,
        device_count;
END;

$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to create or update device and session
CREATE OR REPLACE FUNCTION public.login_with_key(
    input_key_text TEXT,
    input_device_id TEXT,
    input_user_agent TEXT DEFAULT NULL,
    input_device_info JSONB DEFAULT '{}'
)
RETURNS TABLE(
    success BOOLEAN,
    session_id UUID,
    message TEXT,
    expires_at TIMESTAMP WITH TIME ZONE
) AS $$
DECLARE
    key_validation RECORD;
    existing_session RECORD;
    new_session_id UUID;
BEGIN
    -- Validate key
    SELECT * INTO key_validation
    FROM public.validate_key(input_key_text);
    
    IF NOT key_validation.is_valid THEN
        RETURN QUERY SELECT false, NULL::UUID, 'Invalid or expired key', NULL::TIMESTAMP WITH TIME ZONE;
        RETURN;
    END IF;
    
    -- Create or update device
    INSERT INTO devices (id, user_agent, browser_info, last_seen, is_active)
    VALUES (input_device_id, COALESCE(input_user_agent, ''), input_device_info::TEXT, NOW(), true)
    ON CONFLICT (id) DO UPDATE SET
        last_seen = NOW(),
        is_active = true,
        user_agent = COALESCE(EXCLUDED.user_agent, devices.user_agent),
        updated_at = NOW();
    
    -- Check for existing active session
    SELECT * INTO existing_session
    FROM sessions s
    WHERE s.key_id = key_validation.key_id 
    AND s.device_id = input_device_id
    AND s.is_active = true;
    
    IF FOUND THEN
        -- Update existing session
        UPDATE sessions 
        SET last_activity = NOW(), updated_at = NOW()
        WHERE id = existing_session.id;
        
        new_session_id := existing_session.id;
    ELSE
        -- Check device limit
        IF key_validation.current_devices >= key_validation.max_devices THEN
            RETURN QUERY SELECT false, NULL::UUID, 'Device limit exceeded for this key', key_validation.expires_at;
            RETURN;
        END IF;
        
        -- Create new session
        INSERT INTO sessions (key_id, device_id, is_active, last_activity, login_time)
        VALUES (key_validation.key_id, input_device_id, true, NOW(), NOW())
        RETURNING id INTO new_session_id;
    END IF;
    
    -- Log login activity
    PERFORM public.log_user_activity(
        NULL, -- profile_id (not yet created)
        new_session_id,
        'user_login',
        jsonb_build_object(
            'key_text', input_key_text,
            'device_id', input_device_id,
            'login_time', NOW()
        ),
        NULL, -- ip_address
        input_user_agent,
        input_device_info
    );
    
    RETURN QUERY SELECT true, new_session_id, 'Login successful', key_validation.expires_at;
END;

$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to extend key expiration
CREATE OR REPLACE FUNCTION public.extend_key_expiration(
    input_key_text TEXT,
    extend_days INTEGER,
    admin_reason TEXT DEFAULT NULL
)
RETURNS TABLE(
    success BOOLEAN,
    message TEXT,
    new_expiry TIMESTAMP WITH TIME ZONE
) AS $$
DECLARE
    key_record RECORD;
    old_expiry TIMESTAMP WITH TIME ZONE;
    new_expiry TIMESTAMP WITH TIME ZONE;
BEGIN
    -- Get key details
    SELECT id, expires_at, is_active
    INTO key_record
    FROM keys
    WHERE key_text = input_key_text;
    
    IF NOT FOUND THEN
        RETURN QUERY SELECT false, 'Key not found', NULL::TIMESTAMP WITH TIME ZONE;
        RETURN;
    END IF;
    
    old_expiry := key_record.expires_at;
    new_expiry := old_expiry + (extend_days || ' days')::INTERVAL;
    
    -- Update key expiration
    UPDATE keys 
    SET expires_at = new_expiry, 
        is_active = true,
        updated_at = NOW()
    WHERE id = key_record.id;
    
    -- Log the extension
    INSERT INTO key_extensions (key_id, previous_expiry, new_expiry, extended_by_admin, extension_reason, admin_notes)
    VALUES (key_record.id, old_expiry, new_expiry, true, 'Admin extension', admin_reason);
    
    RETURN QUERY SELECT true, 'Key expiration extended successfully', new_expiry;
END;

$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to validate session
CREATE OR REPLACE FUNCTION public.validate_session(session_id_param UUID)
RETURNS TABLE(
    is_valid BOOLEAN,
    profile_id UUID,
    key_expires_at TIMESTAMP WITH TIME ZONE,
    message TEXT
) AS $$
DECLARE
    session_record RECORD;
BEGIN
    SELECT s.*, k.expires_at, k.is_active as key_active, p.id as profile_id
    INTO session_record
    FROM sessions s
    JOIN keys k ON s.key_id = k.id
    LEFT JOIN profiles p ON p.session_id = s.id
    WHERE s.id = session_id_param;
    
    IF NOT FOUND THEN
        RETURN QUERY SELECT false, NULL::UUID, NULL::TIMESTAMP WITH TIME ZONE, 'Session not found';
        RETURN;
    END IF;
    
    -- Check if session is active
    IF NOT session_record.is_active THEN
        RETURN QUERY SELECT false, session_record.profile_id, session_record.expires_at, 'Session is inactive';
        RETURN;
    END IF;
    
    -- Check if key is active
    IF NOT session_record.key_active THEN
        UPDATE sessions SET is_active = false WHERE id = session_id_param;
        RETURN QUERY SELECT false, session_record.profile_id, session_record.expires_at, 'Key is inactive';
        RETURN;
    END IF;
    
    -- Check if key is expired
    IF session_record.expires_at < NOW() THEN
        UPDATE sessions SET is_active = false WHERE id = session_id_param;
        RETURN QUERY SELECT false, session_record.profile_id, session_record.expires_at, 'Key has expired';
        RETURN;
    END IF;
    
    -- Update last activity
    UPDATE sessions SET last_activity = NOW(), updated_at = NOW() WHERE id = session_id_param;
    
    RETURN QUERY SELECT true, session_record.profile_id, session_record.expires_at, 'Session is valid';
END;

$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to increment news views
CREATE OR REPLACE FUNCTION public.increment_news_views(input_news_id UUID)
RETURNS INTEGER AS $$
DECLARE
    updated_views INTEGER;
BEGIN
    UPDATE news 
    SET views = COALESCE(views, 0) + 1 
    WHERE id = input_news_id
    RETURNING views INTO updated_views;
    
    RETURN COALESCE(updated_views, 0);
END;

$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to toggle like
CREATE OR REPLACE FUNCTION public.toggle_like(profile_id_param UUID, news_id_param UUID DEFAULT NULL, comment_id_param UUID DEFAULT NULL)
RETURNS TABLE(
    liked BOOLEAN,
    total_likes INTEGER
) AS $$
DECLARE
    like_exists BOOLEAN := false;
    current_likes INTEGER := 0;
BEGIN
    -- Check if like exists and toggle
    IF news_id_param IS NOT NULL THEN
        SELECT EXISTS(SELECT 1 FROM likes WHERE profile_id = profile_id_param AND news_id = news_id_param) INTO like_exists;
        
        IF like_exists THEN
            DELETE FROM likes WHERE profile_id = profile_id_param AND news_id = news_id_param;
            UPDATE news SET likes = GREATEST(COALESCE(likes, 1) - 1, 0) WHERE id = news_id_param RETURNING likes INTO current_likes;
            RETURN QUERY SELECT false, current_likes;
        ELSE
            INSERT INTO likes (profile_id, news_id) VALUES (profile_id_param, news_id_param);
            UPDATE news SET likes = COALESCE(likes, 0) + 1 WHERE id = news_id_param RETURNING likes INTO current_likes;
            RETURN QUERY SELECT true, current_likes;
        END IF;
    ELSIF comment_id_param IS NOT NULL THEN
        SELECT EXISTS(SELECT 1 FROM likes WHERE profile_id = profile_id_param AND comment_id = comment_id_param) INTO like_exists;
        
        IF like_exists THEN
            DELETE FROM likes WHERE profile_id = profile_id_param AND comment_id = comment_id_param;
            UPDATE comments SET likes = GREATEST(COALESCE(likes, 1) - 1, 0) WHERE id = comment_id_param RETURNING likes INTO current_likes;
            RETURN QUERY SELECT false, current_likes;
        ELSE
            INSERT INTO likes (profile_id, comment_id) VALUES (profile_id_param, comment_id_param);
            UPDATE comments SET likes = COALESCE(likes, 0) + 1 WHERE id = comment_id_param RETURNING likes INTO current_likes;
            RETURN QUERY SELECT true, current_likes;
        END IF;
    END IF;
    
    RETURN QUERY SELECT false, 0;
END;

$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to create or get chat conversation
CREATE OR REPLACE FUNCTION public.get_or_create_conversation(user1_id UUID, user2_id UUID)
RETURNS UUID AS $$
DECLARE
    conversation_id UUID;
    min_id UUID;
    max_id UUID;
BEGIN
    -- Ensure consistent ordering
    IF user1_id < user2_id THEN
        min_id := user1_id;
        max_id := user2_id;
    ELSE
        min_id := user2_id;
        max_id := user1_id;
    END IF;
    
    -- Try to find existing conversation
    SELECT id INTO conversation_id
    FROM chat_conversations
    WHERE (participant1_id = min_id AND participant2_id = max_id);
    
    -- If not found, create new one
    IF conversation_id IS NULL THEN
        INSERT INTO chat_conversations (participant1_id, participant2_id, is_active)
        VALUES (min_id, max_id, true)
        RETURNING id INTO conversation_id;
    END IF;
    
    RETURN conversation_id;
END;

$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to log user activity
CREATE OR REPLACE FUNCTION public.log_user_activity(
    profile_id_param UUID,
    session_id_param UUID,
    activity_type_param TEXT,
    activity_data_param JSONB DEFAULT NULL,
    ip_address_param TEXT DEFAULT NULL,
    user_agent_param TEXT DEFAULT NULL,
    device_info_param JSONB DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
    activity_id UUID;
BEGIN
    INSERT INTO user_activities (profile_id, session_id, activity_type, activity_data, ip_address, user_agent, device_info)
    VALUES (profile_id_param, session_id_param, activity_type_param, activity_data_param, ip_address_param, user_agent_param, device_info_param)
    RETURNING id INTO activity_id;
    
    RETURN activity_id;
END;

$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to ban/unban user
CREATE OR REPLACE FUNCTION public.toggle_user_ban(profile_id_param UUID, ban_status BOOLEAN DEFAULT NULL, ban_reason_param TEXT DEFAULT NULL)
RETURNS TABLE(
    success BOOLEAN,
    is_banned BOOLEAN, 
    message TEXT
) AS $$
DECLARE
    current_status BOOLEAN;
    new_status BOOLEAN;
    profile_exists BOOLEAN;
BEGIN
    SELECT is_banned INTO current_status FROM profiles WHERE id = profile_id_param;
    
    IF NOT FOUND THEN
        RETURN QUERY SELECT false, false, 'Profile not found';
        RETURN;
    END IF;
    
    IF ban_status IS NULL THEN
        new_status := NOT current_status;
    ELSE
        new_status := ban_status;
    END IF;
    
    UPDATE profiles 
    SET is_banned = new_status,
        ban_reason = CASE WHEN new_status THEN ban_reason_param ELSE NULL END,
        banned_at = CASE WHEN new_status THEN NOW() ELSE NULL END,
        updated_at = NOW()
    WHERE id = profile_id_param;
    
    -- Log the activity
    PERFORM log_user_activity(
        profile_id_param,
        NULL,
        CASE WHEN new_status THEN 'user_banned' ELSE 'user_unbanned' END,
        jsonb_build_object(
            'previous_status', current_status,
            'ban_reason', ban_reason_param,
            'admin_action', true
        )
    );
    
    RETURN QUERY SELECT 
        true, 
        new_status, 
        CASE WHEN new_status THEN 'User banned successfully' ELSE 'User unbanned successfully' END;
END;

$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to cleanup expired sessions and keys
CREATE OR REPLACE FUNCTION public.cleanup_expired_data()
RETURNS TABLE(
    expired_keys INTEGER,
    inactive_sessions INTEGER,
    old_activities INTEGER
) AS $$
DECLARE
    expired_key_count INTEGER;
    inactive_session_count INTEGER;
    old_activity_count INTEGER;
BEGIN
    -- Deactivate expired keys
    UPDATE keys 
    SET is_active = false, updated_at = NOW()
    WHERE expires_at < NOW() AND is_active = true;
    
    GET DIAGNOSTICS expired_key_count = ROW_COUNT;
    
    -- Deactivate sessions with expired keys
    UPDATE sessions 
    SET is_active = false, logout_time = NOW(), updated_at = NOW()
    WHERE key_id IN (
        SELECT id FROM keys WHERE expires_at < NOW() OR is_active = false
    ) AND is_active = true;
    
    GET DIAGNOSTICS inactive_session_count = ROW_COUNT;
    
    -- Delete old user activities (older than 90 days)
    DELETE FROM user_activities 
    WHERE created_at < NOW() - INTERVAL '90 days';
    
    GET DIAGNOSTICS old_activity_count = ROW_COUNT;
    
    RETURN QUERY SELECT expired_key_count, inactive_session_count, old_activity_count;
END;

$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ================================
-- REALTIME PUBLICATIONS - Realtime ·Ä°·ÄÑ·Ä∫·Äπ·ÄÇ·Ä´·Äõ·Äï·Ä∫·Äô·Äª·Ä¨·Ä∏
-- ================================

-- Add tables to realtime publication
ALTER PUBLICATION supabase_realtime ADD TABLE about;
ALTER PUBLICATION supabase_realtime ADD TABLE keys;
ALTER PUBLICATION supabase_realtime ADD TABLE devices;
ALTER PUBLICATION supabase_realtime ADD TABLE sessions;
ALTER PUBLICATION supabase_realtime ADD TABLE generated_files;
ALTER PUBLICATION supabase_realtime ADD TABLE profiles;
ALTER PUBLICATION supabase_realtime ADD TABLE news;
ALTER PUBLICATION supabase_realtime ADD TABLE comments;
ALTER PUBLICATION supabase_realtime ADD TABLE likes;
ALTER PUBLICATION supabase_realtime ADD TABLE chat_conversations;
ALTER PUBLICATION supabase_realtime ADD TABLE chat_messages;
ALTER PUBLICATION supabase_realtime ADD TABLE support_messages;
ALTER PUBLICATION supabase_realtime ADD TABLE user_activities;
ALTER PUBLICATION supabase_realtime ADD TABLE key_extensions;

-- ================================
-- SAMPLE DATA FOR TESTING - ·ÄÖ·Äô·Ä∫·Ä∏·Äû·Äï·Ä∫·Äõ·Äî·Ä∫ ·Äî·Äô·Ä∞·Äî·Ä¨ Data ·Äô·Äª·Ä¨·Ä∏
-- ================================

-- Insert sample news (admin)
INSERT INTO news (title, content, is_admin, admin_posted, views, is_featured)
VALUES 
    ('FPS GFX Tool ·Äô·Äæ ·ÄÄ·Äº·Ä≠·ÄØ·ÄÜ·Ä≠·ÄØ·Äï·Ä´·Äû·Ää·Ä∫!', 'FPS GFX Tool ·Äê·ÄΩ·ÄÑ·Ä∫ ·ÄÄ·Äº·Ä≠·ÄØ·ÄÜ·Ä≠·ÄØ·Äï·Ä´·Äê·Äö·Ä∫! ·Äí·ÄÆ tool ·ÄÄ·Ä≠·ÄØ ·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄÆ·Ä∏ ·Äû·ÄÑ·Ä∑·Ä∫·Äõ·Ä≤·Ä∑ PUBG gaming experience ·ÄÄ·Ä≠·ÄØ ·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÜ·ÄØ·Ä∂·Ä∏ ·Äú·ÄØ·Äï·Ä∫·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äï·Äº·ÄÆ·Åã Mobile ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ optimized ·Äú·ÄØ·Äï·Ä∫·Äë·Ä¨·Ä∏·Äï·Äº·ÄÆ·Ä∏ persistent login support ·Äï·Ä´·Äù·ÄÑ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫·Åã', true, true, 15, true),
    ('·Äî·Ä±·Ä¨·ÄÄ·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏ Update v2.5', 'bug fixes ·Äô·Äª·Ä¨·Ä∏·Äî·Äæ·ÄÑ·Ä∑·Ä∫ features ·Ä°·Äû·ÄÖ·Ä∫·Äô·Äª·Ä¨·Ä∏ ·Äï·Ä´·Äù·ÄÑ·Ä∫·Äû·Ä±·Ä¨ ·Äî·Ä±·Ä¨·ÄÄ·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏ version ·ÄÄ·Ä≠·ÄØ download ·Äú·ÄØ·Äï·Ä∫·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äï·Äº·ÄÆ·Åã Mobile responsive design ·Äî·Äæ·ÄÑ·Ä∑·Ä∫ improved session management ·Äï·Ä´·Äù·ÄÑ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫·Åã', true, true, 8, false),
    ('Mobile ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äû·Ä∞·Äô·Äª·Ä¨·Ä∏·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ·Ä°·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÄ·Äº·Ä¨·Ä∏·ÄÅ·Äª·ÄÄ·Ä∫', 'Mobile ·Äê·ÄΩ·ÄÑ·Ä∫ ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äõ·Ä¨·Äê·ÄΩ·ÄÑ·Ä∫ ·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÜ·ÄØ·Ä∂·Ä∏ performance ·Äõ·Äõ·Äæ·Ä≠·Äõ·Äî·Ä∫ ·Ä°·ÄÄ·Äº·Ä∂·Äï·Äº·ÄØ·ÄÅ·Äª·ÄÄ·Ä∫·Äô·Äª·Ä¨·Ä∏ ·Äñ·Ä±·Ä¨·Ä∫·Äï·Äº·Äë·Ä¨·Ä∏·Äï·Ä´·Äû·Ää·Ä∫·Åã Key ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äô·Äæ·ÄØ·Äî·Äæ·ÄÑ·Ä∑·Ä∫ Device management ·Ä°·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏ ·Äú·Ä±·Ä∑·Äú·Ä¨·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫·Åã', true, true, 12, false),
    ('Admin Panel ·Ä°·Äû·ÄÖ·Ä∫ ·Äô·Ä≠·Äê·Ä∫·ÄÜ·ÄÄ·Ä∫', 'Admin Panel ·Äê·ÄΩ·ÄÑ·Ä∫ News management, User management ·Äî·Äæ·ÄÑ·Ä∑·Ä∫ Key management features ·Äô·Äª·Ä¨·Ä∏ ·Äï·Ä´·Äù·ÄÑ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫·Åã Mobile responsive design ·Äñ·Äº·ÄÑ·Ä∑·Ä∫ ·Äê·Ää·Ä∫·ÄÜ·Ä±·Ä¨·ÄÄ·Ä∫·Äë·Ä¨·Ä∏·Äï·Ä´·Äû·Ää·Ä∫·Åã', true, true, 5, true)
ON CONFLICT DO NOTHING;

-- Insert sample support messages
INSERT INTO support_messages (content, is_from_user, priority, status, admin_reply)
VALUES 
    ('·Äô·ÄÑ·Ä∫·Äπ·ÄÇ·Äú·Ä¨·Äï·Ä´! FPS GFX Tool ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äõ·Ä¨·Äê·ÄΩ·ÄÑ·Ä∫ ·Ä°·ÄÄ·Ä∞·Ä°·Ää·ÄÆ·Äú·Ä≠·ÄØ·Ä°·Äï·Ä∫·Äï·Ä´·ÄÄ ·Äí·ÄÆ·Äô·Äæ·Ä¨ ·Äô·Ä±·Ä∏·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫·Åã Mobile app ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ·Ä°·Äë·Ä∞·Ä∏ support ·Äï·Ä±·Ä∏·Äë·Ä¨·Ä∏·Äï·Ä´·Äê·Äö·Ä∫·Åã', false, 'normal', 'open', true),
    ('Key ·Äô·Äª·Ä¨·Ä∏·Åè ·Äû·ÄÄ·Ä∫·Äê·Äô·Ä∫·Ä∏·Äê·Ä≠·ÄØ·Ä∏·Äõ·Äî·Ä∫ ·ÄÜ·ÄÄ·Ä∫·Äû·ÄΩ·Äö·Ä∫·Äú·Ä≠·ÄØ·Äï·Ä´·ÄÄ admin ·ÄÄ·Ä≠·ÄØ ·ÄÜ·ÄÄ·Ä∫·Äû·ÄΩ·Äö·Ä∫·Äï·Ä´·Åã Device management ·Äî·Äæ·ÄÑ·Ä∑·Ä∫ persistent login ·Ä°·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏ ·Ä°·ÄÄ·Ä∞·Ä°·Ää·ÄÆ·Äú·Ää·Ä∫·Ä∏ ·Äõ·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫·Åã', false, 'normal', 'open', true),
    ('Mobile ·Äê·ÄΩ·ÄÑ·Ä∫ ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äõ·Ä¨·Äê·ÄΩ·ÄÑ·Ä∫ ·Äï·Äº·Äø·Äî·Ä¨·Äõ·Äæ·Ä≠·Äï·Ä´·ÄÄ ·Äí·ÄÆ support channel ·Äô·Äæ·Äê·ÄÜ·ÄÑ·Ä∑·Ä∫ ·Ä°·ÄÄ·Ä∞·Ä°·Ää·ÄÆ·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫·Åã', false, 'low', 'open', true)
ON CONFLICT DO NOTHING;

-- ================================
-- SCHEDULED CLEANUP JOB
-- ================================

-- Note: This would typically be set up as a cron job or scheduled function
-- For now, we'll create the function that can be called manually or via webhook

CREATE OR REPLACE FUNCTION public.daily_maintenance()
RETURNS TABLE(
    maintenance_date TIMESTAMP WITH TIME ZONE,
    expired_keys INTEGER,
    inactive_sessions INTEGER,
    old_activities INTEGER,
    success BOOLEAN
) AS $$
DECLARE
    cleanup_result RECORD;
BEGIN
    -- Run cleanup
    SELECT * INTO cleanup_result FROM public.cleanup_expired_data();
    
    -- Log maintenance activity
    PERFORM log_user_activity(
        NULL,
        NULL,
        'system_maintenance',
        jsonb_build_object(
            'expired_keys', cleanup_result.expired_keys,
            'inactive_sessions', cleanup_result.inactive_sessions,
            'old_activities', cleanup_result.old_activities,
            'maintenance_date', NOW()
        )
    );
    
    RETURN QUERY SELECT 
        NOW(),
        cleanup_result.expired_keys,
        cleanup_result.inactive_sessions, 
        cleanup_result.old_activities,
        true;
END;

$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ================================
-- VERIFICATION QUERIES - ·ÄÖ·ÄÖ·Ä∫·ÄÜ·Ä±·Ä∏·Äõ·Äî·Ä∫ Queries ·Äô·Äª·Ä¨·Ä∏
-- ================================

-- Show all tables with row counts
SELECT 
    schemaname,
    tablename,
    n_tup_ins - n_tup_del as row_count
FROM pg_stat_user_tables 
WHERE schemaname = 'public'
ORDER BY tablename;

-- Show all functions
SELECT 
    routine_name,
    routine_type,
    data_type as return_type
FROM information_schema.routines 
WHERE routine_schema = 'public' 
AND routine_type = 'FUNCTION'
ORDER BY routine_name;

-- Show all storage buckets
SELECT id, name, public, created_at FROM storage.buckets ORDER BY name;

-- Show all indexes
SELECT 
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes 
WHERE schemaname = 'public'
ORDER BY tablename, indexname;

-- Show RLS policies
SELECT 
    schemaname,
    tablename,
    policyname,
    permissive,
    roles,
    cmd,
    qual
FROM pg_policies 
WHERE schemaname = 'public'
ORDER BY tablename, policyname;

-- ================================
-- SUCCESS MESSAGE
-- ================================

DO $$
BEGIN
    RAISE NOTICE '================================================================';
    RAISE NOTICE 'FPS GFX Tool Database Setup ·Äú·ÄØ·Ä∂·Ä∏·Äù ·Äï·Äº·ÄÆ·Ä∏·ÄÖ·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ! üéâ';
    RAISE NOTICE '================================================================';
    RAISE NOTICE '·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·ÄÖ·ÄΩ·Ä¨ ·Äñ·Äî·Ä∫·Äê·ÄÆ·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äû·Ä±·Ä¨ ·Ä°·Äõ·Ä¨·Äô·Äª·Ä¨·Ä∏:';
    RAISE NOTICE '‚úÖ 14 Tables with complete relationships';
    RAISE NOTICE '‚úÖ Row Level Security (RLS) policies';  
    RAISE NOTICE '‚úÖ Storage buckets with proper policies';
    RAISE NOTICE '‚úÖ Realtime subscriptions enabled';
    RAISE NOTICE '‚úÖ 15+ Utility functions for complex operations';
    RAISE NOTICE '‚úÖ Comprehensive indexes for performance';
    RAISE NOTICE '‚úÖ Sample data for testing';
    RAISE NOTICE '‚úÖ Device-based session management';
    RAISE NOTICE '‚úÖ Persistent login support';
    RAISE NOTICE '‚úÖ Key extension functionality';
    RAISE NOTICE '‚úÖ Automatic cleanup procedures';
    RAISE NOTICE '================================================================';
    RAISE NOTICE 'Features included:';
    RAISE NOTICE '‚Ä¢ Fixed login errors and session management';
    RAISE NOTICE '‚Ä¢ Mobile-optimized database structure';
    RAISE NOTICE '‚Ä¢ Device tracking and limits';
    RAISE NOTICE '‚Ä¢ News management with admin controls';
    RAISE NOTICE '‚Ä¢ Chat system with file support';
    RAISE NOTICE '‚Ä¢ Support ticket system';
    RAISE NOTICE '‚Ä¢ User activity tracking';
    RAISE NOTICE '‚Ä¢ Automatic key expiration handling';
    RAISE NOTICE '================================================================';
    RAISE NOTICE '·Äî·Ä±·Ä¨·ÄÄ·Ä∫·Äë·Äï·Ä∫ ·Äú·ÄØ·Äï·Ä∫·Äõ·Äô·Ää·Ä∑·Ä∫·Ä°·Äõ·Ä¨·Äô·Äª·Ä¨·Ä∏:';
    RAISE NOTICE '1. Update CONFIG section in index.html and admin.html';
    RAISE NOTICE '2. Replace SUPABASE_URL with your project URL';
    RAISE NOTICE '3. Replace SUPABASE_ANON_KEY with your anon key';
    RAISE NOTICE '4. Deploy the fixed HTML files to your hosting service';
    RAISE NOTICE '5. Test all functionality including mobile responsiveness';
    RAISE NOTICE '================================================================';
    RAISE NOTICE '·Äû·ÄÑ·Ä∑·Ä∫·Äõ·Ä≤·Ä∑ FPS GFX Tool ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äõ·Äî·Ä∫ ·Ä°·ÄÜ·ÄÑ·Ä∫·Äû·ÄÑ·Ä∑·Ä∫·Äñ·Äº·ÄÖ·Ä∫·Äï·Ä´·Äï·Äº·ÄÆ! üöÄ';
    RAISE NOTICE 'All identified issues have been resolved! ‚ú®';
    RAISE NOTICE '================================================================';
END $$;</code></pre>
            </div>
        </div>

        <!-- Configuration Guide -->
        <div class="sql-container rounded-2xl p-6 mt-8">
            <h2 class="text-2xl font-bold text-yellow-400 mb-4">
                <i class="fas fa-cog mr-2"></i>
                Configuration Guide (·Ä°·Äï·Äº·ÄÑ·Ä∫·Ä°·ÄÜ·ÄÑ·Ä∫·Äú·Äô·Ä∫·Ä∏·Ää·ÄΩ·Äæ·Äî·Ä∫)
            </h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-green-400 mb-3">
                        <i class="fas fa-file-code mr-2"></i>
                        index.html ·Äê·ÄΩ·ÄÑ·Ä∫ ·Äï·Äº·ÄÑ·Ä∫·Äõ·Äô·Ää·Ä∑·Ä∫·Ä°·Äõ·Ä¨·Äô·Äª·Ä¨·Ä∏:
                    </h3>
                    <div class="sql-code p-3 text-sm">
<pre><code>const CONFIG = {
  SUPABASE_URL: 'https://rliwdosxsbauwxkayjoa.supabase.co',
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsaXdkb3N4c2JhdXd4a2F5am9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxMDA2NjIsImV4cCI6MjA2OTY3NjY2Mn0.uDvU9eX3Cy--D9l6daGaO2QMpn1YnxMJYVlbaeIgHu4',
  MAX_RETRY_ATTEMPTS: 3,
  RETRY_DELAY: 2000,
  CONNECTION_TIMEOUT: 10000
};</code></pre>
                    </div>
                </div>
                
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-green-400 mb-3">
                        <i class="fas fa-shield-alt mr-2"></i>
                        admin.html ·Äê·ÄΩ·ÄÑ·Ä∫ ·Äï·Äº·ÄÑ·Ä∫·Äõ·Äô·Ää·Ä∑·Ä∫·Ä°·Äõ·Ä¨·Äô·Äª·Ä¨·Ä∏:
                    </h3>
                    <div class="sql-code p-3 text-sm">
<pre><code>const CONFIG = {
  SUPABASE_URL: 'YOUR_SUPABASE_URL_HERE',
  SUPABASE_ANON_KEY: 'YOUR_SUPABASE_ANON_KEY_HERE',
  ADMIN_KEY: 'Opper_FPS',
  MAX_RETRY_ATTEMPTS: 3,
  RETRY_DELAY: 2000
};</code></pre>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 bg-blue-900 bg-opacity-50 border border-blue-600 rounded-lg p-4">
                <h4 class="font-bold text-blue-400 mb-2">
                    <i class="fas fa-lightbulb mr-2"></i>
                    Pro Tips:
                </h4>
                <ul class="text-blue-200 space-y-1 list-disc list-inside text-sm">
                    <li>Supabase project URL ·Äî·Äæ·ÄÑ·Ä∑·Ä∫ anon key ·ÄÄ·Ä≠·ÄØ Settings > API section ·Äê·ÄΩ·ÄÑ·Ä∫ ·Äõ·Äæ·Ä¨·Äî‡¶ø·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äû·Ää·Ä∫</li>
                    <li>Admin key ·ÄÄ·Ä≠·ÄØ ·Äú·ÄØ·Ä∂·ÄÅ·Äº·ÄØ·Ä∂·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ ·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äú·Ä≤·Äû·ÄÑ·Ä∑·Ä∫·Äï·Ä´·Äû·Ää·Ä∫</li>
                    <li>HTML files ·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ Netlify, Vercel ·Äû·Ä≠·ÄØ·Ä∑·Äô·Äü·ÄØ·Äê·Ä∫ GitHub Pages ·Äê·ÄΩ·ÄÑ·Ä∫ deploy ·Äú·ÄØ·Äï·Ä∫·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äû·Ää·Ä∫</li>
                    <li>Database realtime features ·Äû·Ää·Ä∫ ·Ä°·Äú·Ä≠·ÄØ·Ä°·Äú·Äª·Ä±·Ä¨·ÄÄ·Ä∫ ·Ä°·Äú·ÄØ·Äï·Ä∫·Äú·ÄØ·Äï·Ä∫·Äï·Ä´·Äú·Ä≠·Äô·Ä∑·Ä∫·Äô·Ää·Ä∫</li>
                    <li>Storage buckets ·Äô·Äª·Ä¨·Ä∏·Äû·Ää·Ä∫ file uploads ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ·Ä°·ÄÜ·ÄÑ·Ä∫·Äû·ÄÑ·Ä∑·Ä∫·Äñ·Äº·ÄÖ·Ä∫·Äî·Ä±·Äï·Ä´·Äû·Ää·Ä∫</li>
                    <li>Fixed device-based session management with persistent login support</li>
                </ul>
            </div>
        </div>

        <!-- Features List -->
        <div class="sql-container rounded-2xl p-6 mt-8">
            <h2 class="text-2xl font-bold text-yellow-400 mb-4">
                <i class="fas fa-star mr-2"></i>
                Database Features (·Ä°·ÄÑ·Ä∫·Äπ·ÄÇ·Ä´·Äõ·Äï·Ä∫·Äô·Äª·Ä¨·Ä∏)
            </h2>
            
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="text-green-400 font-semibold mb-2">
                        <i class="fas fa-table mr-2"></i>Core Tables
                    </h3>
                    <ul class="text-gray-300 text-sm space-y-1">
                        <li>‚Ä¢ About (Contact Info)</li>
                        <li>‚Ä¢ Devices (Device Tracking)</li>
                        <li>‚Ä¢ Keys (Access Management)</li>
                        <li>‚Ä¢ Sessions (Login Sessions)</li>
                        <li>‚Ä¢ Profiles (User Profiles)</li>
                    </ul>
                </div>
                
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="text-green-400 font-semibold mb-2">
                        <i class="fas fa-newspaper mr-2"></i>Content Tables
                    </h3>
                    <ul class="text-gray-300 text-sm space-y-1">
                        <li>‚Ä¢ News (News Posts)</li>
                        <li>‚Ä¢ Comments (Post Comments)</li>
                        <li>‚Ä¢ Likes (Like System)</li>
                        <li>‚Ä¢ Generated Files</li>
                        <li>‚Ä¢ User Activities</li>
                    </ul>
                </div>
                
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="text-green-400 font-semibold mb-2">
                        <i class="fas fa-comments mr-2"></i>Communication
                    </h3>
                    <ul class="text-gray-300 text-sm space-y-1">
                        <li>‚Ä¢ Chat Conversations</li>
                        <li>‚Ä¢ Chat Messages</li>
                        <li>‚Ä¢ Support Messages</li>
                        <li>‚Ä¢ Key Extensions</li>
                        <li>‚Ä¢ Admin Controls</li>
                    </ul>
                </div>
                
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="text-blue-400 font-semibold mb-2">
                        <i class="fas fa-shield-alt mr-2"></i>Security Features
                    </h3>
                    <ul class="text-gray-300 text-sm space-y-1">
                        <li>‚Ä¢ Row Level Security (RLS)</li>
                        <li>‚Ä¢ Device-based Sessions</li>
                        <li>‚Ä¢ Key Expiration Handling</li>
                        <li>‚Ä¢ User Ban System</li>
                        <li>‚Ä¢ Activity Logging</li>
                    </ul>
                </div>
                
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="text-purple-400 font-semibold mb-2">
                        <i class="fas fa-database mr-2"></i>Storage & Files
                    </h3>
                    <ul class="text-gray-300 text-sm space-y-1">
                        <li>‚Ä¢ Profile Pictures</li>
                        <li>‚Ä¢ News Images/Videos</li>
                        <li>‚Ä¢ Chat Files</li>
                        <li>‚Ä¢ Generated Config Files</li>
                        <li>‚Ä¢ Support Attachments</li>
                    </ul>
                </div>
                
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="text-red-400 font-semibold mb-2">
                        <i class="fas fa-cogs mr-2"></i>Utility Functions
                    </h3>
                    <ul class="text-gray-300 text-sm space-y-1">
                        <li>‚Ä¢ Key Validation</li>
                        <li>‚Ä¢ Login Management</li>
                        <li>‚Ä¢ Session Validation</li>
                        <li>‚Ä¢ Like Toggle</li>
                        <li>‚Ä¢ Automatic Cleanup</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Fixed Issues -->
        <div class="sql-container rounded-2xl p-6 mt-8">
            <h2 class="text-2xl font-bold text-red-400 mb-4">
                <i class="fas fa-bug mr-2"></i>
                Fixed Issues (·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·Äï·Äº·ÄÆ·Ä∏·Äû·Ä±·Ä¨ ·Äï·Äº·Äø·Äî·Ä¨·Äô·Äª·Ä¨·Ä∏)
            </h2>
            
            <div class="bg-green-900 bg-opacity-30 border border-green-600 rounded-lg p-4">
                <h3 class="text-green-400 font-semibold mb-3">
                    <i class="fas fa-check-circle mr-2"></i>
                    ·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·ÄÖ·ÄΩ·Ä¨ ·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·Äï·Äº·ÄÆ·Ä∏·Äû·Ä±·Ä¨ ·Ä°·Äõ·Ä¨·Äô·Äª·Ä¨·Ä∏:
                </h3>
                <ul class="text-green-200 space-y-2 list-disc list-inside">
                    <li><strong>Login Errors Fixed:</strong> "Cannot read properties of undefined (reading 'target')" error resolved</li>
                    <li><strong>Session Management:</strong> Fixed "Cannot access 'screen' before initialization" error</li>
                    <li><strong>Device Tracking:</strong> Proper device-based session management implemented</li>
                    <li><strong>Persistent Login:</strong> Users won't be logged out automatically unless key expires</li>
                    <li><strong>Key Device Limits:</strong> Proper enforcement of device limits per key</li>
                    <li><strong>News Management:</strong> Admin can view and delete user news posts</li>
                    <li><strong>Mobile Optimization:</strong> All tables and functions optimized for mobile use</li>
                    <li><strong>Database Policies:</strong> Complete RLS policies for all tables</li>
                    <li><strong>Storage Buckets:</strong> Proper file upload and management support</li>
                    <li><strong>Key Extension:</strong> Admin can extend key expiration dates</li>
                    <li><strong>User Profile Persistence:</strong> User profiles and news remain even after key expiry</li>
                    <li><strong>Support System:</strong> Complete help desk functionality</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        function copyAllSQL() {
            const sqlContent = document.getElementById('sql-content').textContent;
            navigator.clipboard.writeText(sqlContent).then(() => {
                alert('SQL copied to clipboard! ·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏ copy ·Äú·ÄØ·Äï·Ä∫·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ·Åã');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy SQL. Please select and copy manually.');
            });
        }

        function downloadSQL() {
            const sqlContent = document.getElementById('sql-content').textContent;
            const blob = new Blob([sqlContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fps_gfx_tool_database_complete.sql';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Add syntax highlighting
        document.addEventListener('DOMContentLoaded', function() {
            const codeElement = document.querySelector('#sql-content code');
            if (codeElement) {
                let html = codeElement.innerHTML;
                
                // Keywords
                html = html.replace(/\b(CREATE|TABLE|INSERT|SELECT|UPDATE|DELETE|DROP|ALTER|INDEX|FUNCTION|TRIGGER|POLICY|EXTENSION|IF|NOT|EXISTS|CASCADE|ON|REFERENCES|PRIMARY|KEY|FOREIGN|UNIQUE|CHECK|DEFAULT|NULL|TRUE|FALSE|AND|OR|WHERE|ORDER|BY|GROUP|HAVING|LIMIT|OFFSET|JOIN|LEFT|RIGHT|INNER|OUTER|UNION|WITH|AS|CASE|WHEN|THEN|ELSE|END|BEGIN|DECLARE|RETURN|LANGUAGE|SECURITY|DEFINER|RETURNS|BOOLEAN|INTEGER|TEXT|UUID|TIMESTAMP|TIME|ZONE|JSONB|BIGINT|INTERVAL|VARCHAR|DO|RAISE|NOTICE)\b/gi, '<span class="keyword">$1</span>');
                
                // Strings
                html = html.replace(/'([^']*)'/g, '<span class="string">\'$1\'</span>');
                
                // Comments
                html = html.replace(/--([^\n]*)/g, '<span class="comment">--$1</span>');
                
                // Functions
                html = html.replace(/\b([A-Za-z_][A-Za-z0-9_]*)\s*\(/g, '<span class="function">$1</span>(');
                
                codeElement.innerHTML = html;
            }
        });
    </script>
</body>
</html>
