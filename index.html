<!DOCTYPE html>
<html lang="my">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>FPS GFX Tool - မြန်မာ</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&family=Noto+Sans+Myanmar:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* Custom Fonts */
body {
  font-family: 'Noto Sans Myanmar', 'Inter', sans-serif;
}
h1, h2, h3, .font-orbitron {
  font-family: 'Orbitron', sans-serif;
}
.font-share-tech {
  font-family: 'Share Tech Mono', monospace;
}

/* New Color Palette */
:root {
  --primary-bg: hsl(220 20% 8%); /* Deep Dark Blue-Grey */
  --secondary-bg: hsl(220 20% 12%); /* Slightly Lighter Dark Blue-Grey */
  --accent-purple: hsl(280 80% 60%); /* Vibrant Purple */
  --accent-green: hsl(160 80% 50%); /* Neon Green */
  --accent-red: hsl(0 80% 60%); /* Vibrant Red */
  --text-primary: hsl(220 20% 90%); /* Light Grey */
  --text-secondary: hsl(220 15% 60%); /* Medium Grey */
  --border-color: hsl(220 15% 20%); /* Dark Grey */
  --card-bg: rgba(20, 25, 35, 0.7); /* Dark Translucent */
  --input-bg: rgba(30, 35, 45, 0.6); /* Darker Translucent */
  --table-header-bg: rgba(var(--accent-purple-rgb), 0.15);
  --table-row-hover-bg: rgba(var(--accent-purple-rgb), 0.08);

  /* RGB values for easier use in rgba() */
  --accent-purple-rgb: 199, 56, 255; /* From hsl(280 80% 60%) */
  --accent-green-rgb: 0, 204, 136; /* From hsl(160 80% 50%) */
  --accent-red-rgb: 255, 51, 51; /* From hsl(0 80% 60%) */
}

body {
  background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
}

.myanmar-pattern {
  background-image: 
    radial-gradient(circle at 25% 25%, rgba(var(--accent-purple-rgb), 0.15) 0%, transparent 50%),
    radial-gradient(circle at 75% 75%, rgba(var(--accent-green-rgb), 0.15) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(var(--accent-red-rgb), 0.1) 0%, transparent 50%);
  animation: patternMove 25s ease-in-out infinite;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: -2;
}

@keyframes patternMove {
  0%, 100% { background-position: 0% 0%, 100% 100%, 50% 50%; }
  33% { background-position: 100% 100%, 0% 0%, 75% 25%; }
  66% { background-position: 50% 50%, 75% 25%, 25% 75%; }
}

.myanmar-waves {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 80px;
  background: linear-gradient(45deg, 
    rgba(var(--accent-purple-rgb), 0.2), 
    rgba(var(--accent-green-rgb), 0.2), 
    rgba(var(--accent-red-rgb), 0.2));
  clip-path: polygon(0 100%, 0 60%, 25% 40%, 50% 60%, 75% 30%, 100% 50%, 100% 100%);
  animation: waveFloat 12s ease-in-out infinite;
  z-index: -1;
}

@keyframes waveFloat {
  0%, 100% { transform: translateY(0px) scaleY(1); }
  50% { transform: translateY(-10px) scaleY(1.1); }
}

.app-card {
  backdrop-filter: blur(20px);
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  box-shadow: 
    0 20px 40px -12px rgba(0, 0, 0, 0.8),
    0 0 0 1px rgba(var(--accent-purple-rgb), 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.05);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius: 16px;
}

.app-card:hover {
  transform: translateY(-2px);
  box-shadow: 
    0 25px 50px -12px rgba(var(--accent-purple-rgb), 0.25),
    0 0 0 1px rgba(var(--accent-purple-rgb), 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
  border-color: rgba(var(--accent-purple-rgb), 0.5);
}

.myanmar-btn {
  background: linear-gradient(135deg, var(--accent-purple), var(--accent-green));
  color: #000;
  font-weight: 700;
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  border: none;
  border-radius: 12px;
  padding: 12px 20px;
  cursor: pointer;
  box-shadow: 0 5px 15px rgba(var(--accent-purple-rgb), 0.2);
}

.myanmar-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
  transition: left 0.6s ease;
}

.myanmar-btn:hover::before {
  left: 100%;
}

.myanmar-btn:hover {
  background: linear-gradient(135deg, var(--accent-green), var(--accent-purple));
  transform: translateY(-1px);
  box-shadow: 0 10px 25px rgba(var(--accent-green-rgb), 0.4);
}

.btn-danger {
  background: linear-gradient(135deg, var(--accent-red), #FF6B6B);
  color: white;
  box-shadow: 0 5px 15px rgba(var(--accent-red-rgb), 0.2);
}

.btn-danger:hover {
  background: linear-gradient(135deg, #FF6B6B, var(--accent-red));
  box-shadow: 0 10px 25px rgba(var(--accent-red-rgb), 0.4);
}

.connection-status {
  position: fixed;
  top: 15px;
  right: 15px;
  z-index: 1000;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  backdrop-filter: blur(10px);
  animation: statusPulse 2s infinite;
  color: var(--text-primary);
}

.status-online {
  background: linear-gradient(135deg, var(--accent-green), #4ADE80);
  color: white;
  box-shadow: 0 0 20px rgba(var(--accent-green-rgb), 0.5);
}

.status-offline {
  background: linear-gradient(135deg, var(--accent-red), #EF4444);
  color: white;
  animation: statusShake 0.5s ease-in-out;
}

.status-connecting {
  background: linear-gradient(135deg, var(--accent-purple), #FCD34D);
  color: #000;
  animation: statusSpin 1s linear infinite;
}

@keyframes statusPulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.8; transform: scale(1.05); }
}

@keyframes statusShake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-3px); }
  75% { transform: translateX(3px); }
}

@keyframes statusSpin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.stats-card {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  border-radius: 12px;
}

.stats-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent-purple), var(--accent-green), var(--accent-red));
  opacity: 0;
  transition: opacity 0.3s ease;
}

.stats-card:hover::before {
  opacity: 1;
}

.stats-card:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 15px 35px rgba(var(--accent-purple-rgb), 0.2);
  border-color: rgba(var(--accent-purple-rgb), 0.3);
}

.app-input {
  background: var(--input-bg);
  border: 2px solid var(--border-color);
  backdrop-filter: blur(10px);
  color: var(--text-primary);
  transition: all 0.3s ease;
  border-radius: 12px;
  padding: 12px 16px;
}

.app-input:focus {
  border-color: var(--accent-purple);
  background: rgba(30, 35, 45, 0.8);
  outline: none;
  box-shadow: 0 0 25px rgba(var(--accent-purple-rgb), 0.3);
}

.app-input::placeholder {
  color: var(--text-secondary);
}

.app-table {
  backdrop-filter: blur(10px);
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  overflow: hidden;
}

.app-table th {
  background: var(--table-header-bg);
  color: var(--accent-purple);
  font-weight: 700;
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 0.5px;
  padding: 12px 8px;
}

.app-table td {
  padding: 12px 8px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  color: var(--text-primary);
}

.app-table tr:hover {
  background: var(--table-row-hover-bg);
}

.loading-spinner {
  border: 3px solid rgba(var(--accent-purple-rgb), 0.3);
  border-top: 3px solid var(--accent-purple);
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.notification {
  position: fixed;
  top: 70px;
  right: 15px;
  left: 15px;
  max-width: 400px;
  margin: 0 auto;
  padding: 12px 16px;
  border-radius: 10px;
  color: white;
  font-weight: 600;
  z-index: 1001;
  animation: slideInRight 0.4s ease-out;
  backdrop-filter: blur(15px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

@keyframes slideInRight {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.nav-btn {
  transition: all 0.3s ease;
  position: relative;
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 14px;
  color: var(--text-secondary);
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.nav-btn.active {
  background: linear-gradient(135deg, var(--accent-purple), var(--accent-green)) !important;
  color: #000 !important;
  box-shadow: 0 5px 15px rgba(var(--accent-purple-rgb), 0.4);
  border-color: var(--accent-purple) !important;
}

.nav-btn:not(.active):hover {
  background: rgba(var(--accent-purple-rgb), 0.1);
  color: var(--accent-purple);
  border-color: rgba(var(--accent-purple-rgb), 0.3);
}

.fade-in {
  animation: fadeInUp 0.6s ease-out forwards;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.status-active { color: var(--accent-green); }
.status-inactive, .status-banned, .status-rejected { color: var(--accent-red); }
.status-pending { color: #f59e0b; }


.news-card {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  transition: all 0.3s ease;
  margin-bottom: 16px;
}

.news-card:hover {
  border-color: rgba(var(--accent-purple-rgb), 0.3);
  transform: translateY(-2px);
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 20px;
}

.modal-content {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 24px;
  max-width: 90vw;
  max-height: 90vh;
  overflow-y: auto;
  backdrop-filter: blur(20px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

/* Mobile optimizations */
@media (max-width: 768px) {
  .container { padding: 8px; }
  .app-card { padding: 16px; margin: 8px; }
  .connection-status { top: 10px; right: 10px; font-size: 9px; padding: 6px 12px; }
  .notification { top: 50px; right: 10px; left: 10px; max-width: none; }
  .stats-card { margin-bottom: 12px; }
  .myanmar-btn { padding: 10px 16px; font-size: 14px; }
  .app-table { font-size: 12px; }
  .app-table th, .app-table td { padding: 8px 4px; }
  h1 { font-size: 20px; }
  h2 { font-size: 18px; }
  h3 { font-size: 16px; }
  .nav-btn { padding: 6px 10px; font-size: 12px; margin: 2px; }
  .modal-content { padding: 16px; max-width: 95vw; }
}

@media (max-width: 480px) {
  .myanmar-pattern { opacity: 0.7; }
  .myanmar-waves { height: 60px; }
  .app-card { padding: 12px; margin: 4px; }
  .grid { gap: 8px; }
  .stats-card { padding: 12px; }
  .app-table th, .app-table td { padding: 6px 2px; font-size: 11px; }
}

/* Scrollbar styling */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
::-webkit-scrollbar-thumb { background: var(--accent-purple); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-green); }

/* Loading overlay */
.loading-overlay {
  backdrop-filter: blur(8px);
  background: rgba(0,0,0,0.7);
}

.btn-small {
  padding: 6px 12px;
  font-size: 12px;
  border-radius: 8px;
}

.table-actions {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.hidden { display: none !important; }

/* Search input specific styles */
.search-input-container {
  position: relative;
}
.search-input-container .app-input {
  padding-left: 40px; /* Space for icon */
}
.search-input-container .search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-secondary);
  pointer-events: none;
}
</style>
</head>
<body class="text-white">
<div class="myanmar-pattern"></div>
<div class="myanmar-waves"></div>

<div id="connection-status" class="connection-status status-connecting">
<i class="fas fa-wifi"></i> ချိတ်ဆက်နေသည်...
</div>

<div class="container mx-auto px-2 py-4 max-w-6xl">
<div class="text-center mb-6 fade-in">
  <h1 class="text-2xl md:text-3xl lg:text-4xl font-orbitron font-bold mb-2 text-accent-purple">
    <i class="fas fa-shield-alt mr-2"></i>
    FPS GFX Tool
  </h1>
  <h2 class="text-lg md:text-xl lg:text-2xl font-orbitron font-semibold text-accent-green mb-2">
    MOBILE APPLICATION
  </h2>
  <div class="inline-block px-4 py-2 bg-gradient-to-r from-accent-purple to-accent-green text-black rounded-full font-bold text-sm">
    <i class="fas fa-mobile-alt mr-1"></i> USER INTERFACE
  </div>
</div>

<div id="notification-container"></div>

<div id="login-section" class="max-w-md mx-auto fade-in">
  <div class="app-card p-6">
    <h3 class="text-xl md:text-2xl font-orbitron font-bold text-center mb-6 text-accent-purple">
      <i class="fas fa-sign-in-alt mr-2"></i>
      KEY LOGIN
    </h3>
    <div class="space-y-4">
      <div class="relative search-input-container">
        <input 
          type="text" 
          id="login-key" 
          placeholder="Enter Your Key..." 
          class="app-input w-full"
        >
        <i class="fas fa-key search-icon"></i>
      </div>
      <button 
        onclick="userLogin()" 
        id="login-btn"
        class="myanmar-btn w-full flex items-center justify-center space-x-2"
      >
        <i class="fas fa-sign-in-alt"></i>
        <span id="login-text">LOGIN</span>
      </button>
    </div>
  </div>
</div>

<div id="profile-creation-section" class="max-w-md mx-auto fade-in hidden">
  <div class="app-card p-6">
    <h3 class="text-xl md:text-2xl font-orbitron font-bold text-center mb-6 text-accent-green">
      <i class="fas fa-user-plus mr-2"></i>
      CREATE PROFILE
    </h3>
    <p class="text-center text-text-secondary mb-4">
      သင်၏ Key အတွက် Profile မရှိသေးပါ။ Profile အသစ် ပြုလုပ်ပေးပါ။
    </p>
    <div class="space-y-4">
      <div class="relative search-input-container">
        <input 
          type="text" 
          id="profile-username" 
          placeholder="Username (တစ်ယောက်သုံးသာ)" 
          class="app-input w-full"
        >
        <i class="fas fa-user search-icon"></i>
      </div>
      <div class="relative search-input-container">
        <input 
          type="text" 
          id="profile-display-name" 
          placeholder="သင်၏ အမည်" 
          class="app-input w-full"
        >
        <i class="fas fa-signature search-icon"></i>
      </div>
      <div class="relative">
        <label for="profile-picture" class="block text-sm font-medium mb-2 text-text-secondary">Profile ပုံ (ထည့်ချင်မှထည့်ပါ)</label>
        <input 
          type="file" 
          id="profile-picture" 
          accept="image/*" 
          class="app-input w-full"
        >
      </div>
      <button 
        onclick="createProfile()" 
        id="create-profile-btn"
        class="myanmar-btn w-full flex items-center justify-center space-x-2"
      >
        <i class="fas fa-plus-circle"></i>
        <span id="create-profile-text">CREATE PROFILE</span>
      </button>
    </div>
  </div>
</div>

<div id="app-content" class="hidden">
  <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-6">
    <button onclick="showSection('home', this)" class="nav-btn active">
      <i class="fas fa-home mr-1"></i>
      <span class="hidden sm:inline">HOME</span>
      <span class="sm:hidden">Home</span>
    </button>
    <button onclick="showSection('news', this)" class="nav-btn">
      <i class="fas fa-newspaper mr-1"></i>
      <span class="hidden sm:inline">NEWS</span>
      <span class="sm:hidden">News</span>
    </button>
    <button onclick="showSection('products', this)" class="nav-btn">
      <i class="fas fa-box-open mr-1"></i>
      <span class="hidden sm:inline">PRODUCTS</span>
      <span class="sm:hidden">Products</span>
    </button>
    <button onclick="showSection('chat', this)" class="nav-btn">
      <i class="fas fa-comments mr-1"></i>
      <span class="hidden sm:inline">CHAT</span>
      <span class="sm:hidden">Chat</span>
    </button>
    <button onclick="showSection('support', this)" class="nav-btn">
      <i class="fas fa-headset mr-1"></i>
      <span class="hidden sm:inline">SUPPORT</span>
      <span class="sm:hidden">Support</span>
    </button>
    <button onclick="showSection('about', this)" class="nav-btn">
      <i class="fas fa-info-circle mr-1"></i>
      <span class="hidden sm:inline">ABOUT</span>
      <span class="sm:hidden">About</span>
    </button>
    <button onclick="showSection('mi', this)" class="nav-btn">
      <i class="fas fa-user-circle mr-1"></i>
      <span class="hidden sm:inline">MI</span>
      <span class="sm:hidden">Mi</span>
    </button>
    <button onclick="userLogout()" class="nav-btn btn-danger">
      <i class="fas fa-sign-out-alt mr-1"></i>
      <span class="hidden sm:inline">LOGOUT</span>
      <span class="sm:hidden">Logout</span>
    </button>
  </div>

  <div id="home-section" class="app-section">
    <div class="app-card p-4 md:p-8 text-center">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-4 text-accent-purple">
        <i class="fas fa-home mr-2"></i>
        DASHBOARD OVERVIEW
      </h3>
      <p class="text-text-secondary">
        Welcome to FPS GFX Tool.
      </p>
      <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="stats-card p-4">
          <i class="fas fa-download text-2xl text-blue-400 mb-2"></i>
          <h4 class="text-sm font-semibold text-text-secondary">TOTAL DOWNLOADS</h4>
          <p id="total-downloads" class="text-lg font-bold text-accent-purple">0</p>
        </div>
        <div class="stats-card p-4">
          <i class="fas fa-box-open text-2xl text-purple-400 mb-2"></i>
          <h4 class="text-sm font-semibold text-text-secondary">AVAILABLE PRODUCTS</h4>
          <p id="available-products" class="text-lg font-bold text-accent-green">0</p>
        </div>
      </div>
    </div>
  </div>

  <div id="news-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-newspaper mr-3"></i>
        LATEST NEWS
      </h3>
      <div id="news-list" class="space-y-4">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-center text-text-secondary">Loading news...</p>
      </div>
    </div>
  </div>

  <div id="products-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-box-open mr-3"></i>
        PRODUCTS & APKS
      </h3>
      <div id="products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="loading-spinner mx-auto mb-4 col-span-full"></div>
        <p class="text-center text-text-secondary col-span-full">Loading products...</p>
      </div>
    </div>
  </div>

  <div id="chat-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-comments mr-3"></i>
        GLOBAL CHAT
      </h3>
      <div id="chat-messages" class="bg-black bg-opacity-30 rounded-xl p-4 h-64 md:h-96 overflow-y-auto mb-6 border border-gray-700">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-center text-text-secondary">Loading messages...</p>
      </div>
      <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
        <textarea id="chat-input" placeholder="Type your message..." rows="3"
                  class="app-input flex-1 resize-none"></textarea>
        <button onclick="sendChatMessage()" 
                class="myanmar-btn flex items-center justify-center space-x-2 md:self-end">
          <i class="fas fa-paper-plane"></i>
          <span>SEND</span>
        </button>
      </div>
    </div>
  </div>

  <div id="support-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-headset mr-3"></i>
        SUPPORT
      </h3>
      <div id="support-messages" class="bg-black bg-opacity-30 rounded-xl p-4 h-64 md:h-96 overflow-y-auto mb-6 border border-gray-700">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-center text-text-secondary">Loading messages...</p>
      </div>
      <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
        <textarea id="support-input" placeholder="Type your support message..." rows="3"
                  class="app-input flex-1 resize-none"></textarea>
        <button onclick="sendSupportMessage()" 
                class="myanmar-btn flex items-center justify-center space-x-2 md:self-end">
          <i class="fas fa-paper-plane"></i>
          <span>SEND SUPPORT</span>
        </button>
      </div>
    </div>
  </div>

  <div id="about-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-info-circle mr-3"></i>
        ABOUT US
      </h3>
      <div id="about-content" class="space-y-4 text-text-secondary">
        <p>Loading about information...</p>
      </div>
    </div>
  </div>

  <div id="mi-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-user-circle mr-3"></i>
        MY PROFILE
      </h3>
      <div id="profile-details" class="space-y-4">
        <div class="flex flex-col items-center mb-6">
          <img id="mi-profile-picture" src="/placeholder.svg?height=100&width=100" alt="Profile Picture" class="w-24 h-24 rounded-full object-cover border-4 border-accent-purple mb-4">
          <h4 id="mi-display-name" class="text-xl font-bold text-text-primary"></h4>
          <p id="mi-username" class="text-text-secondary">@</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">KEY</label>
            <input type="text" id="mi-key-text" class="app-input w-full font-share-tech" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">ACCOUNT STATUS</label>
            <input type="text" id="mi-account-status" class="app-input w-full" readonly>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-2 text-text-secondary">NEW PROFILE PICTURE (OPTIONAL)</label>
            <input type="file" id="mi-new-profile-picture" accept="image/*" class="app-input w-full">
          </div>
          <div class="md:col-span-2">
            <button onclick="updateProfile()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
              <i class="fas fa-save"></i>
              <span>UPDATE PROFILE</span>
            </button>
          </div>
        </div>
      </div>
       <div class="mt-8">
        <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
          <i class="fas fa-shopping-bag mr-3"></i>
          MY PURCHASED ADMIN PRODUCTS
        </h3>
        <div id="my-purchased-products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="loading-spinner mx-auto mb-4 col-span-full"></div>
          <p class="text-center text-text-secondary col-span-full">Loading your purchased products...</p>
        </div>
      </div>
    </div>
  </div>

</div>
</div>

<div id="news-modal" class="modal hidden">
<div class="modal-content max-w-2xl">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-orbitron font-bold text-accent-purple">NEWS DETAILS</h2>
    <button onclick="closeModal('news-modal')" class="text-text-secondary hover:text-accent-red">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div id="news-modal-content">
    </div>
</div>
</div>

<div id="payment-modal" class="modal hidden">
<div class="modal-content max-w-md">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-orbitron font-bold text-accent-purple">MAKE PAYMENT</h2>
    <button onclick="closeModal('payment-modal')" class="text-text-secondary hover:text-accent-red">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div id="payment-modal-content" class="space-y-4">
    </div>
</div>
</div>


<div id="confirm-modal" class="modal hidden">
<div class="modal-content max-w-md">
  <div class="text-center">
    <i class="fas fa-exclamation-triangle text-4xl text-accent-red mb-4"></i>
    <h3 id="confirm-title" class="text-xl font-orbitron font-bold text-text-primary mb-4">ARE YOU SURE?</h3>
    <p id="confirm-message" class="text-text-secondary mb-6">This action cannot be undone.</p>
    <div class="flex space-x-4">
      <button onclick="closeConfirmModal()" class="myanmar-btn flex-1">
        <i class="fas fa-times mr-2"></i>
        CANCEL
      </button>
      <button id="confirm-action-btn" onclick="confirmAction()" class="btn-danger myanmar-btn flex-1">
        <i class="fas fa-check mr-2"></i>
        CONFIRM
      </button>
    </div>
  </div>
</div>
</div>

<div id="loading-overlay" class="fixed inset-0 loading-overlay flex items-center justify-center z-50 hidden">
<div class="app-card p-8 text-center">
  <div class="loading-spinner mx-auto mb-4" style="width: 40px; height: 40px;"></div>
  <p class="text-text-primary font-semibold">PROCESSING...</p>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
// ===================================================================================
// CONFIGURATION
// ===================================================================================
const CONFIG = {
  SUPABASE_URL: 'https://rliwdosxsbauwxkayjoa.supabase.co',
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsaXdkb3N4c2JhdXd4a2F5am9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxMDA2NjIsImV4cCI6MjA2OTY3NjY2Mn0.uDvU9eX3Cy--D9l6daGaO2QMpn1YnxMJYVlbaeIgHu4',
};

// ===================================================================================
// STATE MANAGEMENT
// ===================================================================================
let state = {
  supabase: null,
  isAuthenticated: false,
  currentSection: 'home',
  isConnected: false,
  confirmCallback: null,
  userProfile: null, // Stores current user's complete profile data from user_login
  keyInfo: null, // Stores key info when profile creation is needed
  realtimeChannels: [],
  selectedPurchase: { // Holds info for the current purchase process
      type: 'admin_product',
      product: null,
      paymentMethodId: null
  }
};

// ===================================================================================
// UTILITY FUNCTIONS
// ===================================================================================
const utils = {
    formatPrice: (price) => `${parseFloat(price || 0).toFixed(2)} MMK`,
    showLoading: (show) => {
        document.getElementById('loading-overlay').classList.toggle('hidden', !show);
    },
    showNotification: (message, type = 'info', duration = 5000) => {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600', warning: 'bg-yellow-600' };
        const icons = { success: 'fa-check-circle', error: 'fa-exclamation-triangle', info: 'fa-info-circle', warning: 'fa-exclamation-circle' };
        notification.className = `notification ${colors[type]}`;
        notification.innerHTML = `<div class="flex items-center justify-between"><div class="flex items-center"><i class="fas ${icons[type]} mr-2"></i><span>${message}</span></div><button onclick="this.parentElement.parentElement.remove()" class="ml-4"><i class="fas fa-times"></i></button></div>`;
        container.appendChild(notification);
        setTimeout(() => { if(notification.parentElement) notification.remove() }, duration);
    },
    updateConnectionStatus: (status) => {
        const el = document.getElementById('connection-status');
        el.className = 'connection-status';
        if (status === 'online') {
            el.classList.add('status-online');
            el.innerHTML = '<i class="fas fa-check-circle"></i> ONLINE';
        } else if (status === 'offline') {
            el.classList.add('status-offline');
            el.innerHTML = '<i class="fas fa-exclamation-triangle"></i> OFFLINE';
        } else {
            el.classList.add('status-connecting');
            el.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ချိတ်ဆက်နေသည်...';
        }
    }
};

// ===================================================================================
// INITIALIZATION
// ===================================================================================
document.addEventListener('DOMContentLoaded', initializeApp);

async function initializeApp() {
    utils.updateConnectionStatus('connecting');
    try {
        if (!CONFIG.SUPABASE_URL || !CONFIG.SUPABASE_ANON_KEY) throw new Error('Supabase URL or Key is missing!');
        
        state.supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        
        const { error } = await state.supabase.from('about').select('id').limit(1);
        if (error && error.code !== 'PGRST116') throw error;

        utils.updateConnectionStatus('online');
        utils.showNotification('Database connected successfully!', 'success');
        state.isConnected = true;
        
        const storedKey = localStorage.getItem('user_key');
        if (storedKey) {
            document.getElementById('login-key').value = storedKey;
            userLogin(true); // Silent login attempt
        }
    } catch (error) {
        console.error('Initialization Error:', error);
        utils.updateConnectionStatus('offline');
        utils.showNotification(`Connection failed: ${error.message}`, 'error');
    }
    document.getElementById('login-key').addEventListener('keypress', (e) => e.key === 'Enter' && userLogin());
}

// ===================================================================================
// AUTHENTICATION
// ===================================================================================
async function userLogin(isSilent = false) {
    if (!state.isConnected) return utils.showNotification('Database not connected.', 'warning');
    
    const loginKey = document.getElementById('login-key').value.trim();
    if (!loginKey) return utils.showNotification('Please enter a key.', 'warning');

    if (!isSilent) utils.showLoading(true);

    try {
        const { data, error } = await state.supabase.rpc('user_login', { input_key_text: loginKey });
        
        if (error) throw error;
        
        const result = data[0];
        if (!result.success) throw new Error(result.message);
        
        localStorage.setItem('user_key', loginKey);

        if (result.needs_profile) {
            state.keyInfo = result.user_data;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('app-content').classList.add('hidden');
            document.getElementById('profile-creation-section').classList.remove('hidden');
            utils.showNotification(result.message, 'info');
        } else {
            state.isAuthenticated = true;
            state.userProfile = result.user_data;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('profile-creation-section').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            if (!isSilent) utils.showNotification(result.message, 'success');
            
            await state.supabase.rpc('set_current_user_key', { key_text: loginKey });
            loadAllAppData();
            setupRealtimeSubscriptions();
        }

    } catch (error) {
        console.error('Login Error:', error);
        if (!isSilent) utils.showNotification(error.message, 'error');
        userLogout(true); // silent logout to clear state
    } finally {
        if (!isSilent) utils.showLoading(false);
    }
}

async function createProfile() {
    const username = document.getElementById('profile-username').value.trim();
    const displayName = document.getElementById('profile-display-name').value.trim();
    const profilePictureFile = document.getElementById('profile-picture').files[0];

    if (!username || !displayName) return utils.showNotification('Username and Display Name are required.', 'warning');

    utils.showLoading(true);
    try {
        let profilePictureUrl = null;
        if (profilePictureFile) {
            const filePath = `profiles/${state.keyInfo.access_key_id}/${Date.now()}`;
            const { error: uploadError } = await state.supabase.storage.from('profiles').upload(filePath, profilePictureFile);
            if (uploadError) throw uploadError;
            const { data: urlData } = state.supabase.storage.from('profiles').getPublicUrl(filePath);
            profilePictureUrl = urlData.publicUrl;
        }

        const { data, error } = await state.supabase.rpc('create_user_profile', {
            p_access_key_text: state.keyInfo.key_text,
            p_username: username,
            p_display_name: displayName,
            p_profile_picture: profilePictureUrl
        });

        if (error) throw error;

        const result = data[0];
        if (!result.success) throw new Error(result.message);

        state.isAuthenticated = true;
        state.userProfile = result.user_data;
        document.getElementById('profile-creation-section').classList.add('hidden');
        document.getElementById('app-content').classList.remove('hidden');
        utils.showNotification('Profile created successfully!', 'success');
        
        await state.supabase.rpc('set_current_user_key', { key_text: state.keyInfo.key_text });
        
        loadAllAppData();
        setupRealtimeSubscriptions();

    } catch (error) {
        console.error('Profile Creation Error:', error);
        utils.showNotification(error.message, 'error');
    } finally {
        utils.showLoading(false);
    }
}

function userLogout(isSilent = false) {
    const performLogout = () => {
        localStorage.removeItem('user_key');
        state.isAuthenticated = false;
        state.userProfile = null;
        state.keyInfo = null;
        state.realtimeChannels.forEach(channel => state.supabase.removeChannel(channel));
        state.realtimeChannels = [];
        
        document.getElementById('app-content').classList.add('hidden');
        document.getElementById('profile-creation-section').classList.add('hidden');
        document.getElementById('login-section').classList.remove('hidden');
        document.getElementById('login-key').value = '';
        if (!isSilent) utils.showNotification('Logged out successfully!', 'info');
    };
    if (isSilent) {
        performLogout();
    } else {
       showConfirmModal('Are you sure you want to logout?', performLogout);
    }
}

// ===================================================================================
// UI NAVIGATION & LAYOUT
// ===================================================================================
function showSection(section, buttonElement) {
    document.querySelectorAll('.app-section').forEach(sec => sec.classList.add('hidden'));
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    
    document.getElementById(`${section}-section`).classList.remove('hidden');
    buttonElement.classList.add('active');
    
    state.currentSection = section;
    loadSectionData(section);
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

function showConfirmModal(message, callback, title = "ARE YOU SURE?") {
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-message').textContent = message;
    state.confirmCallback = callback;
    document.getElementById('confirm-modal').classList.remove('hidden');
}

function closeConfirmModal() {
    document.getElementById('confirm-modal').classList.add('hidden');
    state.confirmCallback = null;
}

function confirmAction() {
    if (typeof state.confirmCallback === 'function') {
        state.confirmCallback();
    }
    closeConfirmModal();
}

// ===================================================================================
// DATA LOADING
// ===================================================================================
function loadAllAppData() {
    loadSectionData('home');
    showSection('home', document.querySelector('.nav-btn'));
}

function loadSectionData(section) {
    switch (section) {
        case 'home': loadDashboardData(); break;
        case 'news': loadNewsData(); break;
        case 'products': loadAdminProducts(); break;
        case 'chat': loadChatMessages(); break;
        case 'support': loadSupportMessages(); break;
        case 'about': loadAboutData(); break;
        case 'mi':
            loadMiProfile();
            loadMyPurchasedAdminProducts();
            break;
    }
}

async function loadDashboardData() {
    try {
        const { data, error } = await state.supabase.rpc('get_dashboard_stats');
        if (error) throw error;
        const stats = data[0];
        document.getElementById('total-downloads').textContent = stats.total_downloads || 0;
        document.getElementById('available-products').textContent = stats.total_admin_products || 0;
    } catch (e) {
        console.error("Error loading dashboard stats:", e);
    }
}

async function loadNewsData() {
    const container = document.getElementById('news-list');
    container.innerHTML = `<div class="loading-spinner mx-auto"></div>`;
    try {
        const { data, error } = await state.supabase.rpc('get_news_list', { p_limit: 20 });
        if (error) throw error;
        if (data && data.length > 0) {
            container.innerHTML = data.map(news => `
                <div class="news-card p-4">
                    <h4 class="text-lg font-semibold text-accent-purple mb-1">${news.title}</h4>
                    <p class="text-sm text-text-secondary">
                        <i class="fas fa-calendar mr-1"></i> ${new Date(news.created_at).toLocaleDateString()}
                    </p>
                    <p class="text-text-secondary text-sm my-2">${news.content.substring(0, 100)}...</p>
                    <button onclick="viewNewsDetails('${news.id}')" class="myanmar-btn btn-small">Read More</button>
                </div>
            `).join('');
        } else {
            container.innerHTML = `<p class="text-center text-text-secondary">No news available.</p>`;
        }
    } catch (e) {
        console.error("Error loading news:", e);
        container.innerHTML = `<p class="text-center text-accent-red">Failed to load news.</p>`;
    }
}

async function loadAdminProducts() {
    const container = document.getElementById('products-list');
    container.innerHTML = `<div class="loading-spinner mx-auto col-span-full"></div>`;
    try {
        const { data: products, error } = await state.supabase.rpc('get_admin_products');
        if (error) throw error;

        const { data: orders, error: orderError } = await state.supabase.from('orders').select('admin_product_id').eq('buyer_id', state.userProfile.id).eq('status', 'approved');
        if (orderError) throw orderError;
        const purchasedIds = orders.map(o => o.admin_product_id);

        if (products && products.length > 0) {
            container.innerHTML = products.map(p => {
                const isPurchased = purchasedIds.includes(p.id);
                return `
                <div class="app-card p-4 text-center flex flex-col">
                    <img src="${p.icon_url || 'https://via.placeholder.com/64'}" class="w-16 h-16 mx-auto mb-2 object-contain">
                    <h3 class="font-semibold">${p.product_name}</h3>
                    <p class="text-accent-green font-bold text-lg my-2">${p.price > 0 ? utils.formatPrice(p.price) : 'FREE'}</p>
                    <div class="mt-auto w-full">
                    ${isPurchased || p.price <= 0 ? 
                        `<a href="${p.file_url}" target="_blank" download class="myanmar-btn w-full block"><i class="fas fa-download mr-2"></i>DOWNLOAD</a>` :
                        `<button onclick="initiatePurchase('${p.id}')" class="myanmar-btn w-full"><i class="fas fa-shopping-cart mr-2"></i>PURCHASE</button>`
                    }
                    </div>
                </div>`;
            }).join('');
        } else {
            container.innerHTML = `<p class="text-center text-text-secondary col-span-full">No admin products available.</p>`;
        }
    } catch (e) {
        console.error("Error loading admin products:", e);
        container.innerHTML = `<p class="text-center text-accent-red col-span-full">Failed to load products.</p>`;
    }
}

async function loadMiProfile() {
    const p = state.userProfile;
    if (!p) return;
    document.getElementById('mi-profile-picture').src = p.profile_picture || 'https://via.placeholder.com/100';
    document.getElementById('mi-display-name').textContent = p.display_name;
    document.getElementById('mi-username').textContent = `@${p.username}`;
    document.getElementById('mi-key-text').value = p.key_text;
    document.getElementById('mi-account-status').value = p.account_status.toUpperCase();
    document.getElementById('mi-account-status').className = `app-input w-full status-${p.account_status}`;
}

async function loadMyPurchasedAdminProducts() {
    const container = document.getElementById('my-purchased-products-list');
    container.innerHTML = `<div class="loading-spinner mx-auto col-span-full"></div>`;
    try {
        const { data, error } = await state.supabase.rpc('get_user_orders', { p_user_id: state.userProfile.id, p_order_type: 'admin_product' });
        if (error) throw error;
        
        const approvedOrders = data.filter(o => o.status === 'approved');

        if (approvedOrders.length > 0) {
            container.innerHTML = approvedOrders.map(o => `
            <div class="app-card p-4">
                <p class="font-semibold">${o.product_name}</p>
                <p class="text-sm text-text-secondary">${utils.formatPrice(o.amount)} on ${new Date(o.created_at).toLocaleDateString()}</p>
                <p class="text-accent-green font-bold">Status: ${o.status.toUpperCase()}</p>
            </div>
            `).join('');
        } else {
            container.innerHTML = `<p class="text-text-secondary col-span-full">You have not purchased any admin products yet.</p>`;
        }
    } catch(e) {
        console.error("Error loading purchased products:", e);
        container.innerHTML = `<p class="text-accent-red col-span-full">Could not load purchases.</p>`;
    }
}

async function loadAboutData() {
    const container = document.getElementById('about-content');
    container.innerHTML = `<div class="loading-spinner mx-auto"></div>`;
    try {
        const { data, error } = await state.supabase.rpc('get_about_info');
        if (error) throw error;
        const info = data[0];
        container.innerHTML = `
            <p><strong>Contact:</strong> ${info.contact_name}</p>
            <p><strong>Phone:</strong> ${info.phone_number}</p>
            <p><strong>Email:</strong> ${info.email}</p>
            <div class="flex flex-wrap gap-4 mt-4">
              ${info.telegram_link ? `<a href="${info.telegram_link}" class="myanmar-btn" target="_blank"><i class="fab fa-telegram mr-2"></i>Telegram</a>` : ''}
              ${info.facebook_link ? `<a href="${info.facebook_link}" class="myanmar-btn" target="_blank"><i class="fab fa-facebook mr-2"></i>Facebook</a>` : ''}
            </div>
        `;
    } catch (e) { container.innerHTML = `<p class="text-accent-red">Could not load about info.</p>`}
}

async function loadChatMessages() {
    const container = document.getElementById('chat-messages');
    container.innerHTML = `<p class="text-center text-text-secondary">Chat feature is under development.</p>`;
}
async function loadSupportMessages() {
    const container = document.getElementById('support-messages');
    container.innerHTML = `<p class="text-center text-text-secondary">Support feature is under development.</p>`;
}

// ===================================================================================
// USER ACTIONS
// ===================================================================================
async function viewNewsDetails(newsId) {
    utils.showLoading(true);
    try {
        await state.supabase.rpc('increment_news_views', { p_news_id: newsId });
        const { data, error } = await state.supabase.from('news').select('*').eq('id', newsId).single();
        if (error) throw error;

        document.getElementById('news-modal-content').innerHTML = `
            <h3 class="text-xl font-bold">${data.title}</h3>
            <p class="text-sm text-text-secondary mb-4">Views: ${data.views}</p>
            <p class="whitespace-pre-wrap">${data.content}</p>
        `;
        document.getElementById('news-modal').classList.remove('hidden');
    } catch(e) {
        utils.showNotification('Error fetching news details.', 'error');
    } finally {
        utils.showLoading(false);
    }
}

async function initiatePurchase(productId) {
    utils.showLoading(true);
    try {
        const { data: product, error } = await state.supabase.from('admin_products').select('*').eq('id', productId).single();
        if (error) throw error;

        state.selectedPurchase.product = product;
        
        const { data: methods, error: methodError } = await state.supabase.rpc('get_payment_methods');
        if (methodError) throw methodError;
        
        const paymentModalContent = document.getElementById('payment-modal-content');
        paymentModalContent.innerHTML = `
            <h3 class="text-xl font-semibold">${product.product_name}</h3>
            <p class="text-accent-green font-bold text-lg">${utils.formatPrice(product.price)}</p>
            <h4 class="font-semibold mt-4">Select Payment Method</h4>
            <div class="space-y-2">
            ${methods.map(m => `
                <label class="block p-2 border border-border-color rounded-md hover:bg-secondary-bg">
                    <input type="radio" name="payment_method" value="${m.id}" onchange="state.selectedPurchase.paymentMethodId = '${m.id}'">
                    <span class="ml-2">${m.method_name} (${m.account_info})</span>
                     ${m.qr_code_image ? `<img src="${m.qr_code_image}" class="w-24 h-24 mt-2 rounded-md" alt="QR Code">` : ''}
                </label>
            `).join('')}
            </div>
            <label class="block mt-4">Upload Receipt</label>
            <input type="file" id="receipt-upload" class="app-input w-full" accept="image/*">
            <button onclick="submitPurchase()" class="myanmar-btn w-full mt-4">SUBMIT ORDER</button>
        `;
        document.getElementById('payment-modal').classList.remove('hidden');
    } catch(e) {
        utils.showNotification('Error preparing purchase.', 'error');
        console.error(e);
    } finally {
        utils.showLoading(false);
    }
}

async function submitPurchase() {
    const { product, paymentMethodId } = state.selectedPurchase;
    const receiptFile = document.getElementById('receipt-upload').files[0];

    if (!paymentMethodId) return utils.showNotification('Please select a payment method.', 'warning');
    if (!receiptFile) return utils.showNotification('Please upload a payment receipt.', 'warning');

    utils.showLoading(true);
    try {
        const filePath = `receipts/${state.userProfile.id}/${Date.now()}`;
        const { error: uploadError } = await state.supabase.storage.from('receipts').upload(filePath, receiptFile);
        if (uploadError) throw uploadError;
        const { data: urlData } = state.supabase.storage.from('receipts').getPublicUrl(filePath);

        const { data, error } = await state.supabase.rpc('create_order_enhanced', {
            p_buyer_id: state.userProfile.id,
            p_order_type: 'admin_product',
            p_product_id: product.id,
            p_payment_method_id: paymentMethodId,
            p_amount: product.price,
            p_receipt_image: urlData.publicUrl
        });
        
        if (error) throw error;
        
        const result = data[0];
        if (!result.success) throw new Error(result.message);
        
        utils.showNotification('Order submitted successfully! It is now pending approval.', 'success');
        closeModal('payment-modal');
        loadAdminProducts();

    } catch(e) {
        console.error("Error submitting purchase:", e);
        utils.showNotification(e.message, 'error');
    } finally {
        utils.showLoading(false);
    }
}

async function updateProfile() {
    const newPicFile = document.getElementById('mi-new-profile-picture').files[0];
    if(!newPicFile) {
        utils.showNotification("Please select a new profile picture to update.", "info");
        return;
    }

    utils.showLoading(true);
    try {
        let profilePictureUrl = state.userProfile.profile_picture;
        if (newPicFile) {
            const filePath = `profiles/${state.userProfile.id}/${Date.now()}`;
            const { error: uploadError } = await state.supabase.storage.from('profiles').upload(filePath, newPicFile);
            if (uploadError) throw uploadError;
            const { data: urlData } = state.supabase.storage.from('profiles').getPublicUrl(filePath);
            profilePictureUrl = urlData.publicUrl;
        }

        const { data, error } = await state.supabase.rpc('update_user_profile', {
            p_user_id: state.userProfile.id,
            p_profile_picture: profilePictureUrl
        });
        if(error) throw error;

        utils.showNotification("Profile updated successfully!", "success");
        state.userProfile.profile_picture = profilePictureUrl;
        loadMiProfile();

    } catch(e) {
        console.error("Error updating profile", e);
        utils.showNotification("Failed to update profile.", "error");
    } finally {
        utils.showLoading(false);
    }
}

async function sendChatMessage() {
     utils.showNotification('Chat feature is under development.', 'info');
}
async function sendSupportMessage() {
     utils.showNotification('Support feature is under development.', 'info');
}


// ===================================================================================
// REALTIME SUBSCRIPTIONS
// ===================================================================================
function setupRealtimeSubscriptions() {
    state.realtimeChannels.forEach(channel => state.supabase.removeChannel(channel));
    state.realtimeChannels = [];
    
    const newsChannel = state.supabase.channel('public:news')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'news' }, payload => {
            if (state.currentSection === 'news') loadNewsData();
        }).subscribe();
    state.realtimeChannels.push(newsChannel);

    const productsChannel = state.supabase.channel('public:admin_products')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'admin_products' }, payload => {
          if (state.currentSection === 'products') loadAdminProducts();
          if (state.currentSection === 'home') loadDashboardData();
      }).subscribe();
    state.realtimeChannels.push(productsChannel);

    const ordersChannel = state.supabase.channel('public:orders')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'orders', filter: `buyer_id=eq.${state.userProfile.id}` }, payload => {
          if (state.currentSection === 'products') loadAdminProducts(); // to update purchase status
          if (state.currentSection === 'mi') loadMyPurchasedAdminProducts();
      }).subscribe();
    state.realtimeChannels.push(ordersChannel);
}
</script>
</body>
</html>
