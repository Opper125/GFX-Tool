<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FPS GFX Tool</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    body {
      background: linear-gradient(180deg, #1a1a1a, #2a2a2a);
      color: #fff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .container {
      background: #222;
      padding: 24px;
      border-radius: 16px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.8s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-16px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h1, h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 24px;
      text-align: center;
      color: #ffd700;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 12px;
      margin: 12px 0;
      border: none;
      border-radius: 8px;
      background: #333;
      color: #fff;
      font-size: 16px;
      transition: background 0.3s, transform 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      background: #444;
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
    }
    button {
      background: linear-gradient(45deg, #ffd700, #ff8c00);
      font-weight: 600;
      cursor: pointer;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(255, 215, 0, 0.4);
    }
    .pro-badge {
      position: fixed;
      top: 16px;
      right: 16px;
      background: linear-gradient(45deg, #ffd700, #ff8c00);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      animation: glow 1.5s ease-in-out infinite alternate;
      box-shadow: none;
      transform: translateZ(0);
    }
    @keyframes glow {
      from { box-shadow: 0 0 8px rgba(255, 215, 0, 0.6); }
      to { box-shadow: 0 0 16px rgba(255, 215, 0, 0.8); }
    }
    .message {
      padding: 12px;
      margin: 12px 0;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
      animation: slideIn 0.5s ease-out;
    }
    .error { background: #ff4444; }
    .success { background: #44ff44; }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-16px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .game-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
      margin: 16px 0;
    }
    .game-card {
      background: #333;
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.3s, background 0.3s;
    }
    .game-card:hover {
      transform: scale(1.05);
      background: #444;
    }
    .game-card img {
      width: 80px;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .game-card p {
      font-size: 14px;
      margin: 0;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 12px 0;
      font-size: 14px;
    }
    .menu {
      display: flex;
      justify-content: space-around;
      background: #333;
      padding: 12px;
      border-radius: 8px;
      margin-top: 24px;
    }
    .menu button {
      flex: 1;
      margin: 0 4px;
    }
    .news-card {
      background: #333;
      padding: 16px;
      border-radius: 12px;
      margin: 16px 0;
    }
    .news-card img {
      max-width: 100%;
      border-radius: 8px;
      margin: 8px 0;
    }
    .news-card .views {
      font-size: 12px;
      color: #ffd700;
    }
    .comment {
      background: #444;
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
      font-size: 14px;
    }
    .comment.reply {
      margin-left: 24px;
    }
    .profile-pic {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 8px;
      vertical-align: middle;
    }
    @media (max-width: 480px) {
      .container { padding: 16px; }
      h1, h2 { font-size: 20px; }
      input, select, button, textarea { font-size: 14px; }
      .menu { flex-direction: column; }
      .menu button { margin: 4px 0; }
    }
  </style>
</head>
<body>
  <div class="pro-badge">Pro</div>
  <div class="container" id="main-container">
    <h1>FPS GFX Tool</h1>
    <div id="status"></div>
    <button onclick="showAbout()">About</button>
    <div id="about-section" style="display: none;">
      <h2>About Us</h2>
      <div id="about-content"></div>
    </div>
    <input type="text" id="key-input" placeholder="Enter Key" required>
    <button onclick="login()">Login</button>
    <div id="main-content" style="display: none;">
      <div id="home-section">
        <div id="game-selection">
          <h2>Select Game</h2>
          <div class="game-grid">
            <div class="game-card" onclick="selectGame('korean')">
              <img src="https://github.com/user/repo/raw/main/pubg-kr.png" alt="PUBG Korean">
              <p>PUBG Korean</p>
            </div>
            <div class="game-card" onclick="selectGame('global')">
              <img src="https://github.com/user/repo/raw/main/pubg-gl.png" alt="PUBG Global">
              <p>PUBG Global</p>
            </div>
          </div>
        </div>
        <div id="config-form" style="display: none;">
          <h2>Configure Settings</h2>
          <select id="fps">
            <option value="60">60 FPS</option>
            <option value="90">90 FPS</option>
            <option value="120">120 FPS</option>
            <option value="144">144 FPS</option>
          </select>
          <select id="bit-type">
            <option value="32bit">32-bit</option>
            <option value="64bit">64-bit</option>
          </select>
          <label class="checkbox-label">
            <input type="checkbox" id="ipad-view"> Enable iPad View
          </label>
          <input type="number" id="dpi" placeholder="DPI (e.g., 320)" disabled>
          <input type="text" id="resolution" placeholder="Resolution (e.g., 1920x1080)" disabled>
          <button onclick="generateFile()">Generate File</button>
        </div>
        <div id="files-list"></div>
      </div>
      <div id="news-section" style="display: none;">
        <h2>News</h2>
        <button onclick="showCreateProfile()">Create Profile</button>
        <div id="create-profile" style="display: none;">
          <h3>Create Profile</h3>
          <input type="text" id="profile-username" placeholder="Username">
          <input type="text" id="profile-name" placeholder="Name">
          <input type="file" id="profile-picture" accept="image/*">
          <button onclick="createProfile()">Save Profile</button>
        </div>
        <button onclick="showPostNews()" id="post-news-btn" style="display: none;">Post News</button>
        <div id="post-news" style="display: none;">
          <h3>Post News</h3>
          <input type="text" id="news-title" placeholder="Title">
          <textarea id="news-content" placeholder="Content"></textarea>
          <input type="text" id="news-youtube" placeholder="YouTube Link">
          <input type="file" id="news-image" accept="image/*">
          <button onclick="postNews()">Post</button>
        </div>
        <div id="news-list"></div>
      </div>
      <div id="support-section" style="display: none;">
        <h2>Support</h2>
        <div id="support-messages"></div>
        <textarea id="support-input" placeholder="Type your message"></textarea>
        <button onclick="sendSupportMessage()">Send</button>
      </div>
      <div id="telegram-section" style="display: none;">
        <h2>Telegram</h2>
        <div id="telegram-posts"></div>
      </div>
      <div class="menu">
        <button onclick="showSection('home')">Home</button>
        <button onclick="showSection('news')">News</button>
        <button onclick="showSection('support')">Support</button>
        <button onclick="showSection('telegram')">Telegram</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://rliwdosxsbauwxkayjoa.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsaXdkb3N4c2JhdXd4a2F5am9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxMDA2NjIsImV4cCI6MjA2OTY3NjY2Mn0.uDvU9eX3Cy--D9l6daGaO2QMpn1YnxMJYVlbaeIgHu4';
    const TELEGRAM_BOT_TOKEN = '8493584268:AAEpDAPbwRDJYBf9VjlxSiELc4bTrrn_7xw';
    const TELEGRAM_GROUP_ID = '-1002863080440';
    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let deviceId = '';
    let sessionId = '';
    let keyExpiration = null;
    let profileId = null;
    let viewTimers = {};

    async function checkInternet() {
      if (!navigator.onLine) {
        showMessage('No internet connection!', 'error');
        return false;
      }
      return true;
    }

    async function showAbout() {
      if (!(await checkInternet())) return;
      const { data, error } = await supabase.from('about').select('*').single();
      if (error || !data) {
        showMessage('Failed to load about info!', 'error');
        return;
      }
      const content = `
        <p>Telegram: <a href="${data.telegram || '#'}" target="_blank">${data.telegram || 'N/A'}</a></p>
        <p>Viber: <a href="${data.viber || '#'}" target="_blank">${data.viber || 'N/A'}</a></p>
        <p>Phone: ${data.phone || 'N/A'}</p>
      `;
      document.getElementById('about-content').innerHTML = content;
      document.getElementById('about-section').style.display = 'block';
      document.getElementById('key-input').style.display = 'none';
      document.querySelector('button[onclick="login()"]').style.display = 'none';
      document.querySelector('button[onclick="showAbout()"]').style.display = 'none';
    }

    async function login() {
      if (!(await checkInternet())) return;
      const key = document.getElementById('key-input').value.trim();
      if (!key) {
        showMessage('Please enter a key!', 'error');
        return;
      }

      const { data, error } = await supabase
        .from('keys')
        .select('*')
        .eq('key_text', key)
        .eq('is_active', true)
        .single();

      if (error || !data || new Date(data.expires_at) < new Date()) {
        showMessage('Invalid or expired key!', 'error');
        return;
      }

      const deviceInfo = await detectDevice();
      deviceId = deviceInfo.id;
      const { data: sessionCount } = await supabase
        .from('sessions')
        .select('id', { count: 'exact' })
        .eq('key_id', data.id)
        .eq('is_active', true);

      if (sessionCount.length >= data.max_devices) {
        showMessage('Device limit reached for this key!', 'error');
        return;
      }

      const { error: sessionError } = await supabase.from('sessions').insert({
        key_id: data.id,
        device_id: deviceId,
        is_active: true,
      });

      if (sessionError) {
        showMessage('Login failed!', 'error');
        return;
      }

      sessionId = data.id;
      keyExpiration = new Date(data.expires_at);
      showMessage('Login successful!', 'success');
      document.getElementById('key-input').style.display = 'none';
      document.querySelector('button[onclick="login()"]').style.display = 'none';
      document.querySelector('button[onclick="showAbout()"]').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
      startExpirationTimer(data.expires_at);
      requestPermissions();
      loadUserFiles();
      checkProfile();
    }

    async function detectDevice() {
      const ua = navigator.userAgent;
      const architecture = ua.includes('64') ? '64bit' : '32bit';
      const androidMatch = ua.match(/Android\s+([\d.]+)/);
      const modelMatch = ua.match(/\(([^;]+);/);
      const id = btoa(ua).slice(0, 255);
      const device = {
        id,
        user_agent: ua,
        architecture,
        android_version: androidMatch ? androidMatch[1] : 'Unknown',
        model: modelMatch ? modelMatch[1] : 'Unknown',
      };
      await supabase.from('devices').upsert(device);
      return device;
    }

    async function requestPermissions() {
      try {
        // Placeholder for storage permission
        showMessage('Storage permissions granted!', 'success');
      } catch (e) {
        showMessage('Storage permissions denied!', 'error');
      }
    }

    function startExpirationTimer(expiresAt) {
      const timer = setInterval(() => {
        const now = new Date();
        if (now >= new Date(expiresAt)) {
          showMessage('Key expired! Logging out...', 'error');
          logout();
          clearInterval(timer);
          return;
        }
        const timeLeft = new Date(expiresAt - now);
        const days = timeLeft.getUTCDate() - 1;
        const hours = timeLeft.getUTCHours();
        const minutes = timeLeft.getUTCMinutes();
        const dayName = new Date().toLocaleString('en-US', { weekday: 'long' });
        document.getElementById('status').innerHTML = `Key expires on ${dayName} in: ${days}d ${hours}h ${minutes}m`;
      }, 1000);
    }

    async function logout() {
      await supabase.from('sessions').update({ is_active: false }).eq('device_id', deviceId).eq('is_active', true);
      document.getElementById('main-container').innerHTML = `
        <h1>FPS GFX Tool</h1>
        <div id="status"></div>
        <button onclick="showAbout()">About</button>
        <div id="about-section" style="display: none;">
          <h2>About Us</h2>
          <div id="about-content"></div>
        </div>
        <input type="text" id="key-input" placeholder="Enter Key" required>
        <button onclick="login()">Login</button>
      `;
      showMessage('Logged out!', 'error');
    }

    function showSection(section) {
      document.getElementById('home-section').style.display = section === 'home' ? 'block' : 'none';
      document.getElementById('news-section').style.display = section === 'news' ? 'block' : 'none';
      document.getElementById('support-section').style.display = section === 'support' ? 'block' : 'none';
      document.getElementById('telegram-section').style.display = section === 'telegram' ? 'block' : 'none';
      if (section === 'news') loadNews();
      if (section === 'support') loadSupportMessages();
      if (section === 'telegram') loadTelegramPosts();
    }

    function selectGame(version) {
      document.getElementById('game-selection').style.display = 'none';
      document.getElementById('config-form').style.display = 'block';
      document.getElementById('config-form').dataset.game = version;
    }

    async function generateFile() {
      if (!(await checkInternet())) return;
      const fps = document.getElementById('fps').value;
      const bitType = document.getElementById('bit-type').value;
      const ipadView = document.getElementById('ipad-view').checked;
      const dpi = document.getElementById('dpi').value || null;
      const resolution = document.getElementById('resolution').value || null;
      const gameVersion = document.getElementById('config-form').dataset.game;

      const fileContent = JSON.stringify({ fps, bitType, ipadView, dpi, resolution, gameVersion });
      const filePath = `/FPS_OPPER/active_${Date.now()}.sav`;

      const { error } = await supabase.from('generated_files').insert({
        session_id: sessionId,
        game_version: gameVersion,
        fps: parseInt(fps),
        bit_type: bitType,
        ipad_view: ipadView,
        dpi: dpi ? parseInt(dpi) : null,
        resolution,
        file_path: filePath,
      });

      if (error) {
        showMessage('File generation failed!', 'error');
        return;
      }

      const blob = new Blob([fileContent], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `active_${Date.now()}.sav`;
      a.click();
      URL.revokeObjectURL(url);
      showMessage('File generated and downloaded to FPS_OPPER folder!', 'success');
      loadUserFiles();
    }

    async function loadUserFiles() {
      const { data, error } = await supabase
        .from('generated_files')
        .select('*')
        .eq('session_id', sessionId)
        .order('created_at', { ascending: false });

      if (error) {
        showMessage('Failed to load files!', 'error');
        return;
      }

      const filesList = document.getElementById('files-list');
      filesList.innerHTML = '<h2>Your Files</h2>';
      if (data.length === 0) {
        filesList.innerHTML += '<p>No files generated yet.</p>';
        return;
      }
      data.forEach(file => {
        filesList.innerHTML += `<p>${file.game_version} - ${file.fps} FPS - ${file.bit_type} - <a href="${file.file_path}" download>Download</a></p>`;
      });
    }

    async function checkProfile() {
      const { data, error } = await supabase.from('profiles').select('*').eq('id', sessionId).single();
      if (error || !data) {
        document.getElementById('create-profile').style.display = 'block';
        document.getElementById('post-news-btn').style.display = 'none';
      } else {
        profileId = data.id;
        document.getElementById('create-profile').style.display = 'none';
        document.getElementById('post-news-btn').style.display = data.is_banned ? 'none' : 'block';
        if (data.is_banned) showMessage('Your profile is banned!', 'error');
      }
    }

    async function createProfile() {
      const username = document.getElementById('profile-username').value.trim();
      const name = document.getElementById('profile-name').value.trim();
      const file = document.getElementById('profile-picture').files[0];

      if (!username || !name) {
        showMessage('Please fill all fields!', 'error');
        return;
      }

      let imageUrl = null;
      if (file) {
        const { data, error } = await supabase.storage.from('profiles').upload(`public/${sessionId}/${file.name}`, file);
        if (error) {
          showMessage('Image upload failed!', 'error');
          return;
        }
        imageUrl = `${SUPABASE_URL}/storage/v1/object/public/profiles/${data.path}`;
      }

      const { error } = await supabase.from('profiles').upsert({
        id: sessionId,
        username,
        name,
        profile_picture: imageUrl,
      });

      if (error) {
        showMessage('Profile creation failed!', 'error');
        return;
      }

      profileId = sessionId;
      showMessage('Profile created successfully!', 'success');
      document.getElementById('create-profile').style.display = 'none';
      document.getElementById('post-news-btn').style.display = 'block';
    }

    function showCreateProfile() {
      document.getElementById('create-profile').style.display = 'block';
      document.getElementById('post-news').style.display = 'none';
    }

    function showPostNews() {
      document.getElementById('create-profile').style.display = 'none';
      document.getElementById('post-news').style.display = 'block';
    }

    async function postNews() {
      const title = document.getElementById('news-title').value.trim();
      const content = document.getElementById('news-content').value.trim();
      const youtubeLink = document.getElementById('news-youtube').value.trim();
      const file = document.getElementById('news-image').files[0];

      if (!title || !content) {
        showMessage('Please fill title and content!', 'error');
        return;
      }

      let imageUrl = null;
      if (file) {
        const { data, error } = await supabase.storage.from('news').upload(`public/${sessionId}/${file.name}`, file);
        if (error) {
          showMessage('Image upload failed!', 'error');
          return;
        }
        imageUrl = `${SUPABASE_URL}/storage/v1/object/public/news/${data.path}`;
      }

      const { error } = await supabase.from('news').insert({
        profile_id: profileId,
        title,
        content,
        youtube_link: youtubeLink || null,
        image_url: imageUrl,
      });

      if (error) {
        showMessage('News posting failed!', 'error');
        return;
      }

      showMessage('News posted successfully!', 'success');
      document.getElementById('post-news').style.display = 'none';
      loadNews();
    }

    async function loadNews() {
      const { data, error } = await supabase
        .from('news')
        .select('*, profiles(username, name, profile_picture)')
        .order('created_at', { ascending: false });

      if (error) {
        showMessage('Failed to load news!', 'error');
        return;
      }

      const newsList = document.getElementById('news-list');
      newsList.innerHTML = '';
      data.forEach(news => {
        const canEdit = news.profile_id === profileId || news.is_admin;
        newsList.innerHTML += `
          <div class="news-card" id="news-${news.id}">
            <p><img src="${news.profiles?.profile_picture || 'default.png'}" class="profile-pic">${news.profiles?.username || 'Admin'} (${news.profiles?.name || 'Admin'})</p>
            <h3>${news.title}</h3>
            <p>${news.content}</p>
            ${news.image_url ? `<img src="${news.image_url}" alt="News Image">` : ''}
            ${news.youtube_link ? `<p><a href="${news.youtube_link}" target="_blank">Watch on YouTube</a></p>` : ''}
            <p class="views">Views: <span id="views-${news.id}">${news.views}</span></p>
            ${canEdit ? `
              <button onclick="editNews('${news.id}', '${news.title}', '${news.content}', '${news.youtube_link || ''}')">Edit</button>
              <button onclick="deleteNews('${news.id}')">Delete</button>
            ` : ''}
            <div id="comments-${news.id}"></div>
            <textarea id="comment-input-${news.id}" placeholder="Add a comment"></textarea>
            <button onclick="postComment('${news.id}')">Comment</button>
          </div>
        `;
        loadComments(news.id);
        startViewTimer(news.id);
      });
    }

    function startViewTimer(newsId) {
      if (viewTimers[newsId]) clearTimeout(viewTimers[newsId]);
      viewTimers[newsId] = setTimeout(async () => {
        const { data, error } = await supabase
          .from('news')
          .update({ views: supabase.sql('views + 1') })
          .eq('id', newsId)
          .select('views')
          .single();
        if (!error) document.getElementById(`views-${newsId}`).textContent = data.views;
      }, 3000);
    }

    async function editNews(id, title, content, youtubeLink) {
      const newTitle = prompt('Edit title:', title);
      const newContent = prompt('Edit content:', content);
      const newYoutubeLink = prompt('Edit YouTube link:', youtubeLink);
      const file = prompt('Upload new image (not supported in prompt; use form in production):');

      const updates = { title: newTitle, content: newContent, youtube_link: newYoutubeLink || null };
      if (file) {
        // Implement file upload logic similar to postNews
      }

      const { error } = await supabase.from('news').update(updates).eq('id', id);
      if (error) {
        showMessage('News update failed!', 'error');
        return;
      }

      showMessage('News updated successfully!', 'success');
      loadNews();
    }

    async function deleteNews(id) {
      const { error } = await supabase.from('news').delete().eq('id', id);
      if (error) {
        showMessage('News deletion failed!', 'error');
        return;
      }

      showMessage('News deleted successfully!', 'success');
      loadNews();
    }

    async function postComment(newsId) {
      const content = document.getElementById(`comment-input-${newsId}`).value.trim();
      if (!content) {
        showMessage('Please enter a comment!', 'error');
        return;
      }

      const { error } = await supabase.from('comments').insert({
        news_id: newsId,
        profile_id: profileId,
        content,
      });

      if (error) {
        showMessage('Comment posting failed!', 'error');
        return;
      }

      showMessage('Comment posted successfully!', 'success');
      document.getElementById(`comment-input-${newsId}`).value = '';
      loadComments(newsId);
    }

    async function loadComments(newsId) {
      const { data, error } = await supabase
        .from('comments')
        .select('*, profiles(username, name, profile_picture)')
        .eq('news_id', newsId)
        .order('created_at', { ascending: true });

      if (error) {
        showMessage('Failed to load comments!', 'error');
        return;
      }

      const commentsDiv = document.getElementById(`comments-${newsId}`);
      commentsDiv.innerHTML = '';
      const renderComment = (comment, isReply = false) => {
        const canEdit = comment.profile_id === profileId;
        commentsDiv.innerHTML += `
          <div class="comment ${isReply ? 'reply' : ''}">
            <p><img src="${comment.profiles?.profile_picture || 'default.png'}" class="profile-pic">${comment.profiles?.username || 'Anonymous'}</p>
            <p>${comment.content}</p>
            ${canEdit ? `
              <button onclick="editComment('${comment.id}', '${comment.content}', '${newsId}')">Edit</button>
              <button onclick="deleteComment('${comment.id}', '${newsId}')">Delete</button>
            ` : ''}
            <button onclick="showReplyForm('${comment.id}', '${newsId}')">Reply</button>
            <div id="reply-form-${comment.id}" style="display: none;">
              <textarea id="reply-input-${comment.id}" placeholder="Reply"></textarea>
              <button onclick="postReply('${comment.id}', '${newsId}')">Post Reply</button>
            </div>
          </div>
        `;
        const replies = data.filter(c => c.parent_id === comment.id);
        replies.forEach(reply => renderComment(reply, true));
      };

      data.filter(c => !c.parent_id).forEach(comment => renderComment(comment));
    }

    function showReplyForm(commentId, newsId) {
      document.getElementById(`reply-form-${commentId}`).style.display = 'block';
    }

    async function postReply(commentId, newsId) {
      const content = document.getElementById(`reply-input-${commentId}`).value.trim();
      if (!content) {
        showMessage('Please enter a reply!', 'error');
        return;
      }

      const { error } = await supabase.from('comments').insert({
        news_id: newsId,
        profile_id: profileId,
        content,
        parent_id: commentId,
      });

      if (error) {
        showMessage('Reply posting failed!', 'error');
        return;
      }

      showMessage('Reply posted successfully!', 'success');
      document.getElementById(`reply-input-${commentId}`).value = '';
      document.getElementById(`reply-form-${commentId}`).style.display = 'none';
      loadComments(newsId);
    }

    async function editComment(id, content, newsId) {
      const newContent = prompt('Edit comment:', content);
      if (!newContent) return;

      const { error } = await supabase.from('comments').update({ content: newContent }).eq('id', id);
      if (error) {
        showMessage('Comment update failed!', 'error');
        return;
      }

      showMessage('Comment updated successfully!', 'success');
      loadComments(newsId);
    }

    async function deleteComment(id, newsId) {
      const { error } = await supabase.from('comments').delete().eq('id', id);
      if (error) {
        showMessage('Comment deletion failed!', 'error');
        return;
      }

      showMessage('Comment deleted successfully!', 'success');
      loadComments(newsId);
    }

    async function loadSupportMessages() {
      const { data, error } = await supabase
        .from('support_messages')
        .select('*, profiles(username)')
        .eq('profile_id', profileId)
        .order('created_at', { ascending: true });

      if (error) {
        showMessage('Failed to load messages!', 'error');
        return;
      }

      const messagesDiv = document.getElementById('support-messages');
      messagesDiv.innerHTML = '';
      data.forEach(msg => {
        messagesDiv.innerHTML += `
          <div class="message ${msg.is_from_user ? 'user' : 'admin'}">
            <p>${msg.profiles?.username || 'Admin'}: ${msg.content}</p>
          </div>
        `;
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function sendSupportMessage() {
      const content = document.getElementById('support-input').value.trim();
      if (!content) {
        showMessage('Please enter a message!', 'error');
        return;
      }

      const { error } = await supabase.from('support_messages').insert({
        profile_id: profileId,
        content,
        is_from_user: true,
      });

      if (error) {
        showMessage('Message sending failed!', 'error');
        return;
      }

      // Send to Telegram Bot
      await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          chat_id: TELEGRAM_GROUP_ID,
          text: `Support Message from ${profileId}: ${content}`,
        }),
      });

      showMessage('Message sent!', 'success');
      document.getElementById('support-input').value = '';
      loadSupportMessages();
    }

    async function loadTelegramPosts() {
      // Placeholder: Fetch posts from Telegram group using Bot API
      const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getChatHistory?chat_id=${TELEGRAM_GROUP_ID}`);
      const posts = await response.json();
      const postsDiv = document.getElementById('telegram-posts');
      postsDiv.innerHTML = '<p>Telegram posts/videos (placeholder)</p>';
      // Implement actual parsing of Telegram posts/videos
    }

    function showMessage(message, type) {
      const status = document.getElementById('status');
      status.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => status.innerHTML = '', 3000);
    }

    document.getElementById('ipad-view')?.addEventListener('change', (e) => {
      document.getElementById('dpi').disabled = !e.target.checked;
      document.getElementById('resolution').disabled = !e.target.checked;
    });

    supabase
      .channel('keys')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'keys' }, async (payload) => {
        if (payload.eventType === 'UPDATE' && payload.new.id === sessionId && !payload.new.is_active) {
          showMessage('Key deactivated! Logging out...', 'error');
          logout();
        }
      })
      .subscribe();

    supabase
      .channel('news')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'news' }, loadNews)
      .subscribe();

    supabase
      .channel('comments')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'comments' }, payload => {
        if (payload.eventType !== 'DELETE') loadComments(payload.new.news_id || payload.old.news_id);
      })
      .subscribe();

    supabase
      .channel('support_messages')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'support_messages' }, loadSupportMessages)
      .subscribe();

    supabase
      .channel('profiles')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, async (payload) => {
        if (payload.new?.id === profileId && payload.new.is_banned) {
          showMessage('Your profile is banned!', 'error');
          document.getElementById('post-news-btn').style.display = 'none';
        } else if (payload.new?.id === profileId && !payload.new.is_banned) {
          showMessage('Your profile is unbanned!', 'success');
          document.getElementById('post-news-btn').style.display = 'block';
        }
      })
      .subscribe();
  </script>
</body>
</html>
