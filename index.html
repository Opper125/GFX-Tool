<!DOCTYPE html>
<html lang="my">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>FPS GFX Tool - မြန်မာ</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&family=Noto+Sans+Myanmar:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* Custom Fonts */
body {
  font-family: 'Noto Sans Myanmar', 'Inter', sans-serif;
}
h1, h2, h3, .font-orbitron {
  font-family: 'Orbitron', sans-serif;
}
.font-share-tech {
  font-family: 'Share Tech Mono', monospace;
}

/* New Color Palette */
:root {
  --primary-bg: hsl(220 20% 8%); /* Deep Dark Blue-Grey */
  --secondary-bg: hsl(220 20% 12%); /* Slightly Lighter Dark Blue-Grey */
  --accent-purple: hsl(280 80% 60%); /* Vibrant Purple */
  --accent-green: hsl(160 80% 50%); /* Neon Green */
  --accent-red: hsl(0 80% 60%); /* Vibrant Red */
  --text-primary: hsl(220 20% 90%); /* Light Grey */
  --text-secondary: hsl(220 15% 60%); /* Medium Grey */
  --border-color: hsl(220 15% 20%); /* Dark Grey */
  --card-bg: rgba(20, 25, 35, 0.7); /* Dark Translucent */
  --input-bg: rgba(30, 35, 45, 0.6); /* Darker Translucent */
  --table-header-bg: rgba(var(--accent-purple-rgb), 0.15);
  --table-row-hover-bg: rgba(var(--accent-purple-rgb), 0.08);

  /* RGB values for easier use in rgba() */
  --accent-purple-rgb: 199, 56, 255; /* From hsl(280 80% 60%) */
  --accent-green-rgb: 0, 204, 136; /* From hsl(160 80% 50%) */
  --accent-red-rgb: 255, 51, 51; /* From hsl(0 80% 60%) */
}

body {
  background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
}

.myanmar-pattern {
  background-image: 
    radial-gradient(circle at 25% 25%, rgba(var(--accent-purple-rgb), 0.15) 0%, transparent 50%),
    radial-gradient(circle at 75% 75%, rgba(var(--accent-green-rgb), 0.15) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(var(--accent-red-rgb), 0.1) 0%, transparent 50%);
  animation: patternMove 25s ease-in-out infinite;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: -2;
}

@keyframes patternMove {
  0%, 100% { background-position: 0% 0%, 100% 100%, 50% 50%; }
  33% { background-position: 100% 100%, 0% 0%, 75% 25%; }
  66% { background-position: 50% 50%, 75% 25%, 25% 75%; }
}

.myanmar-waves {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 80px;
  background: linear-gradient(45deg, 
    rgba(var(--accent-purple-rgb), 0.2), 
    rgba(var(--accent-green-rgb), 0.2), 
    rgba(var(--accent-red-rgb), 0.2));
  clip-path: polygon(0 100%, 0 60%, 25% 40%, 50% 60%, 75% 30%, 100% 50%, 100% 100%);
  animation: waveFloat 12s ease-in-out infinite;
  z-index: -1;
}

@keyframes waveFloat {
  0%, 100% { transform: translateY(0px) scaleY(1); }
  50% { transform: translateY(-10px) scaleY(1.1); }
}

.app-card {
  backdrop-filter: blur(20px);
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  box-shadow: 
    0 20px 40px -12px rgba(0, 0, 0, 0.8),
    0 0 0 1px rgba(var(--accent-purple-rgb), 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.05);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius: 16px;
}

.app-card:hover {
  transform: translateY(-2px);
  box-shadow: 
    0 25px 50px -12px rgba(var(--accent-purple-rgb), 0.25),
    0 0 0 1px rgba(var(--accent-purple-rgb), 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
  border-color: rgba(var(--accent-purple-rgb), 0.5);
}

.myanmar-btn {
  background: linear-gradient(135deg, var(--accent-purple), var(--accent-green));
  color: #000;
  font-weight: 700;
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  border: none;
  border-radius: 12px;
  padding: 12px 20px;
  cursor: pointer;
  box-shadow: 0 5px 15px rgba(var(--accent-purple-rgb), 0.2);
}

.myanmar-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
  transition: left 0.6s ease;
}

.myanmar-btn:hover::before {
  left: 100%;
}

.myanmar-btn:hover {
  background: linear-gradient(135deg, var(--accent-green), var(--accent-purple));
  transform: translateY(-1px);
  box-shadow: 0 10px 25px rgba(var(--accent-green-rgb), 0.4);
}

.btn-danger {
  background: linear-gradient(135deg, var(--accent-red), #FF6B6B);
  color: white;
  box-shadow: 0 5px 15px rgba(var(--accent-red-rgb), 0.2);
}

.btn-danger:hover {
  background: linear-gradient(135deg, #FF6B6B, var(--accent-red));
  box-shadow: 0 10px 25px rgba(var(--accent-red-rgb), 0.4);
}

.connection-status {
  position: fixed;
  top: 15px;
  right: 15px;
  z-index: 1000;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  backdrop-filter: blur(10px);
  animation: statusPulse 2s infinite;
  color: var(--text-primary);
}

.status-online {
  background: linear-gradient(135deg, var(--accent-green), #4ADE80);
  color: white;
  box-shadow: 0 0 20px rgba(var(--accent-green-rgb), 0.5);
}

.status-offline {
  background: linear-gradient(135deg, var(--accent-red), #EF4444);
  color: white;
  animation: statusShake 0.5s ease-in-out;
}

.status-connecting {
  background: linear-gradient(135deg, var(--accent-purple), #FCD34D);
  color: #000;
  animation: statusSpin 1s linear infinite;
}

@keyframes statusPulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.8; transform: scale(1.05); }
}

@keyframes statusShake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-3px); }
  75% { transform: translateX(3px); }
}

@keyframes statusSpin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.stats-card {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  border-radius: 12px;
}

.stats-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent-purple), var(--accent-green), var(--accent-red));
  opacity: 0;
  transition: opacity 0.3s ease;
}

.stats-card:hover::before {
  opacity: 1;
}

.stats-card:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 15px 35px rgba(var(--accent-purple-rgb), 0.2);
  border-color: rgba(var(--accent-purple-rgb), 0.3);
}

.app-input {
  background: var(--input-bg);
  border: 2px solid var(--border-color);
  backdrop-filter: blur(10px);
  color: var(--text-primary);
  transition: all 0.3s ease;
  border-radius: 12px;
  padding: 12px 16px;
}

.app-input:focus {
  border-color: var(--accent-purple);
  background: rgba(30, 35, 45, 0.8);
  outline: none;
  box-shadow: 0 0 25px rgba(var(--accent-purple-rgb), 0.3);
}

.app-input::placeholder {
  color: var(--text-secondary);
}

.app-table {
  backdrop-filter: blur(10px);
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  overflow: hidden;
}

.app-table th {
  background: var(--table-header-bg);
  color: var(--accent-purple);
  font-weight: 700;
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 0.5px;
  padding: 12px 8px;
}

.app-table td {
  padding: 12px 8px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  color: var(--text-primary);
}

.app-table tr:hover {
  background: var(--table-row-hover-bg);
}

.loading-spinner {
  border: 3px solid rgba(var(--accent-purple-rgb), 0.3);
  border-top: 3px solid var(--accent-purple);
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.notification {
  position: fixed;
  top: 70px;
  right: 15px;
  left: 15px;
  max-width: 400px;
  margin: 0 auto;
  padding: 12px 16px;
  border-radius: 10px;
  color: white;
  font-weight: 600;
  z-index: 1001;
  animation: slideInRight 0.4s ease-out;
  backdrop-filter: blur(15px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

@keyframes slideInRight {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.nav-btn {
  transition: all 0.3s ease;
  position: relative;
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 14px;
  color: var(--text-secondary);
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.nav-btn.active {
  background: linear-gradient(135deg, var(--accent-purple), var(--accent-green)) !important;
  color: #000 !important;
  box-shadow: 0 5px 15px rgba(var(--accent-purple-rgb), 0.4);
  border-color: var(--accent-purple) !important;
}

.nav-btn:not(.active):hover {
  background: rgba(var(--accent-purple-rgb), 0.1);
  color: var(--accent-purple);
  border-color: rgba(var(--accent-purple-rgb), 0.3);
}

.fade-in {
  animation: fadeInUp 0.6s ease-out forwards;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.status-active { color: var(--accent-green); }
.status-inactive { color: var(--accent-red); }
.status-banned { color: var(--accent-red); }

.news-card {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  transition: all 0.3s ease;
  margin-bottom: 16px;
}

.news-card:hover {
  border-color: rgba(var(--accent-purple-rgb), 0.3);
  transform: translateY(-2px);
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 20px;
}

.modal-content {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 24px;
  max-width: 90vw;
  max-height: 90vh;
  overflow-y: auto;
  backdrop-filter: blur(20px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

/* Mobile optimizations */
@media (max-width: 768px) {
  .container { padding: 8px; }
  .app-card { padding: 16px; margin: 8px; }
  .connection-status { top: 10px; right: 10px; font-size: 9px; padding: 6px 12px; }
  .notification { top: 50px; right: 10px; left: 10px; max-width: none; }
  .stats-card { margin-bottom: 12px; }
  .myanmar-btn { padding: 10px 16px; font-size: 14px; }
  .app-table { font-size: 12px; }
  .app-table th, .app-table td { padding: 8px 4px; }
  h1 { font-size: 20px; }
  h2 { font-size: 18px; }
  h3 { font-size: 16px; }
  .nav-btn { padding: 6px 10px; font-size: 12px; margin: 2px; }
  .modal-content { padding: 16px; max-width: 95vw; }
}

@media (max-width: 480px) {
  .myanmar-pattern { opacity: 0.7; }
  .myanmar-waves { height: 60px; }
  .app-card { padding: 12px; margin: 4px; }
  .grid { gap: 8px; }
  .stats-card { padding: 12px; }
  .app-table th, .app-table td { padding: 6px 2px; font-size: 11px; }
}

/* Scrollbar styling */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
::-webkit-scrollbar-thumb { background: var(--accent-purple); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-green); }

/* Loading overlay */
.loading-overlay {
  backdrop-filter: blur(8px);
  background: rgba(0,0,0,0.7);
}

.btn-small {
  padding: 6px 12px;
  font-size: 12px;
  border-radius: 8px;
}

.table-actions {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.hidden { display: none !important; }

/* Search input specific styles */
.search-input-container {
  position: relative;
}
.search-input-container .app-input {
  padding-left: 40px; /* Space for icon */
}
.search-input-container .search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-secondary);
  pointer-events: none;
}
</style>
</head>
<body class="text-white">
<div class="myanmar-pattern"></div>
<div class="myanmar-waves"></div>

<!-- Connection Status -->
<div id="connection-status" class="connection-status status-connecting">
<i class="fas fa-wifi"></i> ချိတ်ဆက်နေသည်...
</div>

<!-- Main Container -->
<div class="container mx-auto px-2 py-4 max-w-6xl">
<!-- Header -->
<div class="text-center mb-6 fade-in">
  <h1 class="text-2xl md:text-3xl lg:text-4xl font-orbitron font-bold mb-2 text-accent-purple">
    <i class="fas fa-shield-alt mr-2"></i>
    FPS GFX Tool
  </h1>
  <h2 class="text-lg md:text-xl lg:text-2xl font-orbitron font-semibold text-accent-green mb-2">
    MOBILE APPLICATION
  </h2>
  <div class="inline-block px-4 py-2 bg-gradient-to-r from-accent-purple to-accent-green text-black rounded-full font-bold text-sm">
    <i class="fas fa-mobile-alt mr-1"></i> USER INTERFACE
  </div>
</div>

<!-- Notification Container -->
<div id="notification-container"></div>

<!-- Login Section -->
<div id="login-section" class="max-w-md mx-auto fade-in">
  <div class="app-card p-6">
    <h3 class="text-xl md:text-2xl font-orbitron font-bold text-center mb-6 text-accent-purple">
      <i class="fas fa-sign-in-alt mr-2"></i>
      KEY LOGIN
    </h3>
    <div class="space-y-4">
      <div class="relative search-input-container">
        <input 
          type="text" 
          id="login-key" 
          placeholder="Enter Your Key..." 
          class="app-input w-full"
        >
        <i class="fas fa-key search-icon"></i>
      </div>
      <button 
        onclick="userLogin()" 
        id="login-btn"
        class="myanmar-btn w-full flex items-center justify-center space-x-2"
      >
        <i class="fas fa-sign-in-alt"></i>
        <span id="login-text">LOGIN</span>
      </button>
    </div>
  </div>
</div>

<!-- Profile Creation Section -->
<div id="profile-creation-section" class="max-w-md mx-auto fade-in hidden">
  <div class="app-card p-6">
    <h3 class="text-xl md:text-2xl font-orbitron font-bold text-center mb-6 text-accent-green">
      <i class="fas fa-user-plus mr-2"></i>
      CREATE PROFILE
    </h3>
    <p class="text-center text-text-secondary mb-4">
      No profile found for your key. Please create one.
    </p>
    <div class="space-y-4">
      <div class="relative search-input-container">
        <input 
          type="text" 
          id="profile-username" 
          placeholder="Username (must be unique)" 
          class="app-input w-full"
        >
        <i class="fas fa-user search-icon"></i>
      </div>
      <div class="relative search-input-container">
        <input 
          type="text" 
          id="profile-name" 
          placeholder="Your Display Name" 
          class="app-input w-full"
        >
        <i class="fas fa-signature search-icon"></i>
      </div>
      <div class="relative">
        <label for="profile-picture" class="block text-sm font-medium mb-2 text-text-secondary">Profile Picture (Optional)</label>
        <input 
          type="file" 
          id="profile-picture" 
          accept="image/*" 
          class="app-input w-full"
        >
      </div>
      <button 
        onclick="createProfile()" 
        id="create-profile-btn"
        class="myanmar-btn w-full flex items-center justify-center space-x-2"
      >
        <i class="fas fa-plus-circle"></i>
        <span id="create-profile-text">CREATE PROFILE</span>
      </button>
    </div>
  </div>
</div>

<!-- Main App Content -->
<div id="app-content" class="hidden">
  <!-- Navigation -->
  <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-6">
    <button onclick="showSection('home', this)" class="nav-btn active">
      <i class="fas fa-home mr-1"></i>
      <span class="hidden sm:inline">HOME</span>
      <span class="sm:hidden">Home</span>
    </button>
    <button onclick="showSection('news', this)" class="nav-btn">
      <i class="fas fa-newspaper mr-1"></i>
      <span class="hidden sm:inline">NEWS</span>
      <span class="sm:hidden">News</span>
    </button>
    <button onclick="showSection('products', this)" class="nav-btn">
      <i class="fas fa-box-open mr-1"></i>
      <span class="hidden sm:inline">PRODUCTS</span>
      <span class="sm:hidden">Products</span>
    </button>
    <button onclick="showSection('marketplace', this)" class="nav-btn">
      <i class="fas fa-store mr-1"></i>
      <span class="hidden sm:inline">MARKETPLACE</span>
      <span class="sm:hidden">Market</span>
    </button>
    <button onclick="showSection('chat', this)" class="nav-btn">
      <i class="fas fa-comments mr-1"></i>
      <span class="hidden sm:inline">CHAT</span>
      <span class="sm:hidden">Chat</span>
    </button>
    <button onclick="showSection('support', this)" class="nav-btn">
      <i class="fas fa-headset mr-1"></i>
      <span class="hidden sm:inline">SUPPORT</span>
      <span class="sm:hidden">Support</span>
    </button>
    <button onclick="showSection('about', this)" class="nav-btn">
      <i class="fas fa-info-circle mr-1"></i>
      <span class="hidden sm:inline">ABOUT</span>
      <span class="sm:hidden">About</span>
    </button>
    <button onclick="showSection('mi', this)" class="nav-btn">
      <i class="fas fa-user-circle mr-1"></i>
      <span class="hidden sm:inline">MI</span>
      <span class="sm:hidden">Mi</span>
    </button>
    <button onclick="userLogout()" class="nav-btn btn-danger">
      <i class="fas fa-sign-out-alt mr-1"></i>
      <span class="hidden sm:inline">LOGOUT</span>
      <span class="sm:hidden">Logout</span>
    </button>
  </div>

  <!-- Home Section -->
  <div id="home-section" class="app-section">
    <div class="app-card p-4 md:p-8 text-center">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-4 text-accent-purple">
        <i class="fas fa-home mr-2"></i>
        DASHBOARD OVERVIEW
      </h3>
      <p class="text-text-secondary">
        Welcome to FPS GFX Tool.
      </p>
      <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="stats-card p-4">
          <i class="fas fa-download text-2xl text-blue-400 mb-2"></i>
          <h4 class="text-sm font-semibold text-text-secondary">TOTAL DOWNLOADS</h4>
          <p id="total-downloads" class="text-lg font-bold text-accent-purple">0</p>
        </div>
        <div class="stats-card p-4">
          <i class="fas fa-box-open text-2xl text-purple-400 mb-2"></i>
          <h4 class="text-sm font-semibold text-text-secondary">AVAILABLE PRODUCTS</h4>
          <p id="available-products" class="text-lg font-bold text-accent-green">0</p>
        </div>
      </div>
    </div>
  </div>

  <!-- News Section -->
  <div id="news-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-newspaper mr-3"></i>
        LATEST NEWS
      </h3>
      <div id="news-list" class="space-y-4">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-center text-text-secondary">Loading news...</p>
      </div>
    </div>
  </div>

  <!-- Products Section (Admin Products) -->
  <div id="products-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-box-open mr-3"></i>
        OFFICIAL PRODUCTS & APKS
      </h3>
      <div id="products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="loading-spinner mx-auto mb-4 col-span-full"></div>
        <p class="text-center text-text-secondary col-span-full">Loading products...</p>
      </div>
    </div>
  </div>

  <!-- Marketplace Section (User Products) -->
  <div id="marketplace-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-store mr-3"></i>
        USER MARKETPLACE
      </h3>
      <div id="marketplace-products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="loading-spinner mx-auto mb-4 col-span-full"></div>
        <p class="text-center text-text-secondary col-span-full">Loading marketplace products...</p>
      </div>
    </div>
  </div>

  <!-- Chat Section -->
  <div id="chat-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-comments mr-3"></i>
        MY CHATS
      </h3>
      <div id="chat-conversations-list" class="space-y-4 mb-6">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-center text-text-secondary">Loading conversations...</p>
      </div>
      <div id="chat-messages-container" class="hidden">
        <button onclick="closeChatConversation()" class="myanmar-btn btn-small mb-4">
          <i class="fas fa-arrow-left mr-1"></i> Back to Conversations
        </button>
        <h4 id="chat-partner-name" class="text-lg font-semibold text-accent-green mb-4"></h4>
        <div id="chat-messages" class="bg-black bg-opacity-30 rounded-xl p-4 h-64 md:h-96 overflow-y-auto mb-6 border border-gray-700">
          <div class="loading-spinner mx-auto mb-4"></div>
          <p class="text-center text-text-secondary">Loading messages...</p>
        </div>
        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
          <textarea id="chat-input" placeholder="Type your message..." rows="3"
                    class="app-input flex-1 resize-none"></textarea>
          <button onclick="sendChatMessage()" 
                  class="myanmar-btn flex items-center justify-center space-x-2 md:self-end">
            <i class="fas fa-paper-plane"></i>
            <span>SEND</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Support Section -->
  <div id="support-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-headset mr-3"></i>
        SUPPORT
      </h3>
      <div id="support-tickets-list" class="space-y-4 mb-6">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-center text-text-secondary">Loading support tickets...</p>
      </div>
      <div id="support-ticket-details-container" class="hidden">
        <button onclick="closeSupportTicketDetails()" class="myanmar-btn btn-small mb-4">
          <i class="fas fa-arrow-left mr-1"></i> Back to Tickets
        </button>
        <h4 id="support-ticket-subject" class="text-lg font-semibold text-accent-green mb-4"></h4>
        <div id="support-ticket-messages" class="bg-black bg-opacity-30 rounded-xl p-4 h-64 md:h-96 overflow-y-auto mb-6 border border-gray-700">
          <div class="loading-spinner mx-auto mb-4"></div>
          <p class="text-center text-text-secondary">Loading messages...</p>
        </div>
        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
          <textarea id="support-reply-input" placeholder="Type your reply..." rows="3"
                    class="app-input flex-1 resize-none"></textarea>
          <button onclick="sendSupportReply()" 
                  class="myanmar-btn flex items-center justify-center space-x-2 md:self-end">
            <i class="fas fa-paper-plane"></i>
            <span>SEND REPLY</span>
          </button>
        </div>
      </div>
      <button id="create-new-ticket-btn" onclick="showCreateTicketForm()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
        <i class="fas fa-plus-circle"></i>
        <span>CREATE NEW TICKET</span>
      </button>
      <div id="create-ticket-form" class="app-card p-4 md:p-8 mt-6 hidden">
        <h4 class="text-lg font-orbitron font-bold mb-4 text-accent-purple">NEW SUPPORT TICKET</h4>
        <div class="space-y-4">
          <input type="text" id="new-ticket-subject" placeholder="Subject" class="app-input w-full">
          <textarea id="new-ticket-message" placeholder="Your message..." rows="5" class="app-input w-full resize-none"></textarea>
          <button onclick="submitNewTicket()" class="myanmar-btn w-full">
            <i class="fas fa-paper-plane mr-2"></i> SUBMIT TICKET
          </button>
          <button onclick="hideCreateTicketForm()" class="myanmar-btn btn-danger w-full">
            <i class="fas fa-times mr-2"></i> CANCEL
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- About Section -->
  <div id="about-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-info-circle mr-3"></i>
        ABOUT US
      </h3>
      <div id="about-content" class="space-y-4 text-text-secondary">
        <p>Loading about information...</p>
      </div>
    </div>
  </div>

  <!-- Mi Section (User Profile) -->
  <div id="mi-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-user-circle mr-3"></i>
        MY PROFILE
      </h3>
      <div id="profile-details" class="space-y-4">
        <div class="flex flex-col items-center mb-6">
          <img id="mi-profile-picture" src="/placeholder.svg?height=100&width=100" alt="Profile Picture" class="w-24 h-24 rounded-full object-cover border-4 border-accent-purple mb-4">
          <h4 id="mi-name" class="text-xl font-bold text-text-primary"></h4>
          <p id="mi-username" class="text-text-secondary">@</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">KEY</label>
            <input type="text" id="mi-key-text" class="app-input w-full font-share-tech" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">ACCOUNT STATUS</label>
            <input type="text" id="mi-account-status" class="app-input w-full" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">KYC STATUS</label>
            <input type="text" id="mi-kyc-status" class="app-input w-full" readonly>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-2 text-text-secondary">NEW PROFILE PICTURE (OPTIONAL)</label>
            <input type="file" id="mi-new-profile-picture" accept="image/*" class="app-input w-full">
          </div>
          <div class="md:col-span-2">
            <button onclick="updateProfile()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
              <i class="fas fa-save"></i>
              <span>UPDATE PROFILE</span>
            </button>
          </div>
        </div>

        <h4 class="text-lg font-orbitron font-bold mt-8 mb-4 text-accent-purple">
          <i class="fas fa-user-shield mr-2"></i>
          KYC VERIFICATION
        </h4>
        <div id="kyc-status-display" class="text-center text-text-secondary mb-4"></div>
        <div id="kyc-form" class="space-y-4 hidden">
          <p class="text-text-secondary text-center">Submit your KYC details to become a seller.</p>
          <input type="text" id="kyc-full-name" placeholder="Full Name" class="app-input w-full">
          <input type="date" id="kyc-dob" placeholder="Date of Birth" class="app-input w-full">
          <select id="kyc-id-type" class="app-input w-full">
            <option value="">Select ID Type</option>
            <option value="nrc">NRC</option>
            <option value="passport">Passport</option>
            <option value="driving_license">Driving License</option>
          </select>
          <input type="text" id="kyc-id-number" placeholder="ID Number" class="app-input w-full">
          <input type="date" id="kyc-expiry-date" placeholder="ID Expiry Date" class="app-input w-full">
          <textarea id="kyc-address" placeholder="Full Address" rows="3" class="app-input w-full resize-none"></textarea>
          <label class="block text-sm font-medium mb-2 text-text-secondary">ID Photo</label>
          <input type="file" id="kyc-id-photo" accept="image/*" class="app-input w-full">
          <label class="block text-sm font-medium mb-2 text-text-secondary">Verification Video (Optional)</label>
          <input type="file" id="kyc-video" accept="video/*" class="app-input w-full">
          <button onclick="submitKyc()" class="myanmar-btn w-full">
            <i class="fas fa-paper-plane mr-2"></i> SUBMIT KYC
          </button>
        </div>
        <button id="show-kyc-form-btn" onclick="toggleKycForm()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
          <i class="fas fa-file-alt"></i>
          <span>SUBMIT KYC REQUEST</span>
        </button>

        <h4 class="text-lg font-orbitron font-bold mt-8 mb-4 text-accent-purple">
          <i class="fas fa-box-open mr-2"></i>
          MY MARKETPLACE PRODUCTS
        </h4>
        <button id="add-marketplace-product-btn" onclick="showAddMarketplaceProductForm()" class="myanmar-btn w-full flex items-center justify-center space-x-2 mb-4">
          <i class="fas fa-plus-circle"></i>
          <span>ADD NEW PRODUCT</span>
        </button>
        <div id="marketplace-products-table-container" class="overflow-x-auto">
          <table class="app-table w-full">
            <thead>
              <tr>
                <th class="text-left">PRODUCT</th>
                <th class="text-left">PRICE</th>
                <th class="text-left">STATUS</th>
                <th class="text-left">ACTIONS</th>
              </tr>
            </thead>
            <tbody id="my-marketplace-products-table-body">
              <tr>
                <td colspan="4" class="text-center text-text-secondary py-8">
                  <div class="loading-spinner mx-auto mb-2"></div>
                  Loading your products...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div id="add-marketplace-product-form" class="app-card p-4 md:p-8 mt-6 hidden">
          <h4 class="text-lg font-orbitron font-bold mb-4 text-accent-purple">ADD NEW MARKETPLACE PRODUCT</h4>
          <div class="space-y-4">
            <input type="text" id="mp-product-name" placeholder="Product Name" class="app-input w-full">
            <textarea id="mp-product-description" placeholder="Product Description..." rows="3" class="app-input w-full resize-none"></textarea>
            <input type="number" id="mp-product-price" placeholder="Price (MMK)" min="0" step="0.01" class="app-input w-full">
            <label class="block text-sm font-medium mb-2 text-text-secondary">Product Images (Max 5)</label>
            <input type="file" id="mp-product-images" accept="image/*" multiple class="app-input w-full">
            <label class="block text-sm font-medium mb-2 text-text-secondary">Product Video (Optional)</label>
            <input type="file" id="mp-product-video" accept="video/*" class="app-input w-full">
            <select id="mp-product-category" class="app-input w-full">
              <option value="">Select Category</option>
            </select>
            <input type="text" id="mp-contact-platform" placeholder="Contact Platform (e.g., Telegram)" class="app-input w-full">
            <input type="url" id="mp-contact-link" placeholder="Contact Link (e.g., https://t.me/your_id)" class="app-input w-full">
            <button onclick="submitMarketplaceProduct()" class="myanmar-btn w-full">
              <i class="fas fa-paper-plane mr-2"></i> SUBMIT PRODUCT
            </button>
            <button onclick="hideAddMarketplaceProductForm()" class="myanmar-btn btn-danger w-full">
              <i class="fas fa-times mr-2"></i> CANCEL
            </button>
          </div>
        </div>

        <h4 class="text-lg font-orbitron font-bold mt-8 mb-4 text-accent-purple">
          <i class="fas fa-shopping-cart mr-2"></i>
          MY ORDERS (AS BUYER)
        </h4>
        <div class="overflow-x-auto">
          <table class="app-table w-full">
            <thead>
              <tr>
                <th class="text-left">PRODUCT</th>
                <th class="text-left">AMOUNT</th>
                <th class="text-left">STATUS</th>
                <th class="text-left">ORDERED AT</th>
                <th class="text-left">ACTIONS</th>
              </tr>
            </thead>
            <tbody id="my-orders-table-body">
              <tr>
                <td colspan="5" class="text-center text-text-secondary py-8">
                  <div class="loading-spinner mx-auto mb-2"></div>
                  Loading your orders...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <h4 class="text-lg font-orbitron font-bold mt-8 mb-4 text-accent-purple">
          <i class="fas fa-handshake mr-2"></i>
          MY SALES (AS SELLER)
        </h4>
        <div class="overflow-x-auto">
          <table class="app-table w-full">
            <thead>
              <tr>
                <th class="text-left">PRODUCT</th>
                <th class="text-left">BUYER</th>
                <th class="text-left">AMOUNT</th>
                <th class="text-left">STATUS</th>
                <th class="text-left">ORDERED AT</th>
                <th class="text-left">ACTIONS</th>
              </tr>
            </thead>
            <tbody id="my-sales-table-body">
              <tr>
                <td colspan="6" class="text-center text-text-secondary py-8">
                  <div class="loading-spinner mx-auto mb-2"></div>
                  Loading your sales...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

</div>
</div>

<!-- News Detail Modal -->
<div id="news-modal" class="modal hidden">
<div class="modal-content max-w-2xl">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-orbitron font-bold text-accent-purple">NEWS DETAILS</h2>
    <button onclick="closeNewsModal()" class="text-text-secondary hover:text-accent-red">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div id="news-modal-content">
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-center text-text-secondary">Loading...</p>
  </div>
</div>
</div>

<!-- Product Detail Modal (for Admin Products) -->
<div id="product-modal" class="modal hidden">
<div class="modal-content max-w-2xl">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-orbitron font-bold text-accent-purple">PRODUCT DETAILS</h2>
    <button onclick="closeProductModal()" class="text-text-secondary hover:text-accent-red">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div id="product-modal-content">
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-center text-text-secondary">Loading...</p>
  </div>
</div>
</div>

<!-- Marketplace Product Detail Modal -->
<div id="marketplace-product-modal" class="modal hidden">
  <div class="modal-content max-w-2xl">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-orbitron font-bold text-accent-purple">MARKETPLACE PRODUCT DETAILS</h2>
      <button onclick="closeMarketplaceProductModal()" class="text-text-secondary hover:text-accent-red">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="marketplace-product-modal-content">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-center text-text-secondary">Loading...</p>
    </div>
  </div>
</div>

<!-- Edit Marketplace Product Modal -->
<div id="edit-marketplace-product-modal" class="modal hidden">
  <div class="modal-content max-w-2xl">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-orbitron font-bold text-accent-purple">EDIT PRODUCT</h2>
      <button onclick="closeEditMarketplaceProductModal()" class="text-text-secondary hover:text-accent-red">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="edit-marketplace-product-modal-content" class="space-y-4">
      <input type="hidden" id="edit-mp-product-id">
      <input type="text" id="edit-mp-product-name" placeholder="Product Name" class="app-input w-full">
      <textarea id="edit-mp-product-description" placeholder="Product Description..." rows="3" class="app-input w-full resize-none"></textarea>
      <input type="number" id="edit-mp-product-price" placeholder="Price (MMK)" min="0" step="0.01" class="app-input w-full">
      <label class="block text-sm font-medium mb-2 text-text-secondary">Current Images</label>
      <div id="edit-mp-current-images" class="grid grid-cols-3 gap-2 mb-2"></div>
      <label class="block text-sm font-medium mb-2 text-text-secondary">Add New Images (Max 5)</label>
      <input type="file" id="edit-mp-product-images" accept="image/*" multiple class="app-input w-full">
      <label class="block text-sm font-medium mb-2 text-text-secondary">Current Video</label>
      <div id="edit-mp-current-video" class="mb-2"></div>
      <label class="block text-sm font-medium mb-2 text-text-secondary">New Video (Optional)</label>
      <input type="file" id="edit-mp-product-video" accept="video/*" class="app-input w-full">
      <select id="edit-mp-product-category" class="app-input w-full">
        <option value="">Select Category</option>
      </select>
      <input type="text" id="edit-mp-contact-platform" placeholder="Contact Platform (e.g., Telegram)" class="app-input w-full">
      <input type="url" id="edit-mp-contact-link" placeholder="Contact Link (e.g., https://t.me/your_id)" class="app-input w-full">
      <button onclick="updateMarketplaceProduct()" class="myanmar-btn w-full">
        <i class="fas fa-save mr-2"></i> UPDATE PRODUCT
      </button>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div id="payment-modal" class="modal hidden">
<div class="modal-content max-w-md">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-orbitron font-bold text-accent-purple">MAKE PAYMENT</h2>
    <button onclick="closePaymentModal()" class="text-text-secondary hover:text-accent-red">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div id="payment-modal-content" class="space-y-4">
    <!-- Payment method selection will go here -->
  </div>
</div>
</div>

<!-- Confirm Delete Modal -->
<div id="confirm-modal" class="modal hidden">
<div class="modal-content max-w-md">
  <div class="text-center">
    <i class="fas fa-exclamation-triangle text-4xl text-accent-red mb-4"></i>
    <h3 class="text-xl font-orbitron font-bold text-text-primary mb-4">ARE YOU SURE?</h3>
    <p id="confirm-message" class="text-text-secondary mb-6">This action cannot be undone.</p>
    <div class="flex space-x-4">
      <button onclick="closeConfirmModal()" class="myanmar-btn flex-1">
        <i class="fas fa-times mr-2"></i>
        CANCEL
      </button>
      <button onclick="confirmAction()" class="btn-danger myanmar-btn flex-1">
        <i class="fas fa-trash mr-2"></i>
        DELETE
      </button>
    </div>
  </div>
</div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 loading-overlay flex items-center justify-center z-50 hidden">
<div class="app-card p-8 text-center">
  <div class="loading-spinner mx-auto mb-4" style="width: 40px; height: 40px;"></div>
  <p class="text-text-primary font-semibold">PROCESSING...</p>
</div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
// Configuration
const CONFIG = {
  SUPABASE_URL: 'https://rliwdosxsbauwxkayjoa.supabase.co', // သင့် Supabase URL ကို ထည့်ပါ
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsaXdkb3N4c2JhdXd4a2F5am9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxMDA2NjIsImV4cCI6MjA2OTY3NjY2Mn0.uDvU9e3Cy--D9l6daGaO2QMpn1YnxMJYVlbaeIgHu4', // သင့် Supabase Anon Key ကို ထည့်ပါ
  MAX_RETRY_ATTEMPTS: 3,
  RETRY_DELAY: 2000,
  MAX_IMAGE_SIZE_MB: 5, // Max size per image for marketplace products
  MAX_VIDEO_SIZE_MB: 10 // Max size for KYC video
};

// State
let state = {
  supabase: null,
  isAuthenticated: false,
  currentSection: 'home',
  reconnectAttempts: 0,
  isConnected: false,
  confirmCallback: null,
  userProfile: null, // Stores current user's profile data
  newsRealtime: null,
  chatRealtime: null,
  supportRealtime: null,
  adminProductsRealtime: null, // For admin-uploaded products
  marketplaceProductsRealtime: null, // For user-posted products
  ordersRealtime: null, // For admin-product orders
  userOrdersRealtime: null, // For marketplace product orders
  selectedProductForPurchase: null, // For admin_products
  selectedMarketplaceProductForPurchase: null, // For marketplace_products
  selectedPaymentMethod: null,
  currentChatConversationId: null,
  currentSupportTicketId: null,
  categories: [] // Store categories for product forms
};

// Utility Functions
const utils = {
  formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  },
  getMediaType(fileType) {
    if (fileType.startsWith('image/')) return 'image';
    if (fileType.startsWith('video/')) return 'video';
    if (fileType.startsWith('audio/')) return 'audio';
    return 'file';
  },
  formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  },
  formatDateTime(dateString) {
    return new Date(dateString).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
  },
  generateRandomPassword() {
    return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
  }
};

// Initialize
document.addEventListener('DOMContentLoaded', initializeApp);

async function initializeApp() {
  updateConnectionStatus('connecting');
  
  try {
    // Check if Supabase config is set
    if (!CONFIG.SUPABASE_URL || CONFIG.SUPABASE_URL === 'https://rliwdosxsbauwxkayjoa.supabase.co') {
      throw new Error('Supabase URL လိုအပ်ပါတယ်! CONFIG အပိုင်းထဲမှာ သင့် Supabase URL ကို ထည့်ပါ။');
    }

    if (!CONFIG.SUPABASE_ANON_KEY || CONFIG.SUPABASE_ANON_KEY === 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsaXdkb3N4c2JhdXd4a2F5am9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxMDA2NjIsImV4cCI6MjA2OTY3NjY2Mn0.uDvU9e3Cy--D9l6daGaO2QMpn1YnxMJYVlbaeIgHu4') {
      throw new Error('Supabase Anon Key လိုအပ်ပါတယ်! CONFIG အပိုင်းထဲမှာ သင့် Supabase Anon Key ကို ထည့်ပါ။');
    }

    // Initialize Supabase
    if (typeof supabase !== 'undefined') {
      state.supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
        auth: { persistSession: true }, // Persist session for user convenience
        realtime: { params: { eventsPerSecond: 10 } }
      });

      // Test connection to 'about' table
      const { data, error } = await state.supabase.from('about').select('id').limit(1);
      
      if (error && error.code !== 'PGRST116') { // PGRST116 means table not found, which is fine for initial setup
        throw new Error(`Database connection failed: ${error.message}`);
      }

      updateConnectionStatus('online');
      showNotification('Database connected successfully! အက်ပ် အသုံးပြုရန် အသင့်ဖြစ်ပါတယ်။', 'success');
      
      state.isConnected = true;
      state.reconnectAttempts = 0;

      // Listen for auth state changes
      state.supabase.auth.onAuthStateChange(async (event, session) => {
        if (event === 'SIGNED_IN' && session) {
          await loadUserProfile(session.user.id);
          if (state.userProfile) {
            // If profile exists, show app content
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('profile-creation-section').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            await loadDashboardData();
            await loadCategories(); // Load categories for product forms
            setupRealtimeSubscriptions();
            showSection('home', document.querySelector('.nav-btn.active'));
          } else {
            // If no profile, show profile creation
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('app-content').classList.add('hidden');
            document.getElementById('profile-creation-section').classList.remove('hidden');
            showNotification('No profile found for your account. Please create one.', 'info', 10000);
          }
        } else if (event === 'SIGNED_OUT') {
          userLogout(false); // Don't show confirm modal on automatic sign out
        }
      });

      // Check if already signed in
      const { data: { session } } = await state.supabase.auth.getSession();
      if (session) {
        // Auth state change listener will handle this
      } else {
        // If not signed in, show login section
        document.getElementById('login-section').classList.remove('hidden');
      }
      
    } else {
      throw new Error('Supabase library မတင်လို့ရပါ');
    }
  } catch (error) {
    console.error('Initialization error:', error);
    updateConnectionStatus('offline');
    showNotification(`Connection failed: ${error.message}`, 'error');
    
    // Retry connection
    if (state.reconnectAttempts < CONFIG.MAX_RETRY_ATTEMPTS) {
      state.reconnectAttempts++;
      setTimeout(() => {
        console.log(`Retrying connection (${state.reconnectAttempts}/${CONFIG.MAX_RETRY_ATTEMPTS})...`);
        initializeApp();
      }, CONFIG.RETRY_DELAY);
    }
  }

  // Add enter key listener for login key input
  document.getElementById('login-key').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      userLogin();
    }
  });
}

async function loadUserProfile(userId) {
  try {
    const { data, error } = await state.supabase
      .from('profiles')
      .select('*')
      .eq('id', userId)
      .single();

    if (error && error.code !== 'PGRST116') throw error; // PGRST116 means no profile found, which is expected for new users

    state.userProfile = data;
  } catch (error) {
    console.error('Error loading user profile:', error);
    state.userProfile = null;
  }
}

function updateConnectionStatus(status) {
  const statusElement = document.getElementById('connection-status');
  statusElement.className = 'connection-status';
  
  switch (status) {
    case 'online':
      statusElement.classList.add('status-online');
      statusElement.innerHTML = '<i class="fas fa-check-circle"></i> ONLINE';
      break;
    case 'offline':
      statusElement.classList.add('status-offline');
      statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> OFFLINE';
      break;
    case 'connecting':
      statusElement.classList.add('status-connecting');
      statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> CONNECTING...';
      break;
  }
}

function showNotification(message, type = 'info', duration = 5000) {
  const container = document.getElementById('notification-container');
  const notification = document.createElement('div');
  
  const bgColors = {
    success: 'bg-green-600',
    error: 'bg-red-600',
    info: 'bg-blue-600',
    warning: 'bg-yellow-600'
  };
  
  const icons = {
    success: 'fa-check-circle',
    error: 'fa-exclamation-triangle',
    info: 'fa-info-circle',
    warning: 'fa-exclamation-circle'
  };
  
  notification.className = `notification ${bgColors[type]}`;
  notification.innerHTML = `
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <i class="fas ${icons[type]} mr-2"></i>
        <span>${message}</span>
      </div>
      <button onclick="this.parentElement.parentElement.remove()" class="ml-4 hover:text-gray-200">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `;
  
  container.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentElement) {
      notification.remove();
    }
  }, duration);
}

async function userLogin() {
  if (!state.isConnected) {
    showNotification('Waiting for database connection...', 'warning');
    return;
  }

  const loginKey = document.getElementById('login-key').value.trim();
  const loginBtn = document.getElementById('login-btn');
  const loginText = document.getElementById('login-text');

  if (!loginKey) {
    showNotification('Please enter Key', 'warning');
    return;
  }

  try {
    loginBtn.disabled = true;
    loginText.textContent = 'LOGGING IN...';
    showLoading(true);

    // First, check if the key exists and is active
    const { data: keyData, error: keyError } = await state.supabase
      .from('api_keys')
      .select('id, key_text, profile_id, is_active')
      .eq('key_text', loginKey)
      .single();

    if (keyError || !keyData || !keyData.is_active) {
      throw new Error('Invalid or inactive Key.');
    }

    let userId = keyData.profile_id;
    let session = null;

    if (userId) {
      // If key is already linked to a profile, try to sign in with that user
      // For simplicity, we'll use a dummy email/password for Supabase Auth
      // In a real app, you might have a more robust system or use custom auth.
      const dummyEmail = `user_${keyData.id}@example.com`;
      const dummyPassword = `password_${keyData.id}`; // This should be securely managed

      const { data: signInData, error: signInError } = await state.supabase.auth.signInWithPassword({
        email: dummyEmail,
        password: dummyPassword,
      });

      if (signInError) {
        // If sign-in fails, it might be a new key or a problem.
        // Try to sign up if user doesn't exist, then sign in.
        const { data: signUpData, error: signUpError } = await state.supabase.auth.signUp({
          email: dummyEmail,
          password: dummyPassword,
        });
        if (signUpError) throw signUpError;
        session = signUpData.session;
        userId = signUpData.user.id;
      } else {
        session = signInData.session;
        userId = signInData.user.id;
      }

    } else {
      // If key is not linked to a profile, create a new Supabase Auth user
      const dummyEmail = `user_${keyData.id}@example.com`;
      const dummyPassword = `password_${keyData.id}`; // This should be securely managed

      const { data: signUpData, error: signUpError } = await state.supabase.auth.signUp({
        email: dummyEmail,
        password: dummyPassword,
      });
      if (signUpError) throw signUpError;
      session = signUpData.session;
      userId = signUpData.user.id;

      // Link the API key to the newly created Supabase Auth user
      const { error: updateKeyError } = await state.supabase
        .from('api_keys')
        .update({ profile_id: userId, is_active: false }) // Deactivate key after first use
        .eq('id', keyData.id);
      if (updateKeyError) throw updateKeyError;
    }

    if (!session) {
      throw new Error('Failed to establish user session.');
    }

    // Load user profile after successful authentication
    await loadUserProfile(userId);

    if (state.userProfile && state.userProfile.is_banned) {
      await state.supabase.auth.signOut();
      throw new Error('Your account is banned. Please contact support.');
    }

    localStorage.setItem('user_key', loginKey); // Persist key for display
    state.isAuthenticated = true;

    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('profile-creation-section').classList.add('hidden');
    document.getElementById('app-content').classList.remove('hidden');
    
    showNotification('Successfully logged in!', 'success');
    
    // If profile_id is null, show profile creation section
    if (!state.userProfile) {
      document.getElementById('app-content').classList.add('hidden');
      document.getElementById('profile-creation-section').classList.remove('hidden');
      showNotification('No profile found for your account. Please create one.', 'info', 10000);
    } else {
      // Load initial data for the app
      await loadDashboardData();
      await loadCategories(); // Load categories for product forms
      setupRealtimeSubscriptions();
      showSection('home', document.querySelector('.nav-btn.active')); // Activate default section
    }
    
  } catch (error) {
    console.error('Login error:', error);
    showNotification(error.message, 'error');
    userLogout(false); // Ensure logout on error
  } finally {
    loginBtn.disabled = false;
    loginText.textContent = 'LOGIN';
    showLoading(false);
  }
}

async function createProfile() {
  const username = document.getElementById('profile-username').value.trim();
  const name = document.getElementById('profile-name').value.trim();
  const profilePictureFile = document.getElementById('profile-picture').files[0];
  const createProfileBtn = document.getElementById('create-profile-btn');
  const createProfileText = document.getElementById('create-profile-text');
  const currentKey = localStorage.getItem('user_key');

  if (!username || !name || !currentKey) {
    showNotification('Please enter Username, Name, and ensure Key is present.', 'warning');
    return;
  }

  if (!state.supabase.auth.currentUser) {
    showNotification('User not authenticated. Please try logging in again.', 'error');
    return;
  }

  try {
    createProfileBtn.disabled = true;
    createProfileText.textContent = 'CREATING PROFILE...';
    showLoading(true);

    let profilePictureUrl = null;
    if (profilePictureFile) {
      const fileExt = profilePictureFile.name.split('.').pop();
      const fileName = `avatars/${state.supabase.auth.currentUser.id}_${Date.now()}.${fileExt}`;
      const { data: uploadData, error: uploadError } = await state.supabase.storage
        .from('profile_avatars')
        .upload(fileName, profilePictureFile);
      if (uploadError) throw uploadError;
      const { data: urlData } = state.supabase.storage.from('profile_avatars').getPublicUrl(fileName);
      profilePictureUrl = urlData.publicUrl;
    }

    const { data, error } = await state.supabase.rpc('create_user_profile', {
      p_username: username,
      p_name: name,
      p_key_text: currentKey,
      p_profile_picture: profilePictureUrl
    });

    if (error) throw error;

    state.userProfile = data; // Update local state with new profile
    
    showNotification('Profile created successfully!', 'success');
    document.getElementById('profile-creation-section').classList.add('hidden');
    document.getElementById('app-content').classList.remove('hidden');
    
    await loadDashboardData();
    await loadCategories();
    setupRealtimeSubscriptions();
    showSection('home', document.querySelector('.nav-btn.active'));

  } catch (error) {
    console.error('Error creating profile:', error);
    if (error.code === '23505') { // Unique constraint violation
      showNotification('Username already exists, please choose another.', 'error');
    } else {
      showNotification(`Failed to create profile: ${error.message}`, 'error');
    }
  } finally {
    createProfileBtn.disabled = false;
    createProfileText.textContent = 'CREATE PROFILE';
    showLoading(false);
  }
}

async function loadDashboardData() {
  try {
    // Load stats for admin_products (official products)
    const { count: productsCount, error: productsError } = await state.supabase.from('admin_products').select('id', { count: 'exact' }).eq('is_active', true);
    if (productsError) throw productsError;
    document.getElementById('available-products').textContent = productsCount || 0;

    // Total downloads (assuming 'approved' orders count as downloads)
    const { count: downloadsCount, error: downloadsError } = await state.supabase.from('orders').select('id', { count: 'exact' }).eq('status', 'approved');
    if (downloadsError) throw downloadsError;
    document.getElementById('total-downloads').textContent = downloadsCount || 0;

  } catch (error) {
    console.error('Error loading dashboard data:', error);
    showNotification('Failed to retrieve dashboard data', 'error');
  }
}

async function loadCategories() {
  try {
    const { data, error } = await state.supabase
      .from('categories')
      .select('*')
      .order('name', { ascending: true });

    if (error) throw error;
    state.categories = data || [];

    // Populate category dropdowns if any
    const mpCategorySelect = document.getElementById('mp-product-category');
    const editMpCategorySelect = document.getElementById('edit-mp-product-category');
    
    if (mpCategorySelect) {
      mpCategorySelect.innerHTML = '<option value="">Select Category</option>';
      state.categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        mpCategorySelect.appendChild(option);
      });
    }
    if (editMpCategorySelect) {
      editMpCategorySelect.innerHTML = '<option value="">Select Category</option>';
      state.categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        editMpCategorySelect.appendChild(option);
      });
    }

  } catch (error) {
    console.error('Error loading categories:', error);
    showNotification('Failed to load categories', 'error');
  }
}

function setupRealtimeSubscriptions() {
  // Unsubscribe from previous channels if they exist
  if (state.newsRealtime) state.supabase.removeChannel(state.newsRealtime);
  if (state.adminProductsRealtime) state.supabase.removeChannel(state.adminProductsRealtime);
  if (state.marketplaceProductsRealtime) state.supabase.removeChannel(state.marketplaceProductsRealtime);
  if (state.ordersRealtime) state.supabase.removeChannel(state.ordersRealtime);
  if (state.userOrdersRealtime) state.supabase.removeChannel(state.userOrdersRealtime);
  if (state.chatRealtime) state.supabase.removeChannel(state.chatRealtime);
  if (state.supportRealtime) state.supabase.removeChannel(state.supportRealtime);

  // News realtime updates
  state.newsRealtime = state.supabase
    .channel('news_changes')
    .on('postgres_changes', 
      { event: '*', schema: 'public', table: 'news' }, 
      (payload) => {
        if (state.currentSection === 'news') {
          loadNewsData();
        }
        loadDashboardData(); // Update stats
      }
    )
    .subscribe();

  // Admin Products realtime
  state.adminProductsRealtime = state.supabase
    .channel('admin_products_changes')
    .on('postgres_changes', 
      { event: '*', schema: 'public', table: 'admin_products' }, 
      (payload) => {
        if (state.currentSection === 'products') {
          loadProductsData();
        }
        loadDashboardData(); // Update stats
      }
    )
    .subscribe();

  // Marketplace Products realtime
  state.marketplaceProductsRealtime = state.supabase
    .channel('marketplace_products_changes')
    .on('postgres_changes', 
      { event: '*', schema: 'public', table: 'marketplace_products' }, 
      (payload) => {
        if (state.currentSection === 'marketplace') {
          loadMarketplaceProductsData();
        }
        if (state.currentSection === 'mi') {
          loadMyMarketplaceProducts();
        }
        loadDashboardData(); // Update stats
      }
    )
    .subscribe();

  // Orders realtime (for admin_products)
  state.ordersRealtime = state.supabase
    .channel('orders_changes')
    .on('postgres_changes', 
      { event: '*', schema: 'public', table: 'orders', filter: `buyer_id=eq.${state.userProfile.id}` }, 
      (payload) => {
        if (state.currentSection === 'mi') {
          loadMyOrders();
        }
      }
    )
    .subscribe();

  // User Orders realtime (for marketplace_products)
  state.userOrdersRealtime = state.supabase
    .channel('user_orders_changes')
    .on('postgres_changes', 
      { event: '*', schema: 'public', table: 'user_orders', filter: `buyer_id=eq.${state.userProfile.id}|seller_id=eq.${state.userProfile.id}` }, 
      (payload) => {
        if (state.currentSection === 'mi') {
          loadMyOrders();
          loadMySales();
        }
        if (state.currentSection === 'chat' && state.currentChatConversationId) {
          loadChatMessages(state.currentChatConversationId); // Reload chat if related to orders
        }
      }
    )
    .subscribe();

  // Chat messages realtime
  state.chatRealtime = state.supabase
    .channel('chat_changes')
    .on('postgres_changes', 
      { event: '*', schema: 'public', table: 'chats', filter: `conversation_id=in.(select id from conversations where participant1_id=eq.${state.userProfile.id} or participant2_id=eq.${state.userProfile.id})` }, 
      (payload) => {
        if (state.currentSection === 'chat' && state.currentChatConversationId === payload.new.conversation_id) {
          loadChatMessages(state.currentChatConversationId);
        } else if (state.currentSection === 'chat') {
          loadChatConversations(); // Refresh conversation list if new message in another chat
        }
      }
    )
    .subscribe();

  // Support tickets realtime
  state.supportRealtime = state.supabase
    .channel('support_tickets_changes')
    .on('postgres_changes', 
      { event: '*', schema: 'public', table: 'support_tickets', filter: `user_id=eq.${state.userProfile.id}` }, 
      (payload) => {
        if (state.currentSection === 'support') {
          loadSupportTickets();
          if (state.currentSupportTicketId === payload.new.id) {
            viewSupportTicketDetails(payload.new.id); // Reload current ticket if it changed
          }
        }
      }
    )
    .subscribe();
}

function showSection(section, buttonElement) {
  // Hide all sections
  document.querySelectorAll('.app-section').forEach(sec => {
    sec.classList.add('hidden');
  });
  
  // Update navigation
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Show selected section
  const sectionElement = document.getElementById(`${section}-section`);
  if (sectionElement) {
    sectionElement.classList.remove('hidden');
    sectionElement.classList.add('fade-in');
  }
  
  // Update active nav
  if (buttonElement) {
    buttonElement.classList.add('active');
  }
  state.currentSection = section;
  
  // Load section data
  switch (section) {
    case 'home':
      loadDashboardData();
      break;
    case 'news':
      loadNewsData();
      break;
    case 'products':
      loadProductsData(); // Admin products
      break;
    case 'marketplace':
      loadMarketplaceProductsData(); // User products
      break;
    case 'chat':
      loadChatConversations();
      break;
    case 'support':
      loadSupportTickets();
      break;
    case 'about':
      loadAboutData();
      break;
    case 'mi':
      loadMiProfile();
      loadMyMarketplaceProducts();
      loadMyOrders();
      loadMySales();
      break;
  }
}

async function loadNewsData() {
  const newsContainer = document.getElementById('news-list');
  newsContainer.innerHTML = `
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-center text-text-secondary">Loading news...</p>
  `;

  try {
    const { data, error } = await state.supabase
      .from('news')
      .select(`
        *,
        created_by_profile:profiles(username, name, profile_picture)
      `)
      .eq('is_published', true)
      .order('created_at', { ascending: false });

    if (error) throw error;

    if (data && data.length > 0) {
      newsContainer.innerHTML = data.map(news => {
        const authorName = news.created_by_profile?.name || 'Admin';
        const authorUsername = news.created_by_profile?.username || 'admin';
        const authorAvatar = news.created_by_profile?.profile_picture || '/placeholder.svg?height=40&width=40';

        let mediaHtml = '';
        if (news.media_urls && news.media_urls.length > 0) {
          news.media_urls.forEach(media => {
            const mediaType = utils.getMediaType(media.type);
            if (mediaType === 'image') {
              mediaHtml += `<img src="${media.url}" class="w-full rounded-lg mb-3" alt="News image">`;
            } else if (mediaType === 'video') {
              mediaHtml += `
                <div class="video-container mb-3">
                  <video controls playsinline webkit-playsinline class="w-full rounded-lg">
                    <source src="${media.url}" type="${media.type}">
                  </video>
                </div>
              `;
            } else if (mediaType === 'audio') {
              mediaHtml += `
                <div class="audio-container mb-3">
                  <audio controls class="w-full">
                    <source src="${media.url}" type="${media.type}">
                  </audio>
                </div>
              `;
            }
          });
        }
        
        return `
          <div class="news-card p-4">
            <div class="flex justify-between items-start mb-3">
              <div>
                <h4 class="text-lg font-semibold text-accent-purple mb-1">${news.title}</h4>
                <p class="text-sm text-text-secondary">
                  <i class="fas fa-user mr-1"></i> ${authorName} (@${authorUsername})
                  <span class="ml-3">
                    <i class="fas fa-calendar mr-1"></i> ${utils.formatDate(news.created_at)}
                  </span>
                </p>
              </div>
              <div class="flex space-x-2">
                <button onclick="viewNews('${news.id}')" class="myanmar-btn btn-small">
                  <i class="fas fa-eye"></i>
                </button>
                <button onclick="shareNews('${news.id}')" class="myanmar-btn btn-small">
                  <i class="fas fa-share-alt"></i>
                </button>
              </div>
            </div>
            
            ${mediaHtml}
            
            <p class="text-text-secondary text-sm mb-3">${news.content.substring(0, 150)}${news.content.length > 150 ? '...' : ''}</p>
            
            <div class="flex items-center justify-between text-sm text-text-secondary">
              <div class="flex space-x-4">
                <span><i class="fas fa-eye mr-1"></i> ${news.views || 0}</span>
                <span><i class="fas fa-heart mr-1"></i> ${news.likes || 0}</span>
              </div>
              ${news.youtube_link ? '<i class="fab fa-youtube text-red-500"></i>' : ''}
            </div>
          </div>
        `;
      }).join('');
    } else {
      newsContainer.innerHTML = `
        <div class="text-center text-text-secondary py-8">
          <i class="fas fa-newspaper text-4xl mb-4"></i>
          <p>No News Found</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading news:', error);
    newsContainer.innerHTML = `
      <div class="text-center text-accent-red py-8">
        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
        <p>Failed to retrieve News</p>
      </div>
    `;
  }
}

async function viewNews(newsId) {
  try {
    const { data, error } = await state.supabase
      .from('news')
      .select(`
        *,
        created_by_profile:profiles(username, name, profile_picture)
      `)
      .eq('id', newsId)
      .single();

    if (error) throw error;

    const authorName = data.created_by_profile?.name || 'Admin';
    const authorUsername = data.created_by_profile?.username || 'admin';
    const authorAvatar = data.created_by_profile?.profile_picture || '/placeholder.svg?height=40&width=40';

    let mediaHtml = '';
    if (data.media_urls && data.media_urls.length > 0) {
      data.media_urls.forEach(media => {
        const mediaType = utils.getMediaType(media.type);
        if (mediaType === 'image') {
          mediaHtml += `<img src="${media.url}" class="w-full rounded-lg mb-3" alt="News image">`;
        } else if (mediaType === 'video') {
          mediaHtml += `
            <div class="video-container mb-3">
              <video controls playsinline webkit-playsinline class="w-full rounded-lg">
                <source src="${media.url}" type="${media.type}">
              </video>
            </div>
          `;
        } else if (mediaType === 'audio') {
          mediaHtml += `
            <div class="audio-container mb-3">
              <audio controls class="w-full">
                <source src="${media.url}" type="${media.type}">
              </audio>
            </div>
          `;
        }
      });
    }

    let socialLinksHtml = '';
    if (data.youtube_link) socialLinksHtml += `<a href="${data.youtube_link}" target="_blank" class="text-red-500 hover:text-red-400"><i class="fab fa-youtube text-2xl"></i></a>`;
    if (data.tiktok_link) socialLinksHtml += `<a href="${data.tiktok_link}" target="_blank" class="text-text-secondary hover:text-text-primary"><i class="fab fa-tiktok text-2xl"></i></a>`;
    if (data.telegram_link) socialLinksHtml += `<a href="${data.telegram_link}" target="_blank" class="text-blue-400 hover:text-blue-300"><i class="fab fa-telegram text-2xl"></i></a>`;
    if (data.facebook_link) socialLinksHtml += `<a href="${data.facebook_link}" target="_blank" class="text-blue-600 hover:text-blue-500"><i class="fab fa-facebook text-2xl"></i></a>`;


    document.getElementById('news-modal-content').innerHTML = `
      <div class="space-y-4">
        <div class="flex items-center space-x-3">
          <img src="${authorAvatar}" 
               alt="Author" class="w-10 h-10 rounded-full object-cover">
          <div>
            <h4 class="font-semibold text-text-primary">${authorName}</h4>
            <p class="text-sm text-text-secondary">@${authorUsername}</p>
          </div>
        </div>
        
        <h3 class="text-xl font-bold text-accent-purple">${data.title}</h3>
        
        ${mediaHtml}
        
        <div class="prose prose-invert max-w-none">
          <p class="text-text-secondary whitespace-pre-wrap">${data.content}</p>
        </div>
        
        ${socialLinksHtml ? `<div class="flex space-x-4 mt-4">${socialLinksHtml}</div>` : ''}

        <div class="flex items-center justify-between text-sm text-text-secondary pt-4 border-t border-border-color">
          <div class="flex space-x-4">
            <span><i class="fas fa-eye mr-1"></i> ${data.views || 0} VIEWS</span>
            <span><i class="fas fa-heart mr-1"></i> ${data.likes || 0} LIKES</span>
          </div>
          <span><i class="fas fa-calendar mr-1"></i> ${utils.formatDateTime(data.created_at)}</span>
        </div>
      </div>
    `;

    document.getElementById('news-modal').classList.remove('hidden');

  } catch (error) {
    console.error('Error viewing news:', error);
    showNotification('Failed to view News', 'error');
  }
}

function closeNewsModal() {
  document.getElementById('news-modal').classList.add('hidden');
}

async function shareNews(newsId) {
  // Implement sharing functionality (e.g., copy link, share to social media)
  const newsUrl = `${window.location.origin}/news/${newsId}`; // Example URL, adjust as needed
  try {
    await navigator.clipboard.writeText(newsUrl);
    showNotification('News link copied to clipboard!', 'success');
  } catch (err) {
    console.error('Failed to copy: ', err);
    showNotification('Failed to copy news link.', 'error');
  }
}

async function loadProductsData() { // For admin_products
  const productsList = document.getElementById('products-list');
  productsList.innerHTML = `
    <div class="loading-spinner mx-auto mb-4 col-span-full"></div>
    <p class="text-center text-text-secondary col-span-full">Loading products...</p>
  `;

  try {
    const { data: products, error } = await state.supabase
      .from('admin_products')
      .select('*')
      .eq('is_active', true)
      .order('created_at', { ascending: false });

    if (error) throw error;

    if (products && products.length > 0) {
      productsList.innerHTML = ''; // Clear loading
      for (const product of products) {
        let isPurchased = false;
        if (state.userProfile && state.userProfile.id) { // Only check if user is logged in and has a profile
          const { data: purchasedData, error: purchasedError } = await state.supabase
            .from('orders')
            .select('id')
            .eq('buyer_id', state.userProfile.id)
            .eq('product_id', product.id)
            .eq('status', 'approved') // Only count approved orders as purchased
            .limit(1);
          isPurchased = !purchasedError && purchasedData && purchasedData.length > 0;
        }

        productsList.innerHTML += `
          <div class="app-card p-4 text-center flex flex-col justify-between items-center">
            <img src="${product.apk_icon_url || '/placeholder.svg?height=64&width=64'}" alt="${product.name} icon" class="w-16 h-16 object-contain mb-3">
            <h3 class="text-lg font-semibold text-text-primary mb-1">${product.name}</h3>
            <p class="text-text-secondary text-sm mb-2">${product.description || 'No description'}</p>
            ${product.price > 0 ? `<p class="text-xl font-bold text-accent-green mb-3">${product.price} MMK</p>` : '<p class="text-xl font-bold text-accent-green mb-3">FREE</p>'}
            ${product.price > 0 && !isPurchased ? `
              <button onclick="initiatePurchase('${product.id}', '${product.name}', ${product.price})" class="myanmar-btn w-full mt-auto">
                <i class="fas fa-shopping-cart mr-2"></i> PURCHASE
              </button>
            ` : `
              <a href="${product.file_url}" target="_blank" download class="myanmar-btn w-full mt-auto">
                <i class="fas fa-download mr-2"></i> DOWNLOAD
              </a>
            `}
          </div>
        `;
      }
    } else {
      productsList.innerHTML = '<p class="text-center col-span-full text-text-secondary">No Products Available</p>';
    }
  } catch (error) {
    console.error('Error loading products:', error);
    productsList.innerHTML = '<p class="text-center col-span-full text-accent-red">Failed to retrieve Products</p>';
  }
}

async function loadMarketplaceProductsData() { // For user-posted products
  const productsList = document.getElementById('marketplace-products-list');
  productsList.innerHTML = `
    <div class="loading-spinner mx-auto mb-4 col-span-full"></div>
    <p class="text-center text-text-secondary col-span-full">Loading marketplace products...</p>
  `;

  try {
    const { data: products, error } = await state.supabase
      .from('marketplace_products')
      .select(`
        *,
        seller_profile:profiles(username, name, profile_picture)
      `)
      .eq('status', 'approved')
      .order('created_at', { ascending: false });

    if (error) throw error;

    if (products && products.length > 0) {
      productsList.innerHTML = ''; // Clear loading
      for (const product of products) {
        const sellerName = product.seller_profile?.name || 'Unknown Seller';
        const sellerUsername = product.seller_profile?.username || 'unknown';
        const sellerAvatar = product.seller_profile?.profile_picture || '/placeholder.svg?height=40&width=40';

        productsList.innerHTML += `
          <div class="app-card p-4 flex flex-col justify-between">
            <div>
              <h3 class="text-lg font-semibold text-text-primary mb-1">${product.name}</h3>
              <p class="text-text-secondary text-sm mb-2">${product.description || 'No description'}</p>
              <p class="text-xl font-bold text-accent-green mb-3">${product.price} MMK</p>
              <div class="flex items-center text-sm text-text-secondary mb-3">
                <img src="${sellerAvatar}" alt="Seller" class="w-6 h-6 rounded-full object-cover mr-2">
                <span>${sellerName} (@${sellerUsername})</span>
              </div>
            </div>
            <div class="mt-auto flex space-x-2">
              <button onclick="viewMarketplaceProductDetails('${product.id}')" class="myanmar-btn btn-small flex-1">
                <i class="fas fa-eye mr-2"></i> VIEW
              </button>
              <button onclick="initiateMarketplacePurchase('${product.id}', '${product.name}', ${product.price}, '${product.seller_id}')" class="myanmar-btn btn-small flex-1">
                <i class="fas fa-shopping-cart mr-2"></i> BUY
              </button>
            </div>
          </div>
        `;
      }
    } else {
      productsList.innerHTML = '<p class="text-center col-span-full text-text-secondary">No Marketplace Products Available</p>';
    }
  } catch (error) {
    console.error('Error loading marketplace products:', error);
    productsList.innerHTML = '<p class="text-center col-span-full text-accent-red">Failed to retrieve Marketplace Products</p>';
  }
}

async function viewMarketplaceProductDetails(productId) {
  try {
    const { data, error } = await state.supabase
      .from('marketplace_products')
      .select(`
        *,
        seller_profile:profiles(username, name, profile_picture),
        category:categories(name)
      `)
      .eq('id', productId)
      .single();

    if (error) throw error;

    const sellerProfile = data.seller_profile;
    const sellerAvatar = sellerProfile?.profile_picture || '/placeholder.svg?height=40&width=40';

    let imagesHtml = '';
    if (data.image_urls && data.image_urls.length > 0) {
      imagesHtml = data.image_urls.map(url => `<img src="${url}" class="w-full rounded-lg mb-2" alt="Product Image">`).join('');
    } else {
      imagesHtml = '<p class="text-text-secondary">No images available.</p>';
    }

    let videoHtml = data.video_url ? `
      <div class="video-container mb-3">
        <video controls playsinline webkit-playsinline class="w-full rounded-lg">
          <source src="${data.video_url}" type="video/mp4">
        </video>
      </div>
    ` : '<p class="text-text-secondary">No video available.</p>';

    document.getElementById('marketplace-product-modal-content').innerHTML = `
      <div class="space-y-4">
        <div class="flex items-center space-x-3 mb-4">
          <img src="${sellerAvatar}" alt="Seller Profile" class="w-12 h-12 rounded-full object-cover">
          <div>
            <h4 class="font-semibold text-text-primary">${sellerProfile?.name || 'N/A'} (@${sellerProfile?.username || 'N/A'})</h4>
            <p class="text-sm text-text-secondary">Posted: ${utils.formatDateTime(data.created_at)}</p>
          </div>
        </div>
        
        <h3 class="text-xl font-bold text-accent-purple">${data.name}</h3>
        <p class="text-text-secondary"><strong>Price:</strong> ${data.price} MMK</p>
        <p class="text-text-secondary"><strong>Category:</strong> ${data.category?.name || 'N/A'}</p>
        <p class="text-text-secondary whitespace-pre-wrap">${data.description}</p>
        
        <h4 class="text-lg font-bold text-accent-green mt-6">Product Images</h4>
        ${imagesHtml}

        <h4 class="text-lg font-bold text-accent-green mt-6">Product Video</h4>
        ${videoHtml}

        <h4 class="text-lg font-bold text-accent-green mt-6">Seller Contact</h4>
        <p class="text-text-secondary"><strong>Platform:</strong> ${data.contact_platform || 'N/A'}</p>
        <p class="text-text-secondary"><strong>Link:</strong> ${data.contact_link ? `<a href="${data.contact_link}" target="_blank" class="text-accent-purple hover:underline">${data.contact_link}</a>` : 'N/A'}</p>
      </div>
    `;
    document.getElementById('marketplace-product-modal').classList.remove('hidden');
  } catch (error) {
    console.error('Error viewing marketplace product details:', error);
    showNotification('Failed to view Marketplace Product details', 'error');
  }
}

function closeMarketplaceProductModal() {
  document.getElementById('marketplace-product-modal').classList.add('hidden');
}

async function initiatePurchase(productId, productName, productPrice) { // For admin_products
  if (!state.userProfile || !state.userProfile.id) {
    showNotification('Please create a profile to purchase products.', 'info');
    return;
  }
  state.selectedProductForPurchase = { id: productId, name: productName, price: productPrice };
  state.selectedMarketplaceProductForPurchase = null; // Clear marketplace product selection
  
  const paymentModalContent = document.getElementById('payment-modal-content');
  paymentModalContent.innerHTML = `
    <h3 class="text-xl font-semibold text-text-primary mb-2">${productName}</h3>
    <p class="text-text-secondary mb-4">Price: <span class="text-accent-green font-bold">${productPrice} MMK</span></p>
    
    <h4 class="text-lg font-semibold text-accent-purple mb-3">SELECT PAYMENT METHOD</h4>
    <div id="payment-methods-list" class="space-y-3 mb-4">
      <div class="loading-spinner mx-auto mb-2"></div>
      <p class="text-center text-text-secondary">Loading payment methods...</p>
    </div>

    <div class="space-y-3">
      <label class="block text-sm font-medium text-text-secondary">UPLOAD RECEIPT IMAGE</label>
      <input type="file" id="receipt-upload" accept="image/*" class="app-input w-full">
      <button onclick="submitPurchase()" class="myanmar-btn w-full">
        <i class="fas fa-paper-plane mr-2"></i>
        CONFIRM PAYMENT
      </button>
    </div>
    <p class="text-sm text-text-secondary mt-4">
      <i class="fas fa-info-circle mr-1"></i>
      After confirming payment, Admin will review and approve your download.
    </p>
  `;

  document.getElementById('payment-modal').classList.remove('hidden');
  
  const paymentMethodsList = document.getElementById('payment-methods-list');
  try {
    const { data: methods, error } = await state.supabase
      .from('payment_methods')
      .select('*')
      .eq('is_active', true)
      .order('method_name', { ascending: true });

    if (error) throw error;

    if (methods && methods.length > 0) {
      paymentMethodsList.innerHTML = methods.map(method => `
        <label class="flex items-center space-x-3 p-3 bg-secondary-bg rounded-lg cursor-pointer border border-border-color">
          <input type="radio" name="payment_method" value="${method.id}" 
                 onchange="state.selectedPaymentMethod = '${method.id}'" class="w-4 h-4 text-accent-purple focus:ring-accent-purple">
          <div>
            <p class="font-semibold text-text-primary">${method.method_name}</p>
            <p class="text-text-secondary text-sm">${method.account_info || ''}</p>
            ${method.qr_code_url ? `<img src="${method.qr_code_url}" class="w-24 h-24 mt-2 rounded-md border border-border-color" alt="QR Code">` : ''}
            ${method.instructions ? `<p class="text-text-secondary text-xs mt-1">${method.instructions}</p>` : ''}
          </div>
        </label>
      `).join('');
    } else {
      paymentMethodsList.innerHTML = '<p class="text-center text-text-secondary">No Payment Methods Available</p>';
    }
  } catch (error) {
    console.error('Error loading payment methods:', error);
    showNotification('Failed to retrieve Payment Methods', 'error');
    paymentMethodsList.innerHTML = '<p class="text-center text-accent-red">Failed to retrieve Payment Methods</p>';
  }
}

async function initiateMarketplacePurchase(productId, productName, productPrice, sellerId) { // For marketplace_products
  if (!state.userProfile || !state.userProfile.id) {
    showNotification('Please create a profile to purchase products.', 'info');
    return;
  }
  if (state.userProfile.id === sellerId) {
    showNotification('You cannot purchase your own product.', 'warning');
    return;
  }

  state.selectedMarketplaceProductForPurchase = { id: productId, name: productName, price: productPrice, seller_id: sellerId };
  state.selectedProductForPurchase = null; // Clear admin product selection
  
  const paymentModalContent = document.getElementById('payment-modal-content');
  paymentModalContent.innerHTML = `
    <h3 class="text-xl font-semibold text-text-primary mb-2">${productName}</h3>
    <p class="text-text-secondary mb-4">Price: <span class="text-accent-green font-bold">${productPrice} MMK</span></p>
    
    <h4 class="text-lg font-semibold text-accent-purple mb-3">SELECT PAYMENT METHOD</h4>
    <div id="payment-methods-list" class="space-y-3 mb-4">
      <div class="loading-spinner mx-auto mb-2"></div>
      <p class="text-center text-text-secondary">Loading payment methods...</p>
    </div>

    <div class="space-y-3">
      <label class="block text-sm font-medium text-text-secondary">UPLOAD RECEIPT IMAGE</label>
      <input type="file" id="receipt-upload" accept="image/*" class="app-input w-full">
      <button onclick="submitMarketplacePurchase()" class="myanmar-btn w-full">
        <i class="fas fa-paper-plane mr-2"></i>
        CONFIRM PAYMENT
      </button>
    </div>
    <p class="text-sm text-text-secondary mt-4">
      <i class="fas fa-info-circle mr-1"></i>
      After confirming payment, Admin will review and approve your download.
    </p>
  `;

  document.getElementById('payment-modal').classList.remove('hidden');
  
  const paymentMethodsList = document.getElementById('payment-methods-list');
  try {
    const { data: methods, error } = await state.supabase
      .from('payment_methods')
      .select('*')
      .eq('is_active', true)
      .order('method_name', { ascending: true });

    if (error) throw error;

    if (methods && methods.length > 0) {
      paymentMethodsList.innerHTML = methods.map(method => `
        <label class="flex items-center space-x-3 p-3 bg-secondary-bg rounded-lg cursor-pointer border border-border-color">
          <input type="radio" name="payment_method" value="${method.id}" 
                 onchange="state.selectedPaymentMethod = '${method.id}'" class="w-4 h-4 text-accent-purple focus:ring-accent-purple">
          <div>
            <p class="font-semibold text-text-primary">${method.method_name}</p>
            <p class="text-text-secondary text-sm">${method.account_info || ''}</p>
            ${method.qr_code_url ? `<img src="${method.qr_code_url}" class="w-24 h-24 mt-2 rounded-md border border-border-color" alt="QR Code">` : ''}
            ${method.instructions ? `<p class="text-text-secondary text-xs mt-1">${method.instructions}</p>` : ''}
          </div>
        </label>
      `).join('');
    } else {
      paymentMethodsList.innerHTML = '<p class="text-center text-text-secondary">No Payment Methods Available</p>';
    }
  } catch (error) {
    console.error('Error loading payment methods:', error);
    showNotification('Failed to retrieve Payment Methods', 'error');
    paymentMethodsList.innerHTML = '<p class="text-center text-accent-red">Failed to retrieve Payment Methods</p>';
  }
}

function closePaymentModal() {
  document.getElementById('payment-modal').classList.add('hidden');
  state.selectedProductForPurchase = null;
  state.selectedMarketplaceProductForPurchase = null;
  state.selectedPaymentMethod = null;
  document.getElementById('receipt-upload').value = '';
}

async function submitPurchase() { // For admin_products
  if (!state.selectedProductForPurchase || !state.selectedPaymentMethod) {
    showNotification('Please select a Product and Payment Method', 'warning');
    return;
  }
  const receiptFile = document.getElementById('receipt-upload').files[0];
  if (!receiptFile) {
    showNotification('Please upload a receipt image', 'warning');
    return;
  }

  showNotification('Confirming payment...', 'info');
  showLoading(true);

  try {
    // Upload receipt image
    const fileExt = receiptFile.name.split('.').pop();
    const fileName = `receipts/${state.userProfile.id}_${state.selectedProductForPurchase.id}_${Date.now()}.${fileExt}`;
    
    const { data: uploadData, error: uploadError } = await state.supabase.storage
      .from('payment_receipts')
      .upload(fileName, receiptFile);
      
    if (uploadError) throw uploadError;
    
    const { data: urlData } = state.supabase.storage
      .from('payment_receipts')
      .getPublicUrl(fileName);
      
    const receiptUrl = urlData.publicUrl;

    // Create order
    const { error: orderError } = await state.supabase.rpc('create_order', {
      p_product_id: state.selectedProductForPurchase.id,
      p_amount: state.selectedProductForPurchase.price,
      p_payment_method_id: state.selectedPaymentMethod
    });

    if (orderError) throw orderError;

    // Update order with receipt URL
    const { error: updateError } = await state.supabase.rpc('upload_payment_receipt_for_order', {
      p_order_id: orderError.details.id, // Assuming RPC returns order ID on creation
      p_receipt_url: receiptUrl
    });
    if (updateError) throw updateError;


    showNotification('Payment submitted successfully! Admin will review it.', 'success');
    closePaymentModal();
    loadProductsData(); // Reload products to update status
  } catch (error) {
    console.error('Error submitting purchase:', error);
    showNotification(`Failed to submit payment: ${error.message}`, 'error');
  } finally {
    showLoading(false);
  }
}

async function submitMarketplacePurchase() { // For marketplace_products
  if (!state.selectedMarketplaceProductForPurchase || !state.selectedPaymentMethod) {
    showNotification('Please select a Product and Payment Method', 'warning');
    return;
  }
  const receiptFile = document.getElementById('receipt-upload').files[0];
  if (!receiptFile) {
    showNotification('Please upload a receipt image', 'warning');
    return;
  }

  showNotification('Confirming payment...', 'info');
  showLoading(true);

  try {
    // Upload receipt image
    const fileExt = receiptFile.name.split('.').pop();
    const fileName = `receipts/${state.userProfile.id}_${state.selectedMarketplaceProductForPurchase.id}_${Date.now()}.${fileExt}`;
    
    const { data: uploadData, error: uploadError } = await state.supabase.storage
      .from('payment_receipts')
      .upload(fileName, receiptFile);
      
    if (uploadError) throw uploadError;
    
    const { data: urlData } = state.supabase.storage
      .from('payment_receipts')
      .getPublicUrl(fileName);
      
    const receiptUrl = urlData.publicUrl;

    // Create user order
    const { data: newOrder, error: orderError } = await state.supabase.rpc('create_user_order', {
      p_marketplace_product_id: state.selectedMarketplaceProductForPurchase.id,
      p_amount: state.selectedMarketplaceProductForPurchase.price,
      p_payment_method_id: state.selectedPaymentMethod
    });

    if (orderError) throw orderError;

    // Update order with receipt URL
    const { error: updateError } = await state.supabase.rpc('upload_payment_receipt_for_user_order', {
      p_order_id: newOrder.id, // Assuming RPC returns order ID on creation
      p_receipt_url: receiptUrl
    });
    if (updateError) throw updateError;

    showNotification('Payment submitted successfully! Admin will review it.', 'success');
    closePaymentModal();
    loadMarketplaceProductsData(); // Reload products to update status
  } catch (error) {
    console.error('Error submitting marketplace purchase:', error);
    showNotification(`Failed to submit payment: ${error.message}`, 'error');
  } finally {
    showLoading(false);
  }
}

async function loadChatConversations() {
  const conversationsList = document.getElementById('chat-conversations-list');
  const chatMessagesContainer = document.getElementById('chat-messages-container');
  const createNewTicketBtn = document.getElementById('create-new-ticket-btn');

  conversationsList.innerHTML = `
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-center text-text-secondary">Loading conversations...</p>
  `;
  chatMessagesContainer.classList.add('hidden');
  createNewTicketBtn.classList.remove('hidden'); // Ensure create ticket button is visible

  if (!state.userProfile || !state.userProfile.id) {
    conversationsList.innerHTML = `
      <div class="text-center text-text-secondary py-8">
        <i class="fas fa-comments text-4xl mb-4"></i>
        <p>Please create a profile to use chat.</p>
      </div>
    `;
    return;
  }

  try {
    const { data: conversations, error } = await state.supabase
      .from('conversations')
      .select(`
        *,
        participant1:profiles!participant1_id(username, name, profile_picture),
        participant2:profiles!participant2_id(username, name, profile_picture),
        user_orders(marketplace_products(name))
      `)
      .or(`participant1_id.eq.${state.userProfile.id},participant2_id.eq.${state.userProfile.id}`)
      .order('updated_at', { ascending: false });

    if (error) throw error;

    if (conversations && conversations.length > 0) {
      conversationsList.innerHTML = conversations.map(conv => {
        const otherParticipant = conv.participant1.id === state.userProfile.id ? conv.participant2 : conv.participant1;
        const otherName = otherParticipant?.name || 'Unknown User';
        const otherUsername = otherParticipant?.username || 'unknown';
        const otherAvatar = otherParticipant?.profile_picture || '/placeholder.svg?height=40&width=40';
        const orderInfo = conv.user_orders ? ` (Order: ${conv.user_orders.marketplace_products?.name || 'N/A'})` : '';

        return `
          <div onclick="openChatConversation('${conv.id}', '${otherName} (@${otherUsername})')" 
               class="app-card p-4 flex items-center space-x-4 cursor-pointer hover:bg-secondary-bg transition-colors duration-200">
            <img src="${otherAvatar}" alt="Chat Partner" class="w-12 h-12 rounded-full object-cover">
            <div>
              <h4 class="font-semibold text-text-primary">${otherName}</h4>
              <p class="text-sm text-text-secondary">@${otherUsername}${orderInfo}</p>
              <p class="text-xs text-text-secondary mt-1">Last message: ${utils.formatDateTime(conv.updated_at)}</p>
            </div>
          </div>
        `;
      }).join('');
    } else {
      conversationsList.innerHTML = `
        <div class="text-center text-text-secondary py-8">
          <i class="fas fa-comments text-4xl mb-4"></i>
          <p>No conversations yet. Start a chat from a product page!</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading chat conversations:', error);
    conversationsList.innerHTML = `
      <div class="text-center text-accent-red py-8">
        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
        <p>Failed to retrieve Chat Conversations</p>
      </div>
    `;
  }
}

async function openChatConversation(conversationId, partnerName) {
  state.currentChatConversationId = conversationId;
  document.getElementById('chat-conversations-list').classList.add('hidden');
  document.getElementById('chat-messages-container').classList.remove('hidden');
  document.getElementById('chat-partner-name').textContent = `Chat with ${partnerName}`;
  await loadChatMessages(conversationId);
}

function closeChatConversation() {
  state.currentChatConversationId = null;
  document.getElementById('chat-messages-container').classList.add('hidden');
  document.getElementById('chat-conversations-list').classList.remove('hidden');
  loadChatConversations(); // Reload conversation list
}

async function loadChatMessages(conversationId) {
  const chatMessagesContainer = document.getElementById('chat-messages');
  chatMessagesContainer.innerHTML = `
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-center text-text-secondary">Loading messages...</p>
  `;

  if (!state.userProfile || !state.userProfile.id) {
    chatMessagesContainer.innerHTML = `
      <div class="text-center text-text-secondary py-8">
        <i class="fas fa-comments text-4xl mb-4"></i>
        <p>Please create a profile to use chat.</p>
      </div>
    `;
    return;
  }

  try {
    const { data: messages, error } = await state.supabase
      .from('chats')
      .select(`
        *,
        sender:profiles(username, name, profile_picture)
      `)
      .eq('conversation_id', conversationId)
      .order('created_at', { ascending: true })
      .limit(100); // Limit to last 100 messages

    if (error) throw error;

    if (messages && messages.length > 0) {
      chatMessagesContainer.innerHTML = messages.map(message => {
        const isCurrentUser = message.sender_id === state.userProfile.id;
        const senderName = message.sender?.name || 'Unknown User';
        const senderUsername = message.sender?.username || 'unknown';
        const avatar = message.sender?.profile_picture || '/placeholder.svg?height=40&width=40';
        
        return `
          <div class="flex items-start mb-4 ${isCurrentUser ? 'justify-end' : ''}">
            ${!isCurrentUser ? `<img src="${avatar}" class="w-8 h-8 rounded-full object-cover mr-3" alt="Sender Avatar">` : ''}
            <div class="max-w-[70%] p-3 rounded-lg ${isCurrentUser ? 'bg-accent-purple text-white ml-auto' : 'bg-secondary-bg text-text-primary mr-auto'}">
              <p class="font-semibold text-sm mb-1">${isCurrentUser ? 'You' : senderName}</p>
              <p class="text-sm">${message.message}</p>
              <span class="block text-xs opacity-70 mt-1">${utils.formatDateTime(message.created_at)}</span>
            </div>
            ${isCurrentUser ? `<img src="${state.userProfile.profile_picture || '/placeholder.svg?height=40&width=40'}" class="w-8 h-8 rounded-full object-cover ml-3" alt="Your Avatar">` : ''}
          </div>
        `;
      }).join('');
      chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom
    } else {
      chatMessagesContainer.innerHTML = `
        <div class="text-center text-text-secondary py-8">
          <i class="fas fa-comments text-4xl mb-4"></i>
          <p>No messages yet. Start the conversation!</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading chat messages:', error);
    chatMessagesContainer.innerHTML = `
      <div class="text-center text-accent-red py-8">
        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
        <p>Failed to retrieve Chat Messages</p>
      </div>
    `;
  }
}

async function sendChatMessage() {
  const chatInput = document.getElementById('chat-input');
  const messageContent = chatInput.value.trim();

  if (!messageContent) {
    showNotification('Message cannot be empty.', 'warning');
    return;
  }
  if (!state.userProfile || !state.userProfile.id || !state.currentChatConversationId) {
    showNotification('Please create a profile and select a conversation to send messages.', 'info');
    return;
  }

  try {
    const { error } = await state.supabase.rpc('send_chat_message', {
      p_conversation_id: state.currentChatConversationId,
      p_message: messageContent
    });

    if (error) throw error;

    chatInput.value = '';
    showNotification('Message sent!', 'success');
    loadChatMessages(state.currentChatConversationId); // Reload messages to show the new one
  } catch (error) {
    console.error('Error sending chat message:', error);
    showNotification(`Failed to send message: ${error.message}`, 'error');
  }
}

async function loadSupportTickets() {
  const ticketsList = document.getElementById('support-tickets-list');
  const ticketDetailsContainer = document.getElementById('support-ticket-details-container');
  const createTicketForm = document.getElementById('create-ticket-form');
  const createNewTicketBtn = document.getElementById('create-new-ticket-btn');

  ticketsList.innerHTML = `
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-center text-text-secondary">Loading support tickets...</p>
  `;
  ticketDetailsContainer.classList.add('hidden');
  createTicketForm.classList.add('hidden');
  createNewTicketBtn.classList.remove('hidden');

  if (!state.userProfile || !state.userProfile.id) {
    ticketsList.innerHTML = `
      <div class="text-center text-text-secondary py-8">
        <i class="fas fa-headset text-4xl mb-4"></i>
        <p>Please create a profile to use support.</p>
      </div>
    `;
    return;
  }

  try {
    const { data: tickets, error } = await state.supabase
      .from('support_tickets')
      .select('*')
      .eq('user_id', state.userProfile.id)
      .order('created_at', { ascending: false });

    if (error) throw error;

    if (tickets && tickets.length > 0) {
      ticketsList.innerHTML = tickets.map(ticket => `
        <div onclick="viewSupportTicketDetails('${ticket.id}')" 
             class="app-card p-4 flex items-center justify-between cursor-pointer hover:bg-secondary-bg transition-colors duration-200">
          <div>
            <h4 class="font-semibold text-text-primary">${ticket.subject}</h4>
            <p class="text-sm text-text-secondary">Status: <span class="status-${ticket.status}">${ticket.status.toUpperCase()}</span></p>
            <p class="text-xs text-text-secondary mt-1">Last update: ${utils.formatDateTime(ticket.updated_at)}</p>
          </div>
          <i class="fas fa-chevron-right text-text-secondary"></i>
        </div>
      `).join('');
    } else {
      ticketsList.innerHTML = `
        <div class="text-center text-text-secondary py-8">
          <i class="fas fa-headset text-4xl mb-4"></i>
          <p>No support tickets yet. Create one!</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading support tickets:', error);
    ticketsList.innerHTML = `
      <div class="text-center text-accent-red py-8">
        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
        <p>Failed to retrieve Support Tickets</p>
      </div>
    `;
  }
}

async function viewSupportTicketDetails(ticketId) {
  state.currentSupportTicketId = ticketId;
  document.getElementById('support-tickets-list').classList.add('hidden');
  document.getElementById('create-new-ticket-btn').classList.add('hidden');
  document.getElementById('create-ticket-form').classList.add('hidden');
  document.getElementById('support-ticket-details-container').classList.remove('hidden');

  const ticketSubjectElement = document.getElementById('support-ticket-subject');
  const ticketMessagesElement = document.getElementById('support-ticket-messages');
  ticketMessagesElement.innerHTML = `
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-center text-text-secondary">Loading messages...</p>
  `;

  try {
    const { data: ticket, error } = await state.supabase
      .from('support_tickets')
      .select('*')
      .eq('id', ticketId)
      .eq('user_id', state.userProfile.id) // Ensure user can only view their own ticket
      .single();

    if (error) throw error;

    ticketSubjectElement.textContent = `Ticket: ${ticket.subject} (Status: ${ticket.status.toUpperCase()})`;
    
    let messagesHtml = `
      <div class="mb-4 p-3 rounded-lg border bg-blue-600 bg-opacity-20 border-blue-500">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center space-x-2">
            <i class="fas fa-user text-sm"></i>
            <span class="font-semibold text-sm">You</span>
          </div>
          <span class="text-xs text-text-secondary">${utils.formatDateTime(ticket.created_at)}</span>
        </div>
        <p class="text-sm text-text-secondary whitespace-pre-wrap">${ticket.message}</p>
      </div>
    `;

    if (ticket.admin_response) {
      messagesHtml += `
        <div class="mb-4 p-3 rounded-lg border bg-green-600 bg-opacity-20 border-green-500">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center space-x-2">
              <i class="fas fa-headset text-sm"></i>
              <span class="font-semibold text-sm">Admin</span>
            </div>
            <span class="text-xs text-text-secondary">${utils.formatDateTime(ticket.updated_at)}</span>
          </div>
          <p class="text-sm text-text-secondary whitespace-pre-wrap">${ticket.admin_response}</p>
        </div>
      `;
    }

    ticketMessagesElement.innerHTML = messagesHtml;
    ticketMessagesElement.scrollTop = ticketMessagesElement.scrollHeight; // Scroll to bottom

  } catch (error) {
    console.error('Error viewing support ticket details:', error);
    showNotification(`Failed to retrieve ticket details: ${error.message}`, 'error');
    closeSupportTicketDetails();
  }
}

function closeSupportTicketDetails() {
  state.currentSupportTicketId = null;
  document.getElementById('support-ticket-details-container').classList.add('hidden');
  document.getElementById('support-reply-input').value = '';
  document.getElementById('create-new-ticket-btn').classList.remove('hidden');
  loadSupportTickets(); // Reload ticket list
}

async function sendSupportReply() {
  const replyInput = document.getElementById('support-reply-input');
  const replyContent = replyInput.value.trim();

  if (!replyContent) {
    showNotification('Reply cannot be empty.', 'warning');
    return;
  }
  if (!state.userProfile || !state.userProfile.id || !state.currentSupportTicketId) {
    showNotification('Please select a ticket to reply.', 'info');
    return;
  }

  try {
    // This function is for user replies, which updates the original ticket message
    // If admin has responded, it will overwrite. For a true chat, we'd need a separate messages table.
    // Given the current schema, user can only update their original message or admin can respond.
    // Let's assume user can only send a new message if admin hasn't responded yet, or if they want to update their original message.
    // For simplicity, we'll just update the original message if no admin response, or create a new ticket if admin has responded.
    // Or, better, use the admin_response field for admin only, and user can only update their initial message.
    // The current HTML implies a simple back-and-forth.
    // Let's use the `send_support_message` RPC for user replies, and it will create a new ticket if the current one is closed/responded.
    // Or, if the ticket is open/in_progress, it updates the message.

    // The current SQL function `send_support_message` creates a new ticket.
    // To reply to an existing ticket, we need a new RPC or direct update.
    // Let's assume for now that user can only create new tickets, and admin replies.
    // If user wants to add more info to an open ticket, they create a new one referencing the old subject.
    // This is a simplification based on the provided HTML and SQL.

    showNotification('To add more to an existing ticket, please create a new ticket with a clear subject referencing the old one.', 'info');
    replyInput.value = '';

  } catch (error) {
    console.error('Error sending support reply:', error);
    showNotification(`Failed to send reply: ${error.message}`, 'error');
  }
}

function showCreateTicketForm() {
  document.getElementById('support-tickets-list').classList.add('hidden');
  document.getElementById('create-new-ticket-btn').classList.add('hidden');
  document.getElementById('create-ticket-form').classList.remove('hidden');
  document.getElementById('new-ticket-subject').value = '';
  document.getElementById('new-ticket-message').value = '';
}

function hideCreateTicketForm() {
  document.getElementById('create-ticket-form').classList.add('hidden');
  document.getElementById('support-tickets-list').classList.remove('hidden');
  document.getElementById('create-new-ticket-btn').classList.remove('hidden');
  loadSupportTickets();
}

async function submitNewTicket() {
  const subject = document.getElementById('new-ticket-subject').value.trim();
  const message = document.getElementById('new-ticket-message').value.trim();

  if (!subject || !message) {
    showNotification('Subject and message cannot be empty.', 'warning');
    return;
  }
  if (!state.userProfile || !state.userProfile.id) {
    showNotification('Please create a profile to submit a ticket.', 'info');
    return;
  }

  showLoading(true);
  try {
    const { error } = await state.supabase.rpc('send_support_message', {
      p_subject: subject,
      p_message: message
    });

    if (error) throw error;

    showNotification('Support ticket submitted successfully!', 'success');
    hideCreateTicketForm();
  } catch (error) {
    console.error('Error submitting new ticket:', error);
    showNotification(`Failed to submit ticket: ${error.message}`, 'error');
  } finally {
    showLoading(false);
  }
}

async function loadAboutData() {
  const aboutContent = document.getElementById('about-content');
  aboutContent.innerHTML = `
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-center text-text-secondary">Loading about information...</p>
  `;
  try {
    const { data: about, error } = await state.supabase
      .from('about')
      .select('*')
      .eq('id', 'main')
      .single();
      
    if (error) throw error;
    
    let socialLinksHtml = '';
    if (about.social_links && about.social_links.length > 0) {
      about.social_links.forEach(link => {
        socialLinksHtml += `
          <a href="${link.url}" target="_blank" class="flex items-center justify-center p-3 rounded-lg bg-secondary-bg text-text-primary hover:bg-accent-purple hover:text-white transition-colors duration-300">
            <img src="${link.icon_url || '/placeholder.svg?height=24&width=24'}" class="w-6 h-6 mr-2" alt="${link.name} icon">
            <span>${link.name}</span>
          </a>
        `;
      });
    }

    aboutContent.innerHTML = `
      <div class="space-y-4">
        <div class="text-center">
          <h3 class="text-xl font-orbitron font-bold text-accent-purple mb-4">CONTACT INFORMATION</h3>
        </div>
        <div class="space-y-3">
          ${about.contact_name ? `<p class="text-text-primary"><i class="fas fa-user mr-2 text-accent-green"></i> ${about.contact_name}</p>` : ''}
          ${about.phone_number ? `
            <a href="tel:${about.phone_number}" class="myanmar-btn w-full flex items-center justify-center">
              <i class="fas fa-phone mr-2"></i>
              ${about.phone_number}
            </a>
          ` : ''}
          ${about.email ? `<p class="text-text-primary"><i class="fas fa-envelope mr-2 text-accent-green"></i> ${about.email}</p>` : ''}
          ${about.description ? `<p class="text-text-primary mt-4">${about.description}</p>` : ''}
          ${socialLinksHtml ? `
            <h4 class="text-lg font-orbitron font-bold text-accent-purple mt-4 mb-3">SOCIAL MEDIA</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              ${socialLinksHtml}
            </div>
          ` : ''}
        </div>
        <div class="mt-6 p-4 bg-blue-600 bg-opacity-20 border border-blue-500 rounded-lg text-text-primary">
          <h4 class="text-blue-400 font-semibold mb-2">
            <i class="fas fa-info-circle mr-2"></i>
            IMPORTANT NOTICE
          </h4>
          <p class="text-sm text-text-secondary">
            For key purchases or any assistance, please contact us through the methods above.
          </p>
        </div>
      </div>
    `;
  } catch (error) {
    console.error('Error loading about info:', error);
    aboutContent.innerHTML = `
      <div class="text-center text-accent-red">
        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
        <p>Failed to retrieve About Information</p>
      </div>
    `;
  }
}

async function loadMiProfile() {
  const profileDetails = document.getElementById('profile-details');
  profileDetails.innerHTML = `
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-center text-text-secondary">Loading profile...</p>
  `;

  if (!state.userProfile || !state.userProfile.id) {
    profileDetails.innerHTML = `
      <div class="text-center text-text-secondary py-8">
        <i class="fas fa-user-circle text-4xl mb-4"></i>
        <p>No profile found. Please create one.</p>
      </div>
    `;
    return;
  }

  try {
    const { data: profile, error } = await state.supabase
      .from('profiles')
      .select(`
        *,
        kyc_request:kyc_requests(status)
      `)
      .eq('id', state.userProfile.id)
      .single();

    if (error) throw error;

    document.getElementById('mi-profile-picture').src = profile.profile_picture || '/placeholder.svg?height=100&width=100';
    document.getElementById('mi-name').textContent = profile.name || 'N/A';
    document.getElementById('mi-username').textContent = `@${profile.username || 'N/A'}`;
    document.getElementById('mi-key-text').value = localStorage.getItem('user_key') || 'N/A'; // Get key from local storage
    document.getElementById('mi-account-status').value = profile.is_banned ? 'BANNED' : 'ACTIVE';
    document.getElementById('mi-kyc-status').value = profile.kyc_status ? profile.kyc_status.toUpperCase() : 'N/A';

    // Update KYC form visibility based on kyc_status
    const kycStatusDisplay = document.getElementById('kyc-status-display');
    const kycForm = document.getElementById('kyc-form');
    const showKycFormBtn = document.getElementById('show-kyc-form-btn');

    if (profile.kyc_status === 'approved') {
      kycStatusDisplay.innerHTML = `<p class="text-accent-green font-bold">KYC Status: APPROVED <i class="fas fa-check-circle"></i></p>`;
      kycForm.classList.add('hidden');
      showKycFormBtn.classList.add('hidden');
    } else if (profile.kyc_status === 'pending') {
      kycStatusDisplay.innerHTML = `<p class="text-accent-purple font-bold">KYC Status: PENDING <i class="fas fa-hourglass-half"></i></p><p class="text-sm">Your request is under review.</p>`;
      kycForm.classList.add('hidden');
      showKycFormBtn.classList.add('hidden');
    } else if (profile.kyc_status === 'rejected') {
      kycStatusDisplay.innerHTML = `<p class="text-accent-red font-bold">KYC Status: REJECTED <i class="fas fa-times-circle"></i></p><p class="text-sm">Your request was rejected. You can resubmit.</p>`;
      kycForm.classList.add('hidden'); // Keep hidden initially, user can click to show
      showKycFormBtn.classList.remove('hidden');
    } else { // 'pending' or no status yet
      kycStatusDisplay.innerHTML = `<p class="text-text-secondary">KYC Status: Not Submitted</p>`;
      kycForm.classList.add('hidden');
      showKycFormBtn.classList.remove('hidden');
    }

  } catch (error) {
    console.error('Error loading Mi profile:', error);
    profileDetails.innerHTML = `
      <div class="text-center text-accent-red">
        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
        <p>Failed to retrieve Profile Information</p>
      </div>
    `;
  }
}

async function updateProfile() {
  if (!state.userProfile || !state.userProfile.id) {
    showNotification('No profile to update.', 'warning');
    return;
  }

  const newProfilePictureFile = document.getElementById('mi-new-profile-picture').files[0];
  showLoading(true);

  try {
    let profilePictureUrl = state.userProfile.profile_picture; // Keep existing if no new file

    if (newProfilePictureFile) {
      const fileExt = newProfilePictureFile.name.split('.').pop();
      const fileName = `avatars/${state.userProfile.id}_${Date.now()}.${fileExt}`;
      
      const { data: uploadData, error: uploadError } = await state.supabase.storage
        .from('profile_avatars')
        .upload(fileName, newProfilePictureFile);
        
      if (uploadError) throw uploadError;
      
      const { data: urlData } = state.supabase.storage
        .from('profile_avatars')
        .getPublicUrl(fileName);
        
      profilePictureUrl = urlData.publicUrl;
    }

    const { error } = await state.supabase.rpc('update_profile_picture', { 
      p_profile_picture: profilePictureUrl
    });

    if (error) throw error;

    state.userProfile.profile_picture = profilePictureUrl; // Update local state
    document.getElementById('mi-new-profile-picture').value = ''; // Clear file input
    showNotification('Profile updated successfully!', 'success');
    loadMiProfile(); // Reload to show updated picture
  } catch (error) {
    console.error('Error updating profile:', error);
    showNotification(`Failed to update profile: ${error.message}`, 'error');
  } finally {
    showLoading(false);
  }
}

function toggleKycForm() {
  const kycForm = document.getElementById('kyc-form');
  const showKycFormBtn = document.getElementById('show-kyc-form-btn');
  if (kycForm.classList.contains('hidden')) {
    kycForm.classList.remove('hidden');
    showKycFormBtn.textContent = 'HIDE KYC FORM';
    showKycFormBtn.classList.add('btn-danger');
  } else {
    kycForm.classList.add('hidden');
    showKycFormBtn.textContent = 'SUBMIT KYC REQUEST';
    showKycFormBtn.classList.remove('btn-danger');
  }
}

async function submitKyc() {
  const fullName = document.getElementById('kyc-full-name').value.trim();
  const dob = document.getElementById('kyc-dob').value;
  const idType = document.getElementById('kyc-id-type').value;
  const idNumber = document.getElementById('kyc-id-number').value.trim();
  const expiryDate = document.getElementById('kyc-expiry-date').value;
  const address = document.getElementById('kyc-address').value.trim();
  const idPhotoFile = document.getElementById('kyc-id-photo').files[0];
  const videoFile = document.getElementById('kyc-video').files[0];

  if (!fullName || !dob || !idType || !idNumber || !expiryDate || !address || !idPhotoFile) {
    showNotification('Please fill all required KYC fields (except video).', 'warning');
    return;
  }

  showLoading(true);
  try {
    let idPhotoUrl = null;
    let videoUrl = null;

    // Upload ID Photo
    const idPhotoExt = idPhotoFile.name.split('.').pop();
    const idPhotoFileName = `kyc/${state.userProfile.id}_id_photo_${Date.now()}.${idPhotoExt}`;
    const { data: idPhotoUploadData, error: idPhotoUploadError } = await state.supabase.storage
      .from('kyc_documents')
      .upload(idPhotoFileName, idPhotoFile);
    if (idPhotoUploadError) throw idPhotoUploadError;
    const { data: idPhotoUrlData } = state.supabase.storage.from('kyc_documents').getPublicUrl(idPhotoFileName);
    idPhotoUrl = idPhotoUrlData.publicUrl;

    // Upload Video if provided
    if (videoFile) {
      const videoExt = videoFile.name.split('.').pop();
      const videoFileName = `kyc/${state.userProfile.id}_video_${Date.now()}.${videoExt}`;
      const { data: videoUploadData, error: videoUploadError } = await state.supabase.storage
        .from('kyc_documents')
        .upload(videoFileName, videoFile);
      if (videoUploadError) throw videoUploadError;
      const { data: videoUrlData } = state.supabase.storage.from('kyc_documents').getPublicUrl(videoFileName);
      videoUrl = videoUrlData.publicUrl;
    }

    const { error } = await state.supabase.rpc('submit_kyc_request', {
      p_full_name: fullName,
      p_date_of_birth: dob,
      p_id_type: idType,
      p_id_number: idNumber,
      p_expiry_date: expiryDate,
      p_address: address,
      p_id_photo_url: idPhotoUrl,
      p_video_url: videoUrl
    });

    if (error) throw error;

    showNotification('KYC request submitted successfully! Please wait for admin review.', 'success');
    toggleKycForm(); // Hide form
    loadMiProfile(); // Reload profile to update KYC status display

  } catch (error) {
    console.error('Error submitting KYC:', error);
    showNotification(`Failed to submit KYC: ${error.message}`, 'error');
  } finally {
    showLoading(false);
  }
}

function showAddMarketplaceProductForm() {
  const addForm = document.getElementById('add-marketplace-product-form');
  const addBtn = document.getElementById('add-marketplace-product-btn');
  const tableContainer = document.getElementById('marketplace-products-table-container');

  if (addForm.classList.contains('hidden')) {
    addForm.classList.remove('hidden');
    addBtn.textContent = 'HIDE FORM';
    addBtn.classList.add('btn-danger');
    tableContainer.classList.add('hidden'); // Hide table when form is open
  } else {
    addForm.classList.add('hidden');
    addBtn.textContent = 'ADD NEW PRODUCT';
    addBtn.classList.remove('btn-danger');
    tableContainer.classList.remove('hidden'); // Show table when form is closed
  }
  // Clear form fields
  document.getElementById('mp-product-name').value = '';
  document.getElementById('mp-product-description').value = '';
  document.getElementById('mp-product-price').value = '';
  document.getElementById('mp-product-images').value = '';
  document.getElementById('mp-product-video').value = '';
  document.getElementById('mp-product-category').value = '';
  document.getElementById('mp-contact-platform').value = '';
  document.getElementById('mp-contact-link').value = '';
}

function hideAddMarketplaceProductForm() {
  showAddMarketplaceProductForm(); // Toggle to hide
}

async function submitMarketplaceProduct() {
  const name = document.getElementById('mp-product-name').value.trim();
  const description = document.getElementById('mp-product-description').value.trim();
  const price = parseFloat(document.getElementById('mp-product-price').value);
  const images = document.getElementById('mp-product-images').files;
  const video = document.getElementById('mp-product-video').files[0];
  const categoryId = document.getElementById('mp-product-category').value;
  const contactPlatform = document.getElementById('mp-contact-platform').value.trim();
  const contactLink = document.getElementById('mp-contact-link').value.trim();

  if (!name || !description || isNaN(price) || images.length === 0 || !categoryId || !contactPlatform || !contactLink) {
    showNotification('Please fill all required fields (Name, Description, Price, Images, Category, Contact Info).', 'warning');
    return;
  }
  if (images.length > 5) {
    showNotification('You can upload a maximum of 5 images.', 'warning');
    return;
  }
  if (state.userProfile.kyc_status !== 'approved') {
    showNotification('Your KYC must be approved to submit marketplace products.', 'error');
    return;
  }

  showLoading(true);
  try {
    let imageUrls = [];
    for (let i = 0; i < images.length; i++) {
      const file = images[i];
      const fileExt = file.name.split('.').pop();
      const fileName = `marketplace_products/${state.userProfile.id}/${Date.now()}_${i}.${fileExt}`;
      const { data: uploadData, error: uploadError } = await state.supabase.storage
        .from('marketplace_product_media')
        .upload(fileName, file);
      if (uploadError) throw uploadError;
      const { data: urlData } = state.supabase.storage.from('marketplace_product_media').getPublicUrl(fileName);
      imageUrls.push(urlData.publicUrl);
    }

    let videoUrl = null;
    if (video) {
      const videoExt = video.name.split('.').pop();
      const videoFileName = `marketplace_products/${state.userProfile.id}/video_${Date.now()}.${videoExt}`;
      const { data: uploadData, error: uploadError } = await state.supabase.storage
        .from('marketplace_product_media')
        .upload(videoFileName, video);
      if (uploadError) throw uploadError;
      const { data: urlData } = state.supabase.storage.from('marketplace_product_media').getPublicUrl(videoFileName);
      videoUrl = urlData.publicUrl;
    }

    const { error } = await state.supabase.rpc('submit_marketplace_product', {
      p_name: name,
      p_description: description,
      p_price: price,
      p_image_urls: imageUrls,
      p_video_url: videoUrl,
      p_contact_platform: contactPlatform,
      p_contact_link: contactLink,
      p_category_id: categoryId
    });

    if (error) throw error;

    showNotification('Marketplace product submitted for review!', 'success');
    hideAddMarketplaceProductForm();
    loadMyMarketplaceProducts(); // Reload user's products
  } catch (error) {
    console.error('Error submitting marketplace product:', error);
    showNotification(`Failed to submit product: ${error.message}`, 'error');
  } finally {
    showLoading(false);
  }
}

async function loadMyMarketplaceProducts() {
  const tbody = document.getElementById('my-marketplace-products-table-body');
  tbody.innerHTML = `
    <tr>
      <td colspan="4" class="text-center text-text-secondary py-8">
        <div class="loading-spinner mx-auto mb-2"></div>
        Loading your products...
      </td>
    </tr>
  `;

  if (!state.userProfile || !state.userProfile.id) {
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="text-center text-text-secondary py-8">
          Please create a profile to view your products.
        </td>
      </tr>
    `;
    return;
  }

  try {
    const { data, error } = await state.supabase
      .from('marketplace_products')
      .select('*')
      .eq('seller_id', state.userProfile.id)
      .order('created_at', { ascending: false });

    if (error) throw error;

    if (data && data.length > 0) {
      tbody.innerHTML = data.map(product => {
        const statusClass = `status-${product.status}`;
        return `
          <tr>
            <td>${product.name}</td>
            <td>${product.price} MMK</td>
            <td><span class="${statusClass} font-semibold">${product.status.toUpperCase()}</span></td>
            <td>
              <div class="table-actions">
                <button onclick="editMarketplaceProduct('${product.id}')" class="myanmar-btn btn-small">
                  <i class="fas fa-edit mr-1"></i> EDIT
                </button>
                <button onclick="deleteMyMarketplaceProduct('${product.id}')" class="btn-danger myanmar-btn btn-small">
                  <i class="fas fa-trash mr-1"></i> DELETE
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    } else {
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="text-center text-text-secondary py-8">
            You have not posted any products yet.
          </td>
        </tr>
      `;
    }
  } catch (error) {
    console.error('Error loading my marketplace products:', error);
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="text-center text-accent-red py-8">
          Failed to retrieve your products
        </td>
      </tr>
    `;
  }
}

async function editMarketplaceProduct(productId) {
  try {
    const { data, error } = await state.supabase
      .from('marketplace_products')
      .select('*')
      .eq('id', productId)
      .eq('seller_id', state.userProfile.id)
      .single();

    if (error) throw error;

    document.getElementById('edit-mp-product-id').value = data.id;
    document.getElementById('edit-mp-product-name').value = data.name;
    document.getElementById('edit-mp-product-description').value = data.description;
    document.getElementById('edit-mp-product-price').value = data.price;
    document.getElementById('edit-mp-product-category').value = data.category_id;
    document.getElementById('edit-mp-contact-platform').value = data.contact_platform;
    document.getElementById('edit-mp-contact-link').value = data.contact_link;

    const currentImagesDiv = document.getElementById('edit-mp-current-images');
    currentImagesDiv.innerHTML = '';
    if (data.image_urls && data.image_urls.length > 0) {
      data.image_urls.forEach(url => {
        currentImagesDiv.innerHTML += `<img src="${url}" class="w-full h-24 object-cover rounded-md" alt="Current Image">`;
      });
    } else {
      currentImagesDiv.innerHTML = '<p class="text-text-secondary text-sm col-span-full">No current images.</p>';
    }

    const currentVideoDiv = document.getElementById('edit-mp-current-video');
    currentVideoDiv.innerHTML = '';
    if (data.video_url) {
      currentVideoDiv.innerHTML = `
        <video controls class="w-full rounded-lg">
          <source src="${data.video_url}" type="video/mp4">
        </video>
      `;
    } else {
      currentVideoDiv.innerHTML = '<p class="text-text-secondary text-sm">No current video.</p>';
    }

    document.getElementById('edit-marketplace-product-modal').classList.remove('hidden');

  } catch (error) {
    console.error('Error loading product for edit:', error);
    showNotification(`Failed to load product for editing: ${error.message}`, 'error');
  }
}

function closeEditMarketplaceProductModal() {
  document.getElementById('edit-marketplace-product-modal').classList.add('hidden');
  // Clear file inputs
  document.getElementById('edit-mp-product-images').value = '';
  document.getElementById('edit-mp-product-video').value = '';
}

async function updateMarketplaceProduct() {
  const productId = document.getElementById('edit-mp-product-id').value;
  const name = document.getElementById('edit-mp-product-name').value.trim();
  const description = document.getElementById('edit-mp-product-description').value.trim();
  const price = parseFloat(document.getElementById('edit-mp-product-price').value);
  const newImages = document.getElementById('edit-mp-product-images').files;
  const newVideo = document.getElementById('edit-mp-product-video').files[0];
  const categoryId = document.getElementById('edit-mp-product-category').value;
  const contactPlatform = document.getElementById('edit-mp-contact-platform').value.trim();
  const contactLink = document.getElementById('edit-mp-contact-link').value.trim();

  if (!name || !description || isNaN(price) || !categoryId || !contactPlatform || !contactLink) {
    showNotification('Please fill all required fields.', 'warning');
    return;
  }

  showLoading(true);
  try {
    // Fetch current product to get existing image/video URLs
    const { data: currentProduct, error: fetchError } = await state.supabase
      .from('marketplace_products')
      .select('image_urls, video_url')
      .eq('id', productId)
      .single();
    if (fetchError) throw fetchError;

    let imageUrls = currentProduct.image_urls || [];
    let videoUrl = currentProduct.video_url;

    // Upload new images and add to array
    for (let i = 0; i < newImages.length; i++) {
      const file = newImages[i];
      const fileExt = file.name.split('.').pop();
      const fileName = `marketplace_products/${state.userProfile.id}/${Date.now()}_new_img_${i}.${fileExt}`;
      const { data: uploadData, error: uploadError } = await state.supabase.storage
        .from('marketplace_product_media')
        .upload(fileName, file);
      if (uploadError) throw uploadError;
      const { data: urlData } = state.supabase.storage.from('marketplace_product_media').getPublicUrl(fileName);
      imageUrls.push(urlData.publicUrl);
    }
    if (imageUrls.length > 5) {
      showNotification('You can have a maximum of 5 images. Please remove some if needed.', 'error');
      showLoading(false);
      return;
    }

    // Upload new video if provided
    if (newVideo) {
      const videoExt = newVideo.name.split('.').pop();
      const videoFileName = `marketplace_products/${state.userProfile.id}/video_${Date.now()}.${videoExt}`;
      const { data: uploadData, error: uploadError } = await state.supabase.storage
        .from('marketplace_product_media')
        .upload(videoFileName, newVideo);
      if (uploadError) throw uploadError;
      const { data: urlData } = state.supabase.storage.from('marketplace_product_media').getPublicUrl(videoFileName);
      videoUrl = urlData.publicUrl;
    }

    const { error } = await state.supabase.rpc('update_marketplace_product', {
      p_product_id: productId,
      p_name: name,
      p_description: description,
      p_price: price,
      p_image_urls: imageUrls,
      p_video_url: videoUrl,
      p_contact_platform: contactPlatform,
      p_contact_link: contactLink
    });

    if (error) throw error;

    showNotification('Marketplace product updated successfully! It will be re-reviewed.', 'success');
    closeEditMarketplaceProductModal();
    loadMyMarketplaceProducts(); // Reload user's products
  } catch (error) {
    console.error('Error updating marketplace product:', error);
    showNotification(`Failed to update product: ${error.message}`, 'error');
  } finally {
    showLoading(false);
  }
}

function deleteMyMarketplaceProduct(productId) {
  showConfirmModal(
    'Are you sure you want to delete this product? This action cannot be undone.',
    async () => {
      try {
        showLoading(true);
        const { error } = await state.supabase.rpc('delete_marketplace_product', { p_product_id: productId });
        if (error) throw error;
        showNotification('Product deleted successfully!', 'success');
        loadMyMarketplaceProducts();
      } catch (error) {
        console.error('Error deleting product:', error);
        showNotification(`Failed to delete product: ${error.message}`, 'error');
      } finally {
        showLoading(false);
      }
    }
  );
}

async function loadMyOrders() { // For admin_products orders
  const tbody = document.getElementById('my-orders-table-body');
  tbody.innerHTML = `
    <tr>
      <td colspan="5" class="text-center text-text-secondary py-8">
        <div class="loading-spinner mx-auto mb-2"></div>
        Loading your orders...
      </td>
    </tr>
  `;

  if (!state.userProfile || !state.userProfile.id) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-text-secondary py-8">
          Please create a profile to view your orders.
        </td>
      </tr>
    `;
    return;
  }

  try {
    const { data, error } = await state.supabase
      .from('orders')
      .select(`
        *,
        product:admin_products(name),
        payment_method:payment_methods(method_name)
      `)
      .eq('buyer_id', state.userProfile.id)
      .order('ordered_at', { ascending: false });

    if (error) throw error;

    if (data && data.length > 0) {
      tbody.innerHTML = data.map(order => {
        const statusClass = `status-${order.status}`;
        return `
          <tr>
            <td>${order.product?.name || 'N/A'}</td>
            <td>${order.amount} MMK</td>
            <td><span class="${statusClass} font-semibold">${order.status.toUpperCase()}</span></td>
            <td>${utils.formatDateTime(order.ordered_at)}</td>
            <td>
              <div class="table-actions">
                ${order.receipt_url ? `
                <a href="${order.receipt_url}" target="_blank" class="myanmar-btn btn-small">
                  <i class="fas fa-receipt mr-1"></i> RECEIPT
                </a>
                ` : ''}
                ${order.status === 'pending' ? `
                <button onclick="initiatePurchase('${order.product_id}', '${order.product?.name || 'N/A'}', ${order.amount})" class="myanmar-btn btn-small">
                  <i class="fas fa-upload mr-1"></i> UPLOAD RECEIPT
                </button>
                ` : ''}
                ${order.status === 'approved' && order.product?.file_url ? `
                <a href="${order.product.file_url}" target="_blank" download class="myanmar-btn btn-small">
                  <i class="fas fa-download mr-1"></i> DOWNLOAD
                </a>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    } else {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center text-text-secondary py-8">
            You have no orders yet.
          </td>
        </tr>
      `;
    }
  } catch (error) {
    console.error('Error loading my orders:', error);
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-accent-red py-8">
          Failed to retrieve your orders
        </td>
      </tr>
    `;
  }
}

async function loadMySales() { // For marketplace_products orders
  const tbody = document.getElementById('my-sales-table-body');
  tbody.innerHTML = `
    <tr>
      <td colspan="6" class="text-center text-text-secondary py-8">
        <div class="loading-spinner mx-auto mb-2"></div>
        Loading your sales...
      </td>
    </tr>
  `;

  if (!state.userProfile || !state.userProfile.id) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center text-text-secondary py-8">
          Please create a profile to view your sales.
        </td>
      </tr>
    `;
    return;
  }

  try {
    const { data, error } = await state.supabase
      .from('user_orders')
      .select(`
        *,
        product:marketplace_products(name),
        buyer:profiles!buyer_id(username, name, profile_picture)
      `)
      .eq('seller_id', state.userProfile.id)
      .order('ordered_at', { ascending: false });

    if (error) throw error;

    if (data && data.length > 0) {
      tbody.innerHTML = data.map(order => {
        const statusClass = `status-${order.status}`;
        const buyerName = order.buyer?.name || 'N/A';
        const buyerUsername = order.buyer?.username || 'N/A';
        const buyerAvatar = order.buyer?.profile_picture || '/placeholder.svg?height=40&width=40';

        return `
          <tr>
            <td>${order.product?.name || 'N/A'}</td>
            <td>
              <img src="${buyerAvatar}" alt="Buyer" class="w-8 h-8 rounded-full object-cover mr-2 inline-block">
              ${buyerName} (@${buyerUsername})
            </td>
            <td>${order.amount} MMK</td>
            <td><span class="${statusClass} font-semibold">${order.status.toUpperCase()}</span></td>
            <td>${utils.formatDateTime(order.ordered_at)}</td>
            <td>
              <div class="table-actions">
                ${order.receipt_url ? `
                <a href="${order.receipt_url}" target="_blank" class="myanmar-btn btn-small">
                  <i class="fas fa-receipt mr-1"></i> RECEIPT
                </a>
                ` : ''}
                <button onclick="openChatConversation('${order.conversation_id}', '${buyerName} (@${buyerUsername})')" class="myanmar-btn btn-small">
                  <i class="fas fa-comments mr-1"></i> CHAT
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    } else {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center text-text-secondary py-8">
            You have no sales yet.
          </td>
        </tr>
      `;
    }
  } catch (error) {
    console.error('Error loading my sales:', error);
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center text-accent-red py-8">
          Failed to retrieve your sales
        </td>
      </tr>
    `;
  }
}

async function userLogout(showConfirm = true) {
  const performLogout = async () => {
    showLoading(true);
    try {
      const { error } = await state.supabase.auth.signOut();
      if (error) throw error;

      localStorage.removeItem('user_key'); // Clear stored key
      state.isAuthenticated = false;
      state.userProfile = null;
      
      // Unsubscribe from all realtime channels on logout
      if (state.newsRealtime) state.supabase.removeChannel(state.newsRealtime);
      if (state.adminProductsRealtime) state.supabase.removeChannel(state.adminProductsRealtime);
      if (state.marketplaceProductsRealtime) state.supabase.removeChannel(state.marketplaceProductsRealtime);
      if (state.ordersRealtime) state.supabase.removeChannel(state.ordersRealtime);
      if (state.userOrdersRealtime) state.supabase.removeChannel(state.userOrdersRealtime);
      if (state.chatRealtime) state.supabase.removeChannel(state.chatRealtime);
      if (state.supportRealtime) state.supabase.removeChannel(state.supportRealtime);

      document.getElementById('app-content').classList.add('hidden');
      document.getElementById('profile-creation-section').classList.add('hidden'); // Hide profile creation too
      document.getElementById('login-section').classList.remove('hidden');
      document.getElementById('login-key').value = ''; // Clear key input
      showNotification('Logged out successfully', 'info');
    } catch (error) {
      console.error('Logout error:', error);
      showNotification(`Failed to logout: ${error.message}`, 'error');
    } finally {
      showLoading(false);
    }
  };

  if (showConfirm) {
    showConfirmModal(
      'Are you sure you want to logout?',
      performLogout
    );
  } else {
    await performLogout();
  }
}

function showConfirmModal(message, callback) {
  document.getElementById('confirm-message').textContent = message;
  state.confirmCallback = callback;
  document.getElementById('confirm-modal').classList.remove('hidden');
}

function closeConfirmModal() {
  document.getElementById('confirm-modal').classList.add('hidden');
  state.confirmCallback = null;
}

function confirmAction() {
  if (state.confirmCallback) {
    state.confirmCallback();
  }
  closeConfirmModal();
}

function showLoading(show) {
  const overlay = document.getElementById('loading-overlay');
  if (show) {
    overlay.classList.remove('hidden');
  } else {
    overlay.classList.add('hidden');
  }
}

// Global functions for HTML onclick events
window.userLogin = userLogin;
window.createProfile = createProfile;
window.showSection = showSection;
window.viewNews = viewNews;
window.closeNewsModal = closeNewsModal;
window.shareNews = shareNews;
window.initiatePurchase = initiatePurchase;
window.initiateMarketplacePurchase = initiateMarketplacePurchase;
window.closePaymentModal = closePaymentModal;
window.submitPurchase = submitPurchase;
window.submitMarketplacePurchase = submitMarketplacePurchase;
window.openChatConversation = openChatConversation;
window.closeChatConversation = closeChatConversation;
window.sendChatMessage = sendChatMessage;
window.loadSupportTickets = loadSupportTickets;
window.viewSupportTicketDetails = viewSupportTicketDetails;
window.closeSupportTicketDetails = closeSupportTicketDetails;
window.sendSupportReply = sendSupportReply;
window.showCreateTicketForm = showCreateTicketForm;
window.hideCreateTicketForm = hideCreateTicketForm;
window.submitNewTicket = submitNewTicket;
window.loadMiProfile = loadMiProfile;
window.updateProfile = updateProfile;
window.toggleKycForm = toggleKycForm;
window.submitKyc = submitKyc;
window.showAddMarketplaceProductForm = showAddMarketplaceProductForm;
window.hideAddMarketplaceProductForm = hideAddMarketplaceProductForm;
window.submitMarketplaceProduct = submitMarketplaceProduct;
window.editMarketplaceProduct = editMarketplaceProduct;
window.closeEditMarketplaceProductModal = closeEditMarketplaceProductModal;
window.updateMarketplaceProduct = updateMarketplaceProduct;
window.deleteMyMarketplaceProduct = deleteMyMarketplaceProduct;
window.userLogout = userLogout;
window.showConfirmModal = showConfirmModal;
window.closeConfirmModal = closeConfirmModal;
window.confirmAction = confirmAction;
window.viewMarketplaceProductDetails = viewMarketplaceProductDetails;
window.closeMarketplaceProductModal = closeMarketplaceProductModal;


// Error handling
window.onerror = function(msg, url, lineNo, columnNo, error) {
  console.error('Global error:', { msg, url, lineNo, columnNo, error });
  showNotification('A system error occurred', 'error');
  return false;
};

// Mobile optimizations
if ('ontouchstart' in window) {
  document.addEventListener('touchstart', function() {}, true);
}

// Prevent zoom on double tap for iOS
document.addEventListener('touchend', function(event) {
  const now = (new Date()).getTime();
  if (now - lastTouchEnd <= 300) {
    event.preventDefault();
  }
  lastTouchEnd = now;
}, false);

let lastTouchEnd = 0;
</script>
</body>
</html>
