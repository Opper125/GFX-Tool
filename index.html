<!DOCTYPE html>
<html lang="my">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>FPS GFX Tool - မြန်မာ</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&family=Noto+Sans+Myanmar:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* Custom Fonts */
body {
  font-family: 'Noto Sans Myanmar', 'Inter', sans-serif;
}
h1, h2, h3, .font-orbitron {
  font-family: 'Orbitron', sans-serif;
}
.font-share-tech {
  font-family: 'Share Tech Mono', monospace;
}

/* New Color Palette */
:root {
  --primary-bg: hsl(220 20% 8%); /* Deep Dark Blue-Grey */
  --secondary-bg: hsl(220 20% 12%); /* Slightly Lighter Dark Blue-Grey */
  --accent-purple: hsl(280 80% 60%); /* Vibrant Purple */
  --accent-green: hsl(160 80% 50%); /* Neon Green */
  --accent-red: hsl(0 80% 60%); /* Vibrant Red */
  --text-primary: hsl(220 20% 90%); /* Light Grey */
  --text-secondary: hsl(220 15% 60%); /* Medium Grey */
  --border-color: hsl(220 15% 20%); /* Dark Grey */
  --card-bg: rgba(20, 25, 35, 0.7); /* Dark Translucent */
  --input-bg: rgba(30, 35, 45, 0.6); /* Darker Translucent */
  --table-header-bg: rgba(var(--accent-purple-rgb), 0.15);
  --table-row-hover-bg: rgba(var(--accent-purple-rgb), 0.08);

  /* RGB values for easier use in rgba() */
  --accent-purple-rgb: 199, 56, 255; /* From hsl(280 80% 60%) */
  --accent-green-rgb: 0, 204, 136; /* From hsl(160 80% 50%) */
  --accent-red-rgb: 255, 51, 51; /* From hsl(0 80% 60%) */
}

body {
  background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
}

.myanmar-pattern {
  background-image: 
    radial-gradient(circle at 25% 25%, rgba(var(--accent-purple-rgb), 0.15) 0%, transparent 50%),
    radial-gradient(circle at 75% 75%, rgba(var(--accent-green-rgb), 0.15) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(var(--accent-red-rgb), 0.1) 0%, transparent 50%);
  animation: patternMove 25s ease-in-out infinite;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: -2;
}

@keyframes patternMove {
  0%, 100% { background-position: 0% 0%, 100% 100%, 50% 50%; }
  33% { background-position: 100% 100%, 0% 0%, 75% 25%; }
  66% { background-position: 50% 50%, 75% 25%, 25% 75%; }
}

.myanmar-waves {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 80px;
  background: linear-gradient(45deg, 
    rgba(var(--accent-purple-rgb), 0.2), 
    rgba(var(--accent-green-rgb), 0.2), 
    rgba(var(--accent-red-rgb), 0.2));
  clip-path: polygon(0 100%, 0 60%, 25% 40%, 50% 60%, 75% 30%, 100% 50%, 100% 100%);
  animation: waveFloat 12s ease-in-out infinite;
  z-index: -1;
}

@keyframes waveFloat {
  0%, 100% { transform: translateY(0px) scaleY(1); }
  50% { transform: translateY(-10px) scaleY(1.1); }
}

.app-card {
  backdrop-filter: blur(20px);
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  box-shadow: 
    0 20px 40px -12px rgba(0, 0, 0, 0.8),
    0 0 0 1px rgba(var(--accent-purple-rgb), 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.05);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius: 16px;
}

.app-card:hover {
  transform: translateY(-2px);
  box-shadow: 
    0 25px 50px -12px rgba(var(--accent-purple-rgb), 0.25),
    0 0 0 1px rgba(var(--accent-purple-rgb), 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
  border-color: rgba(var(--accent-purple-rgb), 0.5);
}

.myanmar-btn {
  background: linear-gradient(135deg, var(--accent-purple), var(--accent-green));
  color: #000;
  font-weight: 700;
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  border: none;
  border-radius: 12px;
  padding: 12px 20px;
  cursor: pointer;
  box-shadow: 0 5px 15px rgba(var(--accent-purple-rgb), 0.2);
}

.myanmar-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
  transition: left 0.6s ease;
}

.myanmar-btn:hover::before {
  left: 100%;
}

.myanmar-btn:hover {
  background: linear-gradient(135deg, var(--accent-green), var(--accent-purple));
  transform: translateY(-1px);
  box-shadow: 0 10px 25px rgba(var(--accent-green-rgb), 0.4);
}

.btn-danger {
  background: linear-gradient(135deg, var(--accent-red), #FF6B6B);
  color: white;
  box-shadow: 0 5px 15px rgba(var(--accent-red-rgb), 0.2);
}

.btn-danger:hover {
  background: linear-gradient(135deg, #FF6B6B, var(--accent-red));
  box-shadow: 0 10px 25px rgba(var(--accent-red-rgb), 0.4);
}

.connection-status {
  position: fixed;
  top: 15px;
  right: 15px;
  z-index: 1000;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  backdrop-filter: blur(10px);
  animation: statusPulse 2s infinite;
  color: var(--text-primary);
}

.status-online {
  background: linear-gradient(135deg, var(--accent-green), #4ADE80);
  color: white;
  box-shadow: 0 0 20px rgba(var(--accent-green-rgb), 0.5);
}

.status-offline {
  background: linear-gradient(135deg, var(--accent-red), #EF4444);
  color: white;
  animation: statusShake 0.5s ease-in-out;
}

.status-connecting {
  background: linear-gradient(135deg, var(--accent-purple), #FCD34D);
  color: #000;
  animation: statusSpin 1s linear infinite;
}

@keyframes statusPulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.8; transform: scale(1.05); }
}

@keyframes statusShake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-3px); }
  75% { transform: translateX(3px); }
}

@keyframes statusSpin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.stats-card {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  border-radius: 12px;
}

.stats-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent-purple), var(--accent-green), var(--accent-red));
  opacity: 0;
  transition: opacity 0.3s ease;
}

.stats-card:hover::before {
  opacity: 1;
}

.stats-card:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 15px 35px rgba(var(--accent-purple-rgb), 0.2);
  border-color: rgba(var(--accent-purple-rgb), 0.3);
}

.app-input {
  background: var(--input-bg);
  border: 2px solid var(--border-color);
  backdrop-filter: blur(10px);
  color: var(--text-primary);
  transition: all 0.3s ease;
  border-radius: 12px;
  padding: 12px 16px;
}

.app-input:focus {
  border-color: var(--accent-purple);
  background: rgba(30, 35, 45, 0.8);
  outline: none;
  box-shadow: 0 0 25px rgba(var(--accent-purple-rgb), 0.3);
}

.app-input::placeholder {
  color: var(--text-secondary);
}

.app-table {
  backdrop-filter: blur(10px);
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  overflow: hidden;
}

.app-table th {
  background: var(--table-header-bg);
  color: var(--accent-purple);
  font-weight: 700;
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 0.5px;
  padding: 12px 8px;
}

.app-table td {
  padding: 12px 8px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  color: var(--text-primary);
}

.app-table tr:hover {
  background: var(--table-row-hover-bg);
}

.loading-spinner {
  border: 3px solid rgba(var(--accent-purple-rgb), 0.3);
  border-top: 3px solid var(--accent-purple);
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.notification {
  position: fixed;
  top: 70px;
  right: 15px;
  left: 15px;
  max-width: 400px;
  margin: 0 auto;
  padding: 12px 16px;
  border-radius: 10px;
  color: white;
  font-weight: 600;
  z-index: 1001;
  animation: slideInRight 0.4s ease-out;
  backdrop-filter: blur(15px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

@keyframes slideInRight {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.nav-btn {
  transition: all 0.3s ease;
  position: relative;
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 14px;
  color: var(--text-secondary);
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.nav-btn.active {
  background: linear-gradient(135deg, var(--accent-purple), var(--accent-green)) !important;
  color: #000 !important;
  box-shadow: 0 5px 15px rgba(var(--accent-purple-rgb), 0.4);
  border-color: var(--accent-purple) !important;
}

.nav-btn:not(.active):hover {
  background: rgba(var(--accent-purple-rgb), 0.1);
  color: var(--accent-purple);
  border-color: rgba(var(--accent-purple-rgb), 0.3);
}

.fade-in {
  animation: fadeInUp 0.6s ease-out forwards;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.status-active { color: var(--accent-green); }
.status-inactive { color: var(--accent-red); }
.status-banned { color: var(--accent-red); }

.news-card {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  transition: all 0.3s ease;
  margin-bottom: 16px;
}

.news-card:hover {
  border-color: rgba(var(--accent-purple-rgb), 0.3);
  transform: translateY(-2px);
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 20px;
}

.modal-content {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 24px;
  max-width: 90vw;
  max-height: 90vh;
  overflow-y: auto;
  backdrop-filter: blur(20px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

/* Mobile optimizations */
@media (max-width: 768px) {
  .container { padding: 8px; }
  .app-card { padding: 16px; margin: 8px; }
  .connection-status { top: 10px; right: 10px; font-size: 9px; padding: 6px 12px; }
  .notification { top: 50px; right: 10px; left: 10px; max-width: none; }
  .stats-card { margin-bottom: 12px; }
  .myanmar-btn { padding: 10px 16px; font-size: 14px; }
  .app-table { font-size: 12px; }
  .app-table th, .app-table td { padding: 8px 4px; }
  h1 { font-size: 20px; }
  h2 { font-size: 18px; }
  h3 { font-size: 16px; }
  .nav-btn { padding: 6px 10px; font-size: 12px; margin: 2px; }
  .modal-content { padding: 16px; max-width: 95vw; }
}

@media (max-width: 480px) {
  .myanmar-pattern { opacity: 0.7; }
  .myanmar-waves { height: 60px; }
  .app-card { padding: 12px; margin: 4px; }
  .grid { gap: 8px; }
  .stats-card { padding: 12px; }
  .app-table th, .app-table td { padding: 6px 2px; font-size: 11px; }
}

/* Scrollbar styling */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
::-webkit-scrollbar-thumb { background: var(--accent-purple); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-green); }

/* Loading overlay */
.loading-overlay {
  backdrop-filter: blur(8px);
  background: rgba(0,0,0,0.7);
}

.btn-small {
  padding: 6px 12px;
  font-size: 12px;
  border-radius: 8px;
}

.table-actions {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.hidden { display: none !important; }

/* Search input specific styles */
.search-input-container {
  position: relative;
}
.search-input-container .app-input {
  padding-left: 40px; /* Space for icon */
}
.search-input-container .search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-secondary);
  pointer-events: none;
}
</style>
</head>
<body class="text-white">
<div class="myanmar-pattern"></div>
<div class="myanmar-waves"></div>

<!-- Connection Status -->
<div id="connection-status" class="connection-status status-connecting">
<i class="fas fa-wifi"></i> ချိတ်ဆက်နေသည်...
</div>

<!-- Main Container -->
<div class="container mx-auto px-2 py-4 max-w-6xl">
<!-- Header -->
<div class="text-center mb-6 fade-in">
  <h1 class="text-2xl md:text-3xl lg:text-4xl font-orbitron font-bold mb-2 text-accent-purple">
    <i class="fas fa-shield-alt mr-2"></i>
    FPS GFX Tool
  </h1>
  <h2 class="text-lg md:text-xl lg:text-2xl font-orbitron font-semibold text-accent-green mb-2">
    MOBILE APPLICATION
  </h2>
  <div class="inline-block px-4 py-2 bg-gradient-to-r from-accent-purple to-accent-green text-black rounded-full font-bold text-sm">
    <i class="fas fa-mobile-alt mr-1"></i> USER INTERFACE
  </div>
</div>

<!-- Notification Container -->
<div id="notification-container"></div>

<!-- Login Section -->
<div id="login-section" class="max-w-md mx-auto fade-in">
  <div class="app-card p-6">
    <h3 class="text-xl md:text-2xl font-orbitron font-bold text-center mb-6 text-accent-purple">
      <i class="fas fa-sign-in-alt mr-2"></i>
      KEY LOGIN
    </h3>
    <div class="space-y-4">
      <div class="relative search-input-container">
        <input 
          type="text" 
          id="login-key" 
          placeholder="Enter Your Key..." 
          class="app-input w-full"
        >
        <i class="fas fa-key search-icon"></i>
      </div>
      <button 
        onclick="userLogin()" 
        id="login-btn"
        class="myanmar-btn w-full flex items-center justify-center space-x-2"
      >
        <i class="fas fa-sign-in-alt"></i>
        <span id="login-text">LOGIN</span>
      </button>
    </div>
  </div>
</div>

<!-- Profile Creation Section -->
<div id="profile-creation-section" class="max-w-md mx-auto fade-in hidden">
  <div class="app-card p-6">
    <h3 class="text-xl md:text-2xl font-orbitron font-bold text-center mb-6 text-accent-green">
      <i class="fas fa-user-plus mr-2"></i>
      CREATE PROFILE
    </h3>
    <p class="text-center text-text-secondary mb-4">
      No profile found for your key. Please create one.
    </p>
    <div class="space-y-4">
      <div class="relative search-input-container">
        <input 
          type="text" 
          id="profile-username" 
          placeholder="Username (must be unique)" 
          class="app-input w-full"
        >
        <i class="fas fa-user search-icon"></i>
      </div>
      <div class="relative search-input-container">
        <input 
          type="text" 
          id="profile-name" 
          placeholder="Your Display Name" 
          class="app-input w-full"
        >
        <i class="fas fa-signature search-icon"></i>
      </div>
      <div class="relative">
        <label for="profile-picture" class="block text-sm font-medium mb-2 text-text-secondary">Profile Picture (Optional)</label>
        <input 
          type="file" 
          id="profile-picture" 
          accept="image/*" 
          class="app-input w-full"
        >
      </div>
      <button 
        onclick="createProfile()" 
        id="create-profile-btn"
        class="myanmar-btn w-full flex items-center justify-center space-x-2"
      >
        <i class="fas fa-plus-circle"></i>
        <span id="create-profile-text">CREATE PROFILE</span>
      </button>
    </div>
  </div>
</div>

<!-- Main App Content -->
<div id="app-content" class="hidden">
  <!-- Navigation -->
  <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-6">
    <button onclick="showSection('home', this)" class="nav-btn active">
      <i class="fas fa-home mr-1"></i>
      <span class="hidden sm:inline">HOME</span>
      <span class="sm:hidden">Home</span>
    </button>
    <button onclick="showSection('news', this)" class="nav-btn">
      <i class="fas fa-newspaper mr-1"></i>
      <span class="hidden sm:inline">NEWS</span>
      <span class="sm:hidden">News</span>
    </button>
    <button onclick="showSection('products', this)" class="nav-btn">
      <i class="fas fa-box-open mr-1"></i>
      <span class="hidden sm:inline">PRODUCTS</span>
      <span class="sm:hidden">Products</span>
    </button>
    <button onclick="showSection('shop', this)" class="nav-btn">
      <i class="fas fa-store mr-1"></i>
      <span class="hidden sm:inline">SHOP</span>
      <span class="sm:hidden">Shop</span>
    </button>
    <button onclick="showSection('chat', this)" class="nav-btn">
      <i class="fas fa-comments mr-1"></i>
      <span class="hidden sm:inline">CHAT</span>
      <span class="sm:hidden">Chat</span>
    </button>
    <button onclick="showSection('support', this)" class="nav-btn">
      <i class="fas fa-headset mr-1"></i>
      <span class="hidden sm:inline">SUPPORT</span>
      <span class="sm:hidden">Support</span>
    </button>
    <button onclick="showSection('about', this)" class="nav-btn">
      <i class="fas fa-info-circle mr-1"></i>
      <span class="hidden sm:inline">ABOUT</span>
      <span class="sm:hidden">About</span>
    </button>
    <button onclick="showSection('mi', this)" class="nav-btn">
      <i class="fas fa-user-circle mr-1"></i>
      <span class="hidden sm:inline">MI</span>
      <span class="sm:hidden">Mi</span>
    </button>
    <button onclick="userLogout()" class="nav-btn btn-danger">
      <i class="fas fa-sign-out-alt mr-1"></i>
      <span class="hidden sm:inline">LOGOUT</span>
      <span class="sm:hidden">Logout</span>
    </button>
  </div>

  <!-- Home Section -->
  <div id="home-section" class="app-section">
    <div class="app-card p-4 md:p-8 text-center">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-4 text-accent-purple">
        <i class="fas fa-home mr-2"></i>
        DASHBOARD OVERVIEW
      </h3>
      <p class="text-text-secondary">
        Welcome to FPS GFX Tool.
      </p>
      <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="stats-card p-4">
          <i class="fas fa-download text-2xl text-blue-400 mb-2"></i>
          <h4 class="text-sm font-semibold text-text-secondary">TOTAL DOWNLOADS (Admin Products)</h4>
          <p id="total-downloads" class="text-lg font-bold text-accent-purple">0</p>
        </div>
        <div class="stats-card p-4">
          <i class="fas fa-box-open text-2xl text-purple-400 mb-2"></i>
          <h4 class="text-sm font-semibold text-text-secondary">AVAILABLE ADMIN PRODUCTS</h4>
          <p id="available-products" class="text-lg font-bold text-accent-green">0</p>
        </div>
        <div class="stats-card p-4">
          <i class="fas fa-store text-2xl text-yellow-400 mb-2"></i>
          <h4 class="text-sm font-semibold text-text-secondary">AVAILABLE USER PRODUCTS</h4>
          <p id="available-user-products" class="text-lg font-bold text-accent-purple">0</p>
        </div>
        <div class="stats-card p-4">
          <i class="fas fa-receipt text-2xl text-orange-400 mb-2"></i>
          <h4 class="text-sm font-semibold text-text-secondary">TOTAL USER ORDERS (APPROVED)</h4>
          <p id="total-user-orders" class="text-lg font-bold text-accent-green">0</p>
        </div>
      </div>
    </div>
  </div>

  <!-- News Section -->
  <div id="news-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-newspaper mr-3"></i>
        LATEST NEWS
      </h3>
      <div id="news-list" class="space-y-4">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-center text-text-secondary">Loading news...</p>
      </div>
    </div>
  </div>

  <!-- Products Section (Admin Products) -->
  <div id="products-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-box-open mr-3"></i>
        ADMIN PRODUCTS & APKS
      </h3>
      <div id="products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="loading-spinner mx-auto mb-4 col-span-full"></div>
        <p class="text-center text-text-secondary col-span-full">Loading products...</p>
      </div>
    </div>
  </div>

  <!-- Shop Section (User Products) -->
  <div id="shop-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-store mr-3"></i>
        USER SHOP
      </h3>
      <!-- Sub-navigation for Shop -->
      <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-6">
        <button onclick="showShopSubSection('browse-products', this)" class="nav-btn active">
          <i class="fas fa-th-large mr-1"></i>
          <span class="hidden sm:inline">BROWSE PRODUCTS</span>
          <span class="sm:hidden">Browse</span>
        </button>
        <button onclick="showShopSubSection('my-shop', this)" class="nav-btn">
          <i class="fas fa-toolbox mr-1"></i>
          <span class="hidden sm:inline">MY SHOP</span>
          <span class="sm:hidden">My Shop</span>
        </button>
        <button onclick="showShopSubSection('my-orders', this)" class="nav-btn">
          <i class="fas fa-history mr-1"></i>
          <span class="hidden sm:inline">MY ORDERS</span>
          <span class="sm:hidden">Orders</span>
        </button>
      </div>

      <!-- Browse Products (Buyer View) -->
      <div id="browse-products-subsection" class="shop-subsection">
        <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
          <i class="fas fa-shopping-basket mr-2"></i>
          ALL LISTED PRODUCTS
        </h4>
        <div id="user-products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="loading-spinner mx-auto mb-4 col-span-full"></div>
          <p class="text-center text-text-secondary col-span-full">Loading user products...</p>
        </div>
      </div>

      <!-- My Shop (Seller View) -->
      <div id="my-shop-subsection" class="shop-subsection hidden">
        <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
          <i class="fas fa-plus-circle mr-2"></i>
          UPLOAD NEW PRODUCT
        </h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">PRODUCT NAME</label>
            <input type="text" id="user-product-name" placeholder="Your Product Name" class="app-input w-full">
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-2 text-text-secondary">DESCRIPTION</label>
            <textarea id="user-product-description" placeholder="Product Description..." rows="3" class="app-input w-full resize-none"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">PRICE (MMK)</label>
            <input type="number" id="user-product-price" placeholder="0.00" min="0" step="0.01" class="app-input w-full">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">PRODUCT IMAGES (Multiple)</label>
            <input type="file" id="user-product-images" accept="image/*" multiple class="app-input w-full">
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-2 text-text-secondary">SOCIAL LINKS (JSON Array - optional)</label>
            <textarea id="user-product-social-links" rows="2" placeholder='[{"name": "Facebook", "url": "...", "icon": "fab fa-facebook"}]' class="app-input w-full resize-none font-share-tech"></textarea>
            <p class="text-xs text-text-secondary mt-1">
              Example: `[{'name': 'Facebook', 'url': 'https://fb.com/profile', 'icon': 'fab fa-facebook'}]`
            </p>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-2 text-text-secondary">CONTACT INFO (JSON Array - optional)</label>
            <textarea id="user-product-contact-info" rows="2" placeholder='[{"name": "Phone", "value": "09..."}]' class="app-input w-full resize-none font-share-tech"></textarea>
            <p class="text-xs text-text-secondary mt-1">
              Example: `[{'name': 'Phone', 'value': '09123456789'}, {'name': 'Telegram', 'value': '@myuser'}]`
            </p>
          </div>
          <div class="md:col-span-2">
            <button onclick="uploadUserProduct()" id="upload-user-product-btn" class="myanmar-btn w-full flex items-center justify-center space-x-2">
              <i class="fas fa-upload"></i>
              <span>UPLOAD PRODUCT</span>
            </button>
          </div>
        </div>

        <h4 class="text-md font-orbitron font-bold mb-4 mt-8 text-accent-green flex items-center">
          <i class="fas fa-list-alt mr-2"></i>
          MY LISTED PRODUCTS
        </h4>
        <div class="relative search-input-container mb-4">
          <input type="text" id="search-my-products" placeholder="Search My Products..." class="app-input w-full" onkeyup="filterTable('my-products-table-body', this.value)">
          <i class="fas fa-search search-icon"></i>
        </div>
        <div class="overflow-x-auto">
          <table class="app-table w-full">
            <thead>
              <tr>
                <th class="text-left">IMAGE</th>
                <th class="text-left">NAME</th>
                <th class="text-left">PRICE</th>
                <th class="text-left">STATUS</th>
                <th class="text-left">ACTIONS</th>
              </tr>
            </thead>
            <tbody id="my-products-table-body">
              <tr>
                <td colspan="5" class="text-center text-text-secondary py-8">
                  <div class="loading-spinner mx-auto mb-2"></div>
                  Loading your products...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <h4 class="text-md font-orbitron font-bold mb-4 mt-8 text-accent-green flex items-center">
          <i class="fas fa-wallet mr-2"></i>
          MY PAYMENT METHODS (For Buyers)
        </h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">METHOD NAME</label>
            <input type="text" id="seller-payment-method-name" placeholder="KBZ Pay / Wave Money" 
                   class="app-input w-full">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">ACCOUNT INFO</label>
            <input type="text" id="seller-payment-account-info" placeholder="Phone Number / Account Number" 
                   class="app-input w-full">
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-2 text-text-secondary">INSTRUCTIONS</label>
            <textarea id="seller-payment-instructions" placeholder="Instructions for transfer..." rows="2"
                      class="app-input w-full resize-none"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">QR CODE IMAGE (OPTIONAL)</label>
            <input type="file" id="seller-payment-qr-code" accept="image/*" 
                   class="app-input w-full">
          </div>
          <div class="flex items-end">
            <button onclick="addSellerPaymentMethod()" 
                    class="myanmar-btn w-full flex items-center justify-center space-x-2">
              <i class="fas fa-plus"></i>
              <span>ADD NEW METHOD</span>
            </button>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="app-table w-full">
            <thead>
              <tr>
                <th class="text-left">METHOD</th>
                <th class="text-left">ACCOUNT INFO</th>
                <th class="text-left">QR CODE</th>
                <th class="text-left">STATUS</th>
                <th class="text-left">ACTIONS</th>
              </tr>
            </thead>
            <tbody id="seller-payment-methods-table-body">
              <tr>
                <td colspan="5" class="text-center text-text-secondary py-8">
                  <div class="loading-spinner mx-auto mb-2"></div>
                  Loading your payment methods...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>

      <!-- My Orders (Seller's Incoming Orders) -->
      <div id="my-orders-subsection" class="shop-subsection hidden">
        <h4 class="text-md font-orbitron font-bold mb-4 text-accent-green flex items-center">
          <i class="fas fa-receipt mr-2"></i>
          INCOMING ORDERS (FOR MY PRODUCTS)
        </h4>
        <div class="relative search-input-container mb-4">
          <input type="text" id="search-incoming-orders" placeholder="Search Incoming Orders..." class="app-input w-full" onkeyup="filterTable('incoming-orders-table-body', this.value)">
          <i class="fas fa-search search-icon"></i>
        </div>
        <div class="overflow-x-auto">
          <table class="app-table w-full">
            <thead>
              <tr>
                <th class="text-left">BUYER</th>
                <th class="text-left">PRODUCT</th>
                <th class="text-left">AMOUNT</th>
                <th class="text-left">RECEIPT</th>
                <th class="text-left">STATUS</th>
                <th class="text-left">ACTIONS</th>
              </tr>
            </thead>
            <tbody id="incoming-orders-table-body">
              <tr>
                <td colspan="6" class="text-center text-text-secondary py-8">
                  <div class="loading-spinner mx-auto mb-2"></div>
                  Loading incoming orders...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Section (Global Chat) -->
  <div id="chat-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-comments mr-3"></i>
        GLOBAL CHAT
      </h3>
      <div id="chat-messages" class="bg-black bg-opacity-30 rounded-xl p-4 h-64 md:h-96 overflow-y-auto mb-6 border border-gray-700">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-center text-text-secondary">Loading messages...</p>
      </div>
      <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
        <textarea id="chat-input" placeholder="Type your message..." rows="3"
                  class="app-input flex-1 resize-none"></textarea>
        <button onclick="sendChatMessage()" 
                class="myanmar-btn flex items-center justify-center space-x-2 md:self-end">
          <i class="fas fa-paper-plane"></i>
          <span>SEND</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Support Section -->
  <div id="support-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-headset mr-3"></i>
        SUPPORT
      </h3>
      <div id="support-messages" class="bg-black bg-opacity-30 rounded-xl p-4 h-64 md:h-96 overflow-y-auto mb-6 border border-gray-700">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-center text-text-secondary">Loading support messages...</p>
      </div>
      <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
        <textarea id="support-input" placeholder="Type your support message..." rows="3"
                  class="app-input flex-1 resize-none"></textarea>
        <button onclick="sendSupportMessage()" 
                class="myanmar-btn flex items-center justify-center space-x-2 md:self-end">
          <i class="fas fa-paper-plane"></i>
          <span>SEND SUPPORT</span>
        </button>
      </div>
    </div>
  </div>

  <!-- About Section -->
  <div id="about-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-info-circle mr-3"></i>
        ABOUT US
      </h3>
      <div id="about-content" class="space-y-4 text-text-secondary">
        <p>Loading about information...</p>
      </div>
    </div>
  </div>

  <!-- Mi Section (User Profile & My News Posts) -->
  <div id="mi-section" class="app-section hidden">
    <div class="app-card p-4 md:p-8">
      <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
        <i class="fas fa-user-circle mr-3"></i>
        MY PROFILE
      </h3>
      <div id="profile-details" class="space-y-4">
        <div class="flex flex-col items-center mb-6">
          <img id="mi-profile-picture" src="/placeholder.svg?height=100&width=100" alt="Profile Picture" class="w-24 h-24 rounded-full object-cover border-4 border-accent-purple mb-4">
          <h4 id="mi-name" class="text-xl font-bold text-text-primary"></h4>
          <p id="mi-username" class="text-text-secondary">@</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">KEY</label>
            <input type="text" id="mi-key-text" class="app-input w-full font-share-tech" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">ACCOUNT STATUS</label>
            <input type="text" id="mi-account-status" class="app-input w-full" readonly>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-2 text-text-secondary">NEW PROFILE PICTURE (OPTIONAL)</label>
            <input type="file" id="mi-new-profile-picture" accept="image/*" class="app-input w-full">
          </div>
          <div class="md:col-span-2">
            <button onclick="updateProfile()" class="myanmar-btn w-full flex items-center justify-center space-x-2">
              <i class="fas fa-save"></i>
              <span>UPDATE PROFILE</span>
            </button>
          </div>
        </div>
      </div>

      <div class="mt-8">
        <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
          <i class="fas fa-bullhorn mr-3"></i>
          MY NEWS POSTS
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">NEWS TITLE</label>
            <input type="text" id="user-news-title" placeholder="Your News Title" class="app-input w-full">
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-2 text-text-secondary">NEWS CONTENT</label>
            <textarea id="user-news-content" placeholder="Your News Content..." rows="4" class="app-input w-full resize-none"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">MEDIA (IMAGE/VIDEO) OPTIONAL</label>
            <input type="file" id="user-news-media" accept="image/*,video/*" multiple class="app-input w-full">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">YOUTUBE LINK (OPTIONAL)</label>
            <input type="url" id="user-news-youtube" placeholder="https://youtube.com/..." class="app-input w-full">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">TIKTOK LINK (OPTIONAL)</label>
            <input type="url" id="user-news-tiktok" placeholder="https://tiktok.com/@..." class="app-input w-full">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">TELEGRAM LINK (OPTIONAL)</label>
            <input type="url" id="user-news-telegram" placeholder="https://t.me/..." class="app-input w-full">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-text-secondary">FACEBOOK LINK (OPTIONAL)</label>
            <input type="url" id="user-news-facebook" placeholder="https://facebook.com/..." class="app-input w-full">
          </div>
          <div class="flex items-end">
            <button onclick="postUserNews()" id="post-user-news-btn" class="myanmar-btn w-full flex items-center justify-center space-x-2">
              <i class="fas fa-paper-plane"></i>
              <span>POST MY NEWS</span>
            </button>
          </div>
        </div>

        <h4 class="text-md font-orbitron font-bold mb-4 mt-8 text-accent-green flex items-center">
          <i class="fas fa-list-alt mr-2"></i>
          YOUR NEWS LIST
        </h4>
        <div id="user-news-list" class="space-y-4">
          <div class="loading-spinner mx-auto mb-4"></div>
          <p class="text-center text-text-secondary">Loading your news...</p>
        </div>
      </div>

      <div class="mt-8">
        <h3 class="text-lg md:text-xl font-orbitron font-bold mb-6 text-accent-purple flex items-center">
          <i class="fas fa-shopping-bag mr-3"></i>
          MY PURCHASED ADMIN PRODUCTS
        </h3>
        <div id="my-purchased-products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="loading-spinner mx-auto mb-4 col-span-full"></div>
          <p class="text-center text-text-secondary col-span-full">Loading your purchased products...</p>
        </div>
      </div>
    </div>
  </div>

</div>
</div>

<!-- News Detail Modal (for Admin News) -->
<div id="news-modal" class="modal hidden">
<div class="modal-content max-w-2xl">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-orbitron font-bold text-accent-purple">NEWS DETAILS</h2>
    <button onclick="closeNewsModal()" class="text-text-secondary hover:text-accent-red">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div id="news-modal-content">
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-center text-text-secondary">Loading...</p>
  </div>
</div>
</div>

<!-- News Detail Modal (for Profile News) -->
<div id="profile-news-modal" class="modal hidden">
  <div class="modal-content max-w-2xl">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-orbitron font-bold text-accent-purple">PROFILE NEWS DETAILS</h2>
      <button onclick="closeProfileNewsModal()" class="text-text-secondary hover:text-accent-red">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="profile-news-modal-content">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-center text-text-secondary">Loading...</p>
    </div>
  </div>
</div>

<!-- Product Detail Modal (for Admin Products) -->
<div id="product-modal" class="modal hidden">
<div class="modal-content max-w-2xl">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-orbitron font-bold text-accent-purple">PRODUCT DETAILS</h2>
    <button onclick="closeProductModal()" class="text-text-secondary hover:text-accent-red">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div id="product-modal-content">
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-center text-text-secondary">Loading...</p>
  </div>
</div>
</div>

<!-- User Product Detail Modal (for User Products) -->
<div id="user-product-modal" class="modal hidden">
  <div class="modal-content max-w-2xl">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-orbitron font-bold text-accent-purple">USER PRODUCT DETAILS</h2>
      <button onclick="closeUserProductModal()" class="text-text-secondary hover:text-accent-red">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="user-product-modal-content">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-center text-text-secondary">Loading...</p>
    </div>
  </div>
</div>

<!-- Payment Modal (for Admin Products) -->
<div id="payment-modal" class="modal hidden">
<div class="modal-content max-w-md">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-orbitron font-bold text-accent-purple">MAKE PAYMENT (Admin Product)</h2>
    <button onclick="closePaymentModal()" class="text-text-secondary hover:text-accent-red">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div id="payment-modal-content" class="space-y-4">
    <!-- Payment method selection will go here -->
  </div>
</div>
</div>

<!-- User Product Payment Modal -->
<div id="user-product-payment-modal" class="modal hidden">
  <div class="modal-content max-w-md">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-orbitron font-bold text-accent-purple">MAKE PAYMENT (User Product)</h2>
      <button onclick="closeUserProductPaymentModal()" class="text-text-secondary hover:text-accent-red">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="user-product-payment-modal-content" class="space-y-4">
      <!-- User payment methods for selected product will go here -->
    </div>
  </div>
</div>

<!-- Buyer-Seller Chat Modal -->
<div id="buyer-seller-chat-modal" class="modal hidden">
  <div class="modal-content max-w-2xl">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-orbitron font-bold text-accent-purple" id="chat-modal-title">CHAT WITH SELLER</h2>
      <button onclick="closeBuyerSellerChatModal()" class="text-text-secondary hover:text-accent-red">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="buyer-seller-chat-messages" class="bg-black bg-opacity-30 rounded-xl p-4 h-64 md:h-96 overflow-y-auto mb-6 border border-gray-700">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-center text-text-secondary">Loading messages...</p>
    </div>
    <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
      <textarea id="buyer-seller-chat-input" placeholder="Type your message..." rows="3"
                class="app-input flex-1 resize-none"></textarea>
      <button onclick="sendBuyerSellerChatMessage()" 
              class="myanmar-btn flex items-center justify-center space-x-2 md:self-end">
        <i class="fas fa-paper-plane"></i>
        <span>SEND</span>
      </button>
    </div>
    <div class="mt-4 flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
        <button onclick="showOrderListToSendMessage()" class="myanmar-btn flex-1 btn-small">
          <i class="fas fa-clipboard-list mr-2"></i>
          SEND ORDER LIST
        </button>
        <input type="file" id="buyer-seller-chat-file-upload" accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" class="app-input flex-1 btn-small">
        <button onclick="uploadBuyerSellerChatFile()" class="myanmar-btn flex-1 btn-small">
          <i class="fas fa-paperclip mr-2"></i>
          UPLOAD FILE
        </button>
    </div>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div id="confirm-modal" class="modal hidden">
<div class="modal-content max-w-md">
  <div class="text-center">
    <i class="fas fa-exclamation-triangle text-4xl text-accent-red mb-4"></i>
    <h3 class="text-xl font-orbitron font-bold text-text-primary mb-4">ARE YOU SURE?</h3>
    <p id="confirm-message" class="text-text-secondary mb-6">This action cannot be undone.</p>
    <div class="flex space-x-4">
      <button onclick="closeConfirmModal()" class="myanmar-btn flex-1">
        <i class="fas fa-times mr-2"></i>
        CANCEL
      </button>
      <button onclick="confirmAction()" class="btn-danger myanmar-btn flex-1">
        <i class="fas fa-trash mr-2"></i>
        DELETE
      </button>
    </div>
  </div>
</div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 loading-overlay flex items-center justify-center z-50 hidden">
<div class="app-card p-8 text-center">
  <div class="loading-spinner mx-auto mb-4" style="width: 40px; height: 40px;"></div>
  <p class="text-text-primary font-semibold">PROCESSING...</p>
</div>
</div>

<!-- Order Upload Animation Overlay -->
<div id="order-upload-animation" class="order-upload-animation hidden">
  <div id="animation-content">
    <div class="spinner"></div>
    <p class="text-lg font-semibold text-text-primary">ORDER UPLOADING...</p>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
// Configuration
const CONFIG = {
  SUPABASE_URL: 'https://rliwdosxsbauwxkayjoa.supabase.co',
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsaXdkb3N4c2JhdXd4a2F5am9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxMDA2NjIsImV4cCI6MjA2OTY3NjY2Mn0.uDvU9eX3Cy--D9l6daGaO2QMpn1YnxMJYVlbaeIgHu4',
  MAX_RETRY_ATTEMPTS: 3,
  RETRY_DELAY: 2000
};

// State
let state = {
  supabase: null,
  isAuthenticated: false,
  currentSection: 'home',
  currentShopSubSection: 'browse-products',
  reconnectAttempts: 0,
  isConnected: false,
  confirmCallback: null,
  userProfile: null, // Stores current user's profile data
  adminProfileChatId: 'a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', // Dummy profile_id for Admin Global Chat
  newsRealtime: null,
  profileNewsRealtime: null, // NEW
  chatRealtime: null,
  supportRealtime: null,
  productsRealtime: null, // Admin products
  userProductsRealtime: null, // NEW: User products
  ordersRealtime: null, // Admin product orders
  userOrdersRealtime: null, // NEW: User product orders
  buyerSellerConversationsRealtime: null, // NEW
  buyerSellerMessagesRealtime: null, // NEW
  selectedProductForPurchase: null, // For Admin Products
  selectedUserProductForPurchase: null, // NEW: For User Products
  selectedPaymentMethod: null, // Admin payment method
  selectedSellerPaymentMethodId: null, // NEW: Seller payment method ID
  currentBuyerSellerConversationId: null, // NEW
  currentChatPartnerProfileId: null, // NEW
};

// Utility Functions
const utils = {
  formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  },
  getMediaType(fileType) {
    if (fileType.startsWith('image/')) return 'image';
    if (fileType.startsWith('video/')) return 'video';
    if (fileType.startsWith('audio/')) return 'audio';
    return 'file';
  },
  // Function to get a unique device ID (simple example, can be improved)
  getDeviceId() {
    let deviceId = localStorage.getItem('device_id');
    if (!deviceId) {
      deviceId = 'device_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('device_id', deviceId);
    }
    return deviceId;
  },
  // Function to format price
  formatPrice(price) {
    return `${parseFloat(price).toFixed(2)} MMK`;
  },
  // Function to show order upload animation
  showOrderUploadAnimation(show, success = false, message = '') {
    const animationOverlay = document.getElementById('order-upload-animation');
    const animationContent = document.getElementById('animation-content');
    if (show) {
      animationContent.innerHTML = ''; // Clear previous content
      if (success) {
        animationContent.innerHTML = `
          <div class="success-checkmark">
            <svg class="success-checkmark__circle" viewBox="0 0 52 52">
              <circle cx="26" cy="26" r="25" fill="none"/>
            </svg>
            <svg class="success-checkmark__check" viewBox="0 0 52 52">
              <path fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
          </div>
          <p class="text-lg font-semibold text-text-primary">${message || 'ORDER UPLOADED SUCCESSFULLY!'}</p>
        `;
      } else {
        animationContent.innerHTML = `
          <div class="spinner"></div>
          <p class="text-lg font-semibold text-text-primary">${message || 'ORDER UPLOADING...'}</p>
        `;
      }
      animationOverlay.classList.remove('hidden');
    } else {
      animationOverlay.classList.add('hidden');
    }
  }
};

// Initialize
document.addEventListener('DOMContentLoaded', initializeApp);

async function initializeApp() {
  updateConnectionStatus('connecting');
  
  try {
    // Check if Supabase config is set
    if (!CONFIG.SUPABASE_URL || CONFIG.SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE') {
      throw new Error('Supabase URL လိုအပ်ပါတယ်! CONFIG အပိုင်းထဲမှာ သင့် Supabase URL ကို ထည့်ပါ။');
    }

    if (!CONFIG.SUPABASE_ANON_KEY || CONFIG.SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
      throw new Error('Supabase Anon Key လိုအပ်ပါတယ်! CONFIG အပိုင်းထဲမှာ သင့် Supabase Anon Key ကို ထည့်ပါ။');
    }

    // Initialize Supabase
    if (typeof supabase !== 'undefined') {
      state.supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
        auth: { persistSession: false },
        realtime: { params: { eventsPerSecond: 10 } }
      });

      // Test connection
      const { data, error } = await state.supabase.from('about').select('id').limit(1);
      
      if (error && error.code !== 'PGRST116') {
        throw new Error(`Database connection failed: ${error.message}`);
      }

      updateConnectionStatus('online');
      showNotification('Database connected successfully! အက်ပ် အသုံးပြုရန် အသင့်ဖြစ်ပါတယ်။', 'success');
      
      state.isConnected = true;
      state.reconnectAttempts = 0;

      // Check for existing key in localStorage
      const storedKey = localStorage.getItem('user_key');
      if (storedKey) {
        document.getElementById('login-key').value = storedKey;
        userLogin(true); // Attempt silent login
      }
      
    } else {
      throw new Error('Supabase library မတင်လို့ရပါ');
    }
  } catch (error) {
    console.error('Initialization error:', error);
    updateConnectionStatus('offline');
    showNotification(`Connection failed: ${error.message}`, 'error');
    
    // Retry connection
    if (state.reconnectAttempts < CONFIG.MAX_RETRY_ATTEMPTS) {
      state.reconnectAttempts++;
      setTimeout(() => {
        console.log(`Retrying connection (${state.reconnectAttempts}/${CONFIG.MAX_RETRY_ATTEMPTS})...`);
        initializeApp();
      }, CONFIG.RETRY_DELAY);
    }
  }

  // Add enter key listener for login key input
  document.getElementById('login-key').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      userLogin();
    }
  });
}

function updateConnectionStatus(status) {
  const statusElement = document.getElementById('connection-status');
  statusElement.className = 'connection-status';
  
  switch (status) {
    case 'online':
      statusElement.classList.add('status-online');
      statusElement.innerHTML = '<i class="fas fa-check-circle"></i> ONLINE';
      break;
    case 'offline':
      statusElement.classList.add('status-offline');
      statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> OFFLINE';
      break;
    case 'connecting':
      statusElement.classList.add('status-connecting');
      statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ချိတ်ဆက်နေသည်...';
      break;
  }
}

function showNotification(message, type = 'info', duration = 5000) {
  const container = document.getElementById('notification-container');
  const notification = document.createElement('div');
  
  const bgColors = {
    success: 'bg-green-600',
    error: 'bg-red-600',
    info: 'bg-blue-600',
    warning: 'bg-yellow-600'
  };
  
  const icons = {
    success: 'fa-check-circle',
    error: 'fa-exclamation-triangle',
    info: 'fa-info-circle',
    warning: 'fa-exclamation-circle'
  };
  
  notification.className = `notification ${bgColors[type]}`;
  notification.innerHTML = `
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <i class="fas ${icons[type]} mr-2"></i>
        <span>${message}</span>
      </div>
      <button onclick="this.parentElement.parentElement.remove()" class="ml-4 hover:text-gray-200">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `;
  
  container.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentElement) {
      notification.remove();
    }
  }, duration);
}

async function userLogin(isSilent = false) {
  if (!state.isConnected) {
    if (!isSilent) showNotification('Waiting for database connection...', 'warning');
    return;
  }

  const loginKey = document.getElementById('login-key').value.trim();
  const loginBtn = document.getElementById('login-btn');
  const loginText = document.getElementById('login-text');

  if (!loginKey) {
    if (!isSilent) showNotification('Please enter Key', 'warning');
    return;
  }

  try {
    if (!isSilent) {
      loginBtn.disabled = true;
      loginText.textContent = 'LOGGING IN...';
    }
    showLoading(true);

    const { data, error } = await state.supabase.rpc('user_login', { input_key_text: loginKey });

    if (error) throw error;

    if (data && data.length > 0) {
      const userData = data[0];
      if (userData.key_is_active === false) {
        throw new Error('Your Key is inactive.');
      }
      if (userData.is_banned === true) {
        throw new Error('Your account is banned.');
      }

      localStorage.setItem('user_key', loginKey); // Persist key
      state.isAuthenticated = true;
      state.userProfile = userData;

      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('profile-creation-section').classList.add('hidden');
      document.getElementById('app-content').classList.remove('hidden');
      
      if (!isSilent) showNotification('Successfully logged in!', 'success');
      
      // If profile_id is null, show profile creation section
      if (!userData.profile_id) {
        document.getElementById('app-content').classList.add('hidden');
        document.getElementById('profile-creation-section').classList.remove('hidden');
        showNotification('No profile found for your key. Please create one.', 'info', 10000);
      } else {
        // Load initial data for the app
        await loadDashboardData();
        setupRealtimeSubscriptions();
        showSection('home', document.querySelector('.nav-btn.active')); // Activate default section
      }
      
    } else {
      throw new Error('Invalid Key or Key is not usable');
    }

  } catch (error) {
    console.error('Login error:', error);
    if (!isSilent) showNotification(error.message, 'error');
    userLogout(); // Ensure logout on error
  } finally {
    if (!isSilent) {
      loginBtn.disabled = false;
      loginText.textContent = 'LOGIN';
    }
    showLoading(false);
  }
}

async function createProfile() {
  const username = document.getElementById('profile-username').value.trim();
  const name = document.getElementById('profile-name').value.trim();
  const profilePictureFile = document.getElementById('profile-picture').files[0];
  const createProfileBtn = document.getElementById('create-profile-btn');
  const createProfileText = document.getElementById('create-profile-text');

  if (!username || !name) {
    showNotification('Please enter Username and Name', 'warning');
    return;
  }

  if (!state.userProfile || !state.userProfile.key_id) {
    showNotification('Key information missing, please re-login.', 'error');
    return;
  }

  try {
    createProfileBtn.disabled = true;
    createProfileText.textContent = 'CREATING PROFILE...';
    showLoading(true);

    let profilePictureUrl = null;
    if (profilePictureFile) {
      const fileExt = profilePictureFile.name.split('.').pop();
      const fileName = `profile_pictures/${state.userProfile.key_id}_${Date.now()}.${fileExt}`;
      const { data: uploadData, error: uploadError } = await state.supabase.storage
        .from('profiles')
        .upload(fileName, profilePictureFile);
      if (uploadError) throw uploadError;
      const { data: urlData } = state.supabase.storage.from('profiles').getPublicUrl(fileName);
      profilePictureUrl = urlData.publicUrl;
    }

    const { data, error } = await state.supabase
      .from('profiles')
      .insert({
        key_id: state.userProfile.key_id,
        username: username,
        name: name,
        profile_picture: profilePictureUrl,
        is_banned: false
      })
      .select()
      .single();

    if (error) throw error;

    state.userProfile.profile_id = data.id;
    state.userProfile.username = data.username;
    state.userProfile.name = data.name;
    state.userProfile.profile_picture = data.profile_picture;
    state.userProfile.is_banned = data.is_banned;

    showNotification('Profile created successfully!', 'success');
    document.getElementById('profile-creation-section').classList.add('hidden');
    document.getElementById('app-content').classList.remove('hidden');
    
    await loadDashboardData();
    setupRealtimeSubscriptions();
    showSection('home', document.querySelector('.nav-btn.active'));

  } catch (error) {
    console.error('Error creating profile:', error);
    if (error.code === '23505') { // Unique constraint violation
      showNotification('Username already exists, please choose another.', 'error');
    } else {
      showNotification('Failed to create profile', 'error');
    }
  } finally {
    createProfileBtn.disabled = false;
    createProfileText.textContent = 'CREATE PROFILE';
    showLoading(false);
  }
}

async function loadDashboardData() {
  try {
    // Load stats for Admin Products
    const [productsResult, downloadsResult] = await Promise.all([
      state.supabase.from('products').select('id', { count: 'exact' }).eq('is_active', true),
      state.supabase.from('orders').select('id', { count: 'exact' }).eq('status', 'approved')
    ]);

    document.getElementById('available-products').textContent = productsResult.count || 0;
    document.getElementById('total-downloads').textContent = downloadsResult.count || 0;

    // Load stats for User Products (NEW)
    const [userProductsResult, userOrdersResult] = await Promise.all([
      state.supabase.from('user_products').select('id', { count: 'exact' }).eq('is_active', true),
      state.supabase.from('user_orders').select('id', { count: 'exact' }).eq('status', 'approved')
    ]);

    document.getElementById('available-user-products').textContent = userProductsResult.count || 0;
    document.getElementById('total-user-orders').textContent = userOrdersResult.count || 0;


  } catch (error) {
    console.error('Error loading dashboard data:', error);
    showNotification('Failed to retrieve dashboard data', 'error');
  }
}

function setupRealtimeSubscriptions() {
  // Unsubscribe from previous channels if they exist
  if (state.newsRealtime) state.supabase.removeChannel(state.newsRealtime);
  if (state.profileNewsRealtime) state.supabase.removeChannel(state.profileNewsRealtime); // NEW
  if (state.chatRealtime) state.supabase.removeChannel(state.chatRealtime);
  if (state.supportRealtime) state.supabase.removeChannel(state.supportRealtime);
  if (state.productsRealtime) state.supabase.removeChannel(state.productsRealtime); // Admin products
  if (state.userProductsRealtime) state.supabase.removeChannel(state.userProductsRealtime); // NEW: User products
  if (state.ordersRealtime) state.supabase.removeChannel(state.ordersRealtime); // Admin orders
  if (state.userOrdersRealtime) state.supabase.removeChannel(state.userOrdersRealtime); // NEW: User orders
  if (state.buyerSellerConversationsRealtime) state.supabase.removeChannel(state.buyerSellerConversationsRealtime); // NEW
  if (state.buyerSellerMessagesRealtime) state.supabase.removeChannel(state.buyerSellerMessagesRealtime); // NEW


  // News realtime updates (Admin News)
  state.newsRealtime = state.supabase
    .channel('news_changes')
    .on('postgres_changes', 
      { event: '*', schema: 'public', table: 'news' }, 
      (payload) => {
        if (state.currentSection === 'news') {
          loadNewsData();
        }
        loadDashboardData(); // Update stats
      }
    )
    .subscribe();

  // Profile News realtime updates (User News) (NEW)
  state.profileNewsRealtime = state.supabase
    .channel('profile_news_changes')
    .on('postgres_changes', 
      { event: '*', schema: 'public', table: 'profile_news' }, 
      (payload) => {
        if (state.currentSection === 'news' || state.currentSection === 'mi') {
          loadNewsData(); // Reload all news including user news
          loadUserNews(); // Reload user's own news list
        }
        loadDashboardData(); // Update stats
      }
    )
    .subscribe();

  // Chat messages realtime (Global Chat)
  state.chatRealtime = state.supabase
    .channel('chat_changes')
    .on('postgres_changes', 
      { event: '*', schema: 'public', table: 'chat_messages' }, 
      (payload) => {
        if (state.currentSection === 'chat') {
          loadChatMessages();
        }
      }
    )
    .subscribe();

  // Support messages realtime
  state.supportRealtime = state.supabase
    .channel('support_changes')
    .on('postgres_changes', 
      { event: '*', schema: 'public', table: 'support_messages' }, 
      (payload) => {
        if (state.currentSection === 'support') {
          loadSupportMessages();
        }
      }
    )
    .subscribe();

  // Products realtime (Admin Products)
  state.productsRealtime = state.supabase
    .channel('products_changes')
    .on('postgres_changes', 
      { event: '*', schema: 'public', table: 'products' }, 
      (payload) => {
        if (state.currentSection === 'products') {
          loadProductsData();
        }
        loadDashboardData(); // Update stats
      }
    )
    .subscribe();

  // User Products realtime (NEW)
  state.userProductsRealtime = state.supabase
    .channel('user_products_changes')
    .on('postgres_changes', 
      { event: '*', schema: 'public', table: 'user_products' }, 
      (payload) => {
        if (state.currentSection === 'shop') {
          loadUserShopProducts(); // For buyer view
          if (state.currentShopSubSection === 'my-shop') {
            loadMyListedProducts(); // For seller view
          }
        }
        loadDashboardData(); // Update stats
      }
    )
    .subscribe();

  // Orders realtime (for user's own orders of Admin Products)
  state.ordersRealtime = state.supabase
    .channel('orders_changes')
    .on('postgres_changes', 
      { event: '*', schema: 'public', table: 'orders', filter: `profile_id=eq.${state.userProfile.profile_id}` }, 
      (payload) => {
        if (state.currentSection === 'mi') {
          loadMyPurchasedAdminProducts(); // Reload purchased products
        }
      }
    )
    .subscribe();

  // User Orders realtime (for user's own orders as BUYER & SELLER) (NEW)
  if (state.userProfile && state.userProfile.profile_id) {
    state.userOrdersRealtime = state.supabase
      .channel(`user_orders_changes:${state.userProfile.profile_id}`)
      .on('postgres_changes', 
        { 
          event: '*', 
          schema: 'public', 
          table: 'user_orders', 
          filter: `buyer_profile_id=eq.${state.userProfile.profile_id}.or.seller_profile_id.eq.${state.userProfile.profile_id}` 
        }, 
        (payload) => {
          if (state.currentSection === 'shop') {
            if (state.currentShopSubSection === 'my-orders') {
              loadIncomingUserOrders(); // Seller's incoming orders
            } else if (state.currentShopSubSection === 'browse-products') {
              loadMyBuyerOrders(); // Buyer's own orders
            }
          }
          loadDashboardData(); // Update stats
        }
      )
      .subscribe();
  }

  // Buyer-Seller Conversations Realtime (NEW)
  if (state.userProfile && state.userProfile.profile_id) {
    state.buyerSellerConversationsRealtime = state.supabase
      .channel(`buyer_seller_conversations:${state.userProfile.profile_id}`)
      .on('postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'buyer_seller_conversations',
          filter: `profile1_id=eq.${state.userProfile.profile_id}.or.profile2_id=eq.${state.userProfile.profile_id}`
        },
        (payload) => {
          // If the chat modal is open and concerns this conversation, refresh messages
          if (state.currentBuyerSellerConversationId) {
            loadBuyerSellerChatMessages(state.currentBuyerSellerConversationId, state.currentChatPartnerProfileId);
          }
        }
      )
      .subscribe();

    // Buyer-Seller Messages Realtime (NEW)
    state.buyerSellerMessagesRealtime = state.supabase
      .channel(`buyer_seller_messages:${state.userProfile.profile_id}`)
      .on('postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'buyer_seller_messages',
          filter: `sender_profile_id=eq.${state.userProfile.profile_id}.or.conversation_id.in.(select id from buyer_seller_conversations where profile1_id='${state.userProfile.profile_id}' or profile2_id='${state.userProfile.profile_id}')`
        },
        (payload) => {
          if (state.currentBuyerSellerConversationId && payload.new.conversation_id === state.currentBuyerSellerConversationId) {
            loadBuyerSellerChatMessages(state.currentBuyerSellerConversationId, state.currentChatPartnerProfileId);
          }
        }
      )
      .subscribe();
  }
}

function showSection(section, buttonElement) {
  // Hide all sections
  document.querySelectorAll('.app-section').forEach(sec => {
    sec.classList.add('hidden');
  });
  
  // Update navigation
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Show selected section
  const sectionElement = document.getElementById(`${section}-section`);
  if (sectionElement) {
    sectionElement.classList.remove('hidden');
    sectionElement.classList.add('fade-in');
  }
  
  // Update active nav
  if (buttonElement) {
    buttonElement.classList.add('active');
  }
  state.currentSection = section;
  
  // Load section data
  switch (section) {
    case 'home':
      loadDashboardData();
      break;
    case 'news':
      loadNewsData(); // Loads both admin and profile news
      break;
    case 'products':
      loadProductsData(); // Loads admin products
      break;
    case 'shop': // NEW
      showShopSubSection(state.currentShopSubSection, document.querySelector(`#shop-section .nav-btn.active`) || document.querySelector(`#shop-section .nav-btn:first-child`));
      break;
    case 'chat':
      loadChatMessages(); // Loads global chat
      break;
    case 'support':
      loadSupportMessages();
      break;
    case 'about':
      loadAboutData();
      break;
    case 'mi':
      loadMiProfile();
      loadUserNews(); // NEW: Load user's own news posts
      loadMyPurchasedAdminProducts(); // NEW: Load user's purchased admin products
      break;
  }
}

// NEW: Shop Sub-Sections
function showShopSubSection(subSection, buttonElement) {
  document.querySelectorAll('.shop-subsection').forEach(sec => {
    sec.classList.add('hidden');
  });
  document.querySelectorAll('#shop-section .nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });

  const subSectionElement = document.getElementById(`${subSection}-subsection`);
  if (subSectionElement) {
    subSectionElement.classList.remove('hidden');
    subSectionElement.classList.add('fade-in');
  }

  if (buttonElement) {
    buttonElement.classList.add('active');
  }
  state.currentShopSubSection = subSection;

  switch (subSection) {
    case 'browse-products':
      loadUserShopProducts(); // Load products for buyers
      loadMyBuyerOrders(); // Load buyer's own orders
      break;
    case 'my-shop':
      loadMyListedProducts(); // Load products listed by current user (seller)
      loadSellerPaymentMethods(); // Load seller's payment methods
      loadIncomingUserOrders(); // Load seller's incoming orders
      break;
    case 'my-orders':
      loadMyBuyerOrders(); // Show buyer's own orders (User orders)
      break;
  }
}

async function loadNewsData() {
  const newsContainer = document.getElementById('news-list');
  newsContainer.innerHTML = `
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-center text-text-secondary">Loading news...</p>
  `;

  try {
    // Fetch Admin News
    const { data: adminNews, error: adminError } = await state.supabase
      .from('news')
      .select(`
        *,
        admin_profiles(username, name, profile_picture)
      `)
      .order('created_at', { ascending: false });
    if (adminError) throw adminError;

    // Fetch Profile News (User Posted News)
    const { data: profileNews, error: profileError } = await state.supabase
      .from('profile_news')
      .select(`
        *,
        profiles(username, name, profile_picture)
      `)
      .order('created_at', { ascending: false });
    if (profileError) throw profileError;

    const allNews = [...(adminNews || []).map(n => ({...n, is_admin_news: true})), 
                     ...(profileNews || []).map(n => ({...n, is_admin_news: false}))];
    
    // Sort all news by created_at descending
    allNews.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());

    if (allNews && allNews.length > 0) {
      newsContainer.innerHTML = allNews.map(news => {
        const author = news.is_admin_news ? news.admin_profiles : news.profiles;
        const authorName = author?.name || 'Unknown';
        const authorUsername = author?.username || 'unknown';
        const authorAvatar = author?.profile_picture || '/placeholder.svg?height=40&width=40';

        let mediaHtml = '';
        if (news.media_urls && news.media_urls.length > 0) {
          // Display only the first media for list view
          const firstMedia = news.media_urls[0];
          const mediaType = utils.getMediaType(firstMedia.type);
            if (mediaType === 'image') {
              mediaHtml += `<img src="${firstMedia.url}" class="w-full rounded-lg mb-3 object-cover max-h-48" alt="News image">`;
            } else if (mediaType === 'video') {
              mediaHtml += `
                <div class="video-container mb-3">
                  <video controls playsinline webkit-playsinline class="w-full rounded-lg max-h-48 object-cover">
                    <source src="${firstMedia.url}" type="${firstMedia.type}">
                  </video>
                </div>
              `;
            }
        }
        
        return `
          <div class="news-card p-4">
            <div class="flex justify-between items-start mb-3">
              <div>
                <h4 class="text-lg font-semibold text-accent-purple mb-1">${news.title}</h4>
                <p class="text-sm text-text-secondary">
                  <i class="fas fa-user mr-1"></i> ${authorName} (@${authorUsername})
                  <span class="ml-3">
                    <i class="fas fa-calendar mr-1"></i> ${new Date(news.created_at).toLocaleDateString('my-MM', { year: 'numeric', month: 'short', day: 'numeric' })}
                  </span>
                </p>
              </div>
              <div class="flex space-x-2">
                <button onclick="${news.is_admin_news ? `viewNews('${news.id}')` : `viewProfileNews('${news.id}')`}" class="myanmar-btn btn-small">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
            
            ${mediaHtml}
            
            <p class="text-text-secondary text-sm mb-3">${news.content.substring(0, 150)}${news.content.length > 150 ? '...' : ''}</p>
            
            <div class="flex items-center justify-between text-sm text-text-secondary">
              <div class="flex space-x-4">
                <span><i class="fas fa-eye mr-1"></i> ${news.views || 0}</span>
                <span><i class="fas fa-heart mr-1"></i> ${news.likes || 0}</span>
              </div>
              ${news.youtube_link ? '<i class="fab fa-youtube text-red-500"></i>' : ''}
            </div>
          </div>
        `;
      }).join('');
    } else {
      newsContainer.innerHTML = `
        <div class="text-center text-text-secondary py-8">
          <i class="fas fa-newspaper text-4xl mb-4"></i>
          <p>No News Found</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading news:', error);
    newsContainer.innerHTML = `
      <div class="text-center text-accent-red py-8">
        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
        <p>Failed to retrieve News</p>
      </div>
    `;
  }
}

async function viewNews(newsId) { // For Admin News
  try {
    // Increment view count
    await state.supabase.rpc('increment_news_views', { input_news_id: newsId });

    const { data, error } = await state.supabase
      .from('news')
      .select(`
        *,
        admin_profiles(username, name, profile_picture)
      `)
      .eq('id', newsId)
      .single();

    if (error) throw error;

    const author = data.admin_profiles;
    const authorName = author?.name || 'Unknown';
    const authorUsername = author?.username || 'unknown';
    const authorAvatar = author?.profile_picture || '/placeholder.svg?height=40&width=40';

    let mediaHtml = '';
    if (data.media_urls && data.media_urls.length > 0) {
      data.media_urls.forEach(media => {
        const mediaType = utils.getMediaType(media.type);
        if (mediaType === 'image') {
          mediaHtml += `<img src="${media.url}" class="w-full rounded-lg mb-3 object-cover" alt="News image">`;
        } else if (mediaType === 'video') {
          mediaHtml += `
            <div class="video-container mb-3">
              <video controls playsinline webkit-playsinline class="w-full rounded-lg">
                <source src="${media.url}" type="${media.type}">
              </video>
            </div>
          `;
        } else if (mediaType === 'audio') {
          mediaHtml += `
            <div class="audio-container mb-3">
              <audio controls class="w-full">
                <source src="${media.url}" type="${media.type}">
              </audio>
            </div>
          `;
        }
      });
    }

    let socialLinksHtml = '';
    if (data.youtube_link) socialLinksHtml += `<a href="${data.youtube_link}" target="_blank" class="text-red-500 hover:text-red-400"><i class="fab fa-youtube text-2xl"></i></a>`;
    if (data.tiktok_link) socialLinksHtml += `<a href="${data.tiktok_link}" target="_blank" class="text-text-secondary hover:text-text-primary"><i class="fab fa-tiktok text-2xl"></i></a>`;
    if (data.telegram_link) socialLinksHtml += `<a href="${data.telegram_link}" target="_blank" class="text-blue-400 hover:text-blue-300"><i class="fab fa-telegram text-2xl"></i></a>`;
    if (data.facebook_link) socialLinksHtml += `<a href="${data.facebook_link}" target="_blank" class="text-blue-600 hover:text-blue-500"><i class="fab fa-facebook text-2xl"></i></a>`;


    document.getElementById('news-modal-content').innerHTML = `
      <div class="space-y-4">
        <div class="flex items-center space-x-3">
          <img src="${authorAvatar}" 
               alt="Author" class="w-10 h-10 rounded-full object-cover">
          <div>
            <h4 class="font-semibold text-text-primary">${authorName} (Admin)</h4>
            <p class="text-sm text-text-secondary">@${authorUsername}</p>
          </div>
        </div>
        
        <h3 class="text-xl font-bold text-accent-purple">${data.title}</h3>
        
        ${mediaHtml}
        
        <div class="prose prose-invert max-w-none">
          <p class="text-text-secondary whitespace-pre-wrap">${data.content}</p>
        </div>
        
        ${socialLinksHtml ? `<div class="flex space-x-4 mt-4">${socialLinksHtml}</div>` : ''}

        <div class="flex items-center justify-between text-sm text-text-secondary pt-4 border-t border-border-color">
          <div class="flex space-x-4">
            <span><i class="fas fa-eye mr-1"></i> ${data.views || 0} VIEWS</span>
            <span><i class="fas fa-heart mr-1"></i> ${data.likes || 0} LIKES</span>
          </div>
          <span><i class="fas fa-calendar mr-1"></i> ${new Date(data.created_at).toLocaleString('my-MM')}</span>
        </div>
      </div>
    `;

    document.getElementById('news-modal').classList.remove('hidden');

  } catch (error) {
    console.error('Error viewing news:', error);
    showNotification('Failed to view News', 'error');
  }
}

function closeNewsModal() {
  document.getElementById('news-modal').classList.add('hidden');
}

async function loadProductsData() { // For Admin Products
  const productsList = document.getElementById('products-list');
  productsList.innerHTML = `
    <div class="loading-spinner mx-auto mb-4 col-span-full"></div>
    <p class="text-center text-text-secondary col-span-full">Loading products...</p>
  `;

  try {
    const { data: products, error } = await state.supabase
      .from('products')
      .select('*')
      .eq('is_active', true)
      .order('created_at', { ascending: false });

    if (error) throw error;

    if (products && products.length > 0) {
      productsList.innerHTML = ''; // Clear loading
      for (const product of products) {
        let isPurchased = false;
        if (state.userProfile && state.userProfile.profile_id) { // Only check if user is logged in and has a profile
          const { data: purchasedData, error: purchasedError } = await state.supabase
            .from('purchased_products')
            .select('id')
            .eq('profile_id', state.userProfile.profile_id)
            .eq('product_id', product.id)
            .limit(1);
          isPurchased = !purchasedError && purchasedData && purchasedData.length > 0;
        }

        productsList.innerHTML += `
          <div class="app-card p-4 text-center flex flex-col justify-between items-center">
            <img src="${product.apk_icon_url || '/placeholder.svg?height=64&width=64'}" alt="${product.name} icon" class="w-16 h-16 object-contain mb-3">
            <h3 class="text-lg font-semibold text-text-primary mb-1">${product.name}</h3>
            <p class="text-text-secondary text-sm mb-2">${product.description || 'No description'}</p>
            ${product.price > 0 ? `<p class="text-xl font-bold text-accent-green mb-3">${utils.formatPrice(product.price)}</p>` : '<p class="text-xl font-bold text-accent-green mb-3">FREE</p>'}
            ${product.price > 0 && !isPurchased ? `
              <button onclick="initiatePurchase('${product.id}', '${product.name}', ${product.price})" class="myanmar-btn w-full mt-auto">
                <i class="fas fa-shopping-cart mr-2"></i> PURCHASE
              </button>
            ` : `
              <a href="${product.file_url}" target="_blank" download class="myanmar-btn w-full mt-auto">
                <i class="fas fa-download mr-2"></i> DOWNLOAD
              </a>
            `}
          </div>
        `;
      }
    } else {
      productsList.innerHTML = '<p class="text-center col-span-full text-text-secondary">No Products Available</p>';
    }
  } catch (error) {
    console.error('Error loading products:', error);
    productsList.innerHTML = '<p class="text-center col-span-full text-accent-red">Failed to retrieve Products</p>';
  }
}

async function initiatePurchase(productId, productName, productPrice) { // For Admin Products
  if (!state.userProfile || !state.userProfile.profile_id) {
    showNotification('Please create a profile to purchase products.', 'info');
    return;
  }
  state.selectedProductForPurchase = { id: productId, name: productName, price: productPrice };
  
  const paymentModalContent = document.getElementById('payment-modal-content');
  paymentModalContent.innerHTML = `
    <h3 class="text-xl font-semibold text-text-primary mb-2">${productName}</h3>
    <p class="text-text-secondary mb-4">Price: <span class="text-accent-green font-bold">${utils.formatPrice(productPrice)}</span></p>
    
    <h4 class="text-lg font-semibold text-accent-purple mb-3">SELECT PAYMENT METHOD</h4>
    <div id="payment-methods-list" class="space-y-3 mb-4">
      <div class="loading-spinner mx-auto mb-2"></div>
      <p class="text-center text-text-secondary">Loading payment methods...</p>
    </div>

    <div class="space-y-3">
      <label class="block text-sm font-medium text-text-secondary">UPLOAD RECEIPT IMAGE</label>
      <input type="file" id="receipt-upload" accept="image/*" class="app-input w-full">
      <button onclick="submitPurchase()" class="myanmar-btn w-full">
        <i class="fas fa-paper-plane mr-2"></i>
        CONFIRM PAYMENT
      </button>
    </div>
    <p class="text-sm text-text-secondary mt-4">
      <i class="fas fa-info-circle mr-1"></i>
      After confirming payment, Admin will review and approve your download.
    </p>
  `;

  document.getElementById('payment-modal').classList.remove('hidden');
  
  const paymentMethodsList = document.getElementById('payment-methods-list');
  try {
    const { data: methods, error } = await state.supabase
      .from('payment_methods')
      .select('*')
      .eq('is_active', true)
      .order('method_name', { ascending: true });

    if (error) throw error;

    if (methods && methods.length > 0) {
      paymentMethodsList.innerHTML = methods.map(method => `
        <label class="flex items-center space-x-3 p-3 bg-secondary-bg rounded-lg cursor-pointer border border-border-color">
          <input type="radio" name="payment_method" value="${method.id}" 
                 onchange="state.selectedPaymentMethod = '${method.id}'" class="w-4 h-4 text-accent-purple focus:ring-accent-purple">
          <div>
            <p class="font-semibold text-text-primary">${method.method_name}</p>
            <p class="text-text-secondary text-sm">${method.account_info || ''}</p>
            ${method.qr_code_url ? `<img src="${method.qr_code_url}" class="w-24 h-24 mt-2 rounded-md border border-border-color" alt="QR Code">` : ''}
            ${method.instructions ? `<p class="text-text-secondary text-xs mt-1">${method.instructions}</p>` : ''}
          </div>
        </label>
      `).join('');
    } else {
      paymentMethodsList.innerHTML = '<p class="text-center text-text-secondary">No Payment Methods Available</p>';
    }
  } catch (error) {
    console.error('Error loading payment methods:', error);
    showNotification('Failed to retrieve Payment Methods', 'error');
    paymentMethodsList.innerHTML = '<p class="text-center text-accent-red">Failed to retrieve Payment Methods</p>';
  }
}

function closePaymentModal() { // For Admin Products
  document.getElementById('payment-modal').classList.add('hidden');
  state.selectedProductForPurchase = null;
  state.selectedPaymentMethod = null;
  document.getElementById('receipt-upload').value = '';
}

async function submitPurchase() { // For Admin Products
  if (!state.selectedProductForPurchase || !state.selectedPaymentMethod) {
    showNotification('Please select a Product and Payment Method', 'warning');
    return;
  }
  const receiptFile = document.getElementById('receipt-upload').files[0];
  if (!receiptFile) {
    showNotification('Please upload a receipt image', 'warning');
    return;
  }

  showNotification('Confirming payment...', 'info');
  utils.showOrderUploadAnimation(true, false, 'ငွေပေးချေမှု အတည်ပြုနေသည်...'); // Show processing animation

  try {
    // Upload receipt image
    const fileExt = receiptFile.name.split('.').pop();
    const fileName = `receipts/${state.userProfile.profile_id}_${state.selectedProductForPurchase.id}_${Date.now()}.${fileExt}`;
    
    const { data: uploadData, error: uploadError } = await state.supabase.storage
      .from('receipts')
      .upload(fileName, receiptFile);
      
    if (uploadError) throw uploadError;
    
    const { data: urlData } = state.supabase.storage
      .from('receipts')
      .getPublicUrl(fileName);
      
    const receiptUrl = urlData.publicUrl;

    // Create order
    const { error: orderError } = await state.supabase
      .from('orders')
      .insert({
        profile_id: state.userProfile.profile_id,
        product_id: state.selectedProductForPurchase.id,
        payment_method_id: state.selectedPaymentMethod,
        amount: state.selectedProductForPurchase.price,
        receipt_url: receiptUrl,
        status: 'pending' // Admin needs to approve this
      });

    if (orderError) throw orderError;

    utils.showOrderUploadAnimation(true, true, 'ငွေပေးချေမှု အောင်မြင်ပါပြီ! Admin မှ စစ်ဆေးပေးပါမည်။'); // Show success animation
    setTimeout(() => utils.showOrderUploadAnimation(false), 2000); // Hide after 2 seconds

    closePaymentModal();
    loadProductsData(); // Reload products to update status
    loadMyPurchasedAdminProducts(); // Reload user's purchased products
    showNotification('Payment submitted successfully! Admin will review it.', 'success');
  } catch (error) {
    console.error('Error submitting purchase:', error);
    utils.showOrderUploadAnimation(false); // Hide animation on error
    showNotification('Failed to submit payment', 'error');
  } finally {
    showLoading(false);
  }
}

async function loadMyPurchasedAdminProducts() { // NEW
  const purchasedProductsList = document.getElementById('my-purchased-products-list');
  if (!state.userProfile || !state.userProfile.profile_id) {
    purchasedProductsList.innerHTML = `
      <div class="text-center text-text-secondary py-8">
        <i class="fas fa-shopping-bag text-4xl mb-4"></i>
        <p>Login to view your purchased products.</p>
      </div>
    `;
    return;
  }

  purchasedProductsList.innerHTML = `
    <div class="loading-spinner mx-auto mb-4 col-span-full"></div>
    <p class="text-center text-text-secondary col-span-full">Loading your purchased products...</p>
  `;

  try {
    const { data: purchasedItems, error } = await state.supabase
      .from('purchased_products')
      .select(`
        *,
        products(name, description, file_url, apk_icon_url, price)
      `)
      .eq('profile_id', state.userProfile.profile_id)
      .order('purchased_at', { ascending: false });

    if (error) throw error;

    if (purchasedItems && purchasedItems.length > 0) {
      purchasedProductsList.innerHTML = '';
      for (const item of purchasedItems) {
        const product = item.products;
        if (!product) continue; // Skip if product data is null

        purchasedProductsList.innerHTML += `
          <div class="app-card p-4 text-center flex flex-col justify-between items-center">
            <img src="${product.apk_icon_url || '/placeholder.svg?height=64&width=64'}" alt="${product.name} icon" class="w-16 h-16 object-contain mb-3">
            <h3 class="text-lg font-semibold text-text-primary mb-1">${product.name}</h3>
            <p class="text-text-secondary text-sm mb-2">${product.description || 'No description'}</p>
            <p class="text-xl font-bold text-accent-green mb-3">${utils.formatPrice(product.price)}</p>
            <p class="text-sm text-text-secondary mb-3">Purchased: ${new Date(item.purchased_at).toLocaleDateString('my-MM')}</p>
            <a href="${product.file_url}" target="_blank" download class="myanmar-btn w-full mt-auto">
              <i class="fas fa-download mr-2"></i> DOWNLOAD
            </a>
          </div>
        `;
      }
    } else {
      purchasedProductsList.innerHTML = '<p class="text-center col-span-full text-text-secondary">You haven\'t purchased any admin products yet.</p>';
    }
  } catch (error) {
    console.error('Error loading purchased admin products:', error);
    purchasedProductsList.innerHTML = '<p class="text-center col-span-full text-accent-red">Failed to retrieve purchased products</p>';
  }
}

// NEW: Shop Section Functions
async function loadUserShopProducts() { // For Buyer View
  const userProductsList = document.getElementById('user-products-list');
  userProductsList.innerHTML = `
    <div class="loading-spinner mx-auto mb-4 col-span-full"></div>
    <p class="text-center text-text-secondary col-span-full">Loading user products...</p>
  `;

  try {
    const { data: products, error } = await state.supabase
      .from('user_products')
      .select(`
        *,
        profiles(username, name, profile_picture)
      `)
      .eq('is_active', true)
      .eq('is_sold_out', false)
      .order('created_at', { ascending: false });

    if (error) throw error;

    if (products && products.length > 0) {
      userProductsList.innerHTML = '';
      products.forEach(product => {
        const seller = product.profiles;
        const sellerName = seller?.name || 'Unknown Seller';
        const sellerUsername = seller?.username || 'unknown';
        const productImageUrl = product.image_urls && product.image_urls.length > 0 ? product.image_urls[0].url : '/placeholder.svg?height=100&width=100';
        
        userProductsList.innerHTML += `
          <div class="app-card p-4 text-center flex flex-col justify-between items-center cursor-pointer" onclick="viewUserProductDetails('${product.id}')">
            <img src="${productImageUrl}" alt="${product.name}" class="w-full h-32 object-cover rounded-lg mb-3">
            <h3 class="text-lg font-semibold text-text-primary mb-1">${product.name}</h3>
            <p class="text-text-secondary text-sm mb-2">by ${sellerName} (@${sellerUsername})</p>
            <p class="text-xl font-bold text-accent-green mb-3">${utils.formatPrice(product.price)}</p>
          </div>
        `;
      });
    } else {
      userProductsList.innerHTML = '<p class="text-center col-span-full text-text-secondary">No User Products Available</p>';
    }
  } catch (error) {
    console.error('Error loading user products:', error);
    userProductsList.innerHTML = '<p class="text-center col-span-full text-accent-red">Failed to retrieve User Products</p>';
  }
}

async function viewUserProductDetails(productId) { // For Buyer View
  showLoading(true);
  try {
    const { data: product, error } = await state.supabase
      .from('user_products')
      .select(`
        *,
        profiles(username, name, profile_picture)
      `)
      .eq('id', productId)
      .single();

    if (error) throw error;
    if (!product) throw new Error('Product not found.');

    const seller = product.profiles;
    const sellerName = seller?.name || 'Unknown Seller';
    const sellerUsername = seller?.username || 'unknown';
    const sellerAvatar = seller?.profile_picture || '/placeholder.svg?height=40&width=40';

    let imagesHtml = '';
    if (product.image_urls && product.image_urls.length > 0) {
      imagesHtml = product.image_urls.map(img => `<img src="${img.url}" class="w-full rounded-lg mb-3 object-cover max-h-96" alt="Product image">`).join('');
    } else {
      imagesHtml = `<img src="/placeholder.svg?height=300&width=500" class="w-full rounded-lg mb-3 object-cover max-h-96" alt="No image">`;
    }

    let socialLinksHtml = '';
    if (product.social_links && product.social_links.length > 0) {
      socialLinksHtml = product.social_links.map(link => `
        <a href="${link.url}" target="_blank" class="text-text-secondary hover:text-accent-purple flex items-center space-x-2">
          <i class="${link.icon || 'fas fa-link'} text-xl"></i><span>${link.name}</span>
        </a>
      `).join('');
    }

    let contactInfoHtml = '';
    if (product.contact_info && product.contact_info.length > 0) {
      contactInfoHtml = product.contact_info.map(info => `
        <p class="text-text-secondary text-sm"><i class="fas fa-info-circle mr-1"></i> ${info.name}: ${info.value}</p>
      `).join('');
    }

    document.getElementById('user-product-modal-content').innerHTML = `
      <div class="space-y-4">
        <div class="flex items-center space-x-3 mb-4">
          <img src="${sellerAvatar}" 
               alt="Author" class="w-10 h-10 rounded-full object-cover">
          <div>
            <h4 class="font-semibold text-text-primary">${sellerName}</h4>
            <p class="text-sm text-text-secondary">@${sellerUsername}</p>
          </div>
        </div>
        
        <h3 class="text-xl font-bold text-accent-purple">${product.name}</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${imagesHtml}
        </div>

        <p class="text-text-secondary whitespace-pre-wrap">${product.description || 'No description provided.'}</p>
        
        <p class="text-2xl font-bold text-accent-green mb-3">${utils.formatPrice(product.price)}</p>

        ${socialLinksHtml ? `
          <div class="mt-4">
            <h4 class="font-semibold text-text-primary mb-2">Social Media:</h4>
            <div class="flex flex-wrap gap-4">${socialLinksHtml}</div>
          </div>
        ` : ''}

        ${contactInfoHtml ? `
          <div class="mt-4">
            <h4 class="font-semibold text-text-primary mb-2">Contact Info:</h4>
            <div class="space-y-1">${contactInfoHtml}</div>
          </div>
        ` : ''}
        
        <div class="flex gap-4 mt-6">
          <button onclick="initiateUserPurchase('${product.id}', '${product.name}', ${product.price}, '${product.seller_profile_id}')" 
                  class="myanmar-btn flex-1 ${product.is_sold_out ? 'opacity-50 cursor-not-allowed' : ''}" 
                  ${product.is_sold_out ? 'disabled' : ''}>
            <i class="fas fa-shopping-cart mr-2"></i> ${product.is_sold_out ? 'SOLD OUT' : 'BUY NOW'}
          </button>
          <button onclick="initiateBuyerSellerChat('${product.seller_profile_id}', '${sellerName}', '${product.name}')" class="myanmar-btn flex-1">
            <i class="fas fa-comments mr-2"></i> CHAT WITH SELLER
          </button>
        </div>
      </div>
    `;

    document.getElementById('user-product-modal').classList.remove('hidden');

  } catch (error) {
    console.error('Error viewing user product:', error);
    showNotification('Failed to view User Product', 'error');
  } finally {
    showLoading(false);
  }
}

function closeUserProductModal() { // For Buyer View
  document.getElementById('user-product-modal').classList.add('hidden');
}

async function initiateUserPurchase(userProductId, productName, productPrice, sellerProfileId) { // NEW: For User Products
  if (!state.userProfile || !state.userProfile.profile_id) {
    showNotification('Please create a profile to purchase products.', 'info');
    return;
  }
  if (state.userProfile.profile_id === sellerProfileId) {
    showNotification('You cannot purchase your own product.', 'warning');
    return;
  }

  state.selectedUserProductForPurchase = { 
    id: userProductId, 
    name: productName, 
    price: productPrice, 
    seller_profile_id: sellerProfileId 
  };
  
  const paymentModalContent = document.getElementById('user-product-payment-modal-content');
  paymentModalContent.innerHTML = `
    <h3 class="text-xl font-semibold text-text-primary mb-2">${productName}</h3>
    <p class="text-text-secondary mb-4">Price: <span class="text-accent-green font-bold">${utils.formatPrice(productPrice)}</span></p>
    
    <h4 class="text-lg font-semibold text-accent-purple mb-3">SELECT SELLER'S PAYMENT METHOD</h4>
    <div id="seller-payment-methods-list" class="space-y-3 mb-4">
      <div class="loading-spinner mx-auto mb-2"></div>
      <p class="text-center text-text-secondary">Loading seller's payment methods...</p>
    </div>

    <div class="space-y-3">
      <label class="block text-sm font-medium text-text-secondary">UPLOAD RECEIPT IMAGE</label>
      <input type="file" id="user-product-receipt-upload" accept="image/*" class="app-input w-full">
      <label class="block text-sm font-medium text-text-secondary mt-2">NOTES FOR SELLER (Optional)</label>
      <textarea id="user-product-buyer-notes" rows="2" placeholder="e.g., My Telegram username is @..." class="app-input w-full resize-none"></textarea>
      <button onclick="submitUserPurchase()" class="myanmar-btn w-full">
        <i class="fas fa-paper-plane mr-2"></i>
        CONFIRM PAYMENT
      </button>
    </div>
    <p class="text-sm text-text-secondary mt-4">
      <i class="fas fa-info-circle mr-1"></i>
      After confirming payment, the seller will review and approve your order.
    </p>
  `;

  document.getElementById('user-product-payment-modal').classList.remove('hidden');
  
  const sellerPaymentMethodsList = document.getElementById('seller-payment-methods-list');
  try {
    const { data: methods, error } = await state.supabase
      .from('seller_payment_methods')
      .select('*')
      .eq('profile_id', sellerProfileId)
      .eq('is_active', true)
      .order('method_name', { ascending: true });

    if (error) throw error;

    if (methods && methods.length > 0) {
      sellerPaymentMethodsList.innerHTML = methods.map(method => `
        <label class="flex items-center space-x-3 p-3 bg-secondary-bg rounded-lg cursor-pointer border border-border-color">
          <input type="radio" name="seller_payment_method" value="${method.id}" 
                 onchange="state.selectedSellerPaymentMethodId = '${method.id}'" class="w-4 h-4 text-accent-purple focus:ring-accent-purple">
          <div>
            <p class="font-semibold text-text-primary">${method.method_name}</p>
            <p class="text-text-secondary text-sm">${method.account_info || ''}</p>
            ${method.qr_code_url ? `<img src="${method.qr_code_url}" class="w-24 h-24 mt-2 rounded-md border border-border-color" alt="QR Code">` : ''}
            ${method.instructions ? `<p class="text-text-secondary text-xs mt-1">${method.instructions}</p>` : ''}
          </div>
        </label>
      `).join('');
    } else {
      sellerPaymentMethodsList.innerHTML = '<p class="text-center text-text-secondary">Seller has no active payment methods.</p>';
    }
  } catch (error) {
    console.error('Error loading seller payment methods:', error);
    showNotification('Failed to retrieve Seller Payment Methods', 'error');
    sellerPaymentMethodsList.innerHTML = '<p class="text-center text-accent-red">Failed to retrieve Seller Payment Methods</p>';
  }
}

function closeUserProductPaymentModal() { // NEW: For User Products
  document.getElementById('user-product-payment-modal').classList.add('hidden');
  state.selectedUserProductForPurchase = null;
  state.selectedSellerPaymentMethodId = null;
  document.getElementById('user-product-receipt-upload').value = '';
  document.getElementById('user-product-buyer-notes').value = '';
}

async function submitUserPurchase() { // NEW: For User Products
  if (!state.selectedUserProductForPurchase || !state.selectedSellerPaymentMethodId) {
    showNotification('Please select a Product and Seller\'s Payment Method', 'warning');
    return;
  }
  const receiptFile = document.getElementById('user-product-receipt-upload').files[0];
  if (!receiptFile) {
    showNotification('Please upload a receipt image', 'warning');
    return;
  }
  const buyerNotes = document.getElementById('user-product-buyer-notes').value.trim();

  showNotification('Confirming order...', 'info');
  utils.showOrderUploadAnimation(true, false, 'Order တင်နေသည်...'); // Show processing animation

  try {
    // Upload receipt image
    const fileExt = receiptFile.name.split('.').pop();
    const fileName = `user_order_receipts/${state.userProfile.profile_id}_${state.selectedUserProductForPurchase.id}_${Date.now()}.${fileExt}`;
    
    const { data: uploadData, error: uploadError } = await state.supabase.storage
      .from('user_order_receipts') // NEW bucket
      .upload(fileName, file);
      
    if (uploadError) throw uploadError;
    
    const { data: urlData } = state.supabase.storage
      .from('user_order_receipts')
      .getPublicUrl(fileName);
      
    const receiptUrl = urlData.publicUrl;

    // Create user order
    const { error: orderError } = await state.supabase
      .from('user_orders') // NEW table
      .insert({
        user_product_id: state.selectedUserProductForPurchase.id,
        buyer_profile_id: state.userProfile.profile_id,
        seller_profile_id: state.selectedUserProductForPurchase.seller_profile_id,
        amount: state.selectedUserProductForPurchase.price,
        receipt_url: receiptUrl,
        status: 'pending',
        buyer_notes: buyerNotes || null
      });

    if (orderError) throw orderError;

    utils.showOrderUploadAnimation(true, true, 'Order တင်ခြင်း အောင်မြင်ပါပြီ! ရောင်းသူမှ စစ်ဆေးပေးပါမည်။'); // Show success animation
    setTimeout(() => utils.showOrderUploadAnimation(false), 2000); // Hide after 2 seconds

    closeUserProductPaymentModal();
    loadUserShopProducts(); // Reload products to update status
    loadMyBuyerOrders(); // Reload buyer's own orders
    showNotification('Order submitted successfully! Seller will review it.', 'success');
  } catch (error) {
    console.error('Error submitting user purchase:', error);
    utils.showOrderUploadAnimation(false); // Hide animation on error
    showNotification('Failed to submit order', 'error');
  } finally {
    showLoading(false);
  }
}

async function loadMyListedProducts() { // NEW: For Seller View
  const myProductsTableBody = document.getElementById('my-products-table-body');
  if (!state.userProfile || !state.userProfile.profile_id) {
    myProductsTableBody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-text-secondary py-8">
          <i class="fas fa-store text-4xl mb-4"></i>
          <p>Login to manage your shop.</p>
        </td>
      </tr>
    `;
    return;
  }

  myProductsTableBody.innerHTML = `
    <tr>
      <td colspan="5" class="text-center text-text-secondary py-8">
        <div class="loading-spinner mx-auto mb-2"></div>
        Loading your products...
      </td>
    </tr>
  `;

  try {
    const { data: products, error } = await state.supabase
      .from('user_products')
      .select('*')
      .eq('seller_profile_id', state.userProfile.profile_id)
      .order('created_at', { ascending: false });

    if (error) throw error;

    if (products && products.length > 0) {
      myProductsTableBody.innerHTML = products.map(product => {
        const productImageUrl = product.image_urls && product.image_urls.length > 0 ? product.image_urls[0].url : '/placeholder.svg?height=50&width=50';
        const statusClass = product.is_active ? 'status-active' : 'status-inactive';
        const statusText = product.is_active ? (product.is_sold_out ? 'SOLD OUT' : 'ACTIVE') : 'INACTIVE';
        
        return `
          <tr>
            <td><img src="${productImageUrl}" class="w-12 h-12 object-cover rounded-md" alt="${product.name}"></td>
            <td>${product.name}</td>
            <td>${utils.formatPrice(product.price)}</td>
            <td class="${statusClass}">${statusText}</td>
            <td class="table-actions">
              <button onclick="editUserProduct('${product.id}')" class="myanmar-btn btn-small">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="toggleUserProductStatus('${product.id}', ${product.is_active})" class="myanmar-btn btn-small">
                <i class="fas ${product.is_active ? 'fa-eye-slash' : 'fa-eye'}"></i>
              </button>
              <button onclick="toggleUserProductSoldOut('${product.id}', ${product.is_sold_out})" class="myanmar-btn btn-small">
                <i class="fas ${product.is_sold_out ? 'fa-check-circle' : 'fa-times-circle'}"></i>
              </button>
              <button onclick="deleteUserProduct('${product.id}')" class="btn-danger myanmar-btn btn-small">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    } else {
      myProductsTableBody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center text-text-secondary py-8">
            <i class="fas fa-box-open text-4xl mb-4"></i>
            <p>You haven't listed any products yet.</p>
          </td>
        </tr>
      `;
    }
  } catch (error) {
    console.error('Error loading my listed products:', error);
    myProductsTableBody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-accent-red py-8">
          <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
          <p>Failed to retrieve your products</p>
        </td>
      </tr>
    `;
  }
}

async function uploadUserProduct() { // NEW
  if (!state.userProfile || !state.userProfile.profile_id) {
    showNotification('Please create a profile to upload products.', 'info');
    return;
  }

  const name = document.getElementById('user-product-name').value.trim();
  const description = document.getElementById('user-product-description').value.trim();
  const price = parseFloat(document.getElementById('user-product-price').value);
  const images = document.getElementById('user-product-images').files;
  const socialLinksRaw = document.getElementById('user-product-social-links').value.trim();
  const contactInfoRaw = document.getElementById('user-product-contact-info').value.trim();

  if (!name || !description || isNaN(price) || price < 0) {
    showNotification('Please fill in product name, description, and a valid price.', 'warning');
    return;
  }
  if (images.length === 0) {
    showNotification('Please upload at least one product image.', 'warning');
    return;
  }

  showLoading(true);

  try {
    let imageUrls = [];
    for (let i = 0; i < images.length; i++) {
      const file = images[i];
      const fileExt = file.name.split('.').pop();
      const fileName = `user_products/${state.userProfile.profile_id}_${Date.now()}_${i}.${fileExt}`;
      
      const { data: uploadData, error: uploadError } = await state.supabase.storage
        .from('user_product_images') // NEW bucket
        .upload(fileName, file);
        
      if (uploadError) throw uploadError;
      
      const { data: urlData } = state.supabase.storage
        .from('user_product_images')
        .getPublicUrl(fileName);
        
      imageUrls.push({ url: urlData.publicUrl, type: file.type, size: file.size });
    }

    let socialLinks = [];
    if (socialLinksRaw) {
      try {
        socialLinks = JSON.parse(socialLinksRaw);
        if (!Array.isArray(socialLinks)) throw new Error('Social links must be a JSON array.');
      } catch (e) {
        showNotification('Invalid Social Links JSON format. Please use: [{"name": "...", "url": "...", "icon": "..."}]', 'error', 10000);
        return;
      }
    }

    let contactInfo = [];
    if (contactInfoRaw) {
      try {
        contactInfo = JSON.parse(contactInfoRaw);
        if (!Array.isArray(contactInfo)) throw new Error('Contact info must be a JSON array.');
      } catch (e) {
        showNotification('Invalid Contact Info JSON format. Please use: [{"name": "...", "value": "..."}]', 'error', 10000);
        return;
      }
    }

    const { error } = await state.supabase
      .from('user_products') // NEW table
      .insert({
        seller_profile_id: state.userProfile.profile_id,
        name,
        description,
        price,
        image_urls: imageUrls,
        social_links: socialLinks,
        contact_info: contactInfo,
        is_active: true,
        is_sold_out: false
      });

    if (error) throw error;

    // Clear form
    document.getElementById('user-product-name').value = '';
    document.getElementById('user-product-description').value = '';
    document.getElementById('user-product-price').value = '';
    document.getElementById('user-product-images').value = '';
    document.getElementById('user-product-social-links').value = '';
    document.getElementById('user-product-contact-info').value = '';

    showNotification('Product uploaded successfully!', 'success');
    loadMyListedProducts(); // Refresh seller's product list
    loadUserShopProducts(); // Refresh buyer's product list
  } catch (error) {
    console.error('Error uploading product:', error);
    showNotification('Failed to upload product', 'error');
  } finally {
    showLoading(false);
  }
}

async function editUserProduct(productId) { // NEW
  showNotification('Edit Product feature coming soon!', 'info');
  // Similar to admin panel, fetch product data, populate form, then update.
}

async function toggleUserProductStatus(productId, currentStatus) { // NEW
  showLoading(true);
  try {
    const { error } = await state.supabase
      .from('user_products')
      .update({ is_active: !currentStatus })
      .eq('id', productId)
      .eq('seller_profile_id', state.userProfile.profile_id); // Ensure owner can toggle

    if (error) throw error;

    showNotification(`Product status updated to ${!currentStatus ? 'Active' : 'Inactive'}`, 'success');
    loadMyListedProducts();
    loadUserShopProducts();
  } catch (error) {
    console.error('Error toggling product status:', error);
    showNotification('Failed to update product status', 'error');
  } finally {
    showLoading(false);
  }
}

async function toggleUserProductSoldOut(productId, currentSoldOutStatus) { // NEW
  showLoading(true);
  try {
    const { error } = await state.supabase
      .from('user_products')
      .update({ is_sold_out: !currentSoldOutStatus })
      .eq('id', productId)
      .eq('seller_profile_id', state.userProfile.profile_id); // Ensure owner can toggle

    if (error) throw error;

    showNotification(`Product marked as ${!currentSoldOutStatus ? 'Sold Out' : 'Available'}`, 'success');
    loadMyListedProducts();
    loadUserShopProducts();
  } catch (error) {
    console.error('Error toggling product sold out status:', error);
    showNotification('Failed to update product sold out status', 'error');
  } finally {
    showLoading(false);
  }
}

function deleteUserProduct(productId) { // NEW
  showConfirmModal(
    'Are you sure you want to delete this product?',
    async () => {
      showLoading(true);
      try {
        const { error } = await state.supabase
          .from('user_products')
          .delete()
          .eq('id', productId)
          .eq('seller_profile_id', state.userProfile.profile_id); // Ensure only owner can delete

        if (error) throw error;

        showNotification('Product deleted successfully!', 'success');
        loadMyListedProducts();
        loadUserShopProducts();
      } catch (error) {
        console.error('Error deleting product:', error);
        showNotification('Failed to delete product.', 'error');
      } finally {
        showLoading(false);
      }
    }
  );
}

async function addSellerPaymentMethod() { // NEW
  if (!state.userProfile || !state.userProfile.profile_id) {
    showNotification('Please create a profile to add payment methods.', 'info');
    return;
  }

  const methodName = document.getElementById('seller-payment-method-name').value.trim();
  const accountInfo = document.getElementById('seller-payment-account-info').value.trim();
  const instructions = document.getElementById('seller-payment-instructions').value.trim();
  const qrCodeFile = document.getElementById('seller-payment-qr-code').files[0];

  if (!methodName || !accountInfo) {
    showNotification('Please enter Method Name and Account Info.', 'warning');
    return;
  }

  showLoading(true);

  try {
    let qrCodeUrl = null;
    if (qrCodeFile) {
      const fileExt = qrCodeFile.name.split('.').pop();
      const fileName = `seller_qrcodes/${state.userProfile.profile_id}_${Date.now()}.${fileExt}`;
      
      const { data: uploadData, error: uploadError } = await state.supabase.storage
        .from('seller_qr_codes') // NEW bucket
        .upload(fileName, qrCodeFile);
        
      if (uploadError) throw uploadError;
      
      const { data: urlData } = state.supabase.storage
        .from('seller_qr_codes')
        .getPublicUrl(fileName);
        
      qrCodeUrl = urlData.publicUrl;
    }

    const { error } = await state.supabase
      .from('seller_payment_methods') // NEW table
      .insert({
        profile_id: state.userProfile.profile_id,
        method_name: methodName,
        account_info: accountInfo,
        qr_code_url: qrCodeUrl,
        instructions: instructions || null,
        is_active: true
      });

    if (error) throw error;

    // Clear form
    document.getElementById('seller-payment-method-name').value = '';
    document.getElementById('seller-payment-account-info').value = '';
    document.getElementById('seller-payment-instructions').value = '';
    document.getElementById('seller-payment-qr-code').value = '';

    showNotification('Payment method added successfully!', 'success');
    loadSellerPaymentMethods();
  } catch (error) {
    console.error('Error adding payment method:', error);
    showNotification('Failed to add payment method', 'error');
  } finally {
    showLoading(false);
  }
}

async function loadSellerPaymentMethods() { // NEW
  const sellerPaymentMethodsTableBody = document.getElementById('seller-payment-methods-table-body');
  if (!state.userProfile || !state.userProfile.profile_id) {
    sellerPaymentMethodsTableBody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-text-secondary py-8">
          <i class="fas fa-wallet text-4xl mb-4"></i>
          <p>Login to manage your payment methods.</p>
        </td>
      </tr>
    `;
    return;
  }

  sellerPaymentMethodsTableBody.innerHTML = `
    <tr>
      <td colspan="5" class="text-center text-text-secondary py-8">
        <div class="loading-spinner mx-auto mb-2"></div>
        Loading your payment methods...
      </td>
    </tr>
  `;

  try {
    const { data: methods, error } = await state.supabase
      .from('seller_payment_methods')
      .select('*')
      .eq('profile_id', state.userProfile.profile_id)
      .order('created_at', { ascending: false });

    if (error) throw error;

    if (methods && methods.length > 0) {
      sellerPaymentMethodsTableBody.innerHTML = methods.map(method => {
        const statusClass = method.is_active ? 'status-active' : 'status-inactive';
        const statusText = method.is_active ? 'ACTIVE' : 'INACTIVE';
        
        return `
          <tr>
            <td>${method.method_name}</td>
            <td>${method.account_info}</td>
            <td>
              ${method.qr_code_url ? `<img src="${method.qr_code_url}" class="w-16 h-16 object-contain rounded-md" alt="QR Code">` : 'N/A'}
            </td>
            <td class="${statusClass}">${statusText}</td>
            <td class="table-actions">
              <button onclick="toggleSellerPaymentMethodStatus('${method.id}', ${method.is_active})" class="myanmar-btn btn-small">
                <i class="fas ${method.is_active ? 'fa-eye-slash' : 'fa-eye'}"></i>
              </button>
              <button onclick="deleteSellerPaymentMethod('${method.id}')" class="btn-danger myanmar-btn btn-small">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    } else {
      sellerPaymentMethodsTableBody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center text-text-secondary py-8">
            <i class="fas fa-wallet text-4xl mb-4"></i>
            <p>You haven't added any payment methods yet.</p>
          </td>
        </tr>
      `;
    }
  } catch (error) {
    console.error('Error loading seller payment methods:', error);
    sellerPaymentMethodsTableBody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-accent-red py-8">
          <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
          <p>Failed to retrieve your payment methods</p>
        </td>
      </tr>
    `;
  }
}

async function toggleSellerPaymentMethodStatus(methodId, currentStatus) { // NEW
  showLoading(true);
  try {
    const { error } = await state.supabase
      .from('seller_payment_methods')
      .update({ is_active: !currentStatus })
      .eq('id', methodId)
      .eq('profile_id', state.userProfile.profile_id); // Ensure owner can toggle

    if (error) throw error;

    showNotification(`Payment method status updated to ${!currentStatus ? 'Active' : 'Inactive'}`, 'success');
    loadSellerPaymentMethods();
  } catch (error) {
    console.error('Error toggling payment method status:', error);
    showNotification('Failed to update payment method status', 'error');
  } finally {
    showLoading(false);
  }
}

function deleteSellerPaymentMethod(methodId) { // NEW
  showConfirmModal(
    'Are you sure you want to delete this payment method?',
    async () => {
      showLoading(true);
      try {
        const { error } = await state.supabase
          .from('seller_payment_methods')
          .delete()
          .eq('id', methodId)
          .eq('profile_id', state.userProfile.profile_id); // Ensure only owner can delete

        if (error) throw error;

        showNotification('Payment method deleted successfully!', 'success');
        loadSellerPaymentMethods();
      } catch (error) {
        console.error('Error deleting payment method:', error);
        showNotification('Failed to delete payment method.', 'error');
      } finally {
        showLoading(false);
      }
    }
  );
}

async function loadIncomingUserOrders() { // NEW: For Seller View
  const incomingOrdersTableBody = document.getElementById('incoming-orders-table-body');
  if (!state.userProfile || !state.userProfile.profile_id) {
    incomingOrdersTableBody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center text-text-secondary py-8">
          <i class="fas fa-receipt text-4xl mb-4"></i>
          <p>Login to view your incoming orders.</p>
        </td>
      </tr>
    `;
    return;
  }

  incomingOrdersTableBody.innerHTML = `
    <tr>
      <td colspan="6" class="text-center text-text-secondary py-8">
        <div class="loading-spinner mx-auto mb-2"></div>
        Loading incoming orders...
      </td>
    </tr>
  `;

  try {
    const { data: orders, error } = await state.supabase
      .from('user_orders')
      .select(`
        *,
        user_products(name, price),
        profiles(username, name, profile_picture)
      `)
      .eq('seller_profile_id', state.userProfile.profile_id)
      .order('ordered_at', { ascending: false });

    if (error) throw error;

    if (orders && orders.length > 0) {
      incomingOrdersTableBody.innerHTML = orders.map(order => {
        const buyer = order.profiles;
        const buyerName = buyer?.name || 'Unknown Buyer';
        const buyerUsername = buyer?.username || 'unknown';
        const productName = order.user_products?.name || 'N/A';
        const statusClass = {
          'pending': 'text-yellow-400',
          'approved': 'text-accent-green',
          'rejected': 'text-accent-red',
          'delivered': 'text-blue-400',
          'cancelled': 'text-gray-400'
        }[order.status] || 'text-text-secondary';
        
        return `
          <tr>
            <td>${buyerName} (@${buyerUsername})</td>
            <td>${productName}</td>
            <td>${utils.formatPrice(order.amount)}</td>
            <td>
              ${order.receipt_url ? `<a href="${order.receipt_url}" target="_blank" class="text-accent-purple hover:underline"><i class="fas fa-file-image mr-1"></i> View Receipt</a>` : 'N/A'}
            </td>
            <td class="${statusClass}">${order.status.toUpperCase()}</td>
            <td class="table-actions">
              ${order.status === 'pending' ? `
                <button onclick="updateUserOrderStatus('${order.id}', 'approved')" class="myanmar-btn btn-small">
                  <i class="fas fa-check"></i> Approve
                </button>
                <button onclick="updateUserOrderStatus('${order.id}', 'rejected')" class="btn-danger myanmar-btn btn-small">
                  <i class="fas fa-times"></i> Reject
                </button>
              ` : order.status === 'approved' ? `
                <button onclick="updateUserOrderStatus('${order.id}', 'delivered')" class="myanmar-btn btn-small">
                  <i class="fas fa-truck"></i> Mark Delivered
                </button>
              ` : ''}
              <button onclick="viewUserOrderDetails('${order.id}')" class="myanmar-btn btn-small">
                <i class="fas fa-eye"></i> Details
              </button>
            </td>
          </tr>
        `;
      }).join('');
    } else {
      incomingOrdersTableBody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center text-text-secondary py-8">
            <i class="fas fa-receipt text-4xl mb-4"></i>
            <p>No incoming orders found.</p>
          </td>
        </tr>
      `;
    }
  } catch (error) {
    console.error('Error loading incoming user orders:', error);
    incomingOrdersTableBody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center text-accent-red py-8">
          <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
          <p>Failed to retrieve incoming orders</p>
        </td>
      </tr>
    `;
  }
}

async function updateUserOrderStatus(orderId, newStatus) { // NEW
  showLoading(true);
  try {
    const { error } = await state.supabase
      .from('user_orders')
      .update({ status: newStatus })
      .eq('id', orderId)
      .eq('seller_profile_id', state.userProfile.profile_id); // Ensure seller can update their orders

    if (error) throw error;

    showNotification(`Order ${orderId} status updated to ${newStatus.toUpperCase()}`, 'success');
    loadIncomingUserOrders();
    loadMyBuyerOrders(); // Refresh buyer's view too
  } catch (error) {
    console.error('Error updating user order status:', error);
    showNotification('Failed to update order status', 'error');
  } finally {
    showLoading(false);
  }
}

async function viewUserOrderDetails(orderId) { // NEW
  showNotification('Order Details feature coming soon!', 'info');
  // Similar to product details modal, fetch order data and display.
}

async function loadMyBuyerOrders() { // NEW: For Buyer View (My Orders tab)
  const myBuyerOrdersList = document.getElementById('my-buyer-orders-list'); // Assuming a new div for this
  if (!myBuyerOrdersList) {
    // If this element doesn't exist, create it or ensure it's part of the HTML structure
    // For now, we'll just log a warning.
    console.warn("Element 'my-buyer-orders-list' not found. Please ensure it's in your HTML for 'My Orders' tab.");
    return;
  }

  if (!state.userProfile || !state.userProfile.profile_id) {
    myBuyerOrdersList.innerHTML = `
      <div class="text-center text-text-secondary py-8">
        <i class="fas fa-history text-4xl mb-4"></i>
        <p>Login to view your order history.</p>
      </div>
    `;
    return;
  }

  myBuyerOrdersList.innerHTML = `
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-center text-text-secondary">Loading your orders...</p>
  `;

  try {
    const { data: orders, error } = await state.supabase
      .from('user_orders')
      .select(`
        *,
        user_products(name, price),
        profiles!seller_profile_id(username, name)
      `)
      .eq('buyer_profile_id', state.userProfile.profile_id)
      .order('ordered_at', { ascending: false });

    if (error) throw error;

    if (orders && orders.length > 0) {
      myBuyerOrdersList.innerHTML = `
        <div class="overflow-x-auto">
          <table class="app-table w-full">
            <thead>
              <tr>
                <th class="text-left">PRODUCT</th>
                <th class="text-left">SELLER</th>
                <th class="text-left">AMOUNT</th>
                <th class="text-left">STATUS</th>
                <th class="text-left">ORDERED AT</th>
              </tr>
            </thead>
            <tbody>
              ${orders.map(order => {
                const productName = order.user_products?.name || 'N/A';
                const sellerName = order.profiles?.name || 'Unknown Seller';
                const statusClass = {
                  'pending': 'text-yellow-400',
                  'approved': 'text-accent-green',
                  'rejected': 'text-accent-red',
                  'delivered': 'text-blue-400',
                  'cancelled': 'text-gray-400'
                }[order.status] || 'text-text-secondary';
                
                return `
                  <tr>
                    <td>${productName}</td>
                    <td>${sellerName}</td>
                    <td>${utils.formatPrice(order.amount)}</td>
                    <td class="${statusClass}">${order.status.toUpperCase()}</td>
                    <td>${new Date(order.ordered_at).toLocaleDateString('my-MM')}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    } else {
      myBuyerOrdersList.innerHTML = `
        <div class="text-center text-text-secondary py-8">
          <i class="fas fa-history text-4xl mb-4"></i>
          <p>You have no purchase orders yet.</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading my buyer orders:', error);
    myBuyerOrdersList.innerHTML = `
      <div class="text-center text-accent-red py-8">
        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
        <p>Failed to retrieve your orders</p>
      </div>
    `;
  }
}

async function initiateBuyerSellerChat(sellerProfileId, sellerName, productName) { // NEW
  if (!state.userProfile || !state.userProfile.profile_id) {
    showNotification('Please create a profile to chat.', 'info');
    return;
  }
  if (state.userProfile.profile_id === sellerProfileId) {
    showNotification('You cannot chat with yourself.', 'warning');
    return;
  }

  showLoading(true);
  try {
    const { data, error } = await state.supabase.rpc('get_or_create_buyer_seller_conversation', {
      profile1_id: state.userProfile.profile_id,
      profile2_id: sellerProfileId
    });

    if (error) throw error;

    state.currentBuyerSellerConversationId = data;
    state.currentChatPartnerProfileId = sellerProfileId;
    document.getElementById('chat-modal-title').textContent = `CHAT WITH ${sellerName} (for ${productName})`;
    
    await loadBuyerSellerChatMessages(data, sellerProfileId);
    document.getElementById('buyer-seller-chat-modal').classList.remove('hidden');
  } catch (error) {
    console.error('Error initiating buyer-seller chat:', error);
    showNotification('Failed to start chat with seller', 'error');
  } finally {
    showLoading(false);
  }
}

function closeBuyerSellerChatModal() { // NEW
  document.getElementById('buyer-seller-chat-modal').classList.add('hidden');
  state.currentBuyerSellerConversationId = null;
  state.currentChatPartnerProfileId = null;
  document.getElementById('buyer-seller-chat-input').value = '';
  document.getElementById('buyer-seller-chat-file-upload').value = '';
}

async function loadBuyerSellerChatMessages(conversationId, chatPartnerProfileId) { // NEW
  const chatMessagesContainer = document.getElementById('buyer-seller-chat-messages');
  chatMessagesContainer.innerHTML = `
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-center text-text-secondary">Loading messages...</p>
  `;
  chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom

  try {
    const { data: messages, error } = await state.supabase
      .from('buyer_seller_messages')
      .select(`
        *,
        sender_profile:profiles!sender_profile_id(username, name, profile_picture)
      `)
      .eq('conversation_id', conversationId)
      .order('created_at', { ascending: true });

    if (error) throw error;

    if (messages && messages.length > 0) {
      chatMessagesContainer.innerHTML = messages.map(msg => {
        const isSender = msg.sender_profile_id === state.userProfile.profile_id;
        const senderName = isSender ? 'You' : msg.sender_profile?.name || 'Unknown';
        const senderAvatar = msg.sender_profile?.profile_picture || '/placeholder.svg?height=30&width=30';
        const messageTime = new Date(msg.created_at).toLocaleTimeString('my-MM', { hour: '2-digit', minute: '2-digit' });
        
        let contentHtml = '';
        if (msg.message_type === 'text') {
          contentHtml = `<p class="text-text-primary whitespace-pre-wrap">${msg.content}</p>`;
        } else if (msg.message_type === 'image') {
          contentHtml = `<img src="${msg.file_url}" class="max-w-xs max-h-48 rounded-lg object-contain" alt="Image">`;
        } else if (msg.message_type === 'file') {
          contentHtml = `
            <a href="${msg.file_url}" target="_blank" download class="text-accent-purple hover:underline flex items-center">
              <i class="fas fa-file mr-2"></i> ${msg.file_name || 'File'} (${utils.formatFileSize(msg.file_size)})
            </a>
          `;
        } else if (msg.message_type === 'order_list') {
          contentHtml = `
            <div class="bg-gray-800 p-3 rounded-lg border border-accent-purple">
              <p class="font-semibold text-accent-green mb-1"><i class="fas fa-clipboard-list mr-1"></i> Order List Sent:</p>
              <p class="text-sm text-text-secondary whitespace-pre-wrap">${msg.content}</p>
            </div>
          `;
        }

        return `
          <div class="flex ${isSender ? 'justify-end' : 'justify-start'} mb-4">
            <div class="flex ${isSender ? 'flex-row-reverse' : 'flex-row'} items-start space-x-2 ${isSender ? 'space-x-reverse' : ''}">
              <img src="${senderAvatar}" alt="${senderName}" class="w-8 h-8 rounded-full object-cover">
              <div class="p-3 rounded-lg ${isSender ? 'bg-accent-purple text-black' : 'bg-secondary-bg text-text-primary'} max-w-xs md:max-w-md">
                <p class="font-semibold text-sm ${isSender ? 'text-black' : 'text-accent-green'}">${senderName}</p>
                ${contentHtml}
                <p class="text-xs text-right ${isSender ? 'text-gray-800' : 'text-text-secondary'} mt-1">${messageTime}</p>
              </div>
            </div>
          </div>
        `;
      }).join('');
      chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom after rendering
    } else {
      chatMessagesContainer.innerHTML = `
        <div class="text-center text-text-secondary py-8">
          <i class="fas fa-comments text-4xl mb-4"></i>
          <p>No messages yet. Start the conversation!</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading buyer-seller chat messages:', error);
    chatMessagesContainer.innerHTML = `
      <div class="text-center text-accent-red py-8">
        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
        <p>Failed to retrieve messages</p>
      </div>
    `;
  }
}

async function sendBuyerSellerChatMessage() { // NEW
  if (!state.currentBuyerSellerConversationId || !state.userProfile || !state.userProfile.profile_id) {
    showNotification('No active chat. Please select a product to chat with seller.', 'warning');
    return;
  }

  const chatInput = document.getElementById('buyer-seller-chat-input');
  const messageContent = chatInput.value.trim();

  if (!messageContent) {
    showNotification('Message cannot be empty.', 'warning');
    return;
  }

  chatInput.value = ''; // Clear input immediately

  try {
    const { error } = await state.supabase
      .from('buyer_seller_messages')
      .insert({
        conversation_id: state.currentBuyerSellerConversationId,
        sender_profile_id: state.userProfile.profile_id,
        content: messageContent,
        message_type: 'text'
      });

    if (error) throw error;

    // Message will be reloaded by realtime subscription
  } catch (error) {
    console.error('Error sending buyer-seller message:', error);
    showNotification('Failed to send message', 'error');
  }
}

async function uploadBuyerSellerChatFile() { // NEW
  if (!state.currentBuyerSellerConversationId || !state.userProfile || !state.userProfile.profile_id) {
    showNotification('No active chat. Please select a product to chat with seller.', 'warning');
    return;
  }

  const fileInput = document.getElementById('buyer-seller-chat-file-upload');
  const file = fileInput.files[0];

  if (!file) {
    showNotification('Please select a file to upload.', 'warning');
    return;
  }

  showLoading(true);

  try {
    const fileExt = file.name.split('.').pop();
    const fileName = `buyer_seller_chat_files/${state.currentBuyerSellerConversationId}_${state.userProfile.profile_id}_${Date.now()}.${fileExt}`;
    
    const { data: uploadData, error: uploadError } = await state.supabase.storage
      .from('buyer_seller_chat_files') // NEW bucket
      .upload(fileName, file);
      
    if (uploadError) throw uploadError;
    
    const { data: urlData } = state.supabase.storage
      .from('buyer_seller_chat_files')
      .getPublicUrl(fileName);
      
    const fileUrl = urlData.publicUrl;
    const fileType = utils.getMediaType(file.type);

    const { error } = await state.supabase
      .from('buyer_seller_messages')
      .insert({
        conversation_id: state.currentBuyerSellerConversationId,
        sender_profile_id: state.userProfile.profile_id,
        content: `[${fileType.toUpperCase()} File] ${file.name}`, // Placeholder content
        message_type: fileType,
        file_url: fileUrl,
        file_name: file.name,
        file_size: file.size
      });

    if (error) throw error;

    fileInput.value = ''; // Clear file input
    showNotification('File uploaded successfully!', 'success');
  } catch (error) {
    console.error('Error uploading chat file:', error);
    showNotification('Failed to upload file', 'error');
  } finally {
    showLoading(false);
  }
}

async function showOrderListToSendMessage() { // NEW
  if (!state.currentBuyerSellerConversationId || !state.userProfile || !state.userProfile.profile_id) {
    showNotification('No active chat. Please select a product to chat with seller.', 'warning');
    return;
  }

  showLoading(true);
  try {
    const { data: orders, error } = await state.supabase
      .from('user_orders')
      .select(`
        *,
        user_products(name, price)
      `)
      .eq('buyer_profile_id', state.userProfile.profile_id)
      .eq('seller_profile_id', state.currentChatPartnerProfileId)
      .order('ordered_at', { ascending: false })
      .limit(5); // Get last 5 orders for this seller

    if (error) throw error;

    let orderListContent = "My Recent Orders:\n";
    if (orders && orders.length > 0) {
      orders.forEach((order, index) => {
        orderListContent += `${index + 1}. Product: ${order.user_products?.name || 'N/A'}, Amount: ${utils.formatPrice(order.amount)}, Status: ${order.status.toUpperCase()}\n`;
      });
    } else {
      orderListContent += "No recent orders with this seller.";
    }

    const { error: sendError } = await state.supabase
      .from('buyer_seller_messages')
      .insert({
        conversation_id: state.currentBuyerSellerConversationId,
        sender_profile_id: state.userProfile.profile_id,
        content: orderListContent,
        message_type: 'order_list'
      });

    if (sendError) throw sendError;

    showNotification('Order list sent successfully!', 'success');
  } catch (error) {
    console.error('Error sending order list:', error);
    showNotification('Failed to send order list', 'error');
  } finally {
    showLoading(false);
  }
}


async function loadChatMessages() { // For Global Chat
  const chatMessagesContainer = document.getElementById('chat-messages');
  chatMessagesContainer.innerHTML = `
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-center text-text-secondary">Loading messages...</p>
  `;
  chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom

  try {
    // Get or create conversation with admin
    const { data: conversationId, error: convError } = await state.supabase.rpc('get_or_create_conversation', {
      user1_id: state.userProfile.profile_id,
      user2_id: state.adminProfileChatId
    });
    if (convError) throw convError;

    const { data: messages, error } = await state.supabase
      .from('chat_messages')
      .select(`
        *,
        sender:profiles!sender_id(username, name, profile_picture)
      `)
      .eq('conversation_id', conversationId)
      .order('created_at', { ascending: true });

    if (error) throw error;

    if (messages && messages.length > 0) {
      chatMessagesContainer.innerHTML = messages.map(msg => {
        const isSender = msg.sender_id === state.userProfile.profile_id;
        const senderName = isSender ? 'You' : msg.sender?.name || 'Admin';
        const senderAvatar = msg.sender?.profile_picture || '/placeholder.svg?height=30&width=30';
        const messageTime = new Date(msg.created_at).toLocaleTimeString('my-MM', { hour: '2-digit', minute: '2-digit' });
        
        return `
          <div class="flex ${isSender ? 'justify-end' : 'justify-start'} mb-4">
            <div class="flex ${isSender ? 'flex-row-reverse' : 'flex-row'} items-start space-x-2 ${isSender ? 'space-x-reverse' : ''}">
              <img src="${senderAvatar}" alt="${senderName}" class="w-8 h-8 rounded-full object-cover">
              <div class="p-3 rounded-lg ${isSender ? 'bg-accent-purple text-black' : 'bg-secondary-bg text-text-primary'} max-w-xs md:max-w-md">
                <p class="font-semibold text-sm ${isSender ? 'text-black' : 'text-accent-green'}">${senderName}</p>
                <p class="text-text-primary whitespace-pre-wrap">${msg.content}</p>
                <p class="text-xs text-right ${isSender ? 'text-gray-800' : 'text-text-secondary'} mt-1">${messageTime}</p>
              </div>
            </div>
          </div>
        `;
      }).join('');
      chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom after rendering
    } else {
      chatMessagesContainer.innerHTML = `
        <div class="text-center text-text-secondary py-8">
          <i class="fas fa-comments text-4xl mb-4"></i>
          <p>No messages yet. Start the conversation!</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading chat messages:', error);
    chatMessagesContainer.innerHTML = `
      <div class="text-center text-accent-red py-8">
        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
        <p>Failed to retrieve messages</p>
      </div>
    `;
  }
}

async function sendChatMessage() { // For Global Chat
  if (!state.userProfile || !state.userProfile.profile_id) {
    showNotification('Please create a profile to send messages.', 'info');
    return;
  }

  const chatInput = document.getElementById('chat-input');
  const messageContent = chatInput.value.trim();

  if (!messageContent) {
    showNotification('Message cannot be empty.', 'warning');
    return;
  }

  chatInput.value = ''; // Clear input immediately

  try {
    // Get or create conversation with admin
    const { data: conversationId, error: convError } = await state.supabase.rpc('get_or_create_conversation', {
      user1_id: state.userProfile.profile_id,
      user2_id: state.adminProfileChatId
    });
    if (convError) throw convError;

    const { error } = await state.supabase
      .from('chat_messages')
      .insert({
        conversation_id: conversationId,
        sender_id: state.userProfile.profile_id,
        content: messageContent
      });

    if (error) throw error;

    // Message will be reloaded by realtime subscription
  } catch (error) {
    console.error('Error sending chat message:', error);
    showNotification('Failed to send message', 'error');
  }
}

async function loadSupportMessages() {
  const supportMessagesContainer = document.getElementById('support-messages');
  supportMessagesContainer.innerHTML = `
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-center text-text-secondary">Loading support messages...</p>
  `;
  supportMessagesContainer.scrollTop = supportMessagesContainer.scrollHeight; // Scroll to bottom

  try {
    const { data: messages, error } = await state.supabase
      .from('support_messages')
      .select(`
        *,
        profile:profiles!profile_id(username, name, profile_picture),
        admin_profile:admin_profiles!admin_profile_id(username, name, profile_picture)
      `)
      .or(`profile_id.eq.${state.userProfile.profile_id},admin_profile_id.eq.${state.adminProfileChatId}`) // Filter for messages involving current user or admin
      .order('created_at', { ascending: true });

    if (error) throw error;

    if (messages && messages.length > 0) {
      supportMessagesContainer.innerHTML = messages.map(msg => {
        const isUserMessage = msg.profile_id === state.userProfile.profile_id;
        const senderName = isUserMessage ? (msg.profile?.name || 'You') : (msg.admin_profile?.name || 'Admin');
        const senderAvatar = isUserMessage ? (msg.profile?.profile_picture || '/placeholder.svg?height=30&width=30') : (msg.admin_profile?.profile_picture || '/placeholder.svg?height=30&width=30');
        const messageTime = new Date(msg.created_at).toLocaleTimeString('my-MM', { hour: '2-digit', minute: '2-digit' });
        
        return `
          <div class="flex ${isUserMessage ? 'justify-end' : 'justify-start'} mb-4">
            <div class="flex ${isUserMessage ? 'flex-row-reverse' : 'flex-row'} items-start space-x-2 ${isUserMessage ? 'space-x-reverse' : ''}">
              <img src="${senderAvatar}" alt="${senderName}" class="w-8 h-8 rounded-full object-cover">
              <div class="p-3 rounded-lg ${isUserMessage ? 'bg-accent-purple text-black' : 'bg-secondary-bg text-text-primary'} max-w-xs md:max-w-md">
                <p class="font-semibold text-sm ${isUserMessage ? 'text-black' : 'text-accent-green'}">${senderName}</p>
                <p class="text-text-primary whitespace-pre-wrap">${msg.content}</p>
                <p class="text-xs text-right ${isUserMessage ? 'text-gray-800' : 'text-text-secondary'} mt-1">${messageTime}</p>
              </div>
            </div>
          </div>
        `;
      }).join('');
      supportMessagesContainer.scrollTop = supportMessagesContainer.scrollHeight; // Scroll to bottom after rendering
    } else {
      supportMessagesContainer.innerHTML = `
        <div class="text-center text-text-secondary py-8">
          <i class="fas fa-headset text-4xl mb-4"></i>
          <p>No support messages yet. Send a message to get help!</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading support messages:', error);
    supportMessagesContainer.innerHTML = `
      <div class="text-center text-accent-red py-8">
        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
        <p>Failed to retrieve support messages</p>
      </div>
    `;
  }
}

async function sendSupportMessage() {
  if (!state.userProfile || !state.userProfile.profile_id) {
    showNotification('Please create a profile to send support messages.', 'info');
    return;
  }

  const supportInput = document.getElementById('support-input');
  const messageContent = supportInput.value.trim();

  if (!messageContent) {
    showNotification('Message cannot be empty.', 'warning');
    return;
  }

  supportInput.value = ''; // Clear input immediately

  try {
    const { error } = await state.supabase
      .from('support_messages')
      .insert({
        profile_id: state.userProfile.profile_id,
        admin_profile_id: state.adminProfileChatId, // Assign to a default admin for now
        content: messageContent,
        is_from_user: true,
        priority: 'normal',
        status: 'open'
      });

    if (error) throw error;

    // Message will be reloaded by realtime subscription
  } catch (error) {
    console.error('Error sending support message:', error);
    showNotification('Failed to send support message', 'error');
  }
}

async function loadAboutData() {
  const aboutContent = document.getElementById('about-content');
  aboutContent.innerHTML = `
    <div class="loading-spinner mx-auto mb-4"></div>
    <p class="text-center text-text-secondary">Loading about information...</p>
  `;

  try {
    const { data, error } = await state.supabase
      .from('about')
      .select('*')
      .eq('id', 'main')
      .single();

    if (error) throw error;

    if (data) {
      let socialLinksHtml = '';
      if (data.social_links && data.social_links.length > 0) {
        socialLinksHtml = data.social_links.map(link => `
          <a href="${link.url}" target="_blank" class="text-accent-purple hover:text-accent-green flex items-center space-x-2">
            <i class="${link.icon_url ? '' : 'fas fa-link'} text-xl"></i>
            ${link.icon_url ? `<img src="${link.icon_url}" class="w-6 h-6 inline-block mr-2" alt="${link.name} icon">` : ''}
            <span>${link.name}</span>
          </a>
        `).join('');
      }

      aboutContent.innerHTML = `
        <p class="text-lg font-semibold text-text-primary mb-2">${data.contact_name || 'FPS GFX Tool Support'}</p>
        <p><i class="fas fa-phone-alt mr-2 text-accent-green"></i> Phone: ${data.phone || 'N/A'}</p>
        <p><i class="fas fa-envelope mr-2 text-accent-green"></i> Email: ${data.email || 'N/A'}</p>
        <p><i class="fab fa-telegram-plane mr-2 text-accent-green"></i> Telegram: <a href="${data.telegram}" target="_blank" class="text-accent-purple hover:underline">${data.telegram || 'N/A'}</a></p>
        <p><i class="fab fa-viber mr-2 text-accent-green"></i> Viber: <a href="${data.viber}" target="_blank" class="text-accent-purple hover:underline">${data.viber || 'N/A'}</a></p>
        <p><i class="fab fa-facebook-f mr-2 text-accent-green"></i> Facebook: <a href="${data.facebook}" target="_blank" class="text-accent-purple hover:underline">${data.facebook || 'N/A'}</a></p>
        <p><i class="fab fa-tiktok mr-2 text-accent-green"></i> TikTok: <a href="${data.tiktok}" target="_blank" class="text-accent-purple hover:underline">${data.tiktok || 'N/A'}</a></p>
        
        ${socialLinksHtml ? `<div class="mt-4 space-y-2">
          <h4 class="font-semibold text-text-primary">Other Links:</h4>
          ${socialLinksHtml}
        </div>` : ''}
      `;
    } else {
      aboutContent.innerHTML = '<p class="text-center text-text-secondary">About information not available.</p>';
    }
  } catch (error) {
    console.error('Error loading about data:', error);
    aboutContent.innerHTML = '<p class="text-center text-accent-red">Failed to retrieve About information</p>';
  }
}

async function loadMiProfile() {
  if (!state.userProfile || !state.userProfile.profile_id) {
    document.getElementById('profile-details').innerHTML = `
      <div class="text-center text-text-secondary py-8">
        <i class="fas fa-user-circle text-4xl mb-4"></i>
        <p>Login to view your profile.</p>
      </div>
    `;
    return;
  }

  try {
    const { data, error } = await state.supabase
      .from('profiles')
      .select('*')
      .eq('id', state.userProfile.profile_id)
      .single();

    if (error) throw error;

    if (data) {
      document.getElementById('mi-profile-picture').src = data.profile_picture || '/placeholder.svg?height=100&width=100';
      document.getElementById('mi-name').textContent = data.name || 'N/A';
      document.getElementById('mi-username').textContent = `@${data.username || 'N/A'}`;
      document.getElementById('mi-key-text').value = localStorage.getItem('user_key') || 'N/A';
      document.getElementById('mi-account-status').value = data.is_banned ? 'BANNED' : 'ACTIVE';
      document.getElementById('mi-account-status').classList.toggle('status-banned', data.is_banned);
      document.getElementById('mi-account-status').classList.toggle('status-active', !data.is_banned);
    } else {
      document.getElementById('profile-details').innerHTML = `
        <div class="text-center text-text-secondary py-8">
          <i class="fas fa-user-circle text-4xl mb-4"></i>
          <p>Profile data not found. Please try creating one.</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading MI profile:', error);
    document.getElementById('profile-details').innerHTML = `
      <div class="text-center text-accent-red py-8">
        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
        <p>Failed to retrieve profile data</p>
      </div>
    `;
  }
}

async function updateProfile() {
  if (!state.userProfile || !state.userProfile.profile_id) {
    showNotification('Please login to update your profile.', 'info');
    return;
  }

  const newProfilePictureFile = document.getElementById('mi-new-profile-picture').files[0];
  showLoading(true);

  try {
    let profilePictureUrl = state.userProfile.profile_picture; // Keep existing if no new file

    if (newProfilePictureFile) {
      const fileExt = newProfilePictureFile.name.split('.').pop();
      const fileName = `profile_pictures/${state.userProfile.profile_id}_${Date.now()}.${fileExt}`;
      
      const { data: uploadData, error: uploadError } = await state.supabase.storage
        .from('profiles')
        .upload(fileName, newProfilePictureFile);
        
      if (uploadError) throw uploadError;
      
      const { data: urlData } = state.supabase.storage
        .from('profiles')
        .getPublicUrl(fileName);
        
      profilePictureUrl = urlData.publicUrl;
    }

    const { error } = await state.supabase
      .from('profiles')
      .update({ profile_picture: profilePictureUrl })
      .eq('id', state.userProfile.profile_id);

    if (error) throw error;

    state.userProfile.profile_picture = profilePictureUrl; // Update local state
    document.getElementById('mi-new-profile-picture').value = ''; // Clear file input
    showNotification('Profile updated successfully!', 'success');
    loadMiProfile(); // Reload profile details
  } catch (error) {
    console.error('Error updating profile:', error);
    showNotification('Failed to update profile', 'error');
  } finally {
    showLoading(false);
  }
}

function userLogout() {
  localStorage.removeItem('user_key');
  state.isAuthenticated = false;
  state.userProfile = null;
  
  // Unsubscribe from all realtime channels
  if (state.newsRealtime) state.supabase.removeChannel(state.newsRealtime);
  if (state.profileNewsRealtime) state.supabase.removeChannel(state.profileNewsRealtime);
  if (state.chatRealtime) state.supabase.removeChannel(state.chatRealtime);
  if (state.supportRealtime) state.supabase.removeChannel(state.supportRealtime);
  if (state.productsRealtime) state.supabase.removeChannel(state.productsRealtime);
  if (state.userProductsRealtime) state.supabase.removeChannel(state.userProductsRealtime);
  if (state.ordersRealtime) state.supabase.removeChannel(state.ordersRealtime);
  if (state.userOrdersRealtime) state.supabase.removeChannel(state.userOrdersRealtime);
  if (state.buyerSellerConversationsRealtime) state.supabase.removeChannel(state.buyerSellerConversationsRealtime);
  if (state.buyerSellerMessagesRealtime) state.supabase.removeChannel(state.buyerSellerMessagesRealtime);

  document.getElementById('app-content').classList.add('hidden');
  document.getElementById('profile-creation-section').classList.add('hidden');
  document.getElementById('login-section').classList.remove('hidden');
  document.getElementById('login-key').value = ''; // Clear key input
  showNotification('Logged out successfully!', 'info');
}

function showLoading(show) {
  const loadingOverlay = document.getElementById('loading-overlay');
  if (show) {
    loadingOverlay.classList.remove('hidden');
  } else {
    loadingOverlay.classList.add('hidden');
  }
}

function showConfirmModal(message, callback) {
  document.getElementById('confirm-message').textContent = message;
  state.confirmCallback = callback;
  document.getElementById('confirm-modal').classList.remove('hidden');
}

function closeConfirmModal() {
  document.getElementById('confirm-modal').classList.add('hidden');
  state.confirmCallback = null;
}

function confirmAction() {
  if (state.confirmCallback) {
    state.confirmCallback();
  }
  closeConfirmModal();
}

function filterTable(tableBodyId, searchTerm) {
  const tableBody = document.getElementById(tableBodyId);
  const rows = tableBody.getElementsByTagName('tr');
  const filter = searchTerm.toLowerCase();

  for (let i = 0; i < rows.length; i++) {
    let row = rows[i];
    let cells = row.getElementsByTagName('td');
    let rowText = '';
    for (let j = 0; j < cells.length; j++) {
      rowText += cells[j].textContent || cells[j].innerText;
    }
    if (rowText.toLowerCase().indexOf(filter) > -1) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  }
}

</script>
</body>
</html>
